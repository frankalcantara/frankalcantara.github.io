<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.553">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Linguagens Formais e Autômatos - 17&nbsp; Otimizações Peephole: Algoritmos e Técnicas em Código Intermediário</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./fase1.html" rel="next">
<link href="./15-llvmIR.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles/custom.css">
</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./14-GeraInter.html">Geração de Código Intermediário</a></li><li class="breadcrumb-item"><a href="./16-peepOtimiza.html"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Otimizações Peephole: Algoritmos e Técnicas em Código Intermediário</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Linguagens Formais e Autômatos</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/frankalcantara/linguagens-formais" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Disciplina de Linguagens Formais</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Analisadores Léxicos</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-lexico.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Analisadores Léxicos</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01a-lexico.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Alfabetos, Linguagens e Strings: Fundamentos Matemáticos</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-lexico.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Autômatos Finitos Determinísticos</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">Analisadores Sintáticos</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04-Gramaticas.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Gramáticas e Linguagens Livres de Contexto</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05-parsersLL1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Parsers LL(1): Começando a Análise Sintática</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06-first-follow.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Conjuntos FIRST e FOLLOW</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07-parserLR1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Parsers <span class="math inline">\(LR(1)\)</span>: Análise Sintática <em>bottom-up</em></span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08-parserSLR1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Parsers <span class="math inline">\(SLR(1)\)</span>: A Ponte Entre Simplicidade e Poder</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
 <span class="menu-text">Analisadores Semânticos</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10-semantico.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Analisadores Semânticos: a determinação do significado</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10a-semantico.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Fundamentos Matemáticos da Semântica</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10b-semantico.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Julgamento de Tipos em Linguagens Imperativas</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10c-semantico.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">O Sistema de Tipos Hindley-Milner</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./11-tabelaSimbolos.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Tabela de Símbolos em Compiladores Modernos</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
 <span class="menu-text">Geração de Código Intermediário</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./14-GeraInter.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Geração de Código Intermediário: A Linguagem Universal do Compilador</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./15-llvmIR.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Introdução à Representação Intermediária (IR) do LLVM com C++</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./16-peepOtimiza.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Otimizações Peephole: Algoritmos e Técnicas em Código Intermediário</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">
 <span class="menu-text">Projetos da Disciplina - 2025-2</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./fase1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Fase 1 - Projeto Prático</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./fase2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Fase 2 - Analisador Sintático <span class="math inline">\(LL(1)\)</span></span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./fase3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Fase 3 - Analisador Semântico</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./apend1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Apêndice 1: A Relação de Myhill-Nerode</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./sol-exercicios.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">Solução dos Exercícios</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./referencias.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Referências</span></a>
  </div>
</li>
    </ul>
    </div>
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Sumário</h2>
   
  <ul>
  <li><a href="#primeiros-passos-conceitos-e-estruturas-de-dados" id="toc-primeiros-passos-conceitos-e-estruturas-de-dados" class="nav-link active" data-scroll-target="#primeiros-passos-conceitos-e-estruturas-de-dados"><span class="header-section-number">17.1</span> Primeiros passos, conceitos e Estruturas de Dados</a>
  <ul class="collapse">
  <li><a href="#estrutura-básica-do-tac" id="toc-estrutura-básica-do-tac" class="nav-link" data-scroll-target="#estrutura-básica-do-tac"><span class="header-section-number">17.1.1</span> Estrutura Básica do TAC</a></li>
  <li><a href="#estruturas-de-dados-fundamentais" id="toc-estruturas-de-dados-fundamentais" class="nav-link" data-scroll-target="#estruturas-de-dados-fundamentais"><span class="header-section-number">17.1.2</span> Estruturas de Dados Fundamentais</a></li>
  </ul></li>
  <li><a href="#eliminação-de-código-morto-dead-code-elimination" id="toc-eliminação-de-código-morto-dead-code-elimination" class="nav-link" data-scroll-target="#eliminação-de-código-morto-dead-code-elimination"><span class="header-section-number">17.2</span> 1. Eliminação de Código Morto (<em>Dead Code Elimination</em>)</a>
  <ul class="collapse">
  <li><a href="#algoritmo" id="toc-algoritmo" class="nav-link" data-scroll-target="#algoritmo"><span class="header-section-number">17.2.1</span> Algoritmo</a></li>
  <li><a href="#exemplo-de-aplicação" id="toc-exemplo-de-aplicação" class="nav-link" data-scroll-target="#exemplo-de-aplicação"><span class="header-section-number">17.2.2</span> Exemplo de Aplicação</a></li>
  <li><a href="#complexidade" id="toc-complexidade" class="nav-link" data-scroll-target="#complexidade"><span class="header-section-number">17.2.3</span> Complexidade</a></li>
  </ul></li>
  <li><a href="#propagação-de-constantes-constant-propagation" id="toc-propagação-de-constantes-constant-propagation" class="nav-link" data-scroll-target="#propagação-de-constantes-constant-propagation"><span class="header-section-number">17.3</span> 2. Propagação de Constantes (<em>Constant Propagation</em>)</a>
  <ul class="collapse">
  <li><a href="#algoritmo-1" id="toc-algoritmo-1" class="nav-link" data-scroll-target="#algoritmo-1"><span class="header-section-number">17.3.1</span> Algoritmo</a></li>
  <li><a href="#exemplo-completo" id="toc-exemplo-completo" class="nav-link" data-scroll-target="#exemplo-completo"><span class="header-section-number">17.3.2</span> Exemplo Completo</a></li>
  <li><a href="#propagação-condicional" id="toc-propagação-condicional" class="nav-link" data-scroll-target="#propagação-condicional"><span class="header-section-number">17.3.3</span> Propagação Condicional</a></li>
  </ul></li>
  <li><a href="#simplificação-algébrica-algebraic-simplification" id="toc-simplificação-algébrica-algebraic-simplification" class="nav-link" data-scroll-target="#simplificação-algébrica-algebraic-simplification"><span class="header-section-number">17.4</span> 3. Simplificação Algébrica (<em>Algebraic Simplification</em>)</a>
  <ul class="collapse">
  <li><a href="#identidades-implementadas" id="toc-identidades-implementadas" class="nav-link" data-scroll-target="#identidades-implementadas"><span class="header-section-number">17.4.1</span> Identidades Implementadas</a></li>
  <li><a href="#algoritmo-2" id="toc-algoritmo-2" class="nav-link" data-scroll-target="#algoritmo-2"><span class="header-section-number">17.4.2</span> Algoritmo</a></li>
  <li><a href="#exemplo-com-múltiplas-identidades" id="toc-exemplo-com-múltiplas-identidades" class="nav-link" data-scroll-target="#exemplo-com-múltiplas-identidades"><span class="header-section-number">17.4.3</span> Exemplo com Múltiplas Identidades</a></li>
  </ul></li>
  <li><a href="#strength-reduction" id="toc-strength-reduction" class="nav-link" data-scroll-target="#strength-reduction"><span class="header-section-number">17.5</span> 4. Strength Reduction</a>
  <ul class="collapse">
  <li><a href="#hierarquia-de-custos" id="toc-hierarquia-de-custos" class="nav-link" data-scroll-target="#hierarquia-de-custos"><span class="header-section-number">17.5.1</span> Hierarquia de Custos</a></li>
  <li><a href="#algoritmo-3" id="toc-algoritmo-3" class="nav-link" data-scroll-target="#algoritmo-3"><span class="header-section-number">17.5.2</span> Algoritmo</a></li>
  <li><a href="#análise-de-economia" id="toc-análise-de-economia" class="nav-link" data-scroll-target="#análise-de-economia"><span class="header-section-number">17.5.3</span> Análise de Economia</a></li>
  <li><a href="#strength-reduction-em-loops" id="toc-strength-reduction-em-loops" class="nav-link" data-scroll-target="#strength-reduction-em-loops"><span class="header-section-number">17.5.4</span> Strength Reduction em Loops</a></li>
  <li><a href="#tabelas-de-strength-reduction-referência-completa" id="toc-tabelas-de-strength-reduction-referência-completa" class="nav-link" data-scroll-target="#tabelas-de-strength-reduction-referência-completa"><span class="header-section-number">17.5.5</span> Tabelas de Strength Reduction: Referência Completa</a></li>
  </ul></li>
  <li><a href="#referências-e-leituras-adicionais" id="toc-referências-e-leituras-adicionais" class="nav-link" data-scroll-target="#referências-e-leituras-adicionais"><span class="header-section-number">17.6</span> Referências e Leituras Adicionais</a>
  <ul class="collapse">
  <li><a href="#notas-de-implementação" id="toc-notas-de-implementação" class="nav-link" data-scroll-target="#notas-de-implementação"><span class="header-section-number">17.6.1</span> Notas de Implementação</a></li>
  </ul></li>
  <li><a href="#propagação-de-cópias-copy-propagation" id="toc-propagação-de-cópias-copy-propagation" class="nav-link" data-scroll-target="#propagação-de-cópias-copy-propagation"><span class="header-section-number">17.7</span> 5. Propagação de Cópias (Copy Propagation)</a>
  <ul class="collapse">
  <li><a href="#algoritmo-4" id="toc-algoritmo-4" class="nav-link" data-scroll-target="#algoritmo-4"><span class="header-section-number">17.7.1</span> Algoritmo</a></li>
  <li><a href="#interação-com-outras-otimizações" id="toc-interação-com-outras-otimizações" class="nav-link" data-scroll-target="#interação-com-outras-otimizações"><span class="header-section-number">17.7.2</span> Interação com Outras Otimizações</a></li>
  <li><a href="#análise-de-alias" id="toc-análise-de-alias" class="nav-link" data-scroll-target="#análise-de-alias"><span class="header-section-number">17.7.3</span> Análise de Alias</a></li>
  </ul></li>
  <li><a href="#eliminação-de-subexpressões-comuns-common-subexpression-elimination" id="toc-eliminação-de-subexpressões-comuns-common-subexpression-elimination" class="nav-link" data-scroll-target="#eliminação-de-subexpressões-comuns-common-subexpression-elimination"><span class="header-section-number">17.8</span> 6. Eliminação de Subexpressões Comuns (Common Subexpression Elimination)</a>
  <ul class="collapse">
  <li><a href="#algoritmo-local" id="toc-algoritmo-local" class="nav-link" data-scroll-target="#algoritmo-local"><span class="header-section-number">17.8.1</span> Algoritmo Local</a></li>
  <li><a href="#cse-global" id="toc-cse-global" class="nav-link" data-scroll-target="#cse-global"><span class="header-section-number">17.8.2</span> CSE Global</a></li>
  <li><a href="#exemplo-detalhado" id="toc-exemplo-detalhado" class="nav-link" data-scroll-target="#exemplo-detalhado"><span class="header-section-number">17.8.3</span> Exemplo Detalhado</a></li>
  </ul></li>
  <li><a href="#otimização-de-branches" id="toc-otimização-de-branches" class="nav-link" data-scroll-target="#otimização-de-branches"><span class="header-section-number">17.9</span> 7. Otimização de Branches</a>
  <ul class="collapse">
  <li><a href="#técnicas-implementadas" id="toc-técnicas-implementadas" class="nav-link" data-scroll-target="#técnicas-implementadas"><span class="header-section-number">17.9.1</span> Técnicas Implementadas</a></li>
  <li><a href="#algoritmo-5" id="toc-algoritmo-5" class="nav-link" data-scroll-target="#algoritmo-5"><span class="header-section-number">17.9.2</span> Algoritmo</a></li>
  <li><a href="#exemplo-complexo" id="toc-exemplo-complexo" class="nav-link" data-scroll-target="#exemplo-complexo"><span class="header-section-number">17.9.3</span> Exemplo Complexo</a></li>
  <li><a href="#branch-prediction-e-otimização" id="toc-branch-prediction-e-otimização" class="nav-link" data-scroll-target="#branch-prediction-e-otimização"><span class="header-section-number">17.9.4</span> Branch Prediction e Otimização</a></li>
  </ul></li>
  <li><a href="#eliminação-de-loadstore-redundantes" id="toc-eliminação-de-loadstore-redundantes" class="nav-link" data-scroll-target="#eliminação-de-loadstore-redundantes"><span class="header-section-number">17.10</span> 8. Eliminação de Load/Store Redundantes</a>
  <ul class="collapse">
  <li><a href="#padrões-detectados" id="toc-padrões-detectados" class="nav-link" data-scroll-target="#padrões-detectados"><span class="header-section-number">17.10.1</span> Padrões Detectados</a></li>
  <li><a href="#algoritmo-6" id="toc-algoritmo-6" class="nav-link" data-scroll-target="#algoritmo-6"><span class="header-section-number">17.10.2</span> Algoritmo</a></li>
  <li><a href="#exemplo-com-store-load" id="toc-exemplo-com-store-load" class="nav-link" data-scroll-target="#exemplo-com-store-load"><span class="header-section-number">17.10.3</span> Exemplo com Store-Load</a></li>
  </ul></li>
  <li><a href="#eliminação-de-código-inalcançável" id="toc-eliminação-de-código-inalcançável" class="nav-link" data-scroll-target="#eliminação-de-código-inalcançável"><span class="header-section-number">17.11</span> 9. Eliminação de Código Inalcançável</a>
  <ul class="collapse">
  <li><a href="#algoritmo-baseado-em-alcançabilidade" id="toc-algoritmo-baseado-em-alcançabilidade" class="nav-link" data-scroll-target="#algoritmo-baseado-em-alcançabilidade"><span class="header-section-number">17.11.1</span> Algoritmo Baseado em Alcançabilidade</a></li>
  <li><a href="#eliminação-de-código-após-return" id="toc-eliminação-de-código-após-return" class="nav-link" data-scroll-target="#eliminação-de-código-após-return"><span class="header-section-number">17.11.2</span> Eliminação de Código Após Return</a></li>
  <li><a href="#análise-de-condições-constantes" id="toc-análise-de-condições-constantes" class="nav-link" data-scroll-target="#análise-de-condições-constantes"><span class="header-section-number">17.11.3</span> Análise de Condições Constantes</a></li>
  <li><a href="#exemplo-completo-1" id="toc-exemplo-completo-1" class="nav-link" data-scroll-target="#exemplo-completo-1"><span class="header-section-number">17.11.4</span> Exemplo Completo</a></li>
  </ul></li>
  <li><a href="#integração-e-ordem-de-aplicação" id="toc-integração-e-ordem-de-aplicação" class="nav-link" data-scroll-target="#integração-e-ordem-de-aplicação"><span class="header-section-number">17.12</span> Integração e Ordem de Aplicação</a>
  <ul class="collapse">
  <li><a href="#pipeline-de-otimização" id="toc-pipeline-de-otimização" class="nav-link" data-scroll-target="#pipeline-de-otimização"><span class="header-section-number">17.12.1</span> Pipeline de Otimização</a></li>
  <li><a href="#métricas-de-otimização" id="toc-métricas-de-otimização" class="nav-link" data-scroll-target="#métricas-de-otimização"><span class="header-section-number">17.12.2</span> Métricas de Otimização</a></li>
  </ul></li>
  <li><a href="#considerações-de-implementação" id="toc-considerações-de-implementação" class="nav-link" data-scroll-target="#considerações-de-implementação"><span class="header-section-number">17.13</span> Considerações de Implementação</a>
  <ul class="collapse">
  <li><a href="#representação-eficiente" id="toc-representação-eficiente" class="nav-link" data-scroll-target="#representação-eficiente"><span class="header-section-number">17.13.1</span> Representação Eficiente</a></li>
  <li><a href="#tratamento-de-tipos" id="toc-tratamento-de-tipos" class="nav-link" data-scroll-target="#tratamento-de-tipos"><span class="header-section-number">17.13.2</span> Tratamento de Tipos</a></li>
  </ul></li>
  <li><a href="#exercícios" id="toc-exercícios" class="nav-link" data-scroll-target="#exercícios"><span class="header-section-number">17.14</span> Exercícios</a>
  <ul class="collapse">
  <li><a href="#exercício-1-otimização-completa" id="toc-exercício-1-otimização-completa" class="nav-link" data-scroll-target="#exercício-1-otimização-completa"><span class="header-section-number">17.14.1</span> Exercício 1: Otimização Completa</a></li>
  <li><a href="#exercício-2-strength-reduction-em-loop" id="toc-exercício-2-strength-reduction-em-loop" class="nav-link" data-scroll-target="#exercício-2-strength-reduction-em-loop"><span class="header-section-number">17.14.2</span> Exercício 2: Strength Reduction em Loop</a></li>
  <li><a href="#exercício-3-cse-e-dead-code" id="toc-exercício-3-cse-e-dead-code" class="nav-link" data-scroll-target="#exercício-3-cse-e-dead-code"><span class="header-section-number">17.14.3</span> Exercício 3: CSE e Dead Code</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/frankalcantara/linguagens-formais/edit/main/16-peepOtimiza.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/frankalcantara/linguagens-formais/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./14-GeraInter.html">Geração de Código Intermediário</a></li><li class="breadcrumb-item"><a href="./16-peepOtimiza.html"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Otimizações Peephole: Algoritmos e Técnicas em Código Intermediário</span></a></li></ol></nav>
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Otimizações Peephole: Algoritmos e Técnicas em Código Intermediário</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>As otimizações <em>peephole</em> são técnicas de otimização local que operam sobre uma pequena janela deslizante de instruções adjacentes no código intermediário. O termo “peephole” (buraco de fechadura) reflete a natureza dessas otimizações: elas “espiam” através de uma pequena abertura no código, identificando padrões específicos que podem ser melhorados. Diferentemente de otimizações globais, que exigem análise de fluxo de dados em todo o programa, as otimizações <em>peephole</em> são rápidas, simples de implementar e podem ser aplicadas repetidamente até convergência.</p>
<p>A eficácia das otimizações <em>peephole</em> reside em sua capacidade de eliminar ineficiências introduzidas durante a geração de código intermediário. Compiladores frequentemente geram código conservador e redundante para manter a correção e simplicidade do gerador de código. As otimizações <em>peephole</em> atuam como um pós-processador, refinando esse código através de transformações locais baseadas em padrões.</p>
<section id="primeiros-passos-conceitos-e-estruturas-de-dados" class="level2" data-number="17.1">
<h2 data-number="17.1" class="anchored" data-anchor-id="primeiros-passos-conceitos-e-estruturas-de-dados"><span class="header-section-number">17.1</span> Primeiros passos, conceitos e Estruturas de Dados</h2>
<p>Antes de explorarmos as técnicas específicas, é fundamental que a esforçada leitora relembre o básico da representação de código sobre a qual essas otimizações operam. O <strong>Three Address Code</strong> (TAC) é uma representação intermediária que se aproxima da linguagem de máquina mantendo independência de arquitetura. Cada instrução TAC tem no máximo três endereços, operandos, e realiza uma única operação elementar.</p>
<section id="estrutura-básica-do-tac" class="level3" data-number="17.1.1">
<h3 data-number="17.1.1" class="anchored" data-anchor-id="estrutura-básica-do-tac"><span class="header-section-number">17.1.1</span> Estrutura Básica do TAC</h3>
<p>Uma instrução TAC típica segue a forma:</p>
<pre class="shell"><code>resultado = operando1 operador operando2</code></pre>
<p>Exemplos de instruções TAC:</p>
<pre class="shell"><code>t1 = a + b        # Adição
t2 = t1 * c       # Multiplicação
x = t2            # Atribuição
if x &gt; 0 goto L1   # Branch condicional
goto L2           # Branch incondicional</code></pre>
<p>As variáveis temporárias (<span class="math inline">\(t1\)</span>, <span class="math inline">\(t2\)</span>, …) são criadas conforme necessário para armazenar resultados intermediários. Esta linearização de expressões complexas facilita tanto a análise quanto a transformação do código.</p>
</section>
<section id="estruturas-de-dados-fundamentais" class="level3" data-number="17.1.2">
<h3 data-number="17.1.2" class="anchored" data-anchor-id="estruturas-de-dados-fundamentais"><span class="header-section-number">17.1.2</span> Estruturas de Dados Fundamentais</h3>
<p>A implementação eficiente de otimizações <em>peephole</em> requer estruturas de dados apropriadas para representar e manipular o código intermediário.</p>
<section id="representação-de-instruções" class="level4" data-number="17.1.2.1">
<h4 data-number="17.1.2.1" class="anchored" data-anchor-id="representação-de-instruções"><span class="header-section-number">17.1.2.1</span> Representação de Instruções</h4>
<p>Considere o exemplo a seguir, que define uma classe simples para representar instruções TAC:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Instruction:</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, op, dest<span class="op">=</span><span class="va">None</span>, arg1<span class="op">=</span><span class="va">None</span>, arg2<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.op <span class="op">=</span> op        <span class="co"># Operador ('+', '-', '*', '/', 'ASSIGN', etc.)</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dest <span class="op">=</span> dest    <span class="co"># Variável destino</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.arg1 <span class="op">=</span> arg1    <span class="co"># Primeiro operando</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.arg2 <span class="op">=</span> arg2    <span class="co"># Segundo operando</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__str__</span>(<span class="va">self</span>):</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.op <span class="kw">in</span> [<span class="st">'+'</span>, <span class="st">'-'</span>, <span class="st">'*'</span>, <span class="st">'/'</span>, <span class="st">'&lt;&lt;'</span>, <span class="st">'&gt;&gt;'</span>, <span class="st">'**'</span>]:</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="ss">f"</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>dest<span class="sc">}</span><span class="ss"> = </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>arg1<span class="sc">}</span><span class="ss"> </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>op<span class="sc">}</span><span class="ss"> </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>arg2<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> <span class="va">self</span>.op <span class="op">==</span> <span class="st">'ASSIGN'</span>:</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="ss">f"</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>dest<span class="sc">}</span><span class="ss"> = </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>arg1<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> <span class="va">self</span>.op <span class="op">==</span> <span class="st">'GOTO'</span>:</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="ss">f"goto </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>dest<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> <span class="va">self</span>.op <span class="kw">in</span> [<span class="st">'IF_GT'</span>, <span class="st">'IF_LT'</span>, <span class="st">'IF_EQ'</span>]:</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="ss">f"if </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>arg1<span class="sc">}</span><span class="ss"> </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>op<span class="sc">}</span><span class="ss"> </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>arg2<span class="sc">}</span><span class="ss"> goto </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>dest<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> <span class="va">self</span>.op <span class="op">==</span> <span class="st">'LABEL'</span>:</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="ss">f"</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>dest<span class="sc">}</span><span class="ss">:"</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> <span class="va">self</span>.op <span class="op">==</span> <span class="st">'LOAD'</span>:</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="ss">f"</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>dest<span class="sc">}</span><span class="ss"> = load </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>arg1<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> <span class="va">self</span>.op <span class="op">==</span> <span class="st">'STORE'</span>:</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="ss">f"store </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>arg1<span class="sc">}</span><span class="ss">, </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>arg2<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="ss">f"</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>op<span class="sc">}</span><span class="ss"> </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>dest<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__eq__</span>(<span class="va">self</span>, other):</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Necessário para verificação de convergência."""</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="bu">isinstance</span>(other, Instruction):</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.op <span class="op">==</span> other.op <span class="kw">and</span> <span class="op">\</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>               <span class="va">self</span>.dest <span class="op">==</span> other.dest <span class="kw">and</span> <span class="op">\</span></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>               <span class="va">self</span>.arg1 <span class="op">==</span> other.arg1 <span class="kw">and</span> <span class="op">\</span></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>               <span class="va">self</span>.arg2 <span class="op">==</span> other.arg2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="tabela-de-definições" class="level4" data-number="17.1.2.2">
<h4 data-number="17.1.2.2" class="anchored" data-anchor-id="tabela-de-definições"><span class="header-section-number">17.1.2.2</span> Tabela de Definições</h4>
<p>Para rastrear em que ponto do código variáveis são definidas, podemos utilizar uma estrutura que mapeie cada variável à instrução que a define:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>definitions <span class="op">=</span> {}  <span class="co"># variável -&gt; instrução que a define</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>uses <span class="op">=</span> {}         <span class="co"># variável -&gt; conjunto de instruções que a usam</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
</section>
<section id="eliminação-de-código-morto-dead-code-elimination" class="level2" data-number="17.2">
<h2 data-number="17.2" class="anchored" data-anchor-id="eliminação-de-código-morto-dead-code-elimination"><span class="header-section-number">17.2</span> 1. Eliminação de Código Morto (<em>Dead Code Elimination</em>)</h2>
<p>A eliminação de código morto remove instruções cujos resultados nunca são utilizados. Esta otimização é fundamental, pois código não utilizado consome recursos de compilação, aumenta o tamanho do executável e pode mascarar outras oportunidades de otimização.</p>
<section id="algoritmo" class="level3" data-number="17.2.1">
<h3 data-number="17.2.1" class="anchored" data-anchor-id="algoritmo"><span class="header-section-number">17.2.1</span> Algoritmo</h3>
<p>O algoritmo opera em duas fases: marcação (<em>mark</em>) e remoção (<em>sweep</em>), inspirado em algoritmos de coleta de lixo.</p>
<p><strong>Fase 1: Construção das Cadeias de Uso-Definição (<em>Use-Def Chains</em>)</strong></p>
<div class="sourceCode" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> build_use_def_chains(instructions):</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Constrói cadeias de uso-definição para todas as variáveis.</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="co">        instructions: Lista de instruções TAC</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="co">        definitions: Dicionário {variável: instrução que define}</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="co">        uses: Dicionário {variável: conjunto de instruções que usam}</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    definitions <span class="op">=</span> {}</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    uses <span class="op">=</span> {}</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># assumes is_variable() é uma função auxiliar</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> is_variable(val):</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">isinstance</span>(val, <span class="bu">str</span>) <span class="kw">and</span> (val[<span class="dv">0</span>].isalpha() <span class="kw">or</span> val[<span class="dv">0</span>] <span class="op">==</span> <span class="st">'t'</span>)</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> instr <span class="kw">in</span> instructions:</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Registrar definição</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Assumindo que 'dest' em GOTO/IF é um label, não uma variável</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> instr.dest <span class="kw">and</span> instr.op <span class="kw">not</span> <span class="kw">in</span> [<span class="st">'GOTO'</span>, <span class="st">'IF_GT'</span>, <span class="st">'IF_LT'</span>, <span class="st">'IF_EQ'</span>, <span class="st">'LABEL'</span>]:</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>            definitions[instr.dest] <span class="op">=</span> instr</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Registrar usos</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> var <span class="kw">in</span> [instr.arg1, instr.arg2]:</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> var <span class="kw">and</span> is_variable(var):</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> var <span class="kw">not</span> <span class="kw">in</span> uses:</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>                    uses[var] <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>                uses[var].add(instr)</span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Casos especiais de uso (e.g., branch condicional, store)</span></span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> instr.op <span class="kw">in</span> [<span class="st">'IF_GT'</span>, <span class="st">'IF_LT'</span>, <span class="st">'IF_EQ'</span>, <span class="st">'STORE'</span>, <span class="st">'RETURN'</span>]:</span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>             <span class="cf">if</span> instr.arg1 <span class="kw">and</span> is_variable(instr.arg1):</span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> instr.arg1 <span class="kw">not</span> <span class="kw">in</span> uses: uses[instr.arg1] <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>                uses[instr.arg1].add(instr)</span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>             <span class="cf">if</span> instr.arg2 <span class="kw">and</span> is_variable(instr.arg2):</span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> instr.arg2 <span class="kw">not</span> <span class="kw">in</span> uses: uses[instr.arg2] <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>                uses[instr.arg2].add(instr)</span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> definitions, uses</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Fase 2: Marcação de Código Vivo</strong></p>
<div class="sourceCode" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mark_live_code(instructions, definitions, uses):</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Marca instruções que são essenciais (live).</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Uma instrução é essencial se:</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="co">    1. Tem efeito colateral (I/O, chamada de função, store)</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="co">    2. Define uma variável usada por instrução essencial</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="co">    3. É uma instrução de controle (branch, return)</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    live <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    worklist <span class="op">=</span> []</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Inicializar com instruções essenciais</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> instr <span class="kw">in</span> instructions:</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> is_essential(instr):</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>            live.add(instr)</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>            worklist.append(instr)</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Propagar marcação</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> worklist:</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>        instr <span class="op">=</span> worklist.pop()</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Marcar instruções que definem operandos usados</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>        operands <span class="op">=</span> [instr.arg1, instr.arg2]</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> instr.op <span class="kw">in</span> [<span class="st">'STORE'</span>]: <span class="co"># store val, addr -&gt; val é arg1, addr é arg2</span></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>            operands <span class="op">=</span> [instr.arg1, instr.arg2]</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> instr.op <span class="kw">in</span> [<span class="st">'IF_GT'</span>, <span class="st">'IF_LT'</span>, <span class="st">'IF_EQ'</span>]: <span class="co"># if arg1 op arg2</span></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>            operands <span class="op">=</span> [instr.arg1, instr.arg2]</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> instr.op <span class="op">==</span> <span class="st">'RETURN'</span>: <span class="co"># return arg1</span></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>            operands <span class="op">=</span> [instr.arg1]</span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> var <span class="kw">in</span> operands:</span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> var <span class="kw">in</span> definitions:</span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>                def_instr <span class="op">=</span> definitions[var]</span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> def_instr <span class="kw">not</span> <span class="kw">in</span> live:</span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>                    live.add(def_instr)</span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>                    worklist.append(def_instr)</span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> live</span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> is_essential(instr):</span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Verifica se instrução tem efeito colateral ou é crítica."""</span></span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a>    <span class="co"># STORE é essencial (efeito colateral na memória)</span></span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> instr.op <span class="kw">in</span> [<span class="st">'RETURN'</span>, <span class="st">'CALL'</span>, <span class="st">'PRINT'</span>, <span class="st">'GOTO'</span>, </span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'IF_GT'</span>, <span class="st">'IF_LT'</span>, <span class="st">'IF_EQ'</span>, <span class="st">'STORE'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Fase 3: Remoção</strong></p>
<div class="sourceCode" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> eliminate_dead_code(instructions):</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Remove instruções mortas."""</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    definitions, uses <span class="op">=</span> build_use_def_chains(instructions)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    live <span class="op">=</span> mark_live_code(instructions, definitions, uses)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [instr <span class="cf">for</span> instr <span class="kw">in</span> instructions <span class="cf">if</span> instr <span class="kw">in</span> live]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="exemplo-de-aplicação" class="level3" data-number="17.2.2">
<h3 data-number="17.2.2" class="anchored" data-anchor-id="exemplo-de-aplicação"><span class="header-section-number">17.2.2</span> Exemplo de Aplicação</h3>
<p><strong>Antes</strong>:</p>
<pre class="shell"><code>t1 = a + b
t2 = c * d    # Código morto - t2 nunca usado
t3 = t1 + 5
x = t3
RETURN x      # Essencial (assumindo x é o retorno)</code></pre>
<p><strong>Depois</strong>: (O algoritmo marcaria <code>RETURN x</code> como essencial, depois <code>x = t3</code>, <code>t3 = t1 + 5</code>, <code>t1 = a + b</code>. <code>t2</code> não seria marcado).</p>
<pre class="shell"><code>t1 = a + b
t3 = t1 + 5
x = t3
RETURN x</code></pre>
</section>
<section id="complexidade" class="level3" data-number="17.2.3">
<h3 data-number="17.2.3" class="anchored" data-anchor-id="complexidade"><span class="header-section-number">17.2.3</span> Complexidade</h3>
<ul>
<li><strong>Tempo</strong>: <span class="math inline">\(O(n + e)\)</span>, onde <span class="math inline">\(n\)</span> é o número de instruções e <span class="math inline">\(e\)</span> o número de usos (visitas no grafo).</li>
<li><strong>Espaço</strong>: <span class="math inline">\(O(n)\)</span> para as estruturas de dados.</li>
</ul>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Iteração Múltipla</strong></p>
<p>A eliminação de código morto pode revelar novo código morto. Por exemplo, se <code>t2 = c * d</code> for removido e <code>c</code> e <code>d</code> não forem usados em outros lugares, as instruções que os definem também tornam-se mortas. Por isso, essa otimização frequentemente é aplicada iterativamente.</p>
</div>
</div>
</section>
</section>
<section id="propagação-de-constantes-constant-propagation" class="level2" data-number="17.3">
<h2 data-number="17.3" class="anchored" data-anchor-id="propagação-de-constantes-constant-propagation"><span class="header-section-number">17.3</span> 2. Propagação de Constantes (<em>Constant Propagation</em>)</h2>
<p>A propagação de constantes substitui usos de variáveis por seus valores constantes conhecidos, permitindo avaliação em tempo de compilação (constant folding).</p>
<section id="algoritmo-1" class="level3" data-number="17.3.1">
<h3 data-number="17.3.1" class="anchored" data-anchor-id="algoritmo-1"><span class="header-section-number">17.3.1</span> Algoritmo</h3>
<div class="sourceCode" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> is_constant(value):</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Verifica se valor é constante numérica."""</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">isinstance</span>(value, (<span class="bu">int</span>, <span class="bu">float</span>))</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> evaluate(val1, op, val2):</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Avalia expressão constante."""</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> is_constant(val1) <span class="kw">or</span> <span class="kw">not</span> is_constant(val2):</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> op <span class="op">==</span> <span class="st">'+'</span>: <span class="cf">return</span> val1 <span class="op">+</span> val2</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> op <span class="op">==</span> <span class="st">'-'</span>: <span class="cf">return</span> val1 <span class="op">-</span> val2</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> op <span class="op">==</span> <span class="st">'*'</span>: <span class="cf">return</span> val1 <span class="op">*</span> val2</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> op <span class="op">==</span> <span class="st">'/'</span>: <span class="cf">return</span> val1 <span class="op">/</span> val2 <span class="co"># Cuidado com divisão por zero</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span>:</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> constant_propagation(instructions):</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a><span class="co">    Propaga valores constantes e realiza constant folding </span></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a><span class="co">    (em um único bloco básico).</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a><span class="co">        instructions: Lista de instruções TAC</span></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a><span class="co">        Lista otimizada de instruções</span></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>    constants <span class="op">=</span> {}  <span class="co"># Mapa de variável -&gt; valor constante</span></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> []</span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> instr <span class="kw">in</span> instructions:</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Substituir operandos por constantes conhecidas</span></span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>        arg1 <span class="op">=</span> constants.get(instr.arg1, instr.arg1)</span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>        arg2 <span class="op">=</span> constants.get(instr.arg2, instr.arg2)</span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Constant folding se ambos operandos são constantes</span></span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> instr.op <span class="kw">in</span> [<span class="st">'+'</span>, <span class="st">'-'</span>, <span class="st">'*'</span>, <span class="st">'/'</span>]:</span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>            value <span class="op">=</span> evaluate(arg1, instr.op, arg2)</span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> value <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Dobramos para uma constante</span></span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>                constants[instr.dest] <span class="op">=</span> value</span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>                result.append(Instruction(<span class="st">'ASSIGN'</span>, instr.dest, value))</span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Não é constante, invalidar destino</span></span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a>                constants.pop(instr.dest, <span class="va">None</span>)</span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a>                result.append(Instruction(instr.op, instr.dest, arg1, arg2))</span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Atribuição de constante</span></span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> instr.op <span class="op">==</span> <span class="st">'ASSIGN'</span>:</span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> is_constant(arg1):</span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a>                constants[instr.dest] <span class="op">=</span> arg1</span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb10-54"><a href="#cb10-54" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Atribuição de variável (e.g., x = y)</span></span>
<span id="cb10-55"><a href="#cb10-55" aria-hidden="true" tabindex="-1"></a>                constants.pop(instr.dest, <span class="va">None</span>)</span>
<span id="cb10-56"><a href="#cb10-56" aria-hidden="true" tabindex="-1"></a>            result.append(Instruction(<span class="st">'ASSIGN'</span>, instr.dest, arg1))</span>
<span id="cb10-57"><a href="#cb10-57" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-58"><a href="#cb10-58" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Outras instruções (LOAD, CALL) invalidam destino</span></span>
<span id="cb10-59"><a href="#cb10-59" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> instr.dest:</span>
<span id="cb10-60"><a href="#cb10-60" aria-hidden="true" tabindex="-1"></a>             constants.pop(instr.dest, <span class="va">None</span>)</span>
<span id="cb10-61"><a href="#cb10-61" aria-hidden="true" tabindex="-1"></a>             result.append(Instruction(instr.op, instr.dest, arg1, arg2))</span>
<span id="cb10-62"><a href="#cb10-62" aria-hidden="true" tabindex="-1"></a>             </span>
<span id="cb10-63"><a href="#cb10-63" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb10-64"><a href="#cb10-64" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Instruções sem destino (GOTO, IF, STORE)</span></span>
<span id="cb10-65"><a href="#cb10-65" aria-hidden="true" tabindex="-1"></a>            result.append(Instruction(instr.op, instr.dest, arg1, arg2))</span>
<span id="cb10-66"><a href="#cb10-66" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-67"><a href="#cb10-67" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="exemplo-completo" class="level3" data-number="17.3.2">
<h3 data-number="17.3.2" class="anchored" data-anchor-id="exemplo-completo"><span class="header-section-number">17.3.2</span> Exemplo Completo</h3>
<p><strong>Entrada</strong>:</p>
<pre class="shell"><code>x = 10
y = x + 5
z = y * 2
w = z + x</code></pre>
<p><strong>Trace da Execução</strong>:</p>
<table class="table">
<thead>
<tr class="header">
<th>Instrução</th>
<th><code>constants</code> após</th>
<th>Instrução gerada</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>x = 10</td>
<td>{x: 10}</td>
<td>x = 10</td>
</tr>
<tr class="even">
<td>y = x + 5</td>
<td>{x: 10, y: 15}</td>
<td>y = 15</td>
</tr>
<tr class="odd">
<td>z = y * 2</td>
<td>{x: 10, y: 15, z: 30}</td>
<td>z = 30</td>
</tr>
<tr class="even">
<td>w = z + x</td>
<td>{x: 10, y: 15, z: 30, w: 40}</td>
<td>w = 40</td>
</tr>
</tbody>
</table>
<p><strong>Saída</strong>:</p>
<pre class="shell"><code>x = 10
y = 15
z = 30
w = 40</code></pre>
</section>
<section id="propagação-condicional" class="level3" data-number="17.3.3">
<h3 data-number="17.3.3" class="anchored" data-anchor-id="propagação-condicional"><span class="header-section-number">17.3.3</span> Propagação Condicional</h3>
<p>Em programas com controle de fluxo, a propagação de constantes torna-se mais complexa, exigindo análise de fluxo de dados (<em>dataflow analysis</em>) e um algoritmo de ponto fixo sobre o Grafo de Fluxo de Controle (CFG).</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> conditional_constant_propagation(cfg):</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Propagação de constantes sensível ao fluxo de controle (conceitual).</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Usa algoritmo de ponto fixo sobre o grafo de fluxo de controle.</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Para cada bloco básico, manter mapa de constantes (IN e OUT)</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    constants_in <span class="op">=</span> {block: {} <span class="cf">for</span> block <span class="kw">in</span> cfg.blocks}</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    constants_out <span class="op">=</span> {block: {} <span class="cf">for</span> block <span class="kw">in</span> cfg.blocks}</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    worklist <span class="op">=</span> <span class="bu">list</span>(cfg.blocks)</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> worklist:</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>        block <span class="op">=</span> worklist.pop()</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Mergear constantes dos predecessores</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> block.predecessors:</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>            new_in <span class="op">=</span> merge_constants([constants_out[p] <span class="cf">for</span> p <span class="kw">in</span> block.predecessors])</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>            new_in <span class="op">=</span> {} <span class="co"># Bloco de entrada</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>        constants_in[block] <span class="op">=</span> new_in</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Propagar constantes dentro do bloco</span></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>        new_out <span class="op">=</span> propagate_in_block(block.instructions, new_in.copy())</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Se constantes mudaram, adicionar sucessores à worklist</span></span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> new_out <span class="op">!=</span> constants_out[block]:</span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>            constants_out[block] <span class="op">=</span> new_out</span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>            worklist.extend(block.successors)</span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Após convergência, reescrever o código (não mostrado)</span></span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> constants_in, constants_out</span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> merge_constants(maps):</span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a><span class="co">    Merge de mapas de constantes. </span></span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a><span class="co">    Uma variável só é constante se tiver o *mesmo* valor constante</span></span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a><span class="co">    em *todos* os caminhos.</span></span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> maps: <span class="cf">return</span> {}</span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a>    merged <span class="op">=</span> maps[<span class="dv">0</span>].copy()</span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> var <span class="kw">in</span> <span class="bu">list</span>(merged.keys()):</span>
<span id="cb13-43"><a href="#cb13-43" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> other_map <span class="kw">in</span> maps[<span class="dv">1</span>:]:</span>
<span id="cb13-44"><a href="#cb13-44" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> var <span class="kw">not</span> <span class="kw">in</span> other_map <span class="kw">or</span> other_map[var] <span class="op">!=</span> merged[var]:</span>
<span id="cb13-45"><a href="#cb13-45" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Conflito ou valor não disponível</span></span>
<span id="cb13-46"><a href="#cb13-46" aria-hidden="true" tabindex="-1"></a>                merged.pop(var)</span>
<span id="cb13-47"><a href="#cb13-47" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb13-48"><a href="#cb13-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> merged</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="simplificação-algébrica-algebraic-simplification" class="level2" data-number="17.4">
<h2 data-number="17.4" class="anchored" data-anchor-id="simplificação-algébrica-algebraic-simplification"><span class="header-section-number">17.4</span> 3. Simplificação Algébrica (<em>Algebraic Simplification</em>)</h2>
<p>Aplica identidades matemáticas para simplificar expressões, eliminando operações redundantes.</p>
<section id="identidades-implementadas" class="level3" data-number="17.4.1">
<h3 data-number="17.4.1" class="anchored" data-anchor-id="identidades-implementadas"><span class="header-section-number">17.4.1</span> Identidades Implementadas</h3>
<table class="table">
<thead>
<tr class="header">
<th>Padrão</th>
<th>Simplificação</th>
<th>Justificativa</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>x + 0</code></td>
<td><code>x</code></td>
<td>Elemento neutro da adição</td>
</tr>
<tr class="even">
<td><code>x - 0</code></td>
<td><code>x</code></td>
<td>Subtração de zero</td>
</tr>
<tr class="odd">
<td><code>x * 1</code></td>
<td><code>x</code></td>
<td>Elemento neutro da multiplicação</td>
</tr>
<tr class="even">
<td><code>x / 1</code></td>
<td><code>x</code></td>
<td>Divisão por um</td>
</tr>
<tr class="odd">
<td><code>x * 0</code></td>
<td><code>0</code></td>
<td>Propriedade do zero</td>
</tr>
<tr class="even">
<td><code>x - x</code></td>
<td><code>0</code></td>
<td>Diferença nula</td>
</tr>
<tr class="odd">
<td><code>x / x</code></td>
<td><code>1</code></td>
<td>Quociente unitário (<span class="math inline">\(x \neq 0\)</span>)</td>
</tr>
</tbody>
</table>
</section>
<section id="algoritmo-2" class="level3" data-number="17.4.2">
<h3 data-number="17.4.2" class="anchored" data-anchor-id="algoritmo-2"><span class="header-section-number">17.4.2</span> Algoritmo</h3>
<div class="sourceCode" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> algebraic_simplification(instructions):</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Aplica identidades algébricas para simplificar expressões.</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="co">        Lista otimizada de instruções</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> []</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> instr <span class="kw">in</span> instructions:</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>        simplified <span class="op">=</span> apply_identities(instr)</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>        result.append(simplified)</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> apply_identities(instr):</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Aplica identidades algébricas a uma instrução."""</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> instr.op <span class="kw">not</span> <span class="kw">in</span> [<span class="st">'+'</span>, <span class="st">'-'</span>, <span class="st">'*'</span>, <span class="st">'/'</span>]:</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> instr</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>    arg1, arg2 <span class="op">=</span> instr.arg1, instr.arg2</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># x + 0 = x ou 0 + x = x</span></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> instr.op <span class="op">==</span> <span class="st">'+'</span>:</span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> arg2 <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> Instruction(<span class="st">'ASSIGN'</span>, instr.dest, arg1)</span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> arg1 <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> Instruction(<span class="st">'ASSIGN'</span>, instr.dest, arg2)</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># x - 0 = x</span></span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> instr.op <span class="op">==</span> <span class="st">'-'</span>:</span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> arg2 <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> Instruction(<span class="st">'ASSIGN'</span>, instr.dest, arg1)</span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>        <span class="co"># x - x = 0</span></span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> arg1 <span class="op">==</span> arg2:</span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> Instruction(<span class="st">'ASSIGN'</span>, instr.dest, <span class="dv">0</span>)</span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># x * 1 = x ou 1 * x = x</span></span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> instr.op <span class="op">==</span> <span class="st">'*'</span>:</span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> arg2 <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> Instruction(<span class="st">'ASSIGN'</span>, instr.dest, arg1)</span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> arg1 <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> Instruction(<span class="st">'ASSIGN'</span>, instr.dest, arg2)</span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a>        <span class="co"># x * 0 = 0 ou 0 * x = 0</span></span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> arg2 <span class="op">==</span> <span class="dv">0</span> <span class="kw">or</span> arg1 <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> Instruction(<span class="st">'ASSIGN'</span>, instr.dest, <span class="dv">0</span>)</span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a>    <span class="co"># x / 1 = x</span></span>
<span id="cb14-49"><a href="#cb14-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> instr.op <span class="op">==</span> <span class="st">'/'</span>:</span>
<span id="cb14-50"><a href="#cb14-50" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> arg2 <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb14-51"><a href="#cb14-51" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> Instruction(<span class="st">'ASSIGN'</span>, instr.dest, arg1)</span>
<span id="cb14-52"><a href="#cb14-52" aria-hidden="true" tabindex="-1"></a>        <span class="co"># x / x = 1 (assumindo x != 0)</span></span>
<span id="cb14-53"><a href="#cb14-53" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> arg1 <span class="op">==</span> arg2 <span class="kw">and</span> arg1 <span class="op">!=</span> <span class="dv">0</span>: <span class="co"># Adiciona verificação simples</span></span>
<span id="cb14-54"><a href="#cb14-54" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> Instruction(<span class="st">'ASSIGN'</span>, instr.dest, <span class="dv">1</span>)</span>
<span id="cb14-55"><a href="#cb14-55" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-56"><a href="#cb14-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> instr</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="exemplo-com-múltiplas-identidades" class="level3" data-number="17.4.3">
<h3 data-number="17.4.3" class="anchored" data-anchor-id="exemplo-com-múltiplas-identidades"><span class="header-section-number">17.4.3</span> Exemplo com Múltiplas Identidades</h3>
<p><strong>Entrada</strong>:</p>
<pre class="shell"><code>t1 = x * 1
t2 = y + 0
t3 = z - 0
t4 = t1 + t2</code></pre>
<p><strong>Simplificação Passo a Passo</strong>:</p>
<ol type="1">
<li><code>t1 = x * 1</code> <span class="math inline">\(\rightarrow\)</span> <code>t1 = x</code> (identidade multiplicativa)</li>
<li><code>t2 = y + 0</code> <span class="math inline">\(\rightarrow\)</span> <code>t2 = y</code> (identidade aditiva)</li>
<li><code>t3 = z - 0</code> <span class="math inline">\(\rightarrow\)</span> <code>t3 = z</code> (subtração de zero)</li>
<li><code>t4 = t1 + t2</code> (Esta etapa requer copy propagation para se tornar <code>t4 = x + y</code>)</li>
</ol>
<p><strong>Saída (Apenas Simplificação Algébrica)</strong>:</p>
<pre class="shell"><code>t1 = x
t2 = y
t3 = z
t4 = t1 + t2</code></pre>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Cuidado com Overflow e Precisão</strong></p>
<p>Algumas simplificações podem alterar o comportamento em casos extremos:</p>
<ul>
<li><code>x - x</code> pode não ser zero se <code>x</code> é NaN em ponto flutuante;</li>
<li><code>x / x</code> é indefinido quando <code>x = 0</code>;</li>
<li>Operações com infinito requerem tratamento especial.</li>
</ul>
<p>Compiladores devem considerar flags como <code>-ffast-math</code> que permitem otimizações algebricamente corretas, mas numericamente potencialmente imprecisas.</p>
</div>
</div>
</section>
</section>
<section id="strength-reduction" class="level2" data-number="17.5">
<h2 data-number="17.5" class="anchored" data-anchor-id="strength-reduction"><span class="header-section-number">17.5</span> 4. Strength Reduction</h2>
<p>Substitui operações custosas por equivalentes mais eficientes. O nome vem da ideia de reduzir a “força” (complexidade/custo) da operação.</p>
<section id="hierarquia-de-custos" class="level3" data-number="17.5.1">
<h3 data-number="17.5.1" class="anchored" data-anchor-id="hierarquia-de-custos"><span class="header-section-number">17.5.1</span> Hierarquia de Custos</h3>
<p>Em arquiteturas típicas, as operações têm custos relativos:</p>
<table class="table">
<thead>
<tr class="header">
<th>Operação</th>
<th>Custo Relativo</th>
<th>Ciclos (típico)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Shift</td>
<td>1x</td>
<td>1</td>
</tr>
<tr class="even">
<td>Adição</td>
<td>1x</td>
<td>1</td>
</tr>
<tr class="odd">
<td>Multiplicação</td>
<td>3-5x</td>
<td>3-5</td>
</tr>
<tr class="even">
<td>Divisão</td>
<td>10-40x</td>
<td>10-40</td>
</tr>
<tr class="odd">
<td>Exponenciação</td>
<td>100+x</td>
<td>100+</td>
</tr>
</tbody>
</table>
</section>
<section id="algoritmo-3" class="level3" data-number="17.5.2">
<h3 data-number="17.5.2" class="anchored" data-anchor-id="algoritmo-3"><span class="header-section-number">17.5.2</span> Algoritmo</h3>
<div class="sourceCode" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> strength_reduction(instructions):</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Substitui operações custosas por equivalentes mais eficientes.</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Transformações principais:</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="co">    - x * 2^n → x &lt;&lt; n</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="co">    - x / 2^n → x &gt;&gt; n  (para inteiros positivos)</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="co">    - x ** 2 → x * x</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> []</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> instr <span class="kw">in</span> instructions:</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>        reduced <span class="op">=</span> reduce_strength(instr)</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>        result.append(reduced)</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> is_power_of_2(n):</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Verifica se n é potência de 2."""</span></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">isinstance</span>(n, <span class="bu">int</span>) <span class="kw">and</span> n <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">and</span> (n <span class="op">&amp;</span> (n <span class="op">-</span> <span class="dv">1</span>)) <span class="op">==</span> <span class="dv">0</span></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> log2(n):</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Calcula log₂(n) para potências de 2."""</span></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Correção: n.bit_length() - 1</span></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ex: n=2 (10b), bit_length=2, log2=1</span></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ex: n=4 (100b), bit_length=3, log2=2</span></span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ex: n=8 (1000b), bit_length=4, log2=3</span></span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> is_power_of_2(n):</span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span> <span class="co"># Ou levantar erro</span></span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> n.bit_length() <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> reduce_strength(instr):</span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Aplica strength reduction a uma instrução."""</span></span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> instr.op <span class="kw">not</span> <span class="kw">in</span> [<span class="st">'*'</span>, <span class="st">'/'</span>, <span class="st">'**'</span>]:</span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> instr</span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a>    arg1, arg2 <span class="op">=</span> instr.arg1, instr.arg2</span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Multiplicação por potência de 2</span></span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> instr.op <span class="op">==</span> <span class="st">'*'</span> <span class="kw">and</span> is_power_of_2(arg2):</span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a>        shift <span class="op">=</span> log2(arg2)</span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> Instruction(<span class="st">'&lt;&lt;'</span>, instr.dest, arg1, shift)</span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> instr.op <span class="op">==</span> <span class="st">'*'</span> <span class="kw">and</span> is_power_of_2(arg1):</span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a>        shift <span class="op">=</span> log2(arg1)</span>
<span id="cb17-45"><a href="#cb17-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> Instruction(<span class="st">'&lt;&lt;'</span>, instr.dest, arg2, shift)</span>
<span id="cb17-46"><a href="#cb17-46" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-47"><a href="#cb17-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Divisão por potência de 2 (inteiros sem sinal)</span></span>
<span id="cb17-48"><a href="#cb17-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> instr.op <span class="op">==</span> <span class="st">'/'</span> <span class="kw">and</span> is_power_of_2(arg2):</span>
<span id="cb17-49"><a href="#cb17-49" aria-hidden="true" tabindex="-1"></a>        shift <span class="op">=</span> log2(arg2)</span>
<span id="cb17-50"><a href="#cb17-50" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> Instruction(<span class="st">'&gt;&gt;'</span>, instr.dest, arg1, shift)</span>
<span id="cb17-51"><a href="#cb17-51" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-52"><a href="#cb17-52" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Exponenciação por 2</span></span>
<span id="cb17-53"><a href="#cb17-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> instr.op <span class="op">==</span> <span class="st">'**'</span> <span class="kw">and</span> arg2 <span class="op">==</span> <span class="dv">2</span>:</span>
<span id="cb17-54"><a href="#cb17-54" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> Instruction(<span class="st">'*'</span>, instr.dest, arg1, arg1)</span>
<span id="cb17-55"><a href="#cb17-55" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-56"><a href="#cb17-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> instr</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="análise-de-economia" class="level3" data-number="17.5.3">
<h3 data-number="17.5.3" class="anchored" data-anchor-id="análise-de-economia"><span class="header-section-number">17.5.3</span> Análise de Economia</h3>
<p><strong>Exemplo de ganho de desempenho</strong>:</p>
<pre class="shell"><code># Original
t1 = x * 8      # ~4 ciclos

# Otimizado  
t1 = x &lt;&lt; 3     # ~1 ciclo</code></pre>
<p>Economia: 3 ciclos por operação (~75% redução)</p>
</section>
<section id="strength-reduction-em-loops" class="level3" data-number="17.5.4">
<h3 data-number="17.5.4" class="anchored" data-anchor-id="strength-reduction-em-loops"><span class="header-section-number">17.5.4</span> Strength Reduction em Loops</h3>
<p>A aplicação mais impactante de strength reduction ocorre em loops:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> loop_strength_reduction(loop):</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Reduz força de multiplicações em loops através de </span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="co">    variáveis de indução. (Conceitual)</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Transforma: i * c (em cada iteração)</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="co">    Em: variável acumuladora incrementada por c</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    induction_vars <span class="op">=</span> find_induction_variables(loop)</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> var <span class="kw">in</span> induction_vars:</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> has_multiplication_by_constant(var, loop):</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>            strength_reduce_induction(var, loop)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Exemplo</strong>:</p>
<pre class="shell"><code># Original
for i = 0 to n:
    a[i * 4] = 0</code></pre>
<p><strong>Otimizado</strong>:</p>
<pre class="shell"><code># Substitui multiplicação por incremento
j = 0
for i = 0 to n:
    a[j] = 0
    j = j + 4</code></pre>
</section>
<section id="tabelas-de-strength-reduction-referência-completa" class="level3" data-number="17.5.5">
<h3 data-number="17.5.5" class="anchored" data-anchor-id="tabelas-de-strength-reduction-referência-completa"><span class="header-section-number">17.5.5</span> Tabelas de Strength Reduction: Referência Completa</h3>
<section id="multiplicação-por-constantes-não-potências-de-2" class="level4" data-number="17.5.5.1">
<h4 data-number="17.5.5.1" class="anchored" data-anchor-id="multiplicação-por-constantes-não-potências-de-2"><span class="header-section-number">17.5.5.1</span> 1. Multiplicação por Constantes (Não-Potências de 2)</h4>
<p>A técnica decompõe multiplicações em sequências de shifts e adições/subtrações.</p>
<section id="tabela-de-conversões-para-multiplicação" class="level5" data-number="17.5.5.1.1">
<h5 data-number="17.5.5.1.1" class="anchored" data-anchor-id="tabela-de-conversões-para-multiplicação"><span class="header-section-number">17.5.5.1.1</span> Tabela de Conversões para Multiplicação</h5>
<table class="table">
<colgroup>
<col style="width: 23%">
<col style="width: 33%">
<col style="width: 26%">
<col style="width: 16%">
</colgroup>
<thead>
<tr class="header">
<th>Original</th>
<th>Transformação</th>
<th>Operações</th>
<th>Ganho</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>x * 3</td>
<td>(x &lt;&lt; 1) + x</td>
<td>1 shift + 1 add</td>
<td>~60%</td>
</tr>
<tr class="even">
<td>x * 5</td>
<td>(x &lt;&lt; 2) + x</td>
<td>1 shift + 1 add</td>
<td>~60%</td>
</tr>
<tr class="odd">
<td>x * 6</td>
<td>(x &lt;&lt; 1) + (x &lt;&lt; 2)</td>
<td>2 shifts + 1 add</td>
<td>~50%</td>
</tr>
<tr class="even">
<td>x * 7</td>
<td>(x &lt;&lt; 3) - x</td>
<td>1 shift + 1 sub</td>
<td>~60%</td>
</tr>
<tr class="odd">
<td>x * 9</td>
<td>(x &lt;&lt; 3) + x</td>
<td>1 shift + 1 add</td>
<td>~60%</td>
</tr>
<tr class="even">
<td>x * 10</td>
<td>(x &lt;&lt; 3) + (x &lt;&lt; 1)</td>
<td>2 shifts + 1 add</td>
<td>~50%</td>
</tr>
<tr class="odd">
<td>x * 11</td>
<td>(x &lt;&lt; 3) + (x &lt;&lt; 1) + x</td>
<td>2 shifts + 2 adds</td>
<td>~40%</td>
</tr>
<tr class="even">
<td>x * 12</td>
<td>(x &lt;&lt; 3) + (x &lt;&lt; 2)</td>
<td>2 shifts + 1 add</td>
<td>~50%</td>
</tr>
<tr class="odd">
<td>x * 15</td>
<td>(x &lt;&lt; 4) - x</td>
<td>1 shift + 1 sub</td>
<td>~60%</td>
</tr>
<tr class="even">
<td>x * 17</td>
<td>(x &lt;&lt; 4) + x</td>
<td>1 shift + 1 add</td>
<td>~60%</td>
</tr>
<tr class="odd">
<td>x * 18</td>
<td>(x &lt;&lt; 4) + (x &lt;&lt; 1)</td>
<td>2 shifts + 1 add</td>
<td>~50%</td>
</tr>
<tr class="even">
<td>x * 20</td>
<td>(x &lt;&lt; 4) + (x &lt;&lt; 2)</td>
<td>2 shifts + 1 add</td>
<td>~50%</td>
</tr>
<tr class="odd">
<td>x * 21</td>
<td>(x &lt;&lt; 4) + (x &lt;&lt; 2) + x</td>
<td>2 shifts + 2 adds</td>
<td>~40%</td>
</tr>
<tr class="even">
<td>x * 24</td>
<td>(x &lt;&lt; 4) + (x &lt;&lt; 3)</td>
<td>2 shifts + 1 add</td>
<td>~50%</td>
</tr>
<tr class="odd">
<td>x * 25</td>
<td>(x &lt;&lt; 4) + (x &lt;&lt; 3) + x</td>
<td>2 shifts + 2 adds</td>
<td>~40%</td>
</tr>
<tr class="even">
<td>x * 27</td>
<td>(x &lt;&lt; 4) + (x &lt;&lt; 3) + (x &lt;&lt; 1) + x</td>
<td>3 shifts + 3 adds</td>
<td>~20%</td>
</tr>
<tr class="odd">
<td>x * 31</td>
<td>(x &lt;&lt; 5) - x</td>
<td>1 shift + 1 sub</td>
<td>~60%</td>
</tr>
<tr class="even">
<td>x * 32</td>
<td>x &lt;&lt; 5</td>
<td>1 shift</td>
<td>~75%</td>
</tr>
<tr class="odd">
<td>x * 33</td>
<td>(x &lt;&lt; 5) + x</td>
<td>1 shift + 1 add</td>
<td>~60%</td>
</tr>
<tr class="even">
<td>x * 63</td>
<td>(x &lt;&lt; 6) - x</td>
<td>1 shift + 1 sub</td>
<td>~60%</td>
</tr>
<tr class="odd">
<td>x * 64</td>
<td>x &lt;&lt; 6</td>
<td>1 shift</td>
<td>~75%</td>
</tr>
<tr class="even">
<td>x * 65</td>
<td>(x &lt;&lt; 6) + x</td>
<td>1 shift + 1 add</td>
<td>~60%</td>
</tr>
<tr class="odd">
<td>x * 100</td>
<td>(x &lt;&lt; 6) + (x &lt;&lt; 5) + (x &lt;&lt; 2)</td>
<td>3 shifts + 2 adds</td>
<td>~40%</td>
</tr>
<tr class="even">
<td>x * 127</td>
<td>(x &lt;&lt; 7) - x</td>
<td>1 shift + 1 sub</td>
<td>~60%</td>
</tr>
<tr class="odd">
<td>x * 255</td>
<td>(x &lt;&lt; 8) - x</td>
<td>1 shift + 1 sub</td>
<td>~60%</td>
</tr>
</tbody>
</table>
</section>
<section id="algoritmo-para-gerar-sequência-ótima" class="level5" data-number="17.5.5.1.2">
<h5 data-number="17.5.5.1.2" class="anchored" data-anchor-id="algoritmo-para-gerar-sequência-ótima"><span class="header-section-number">17.5.5.1.2</span> Algoritmo para Gerar Sequência Ótima</h5>
<div class="sourceCode" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> multiply_by_constant(n):</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Gera sequência ótima de shifts e adds para multiplicar por n.</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Usa algoritmo de adição-subtração de cadeia (addition chain).</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> n <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">"0"</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> n <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">"x"</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Verificar se é potência de 2</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> n <span class="op">&amp;</span> (n <span class="op">-</span> <span class="dv">1</span>) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>        shift <span class="op">=</span> n.bit_length() <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="ss">f"x &lt;&lt; </span><span class="sc">{</span>shift<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Verificar padrão 2^k - 1</span></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (n <span class="op">+</span> <span class="dv">1</span>) <span class="op">&amp;</span> n <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>        shift <span class="op">=</span> (n <span class="op">+</span> <span class="dv">1</span>).bit_length() <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="ss">f"(x &lt;&lt; </span><span class="sc">{</span>shift<span class="sc">}</span><span class="ss">) - x"</span></span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Verificar padrão 2^k + 1</span></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (n <span class="op">-</span> <span class="dv">1</span>) <span class="op">&amp;</span> (n <span class="op">-</span> <span class="dv">2</span>) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>        shift <span class="op">=</span> (n <span class="op">-</span> <span class="dv">1</span>).bit_length() <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="ss">f"(x &lt;&lt; </span><span class="sc">{</span>shift<span class="sc">}</span><span class="ss">) + x"</span></span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Decomposição em soma de potências de 2</span></span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>    operations <span class="op">=</span> []</span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>    temp <span class="op">=</span> n</span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>    shift <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> temp <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> temp <span class="op">&amp;</span> <span class="dv">1</span>:</span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a>            operations.append(<span class="ss">f"(x &lt;&lt; </span><span class="sc">{</span>shift<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a>        temp <span class="op">&gt;&gt;=</span> <span class="dv">1</span></span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a>        shift <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">" + "</span>.join(operations)</span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Exemplos</span></span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"x * 7  = </span><span class="sc">{</span>multiply_by_constant(<span class="dv">7</span>)<span class="sc">}</span><span class="ss">"</span>)   <span class="co"># (x &lt;&lt; 3) - x</span></span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"x * 9  = </span><span class="sc">{</span>multiply_by_constant(<span class="dv">9</span>)<span class="sc">}</span><span class="ss">"</span>)   <span class="co"># (x &lt;&lt; 3) + x</span></span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"x * 15 = </span><span class="sc">{</span>multiply_by_constant(<span class="dv">15</span>)<span class="sc">}</span><span class="ss">"</span>)  <span class="co"># (x &lt;&lt; 4) - x</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="divisão-por-constantes-magic-numbers" class="level4" data-number="17.5.5.2">
<h4 data-number="17.5.5.2" class="anchored" data-anchor-id="divisão-por-constantes-magic-numbers"><span class="header-section-number">17.5.5.2</span> 2. Divisão por Constantes (Magic Numbers)</h4>
<p>Divisão inteira pode ser substituída por multiplicação + shift usando “números mágicos”.</p>
<section id="fórmula-geral" class="level5" data-number="17.5.5.2.1">
<h5 data-number="17.5.5.2.1" class="anchored" data-anchor-id="fórmula-geral"><span class="header-section-number">17.5.5.2.1</span> Fórmula Geral</h5>
<p>Para divisão inteira <code>x / d</code>, usar:</p>
<pre><code>resultado = (x * M) &gt;&gt; s</code></pre>
<p>Onde <code>M</code> é o “número mágico” e <code>s</code> é o shift.</p>
</section>
<section id="tabela-de-números-mágicos-32-bit" class="level5" data-number="17.5.5.2.2">
<h5 data-number="17.5.5.2.2" class="anchored" data-anchor-id="tabela-de-números-mágicos-32-bit"><span class="header-section-number">17.5.5.2.2</span> Tabela de Números Mágicos (32-bit)</h5>
<table class="table">
<thead>
<tr class="header">
<th>Divisor</th>
<th>M (hex)</th>
<th>Shift</th>
<th>Comentário</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>3</td>
<td>0xAAAAAAAB</td>
<td>33</td>
<td>(x * M) &gt;&gt; 33</td>
</tr>
<tr class="even">
<td>5</td>
<td>0xCCCCCCCD</td>
<td>34</td>
<td>(x * M) &gt;&gt; 34</td>
</tr>
<tr class="odd">
<td>6</td>
<td>0xAAAAAAAB</td>
<td>34</td>
<td>(x * M) &gt;&gt; 34</td>
</tr>
<tr class="even">
<td>7</td>
<td>0x92492493</td>
<td>34</td>
<td>(x * M) &gt;&gt; 34</td>
</tr>
<tr class="odd">
<td>9</td>
<td>0x38E38E39</td>
<td>33</td>
<td>(x * M) &gt;&gt; 33</td>
</tr>
<tr class="even">
<td>10</td>
<td>0xCCCCCCCD</td>
<td>35</td>
<td>(x * M) &gt;&gt; 35</td>
</tr>
<tr class="odd">
<td>11</td>
<td>0xBA2E8BA3</td>
<td>35</td>
<td>(x * M) &gt;&gt; 35</td>
</tr>
<tr class="even">
<td>12</td>
<td>0xAAAAAAAB</td>
<td>35</td>
<td>(x * M) &gt;&gt; 35</td>
</tr>
<tr class="odd">
<td>13</td>
<td>0x4EC4EC4F</td>
<td>34</td>
<td>(x * M) &gt;&gt; 34</td>
</tr>
<tr class="even">
<td>25</td>
<td>0x51EB851F</td>
<td>37</td>
<td>(x * M) &gt;&gt; 37</td>
</tr>
<tr class="odd">
<td>100</td>
<td>0x51EB851F</td>
<td>37</td>
<td>(x * M) &gt;&gt; 37</td>
</tr>
<tr class="even">
<td>1000</td>
<td>0x431BDE83</td>
<td>41</td>
<td>(x * M) &gt;&gt; 41</td>
</tr>
</tbody>
</table>
</section>
<section id="algoritmo-para-calcular-número-mágico" class="level5" data-number="17.5.5.2.3">
<h5 data-number="17.5.5.2.3" class="anchored" data-anchor-id="algoritmo-para-calcular-número-mágico"><span class="header-section-number">17.5.5.2.3</span> Algoritmo para Calcular Número Mágico</h5>
<div class="sourceCode" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_magic_number(divisor, bits<span class="op">=</span><span class="dv">32</span>):</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Calcula número mágico para divisão por constante.</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Baseado no algoritmo de Granlund-Montgomery.</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="co">        divisor: inteiro positivo</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a><span class="co">        bits: tamanho do inteiro (32 ou 64)</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a><span class="co">        (magic, shift): tupla com número mágico e shift</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> divisor <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"Divisor não pode ser zero"</span>)</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Para potências de 2, usar shift direto</span></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> divisor <span class="op">&amp;</span> (divisor <span class="op">-</span> <span class="dv">1</span>) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>        shift <span class="op">=</span> (divisor <span class="op">-</span> <span class="dv">1</span>).bit_length()</span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> (<span class="dv">1</span>, shift)</span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calcular número mágico</span></span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>    nc <span class="op">=</span> ((<span class="dv">1</span> <span class="op">&lt;&lt;</span> bits) <span class="op">-</span> <span class="dv">1</span>) <span class="op">//</span> divisor</span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a>    nbits_nc <span class="op">=</span> nc.bit_length()</span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> p <span class="kw">in</span> <span class="bu">range</span>(nbits_nc, <span class="dv">2</span> <span class="op">*</span> bits <span class="op">+</span> <span class="dv">1</span>):</span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a>        q <span class="op">=</span> (<span class="dv">1</span> <span class="op">&lt;&lt;</span> p) <span class="op">//</span> divisor</span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a>        r <span class="op">=</span> (<span class="dv">1</span> <span class="op">&lt;&lt;</span> p) <span class="op">-</span> q <span class="op">*</span> divisor</span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> r <span class="op">&lt;=</span> (<span class="dv">1</span> <span class="op">&lt;&lt;</span> p) <span class="op">-</span> nc:</span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a>            m <span class="op">=</span> q <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a>            s <span class="op">=</span> p <span class="op">-</span> bits</span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> (m, s)</span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"Não conseguiu calcular número mágico"</span>)</span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Exemplo de uso</span></span>
<span id="cb24-37"><a href="#cb24-37" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> divide_by_constant(x, divisor):</span>
<span id="cb24-38"><a href="#cb24-38" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Divide x por divisor usando número mágico."""</span></span>
<span id="cb24-39"><a href="#cb24-39" aria-hidden="true" tabindex="-1"></a>    magic, shift <span class="op">=</span> compute_magic_number(divisor)</span>
<span id="cb24-40"><a href="#cb24-40" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-41"><a href="#cb24-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> divisor <span class="op">&amp;</span> (divisor <span class="op">-</span> <span class="dv">1</span>) <span class="op">==</span> <span class="dv">0</span>:  <span class="co"># Potência de 2</span></span>
<span id="cb24-42"><a href="#cb24-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> x <span class="op">&gt;&gt;</span> shift</span>
<span id="cb24-43"><a href="#cb24-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb24-44"><a href="#cb24-44" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Multiplicação de precisão alta</span></span>
<span id="cb24-45"><a href="#cb24-45" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> (x <span class="op">*</span> magic) <span class="op">&gt;&gt;</span> (<span class="dv">32</span> <span class="op">+</span> shift)</span>
<span id="cb24-46"><a href="#cb24-46" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> result</span>
<span id="cb24-47"><a href="#cb24-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-48"><a href="#cb24-48" aria-hidden="true" tabindex="-1"></a><span class="co"># Teste</span></span>
<span id="cb24-49"><a href="#cb24-49" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> d <span class="kw">in</span> [<span class="dv">3</span>, <span class="dv">5</span>, <span class="dv">7</span>, <span class="dv">10</span>]:</span>
<span id="cb24-50"><a href="#cb24-50" aria-hidden="true" tabindex="-1"></a>    m, s <span class="op">=</span> compute_magic_number(d)</span>
<span id="cb24-51"><a href="#cb24-51" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Divisão por </span><span class="sc">{</span>d<span class="sc">}</span><span class="ss">: magic=0x</span><span class="sc">{</span>m<span class="sc">:X}</span><span class="ss">, shift=</span><span class="sc">{</span>s<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="operações-modulares" class="level4" data-number="17.5.5.3">
<h4 data-number="17.5.5.3" class="anchored" data-anchor-id="operações-modulares"><span class="header-section-number">17.5.5.3</span> 3. Operações Modulares</h4>
<section id="tabela-para-módulo-com-potências-de-2" class="level5" data-number="17.5.5.3.1">
<h5 data-number="17.5.5.3.1" class="anchored" data-anchor-id="tabela-para-módulo-com-potências-de-2"><span class="header-section-number">17.5.5.3.1</span> Tabela para Módulo com Potências de 2</h5>
<table class="table">
<thead>
<tr class="header">
<th>Original</th>
<th>Transformação</th>
<th>Explicação</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>x % 2</td>
<td>x &amp; 1</td>
<td>Bit menos significativo</td>
</tr>
<tr class="even">
<td>x % 4</td>
<td>x &amp; 3</td>
<td>2 bits menos significativos</td>
</tr>
<tr class="odd">
<td>x % 8</td>
<td>x &amp; 7</td>
<td>3 bits menos significativos</td>
</tr>
<tr class="even">
<td>x % 16</td>
<td>x &amp; 15</td>
<td>4 bits menos significativos</td>
</tr>
<tr class="odd">
<td>x % 32</td>
<td>x &amp; 31</td>
<td>5 bits menos significativos</td>
</tr>
<tr class="even">
<td>x % 64</td>
<td>x &amp; 63</td>
<td>6 bits menos significativos</td>
</tr>
<tr class="odd">
<td>x % 2^n</td>
<td>x &amp; (2^n - 1)</td>
<td>n bits menos significativos</td>
</tr>
</tbody>
</table>
</section>
<section id="módulo-por-constantes-especiais" class="level5" data-number="17.5.5.3.2">
<h5 data-number="17.5.5.3.2" class="anchored" data-anchor-id="módulo-por-constantes-especiais"><span class="header-section-number">17.5.5.3.2</span> Módulo por Constantes Especiais</h5>
<div class="sourceCode" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> modulo_strength_reduction(x, divisor):</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Otimiza operação de módulo."""</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Potência de 2</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> divisor <span class="op">&amp;</span> (divisor <span class="op">-</span> <span class="dv">1</span>) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>        mask <span class="op">=</span> divisor <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="ss">f"</span><span class="sc">{</span>x<span class="sc">}</span><span class="ss"> &amp; </span><span class="sc">{</span>mask<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Módulo 3 (caso especial)</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> divisor <span class="op">==</span> <span class="dv">3</span>:</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>        <span class="co"># x % 3 pode usar soma de dígitos</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">"modulo_3_special(x)"</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Módulo 5 (caso especial)</span></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> divisor <span class="op">==</span> <span class="dv">5</span>:</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">"modulo_5_special(x)"</span></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Caso geral: usar divisão otimizada + multiplicação</span></span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="ss">f"x - (x / </span><span class="sc">{</span>divisor<span class="sc">}</span><span class="ss">) * </span><span class="sc">{</span>divisor<span class="sc">}</span><span class="ss">"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="exponenciação" class="level4" data-number="17.5.5.4">
<h4 data-number="17.5.5.4" class="anchored" data-anchor-id="exponenciação"><span class="header-section-number">17.5.5.4</span> 4. Exponenciação</h4>
<section id="tabela-para-exponenciação-por-constantes-pequenas" class="level5" data-number="17.5.5.4.1">
<h5 data-number="17.5.5.4.1" class="anchored" data-anchor-id="tabela-para-exponenciação-por-constantes-pequenas"><span class="header-section-number">17.5.5.4.1</span> Tabela para Exponenciação por Constantes Pequenas</h5>
<table class="table">
<thead>
<tr class="header">
<th>Original</th>
<th>Transformação</th>
<th>Operações</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>x^2</td>
<td>x * x</td>
<td>1 mult</td>
</tr>
<tr class="even">
<td>x^3</td>
<td>x * x * x</td>
<td>2 mults</td>
</tr>
<tr class="odd">
<td>x^4</td>
<td>(x * x) * (x * x)</td>
<td>2 mults</td>
</tr>
<tr class="even">
<td>x^5</td>
<td>x^4 * x</td>
<td>3 mults</td>
</tr>
<tr class="odd">
<td>x^6</td>
<td>(x^3) * (x^3)</td>
<td>3 mults</td>
</tr>
<tr class="even">
<td>x^7</td>
<td>x^6 * x</td>
<td>4 mults</td>
</tr>
<tr class="odd">
<td>x^8</td>
<td>((x * x) * (x * x)) * ((x * x) * (x * x))</td>
<td>3 mults</td>
</tr>
<tr class="even">
<td>x^10</td>
<td>(x^5) * (x^5)</td>
<td>4 mults</td>
</tr>
</tbody>
</table>
</section>
<section id="exponenciação-rápida-square-and-multiply" class="level5" data-number="17.5.5.4.2">
<h5 data-number="17.5.5.4.2" class="anchored" data-anchor-id="exponenciação-rápida-square-and-multiply"><span class="header-section-number">17.5.5.4.2</span> Exponenciação Rápida (Square-and-Multiply)</h5>
<div class="sourceCode" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> power_strength_reduction(base, exponent):</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Gera código otimizado para exponenciação.</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Usa algoritmo de exponenciação binária.</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> exponent <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">"1"</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> exponent <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> base</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> exponent <span class="op">==</span> <span class="dv">2</span>:</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="ss">f"</span><span class="sc">{</span>base<span class="sc">}</span><span class="ss"> * </span><span class="sc">{</span>base<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Decomposição binária</span></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>    operations <span class="op">=</span> []</span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>    binary <span class="op">=</span> <span class="bu">bin</span>(exponent)[<span class="dv">2</span>:]  <span class="co"># Remover '0b'</span></span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> base</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, bit <span class="kw">in</span> <span class="bu">enumerate</span>(binary[<span class="dv">1</span>:], <span class="dv">1</span>):</span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> <span class="ss">f"(</span><span class="sc">{</span>result<span class="sc">}</span><span class="ss">) * (</span><span class="sc">{</span>result<span class="sc">}</span><span class="ss">)"</span>  <span class="co"># Square</span></span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> bit <span class="op">==</span> <span class="st">'1'</span>:</span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>            result <span class="op">=</span> <span class="ss">f"(</span><span class="sc">{</span>result<span class="sc">}</span><span class="ss">) * </span><span class="sc">{</span>base<span class="sc">}</span><span class="ss">"</span>   <span class="co"># Multiply</span></span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result</span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Exemplos</span></span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"x^5 = </span><span class="sc">{</span>power_strength_reduction(<span class="st">'x'</span>, <span class="dv">5</span>)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"x^10 = </span><span class="sc">{</span>power_strength_reduction(<span class="st">'x'</span>, <span class="dv">10</span>)<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="operações-em-loops-variáveis-de-indução" class="level4" data-number="17.5.5.5">
<h4 data-number="17.5.5.5" class="anchored" data-anchor-id="operações-em-loops-variáveis-de-indução"><span class="header-section-number">17.5.5.5</span> 5. Operações em Loops (Variáveis de Indução)</h4>
<section id="transformações-clássicas" class="level5" data-number="17.5.5.5.1">
<h5 data-number="17.5.5.5.1" class="anchored" data-anchor-id="transformações-clássicas"><span class="header-section-number">17.5.5.5.1</span> Transformações Clássicas</h5>
<table class="table">
<thead>
<tr class="header">
<th>Padrão Original</th>
<th>Transformação</th>
<th>Ganho</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>i * c</code> em loop</td>
<td>Acumulador += c</td>
<td>Elimina mult/iteração</td>
</tr>
<tr class="even">
<td><code>i * i</code> em loop</td>
<td>Acumulador += 2i + 1</td>
<td>Elimina mult/iteração</td>
</tr>
<tr class="odd">
<td><code>a[i * stride]</code></td>
<td>Ponteiro += stride</td>
<td>Elimina mult + add</td>
</tr>
</tbody>
</table>
</section>
<section id="exemplo-multiplicação-em-loop" class="level5" data-number="17.5.5.5.2">
<h5 data-number="17.5.5.5.2" class="anchored" data-anchor-id="exemplo-multiplicação-em-loop"><span class="header-section-number">17.5.5.5.2</span> Exemplo: Multiplicação em Loop</h5>
<div class="sourceCode" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Original (multiplicação por iteração)</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n):</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> i <span class="op">*</span> <span class="dv">5</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(result)</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Otimizado (adição por iteração)</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>result <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n):</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(result)</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>    result <span class="op">+=</span> <span class="dv">5</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="exemplo-quadrados-em-loop" class="level5" data-number="17.5.5.5.3">
<h5 data-number="17.5.5.5.3" class="anchored" data-anchor-id="exemplo-quadrados-em-loop"><span class="header-section-number">17.5.5.5.3</span> Exemplo: Quadrados em Loop</h5>
<div class="sourceCode" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Original (multiplicação por iteração)</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n):</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>    square <span class="op">=</span> i <span class="op">*</span> i</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(square)</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Otimizado (série de ímpares)</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>square <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>odd <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n):</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(square)</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>    square <span class="op">+=</span> odd</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>    odd <span class="op">+=</span> <span class="dv">2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="funções-trigonométricas-em-ângulos-especiais" class="level4" data-number="17.5.5.6">
<h4 data-number="17.5.5.6" class="anchored" data-anchor-id="funções-trigonométricas-em-ângulos-especiais"><span class="header-section-number">17.5.5.6</span> 6. Funções Trigonométricas em Ângulos Especiais</h4>
<section id="tabela-de-valores-exatos" class="level5" data-number="17.5.5.6.1">
<h5 data-number="17.5.5.6.1" class="anchored" data-anchor-id="tabela-de-valores-exatos"><span class="header-section-number">17.5.5.6.1</span> Tabela de Valores Exatos</h5>
<table class="table">
<thead>
<tr class="header">
<th>Função</th>
<th>Transformação</th>
<th>Valor</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>sin(0)</td>
<td>0</td>
<td>constante</td>
</tr>
<tr class="even">
<td>sin(π/6)</td>
<td>0.5</td>
<td>constante</td>
</tr>
<tr class="odd">
<td>sin(π/4)</td>
<td>√2/2 ≈ 0.707</td>
<td>constante</td>
</tr>
<tr class="even">
<td>sin(π/3)</td>
<td>√3/2 ≈ 0.866</td>
<td>constante</td>
</tr>
<tr class="odd">
<td>sin(π/2)</td>
<td>1.0</td>
<td>constante</td>
</tr>
<tr class="even">
<td>cos(0)</td>
<td>1.0</td>
<td>constante</td>
</tr>
<tr class="odd">
<td>cos(π/2)</td>
<td>0</td>
<td>constante</td>
</tr>
<tr class="even">
<td>tan(0)</td>
<td>0</td>
<td>constante</td>
</tr>
<tr class="odd">
<td>tan(π/4)</td>
<td>1.0</td>
<td>constante</td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="operações-de-ponto-flutuante" class="level4" data-number="17.5.5.7">
<h4 data-number="17.5.5.7" class="anchored" data-anchor-id="operações-de-ponto-flutuante"><span class="header-section-number">17.5.5.7</span> 7. Operações de Ponto Flutuante</h4>
<section id="divisão-por-constantes-float" class="level5" data-number="17.5.5.7.1">
<h5 data-number="17.5.5.7.1" class="anchored" data-anchor-id="divisão-por-constantes-float"><span class="header-section-number">17.5.5.7.1</span> Divisão por Constantes Float</h5>
<table class="table">
<thead>
<tr class="header">
<th>Original</th>
<th>Transformação</th>
<th>Ganho</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>x / 2.0</td>
<td>x * 0.5</td>
<td>~30%</td>
</tr>
<tr class="even">
<td>x / 4.0</td>
<td>x * 0.25</td>
<td>~30%</td>
</tr>
<tr class="odd">
<td>x / 10.0</td>
<td>x * 0.1</td>
<td>~30%</td>
</tr>
</tbody>
</table>
<p><strong>Nota</strong>: Multiplicação é geralmente mais rápida que divisão em FPUs modernas.</p>
</section>
</section>
<section id="operações-bit-a-bit" class="level4" data-number="17.5.5.8">
<h4 data-number="17.5.5.8" class="anchored" data-anchor-id="operações-bit-a-bit"><span class="header-section-number">17.5.5.8</span> 8. Operações Bit a Bit</h4>
<section id="tabela-de-truques-com-bits" class="level5" data-number="17.5.5.8.1">
<h5 data-number="17.5.5.8.1" class="anchored" data-anchor-id="tabela-de-truques-com-bits"><span class="header-section-number">17.5.5.8.1</span> Tabela de Truques com Bits</h5>
<table class="table">
<thead>
<tr class="header">
<th>Operação</th>
<th>Transformação</th>
<th>Uso</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>x % 2 == 0</td>
<td>(x &amp; 1) == 0</td>
<td>Testar paridade</td>
</tr>
<tr class="even">
<td>x / 2^n</td>
<td>x &gt;&gt; n</td>
<td>Divisão por pot. de 2</td>
</tr>
<tr class="odd">
<td>x * 2^n</td>
<td>x &lt;&lt; n</td>
<td>Multiplicação pot. 2</td>
</tr>
<tr class="even">
<td>abs(x)</td>
<td>(x ^ (x &gt;&gt; 31)) - (x &gt;&gt; 31)</td>
<td>Valor absoluto sem branch</td>
</tr>
<tr class="odd">
<td>max(a, b)</td>
<td>b ^ ((a ^ b) &amp; -(a &gt; b))</td>
<td>Máximo sem branch</td>
</tr>
<tr class="even">
<td>min(a, b)</td>
<td>a ^ ((a ^ b) &amp; -(a &gt; b))</td>
<td>Mínimo sem branch</td>
</tr>
<tr class="odd">
<td>swap(a, b)</td>
<td>a^=b; b^=a; a^=b</td>
<td>Trocar sem temp</td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="seleção-de-técnica-por-arquitetura" class="level4" data-number="17.5.5.9">
<h4 data-number="17.5.5.9" class="anchored" data-anchor-id="seleção-de-técnica-por-arquitetura"><span class="header-section-number">17.5.5.9</span> 9. Seleção de Técnica por Arquitetura</h4>
<section id="custos-relativos-ciclos-típicos-em-x86-64" class="level5" data-number="17.5.5.9.1">
<h5 data-number="17.5.5.9.1" class="anchored" data-anchor-id="custos-relativos-ciclos-típicos-em-x86-64"><span class="header-section-number">17.5.5.9.1</span> Custos Relativos (ciclos típicos em x86-64)</h5>
<table class="table">
<thead>
<tr class="header">
<th>Operação</th>
<th>Latência</th>
<th>Throughput</th>
<th>Observações</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>ADD</td>
<td>1</td>
<td>0.25-0.5</td>
<td>Muito rápido</td>
</tr>
<tr class="even">
<td>SHIFT</td>
<td>1</td>
<td>0.5</td>
<td>Muito rápido</td>
</tr>
<tr class="odd">
<td>MUL (int)</td>
<td>3-4</td>
<td>0.5-1</td>
<td>Rápido moderno</td>
</tr>
<tr class="even">
<td>DIV (int)</td>
<td>20-80</td>
<td>20-80</td>
<td>Muito lento</td>
</tr>
<tr class="odd">
<td>MUL (float)</td>
<td>4-5</td>
<td>0.5</td>
<td>Razoável</td>
</tr>
<tr class="even">
<td>DIV (float)</td>
<td>10-15</td>
<td>10-15</td>
<td>Lento</td>
</tr>
</tbody>
</table>
</section>
<section id="heurística-de-decisão" class="level5" data-number="17.5.5.9.2">
<h5 data-number="17.5.5.9.2" class="anchored" data-anchor-id="heurística-de-decisão"><span class="header-section-number">17.5.5.9.2</span> Heurística de Decisão</h5>
<div class="sourceCode" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> should_apply_strength_reduction(operation, operand, target_arch<span class="op">=</span><span class="st">"x86-64"</span>):</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Decide se vale a pena aplicar strength reduction.</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="co">        operation: 'mul', 'div', 'mod', 'pow'</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a><span class="co">        operand: valor da constante</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a><span class="co">        target_arch: arquitetura alvo</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a><span class="co">        bool: True se deve otimizar</span></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> operation <span class="op">==</span> <span class="st">'mul'</span>:</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Multiplicação moderna é rápida</span></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Só vale a pena para constantes muito usadas ou em loops críticos</span></span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> is_power_of_2(operand):</span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">True</span>  <span class="co"># Shift sempre vale a pena</span></span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Decomposição em &lt;= 3 operações</span></span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>        ops_count <span class="op">=</span> count_operations_needed(operand)</span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> ops_count <span class="op">&lt;=</span> <span class="dv">3</span></span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> operation <span class="op">==</span> <span class="st">'div'</span>:</span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Divisão é sempre lenta, sempre otimizar</span></span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> operation <span class="op">==</span> <span class="st">'mod'</span>:</span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Módulo é lento, otimizar quando possível</span></span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> is_power_of_2(operand)</span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> operation <span class="op">==</span> <span class="st">'pow'</span>:</span>
<span id="cb29-32"><a href="#cb29-32" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Exponenciação: otimizar para expoentes pequenos</span></span>
<span id="cb29-33"><a href="#cb29-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> operand <span class="op">&lt;=</span> <span class="dv">10</span></span>
<span id="cb29-34"><a href="#cb29-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-35"><a href="#cb29-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb29-36"><a href="#cb29-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-37"><a href="#cb29-37" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> count_operations_needed(n):</span>
<span id="cb29-38"><a href="#cb29-38" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Conta quantas ops são necessárias para multiplicar por n."""</span></span>
<span id="cb29-39"><a href="#cb29-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> is_power_of_2(n):</span>
<span id="cb29-40"><a href="#cb29-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">1</span>  <span class="co"># Apenas shift</span></span>
<span id="cb29-41"><a href="#cb29-41" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-42"><a href="#cb29-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Contar bits set (aproximação simples)</span></span>
<span id="cb29-43"><a href="#cb29-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">bin</span>(n).count(<span class="st">'1'</span>)</span>
<span id="cb29-44"><a href="#cb29-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-45"><a href="#cb29-45" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> is_power_of_2(n):</span>
<span id="cb29-46"><a href="#cb29-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> n <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">and</span> (n <span class="op">&amp;</span> (n <span class="op">-</span> <span class="dv">1</span>)) <span class="op">==</span> <span class="dv">0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="implementação-prática-em-compilador" class="level4" data-number="17.5.5.10">
<h4 data-number="17.5.5.10" class="anchored" data-anchor-id="implementação-prática-em-compilador"><span class="header-section-number">17.5.5.10</span> 10. Implementação Prática em Compilador</h4>
<section id="framework-de-strength-reduction" class="level5" data-number="17.5.5.10.1">
<h5 data-number="17.5.5.10.1" class="anchored" data-anchor-id="framework-de-strength-reduction"><span class="header-section-number">17.5.5.10.1</span> Framework de Strength Reduction</h5>
<div class="sourceCode" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> StrengthReducer:</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Framework para aplicar strength reduction."""</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, target_arch<span class="op">=</span><span class="st">'generic'</span>):</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.target_arch <span class="op">=</span> target_arch</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.transformations <span class="op">=</span> <span class="va">self</span>._build_transformation_table()</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _build_transformation_table(<span class="va">self</span>):</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Constrói tabela de transformações."""</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>            <span class="st">'mul'</span>: <span class="va">self</span>._optimize_multiply,</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>            <span class="st">'div'</span>: <span class="va">self</span>._optimize_divide,</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>            <span class="st">'mod'</span>: <span class="va">self</span>._optimize_modulo,</span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>            <span class="st">'pow'</span>: <span class="va">self</span>._optimize_power,</span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> optimize(<span class="va">self</span>, instruction):</span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a><span class="co">        Otimiza uma instrução.</span></span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a><span class="co">        Args:</span></span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a><span class="co">            instruction: objeto Instruction</span></span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a><span class="co">            </span></span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a><span class="co">        Returns:</span></span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a><span class="co">            lista de instruções otimizadas</span></span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> instruction.op <span class="kw">not</span> <span class="kw">in</span> <span class="va">self</span>.transformations:</span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> [instruction]</span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a>        optimizer <span class="op">=</span> <span class="va">self</span>.transformations[instruction.op]</span>
<span id="cb30-31"><a href="#cb30-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> optimizer(instruction)</span>
<span id="cb30-32"><a href="#cb30-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-33"><a href="#cb30-33" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _optimize_multiply(<span class="va">self</span>, instr):</span>
<span id="cb30-34"><a href="#cb30-34" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Otimiza multiplicação."""</span></span>
<span id="cb30-35"><a href="#cb30-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="bu">isinstance</span>(instr.arg2, <span class="bu">int</span>):</span>
<span id="cb30-36"><a href="#cb30-36" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> [instr]</span>
<span id="cb30-37"><a href="#cb30-37" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb30-38"><a href="#cb30-38" aria-hidden="true" tabindex="-1"></a>        n <span class="op">=</span> instr.arg2</span>
<span id="cb30-39"><a href="#cb30-39" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb30-40"><a href="#cb30-40" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Potência de 2</span></span>
<span id="cb30-41"><a href="#cb30-41" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> n <span class="op">&amp;</span> (n <span class="op">-</span> <span class="dv">1</span>) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb30-42"><a href="#cb30-42" aria-hidden="true" tabindex="-1"></a>            shift <span class="op">=</span> (n <span class="op">-</span> <span class="dv">1</span>).bit_length()</span>
<span id="cb30-43"><a href="#cb30-43" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> [Instruction(<span class="st">'&lt;&lt;'</span>, instr.dest, instr.arg1, shift)]</span>
<span id="cb30-44"><a href="#cb30-44" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb30-45"><a href="#cb30-45" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Padrão 2^k - 1 (ex: 7 = 8-1)</span></span>
<span id="cb30-46"><a href="#cb30-46" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (n <span class="op">+</span> <span class="dv">1</span>) <span class="op">&amp;</span> n <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb30-47"><a href="#cb30-47" aria-hidden="true" tabindex="-1"></a>            shift <span class="op">=</span> (n <span class="op">+</span> <span class="dv">1</span>).bit_length() <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb30-48"><a href="#cb30-48" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> [</span>
<span id="cb30-49"><a href="#cb30-49" aria-hidden="true" tabindex="-1"></a>                Instruction(<span class="st">'&lt;&lt;'</span>, <span class="st">'t_temp'</span>, instr.arg1, shift),</span>
<span id="cb30-50"><a href="#cb30-50" aria-hidden="true" tabindex="-1"></a>                Instruction(<span class="st">'-'</span>, instr.dest, <span class="st">'t_temp'</span>, instr.arg1)</span>
<span id="cb30-51"><a href="#cb30-51" aria-hidden="true" tabindex="-1"></a>            ]</span>
<span id="cb30-52"><a href="#cb30-52" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb30-53"><a href="#cb30-53" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Padrão 2^k + 1 (ex: 9 = 8+1)</span></span>
<span id="cb30-54"><a href="#cb30-54" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (n <span class="op">-</span> <span class="dv">1</span>) <span class="op">&amp;</span> (n <span class="op">-</span> <span class="dv">2</span>) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb30-55"><a href="#cb30-55" aria-hidden="true" tabindex="-1"></a>            shift <span class="op">=</span> (n <span class="op">-</span> <span class="dv">1</span>).bit_length() <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb30-56"><a href="#cb30-56" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> [</span>
<span id="cb30-57"><a href="#cb30-57" aria-hidden="true" tabindex="-1"></a>                Instruction(<span class="st">'&lt;&lt;'</span>, <span class="st">'t_temp'</span>, instr.arg1, shift),</span>
<span id="cb30-58"><a href="#cb30-58" aria-hidden="true" tabindex="-1"></a>                Instruction(<span class="st">'+'</span>, instr.dest, <span class="st">'t_temp'</span>, instr.arg1)</span>
<span id="cb30-59"><a href="#cb30-59" aria-hidden="true" tabindex="-1"></a>            ]</span>
<span id="cb30-60"><a href="#cb30-60" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb30-61"><a href="#cb30-61" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Decomposição geral (limitar a 3 operações)</span></span>
<span id="cb30-62"><a href="#cb30-62" aria-hidden="true" tabindex="-1"></a>        decomp <span class="op">=</span> <span class="va">self</span>._decompose_multiply(n)</span>
<span id="cb30-63"><a href="#cb30-63" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(decomp) <span class="op">&lt;=</span> <span class="dv">3</span>:</span>
<span id="cb30-64"><a href="#cb30-64" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">self</span>._generate_multiply_sequence(instr, decomp)</span>
<span id="cb30-65"><a href="#cb30-65" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb30-66"><a href="#cb30-66" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Não vale a pena, manter original</span></span>
<span id="cb30-67"><a href="#cb30-67" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> [instr]</span>
<span id="cb30-68"><a href="#cb30-68" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-69"><a href="#cb30-69" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _optimize_divide(<span class="va">self</span>, instr):</span>
<span id="cb30-70"><a href="#cb30-70" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Otimiza divisão."""</span></span>
<span id="cb30-71"><a href="#cb30-71" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="bu">isinstance</span>(instr.arg2, <span class="bu">int</span>):</span>
<span id="cb30-72"><a href="#cb30-72" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> [instr]</span>
<span id="cb30-73"><a href="#cb30-73" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb30-74"><a href="#cb30-74" aria-hidden="true" tabindex="-1"></a>        divisor <span class="op">=</span> instr.arg2</span>
<span id="cb30-75"><a href="#cb30-75" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb30-76"><a href="#cb30-76" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Potência de 2: usar shift</span></span>
<span id="cb30-77"><a href="#cb30-77" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> divisor <span class="op">&amp;</span> (divisor <span class="op">-</span> <span class="dv">1</span>) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb30-78"><a href="#cb30-78" aria-hidden="true" tabindex="-1"></a>            shift <span class="op">=</span> (divisor <span class="op">-</span> <span class="dv">1</span>).bit_length()</span>
<span id="cb30-79"><a href="#cb30-79" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> [Instruction(<span class="st">'&gt;&gt;'</span>, instr.dest, instr.arg1, shift)]</span>
<span id="cb30-80"><a href="#cb30-80" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb30-81"><a href="#cb30-81" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Usar número mágico</span></span>
<span id="cb30-82"><a href="#cb30-82" aria-hidden="true" tabindex="-1"></a>        magic, shift <span class="op">=</span> <span class="va">self</span>._compute_magic_number(divisor)</span>
<span id="cb30-83"><a href="#cb30-83" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> [</span>
<span id="cb30-84"><a href="#cb30-84" aria-hidden="true" tabindex="-1"></a>            Instruction(<span class="st">'*'</span>, <span class="st">'t_temp'</span>, instr.arg1, magic),</span>
<span id="cb30-85"><a href="#cb30-85" aria-hidden="true" tabindex="-1"></a>            Instruction(<span class="st">'&gt;&gt;'</span>, instr.dest, <span class="st">'t_temp'</span>, <span class="dv">32</span> <span class="op">+</span> shift)</span>
<span id="cb30-86"><a href="#cb30-86" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb30-87"><a href="#cb30-87" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-88"><a href="#cb30-88" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _optimize_modulo(<span class="va">self</span>, instr):</span>
<span id="cb30-89"><a href="#cb30-89" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Otimiza módulo."""</span></span>
<span id="cb30-90"><a href="#cb30-90" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="bu">isinstance</span>(instr.arg2, <span class="bu">int</span>):</span>
<span id="cb30-91"><a href="#cb30-91" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> [instr]</span>
<span id="cb30-92"><a href="#cb30-92" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb30-93"><a href="#cb30-93" aria-hidden="true" tabindex="-1"></a>        divisor <span class="op">=</span> instr.arg2</span>
<span id="cb30-94"><a href="#cb30-94" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb30-95"><a href="#cb30-95" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Potência de 2: usar AND</span></span>
<span id="cb30-96"><a href="#cb30-96" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> divisor <span class="op">&amp;</span> (divisor <span class="op">-</span> <span class="dv">1</span>) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb30-97"><a href="#cb30-97" aria-hidden="true" tabindex="-1"></a>            mask <span class="op">=</span> divisor <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb30-98"><a href="#cb30-98" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> [Instruction(<span class="st">'&amp;'</span>, instr.dest, instr.arg1, mask)]</span>
<span id="cb30-99"><a href="#cb30-99" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb30-100"><a href="#cb30-100" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Não otimizar outros casos</span></span>
<span id="cb30-101"><a href="#cb30-101" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> [instr]</span>
<span id="cb30-102"><a href="#cb30-102" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-103"><a href="#cb30-103" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _optimize_power(<span class="va">self</span>, instr):</span>
<span id="cb30-104"><a href="#cb30-104" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Otimiza exponenciação."""</span></span>
<span id="cb30-105"><a href="#cb30-105" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="bu">isinstance</span>(instr.arg2, <span class="bu">int</span>):</span>
<span id="cb30-106"><a href="#cb30-106" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> [instr]</span>
<span id="cb30-107"><a href="#cb30-107" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb30-108"><a href="#cb30-108" aria-hidden="true" tabindex="-1"></a>        exp <span class="op">=</span> instr.arg2</span>
<span id="cb30-109"><a href="#cb30-109" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb30-110"><a href="#cb30-110" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> exp <span class="op">==</span> <span class="dv">2</span>:</span>
<span id="cb30-111"><a href="#cb30-111" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> [Instruction(<span class="st">'*'</span>, instr.dest, instr.arg1, instr.arg1)]</span>
<span id="cb30-112"><a href="#cb30-112" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb30-113"><a href="#cb30-113" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> exp <span class="op">&lt;=</span> <span class="dv">10</span>:</span>
<span id="cb30-114"><a href="#cb30-114" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">self</span>._generate_power_sequence(instr, exp)</span>
<span id="cb30-115"><a href="#cb30-115" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb30-116"><a href="#cb30-116" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> [instr]</span>
<span id="cb30-117"><a href="#cb30-117" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-118"><a href="#cb30-118" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _decompose_multiply(<span class="va">self</span>, n):</span>
<span id="cb30-119"><a href="#cb30-119" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Decompõe multiplicação em shifts e adds."""</span></span>
<span id="cb30-120"><a href="#cb30-120" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Implementação simplificada</span></span>
<span id="cb30-121"><a href="#cb30-121" aria-hidden="true" tabindex="-1"></a>        decomposition <span class="op">=</span> []</span>
<span id="cb30-122"><a href="#cb30-122" aria-hidden="true" tabindex="-1"></a>        shift <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb30-123"><a href="#cb30-123" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span> n <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb30-124"><a href="#cb30-124" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> n <span class="op">&amp;</span> <span class="dv">1</span>:</span>
<span id="cb30-125"><a href="#cb30-125" aria-hidden="true" tabindex="-1"></a>                decomposition.append((<span class="st">'shift'</span>, shift))</span>
<span id="cb30-126"><a href="#cb30-126" aria-hidden="true" tabindex="-1"></a>            n <span class="op">&gt;&gt;=</span> <span class="dv">1</span></span>
<span id="cb30-127"><a href="#cb30-127" aria-hidden="true" tabindex="-1"></a>            shift <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb30-128"><a href="#cb30-128" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> decomposition</span>
<span id="cb30-129"><a href="#cb30-129" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-130"><a href="#cb30-130" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _generate_multiply_sequence(<span class="va">self</span>, instr, decomposition):</span>
<span id="cb30-131"><a href="#cb30-131" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Gera sequência de instruções para multiplicação."""</span></span>
<span id="cb30-132"><a href="#cb30-132" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Implementação simplificada</span></span>
<span id="cb30-133"><a href="#cb30-133" aria-hidden="true" tabindex="-1"></a>        instructions <span class="op">=</span> []</span>
<span id="cb30-134"><a href="#cb30-134" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ... gerar instruções baseadas na decomposição</span></span>
<span id="cb30-135"><a href="#cb30-135" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> instructions</span>
<span id="cb30-136"><a href="#cb30-136" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-137"><a href="#cb30-137" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _compute_magic_number(<span class="va">self</span>, divisor):</span>
<span id="cb30-138"><a href="#cb30-138" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Calcula número mágico para divisão."""</span></span>
<span id="cb30-139"><a href="#cb30-139" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Implementação do algoritmo Granlund-Montgomery</span></span>
<span id="cb30-140"><a href="#cb30-140" aria-hidden="true" tabindex="-1"></a>        <span class="co"># (simplificado aqui)</span></span>
<span id="cb30-141"><a href="#cb30-141" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> (<span class="bn">0xAAAAAAAB</span>, <span class="dv">1</span>)  <span class="co"># Placeholder</span></span>
<span id="cb30-142"><a href="#cb30-142" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-143"><a href="#cb30-143" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _generate_power_sequence(<span class="va">self</span>, instr, exp):</span>
<span id="cb30-144"><a href="#cb30-144" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Gera sequência para exponenciação."""</span></span>
<span id="cb30-145"><a href="#cb30-145" aria-hidden="true" tabindex="-1"></a>        instructions <span class="op">=</span> []</span>
<span id="cb30-146"><a href="#cb30-146" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Implementar exponenciação binária</span></span>
<span id="cb30-147"><a href="#cb30-147" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> instructions</span>
<span id="cb30-148"><a href="#cb30-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-149"><a href="#cb30-149" aria-hidden="true" tabindex="-1"></a><span class="co"># Uso</span></span>
<span id="cb30-150"><a href="#cb30-150" aria-hidden="true" tabindex="-1"></a>reducer <span class="op">=</span> StrengthReducer()</span>
<span id="cb30-151"><a href="#cb30-151" aria-hidden="true" tabindex="-1"></a>optimized <span class="op">=</span> reducer.optimize(Instruction(<span class="st">'*'</span>, <span class="st">'t1'</span>, <span class="st">'x'</span>, <span class="dv">7</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
</section>
</section>
<section id="referências-e-leituras-adicionais" class="level2" data-number="17.6">
<h2 data-number="17.6" class="anchored" data-anchor-id="referências-e-leituras-adicionais"><span class="header-section-number">17.6</span> Referências e Leituras Adicionais</h2>
<ol type="1">
<li><strong>“Hacker’s Delight”</strong> de Henry S. Warren Jr.&nbsp;- Capítulos sobre multiplicação e divisão otimizadas</li>
<li><strong>“Division by Invariant Integers using Multiplication”</strong> - Granlund &amp; Montgomery (1994)</li>
<li><strong>Intel® 64 and IA-32 Architectures Optimization Reference Manual</strong></li>
<li><strong>“Compiler Design: Analysis and Transformation”</strong> - Reinhard Wilhelm &amp; Helmut Seidl</li>
</ol>
<section id="notas-de-implementação" class="level3" data-number="17.6.1">
<h3 data-number="17.6.1" class="anchored" data-anchor-id="notas-de-implementação"><span class="header-section-number">17.6.1</span> Notas de Implementação</h3>
<section id="quando-não-aplicar-strength-reduction" class="level4" data-number="17.6.1.1">
<h4 data-number="17.6.1.1" class="anchored" data-anchor-id="quando-não-aplicar-strength-reduction"><span class="header-section-number">17.6.1.1</span> Quando NÃO Aplicar Strength Reduction</h4>
<ol type="1">
<li><strong>Processadores modernos com multiplicadores rápidos</strong>: Em CPUs modernas (desde ~2010), multiplicação inteira é quase tão rápida quanto adição</li>
<li><strong>Código já otimizado</strong>: Evitar sobre-otimização que prejudica legibilidade</li>
<li><strong>Constantes variáveis</strong>: Se o “constante” pode mudar (ex: configuração)</li>
<li><strong>Debugging</strong>: Código otimizado é mais difícil de debugar</li>
</ol>
</section>
<section id="considerações-de-arquitetura" class="level4" data-number="17.6.1.2">
<h4 data-number="17.6.1.2" class="anchored" data-anchor-id="considerações-de-arquitetura"><span class="header-section-number">17.6.1.2</span> Considerações de Arquitetura</h4>
<ul>
<li><strong>ARM</strong>: Multiplicação pode ser mais lenta, strength reduction mais benéfico</li>
<li><strong>x86-64</strong>: Multiplicação moderna é rápida, focar em divisão e módulo</li>
<li><strong>Microcontroladores</strong>: Strength reduction é crucial (sem FPU, multiplicadores lentos)</li>
<li><strong>GPUs</strong>: Evitar divergência de branches, preferir operações uniformes</li>
</ul>
</section>
</section>
</section>
<section id="propagação-de-cópias-copy-propagation" class="level2" data-number="17.7">
<h2 data-number="17.7" class="anchored" data-anchor-id="propagação-de-cópias-copy-propagation"><span class="header-section-number">17.7</span> 5. Propagação de Cópias (Copy Propagation)</h2>
<p>Substitui usos de variáveis copiadas pela variável original, eliminando cópias intermediárias desnecessárias.</p>
<section id="algoritmo-4" class="level3" data-number="17.7.1">
<h3 data-number="17.7.1" class="anchored" data-anchor-id="algoritmo-4"><span class="header-section-number">17.7.1</span> Algoritmo</h3>
<div class="sourceCode" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> copy_propagation(instructions):</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Propaga cópias (em um bloco básico).</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Transforma: x = y; z = x + 1</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Em: x = y; z = y + 1</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># assumes is_variable()</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> is_variable(val):</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">isinstance</span>(val, <span class="bu">str</span>) <span class="kw">and</span> (val[<span class="dv">0</span>].isalpha() <span class="kw">or</span> val[<span class="dv">0</span>] <span class="op">==</span> <span class="st">'t'</span>)</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>    copies <span class="op">=</span> {}  <span class="co"># Mapa: variável -&gt; variável que contém mesmo valor</span></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> []</span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> instr <span class="kw">in</span> instructions:</span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Substituir usos por originais</span></span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>        arg1 <span class="op">=</span> copies.get(instr.arg1, instr.arg1)</span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>        arg2 <span class="op">=</span> copies.get(instr.arg2, instr.arg2)</span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>        new_instr <span class="op">=</span> Instruction(instr.op, instr.dest, arg1, arg2)</span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Invalidar cópias se variável for redefinida</span></span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> instr.dest:</span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Remover dest de copies (se dest = z, remove z)</span></span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a>            copies.pop(instr.dest, <span class="va">None</span>)</span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Remover entradas que apontam para dest (se w = dest, remove w)</span></span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a>            copies <span class="op">=</span> {k: v <span class="cf">for</span> k, v <span class="kw">in</span> copies.items() <span class="cf">if</span> v <span class="op">!=</span> instr.dest}</span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Detectar nova cópia</span></span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> new_instr.op <span class="op">==</span> <span class="st">'ASSIGN'</span> <span class="kw">and</span> is_variable(new_instr.arg1):</span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true" tabindex="-1"></a>            copies[new_instr.dest] <span class="op">=</span> new_instr.arg1</span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-33"><a href="#cb31-33" aria-hidden="true" tabindex="-1"></a>        result.append(new_instr)</span>
<span id="cb31-34"><a href="#cb31-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-35"><a href="#cb31-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="interação-com-outras-otimizações" class="level3" data-number="17.7.2">
<h3 data-number="17.7.2" class="anchored" data-anchor-id="interação-com-outras-otimizações"><span class="header-section-number">17.7.2</span> Interação com Outras Otimizações</h3>
<p>Copy propagation frequentemente habilita outras otimizações:</p>
<p><strong>Exemplo</strong>:</p>
<pre class="shell"><code># Original
x = a
y = x + 5
z = x * 2

# Após copy propagation
x = a
y = a + 5
z = a * 2

# 'x = a' pode ser eliminado como código morto se 'x' não usado depois
y = a + 5
z = a * 2</code></pre>
</section>
<section id="análise-de-alias" class="level3" data-number="17.7.3">
<h3 data-number="17.7.3" class="anchored" data-anchor-id="análise-de-alias"><span class="header-section-number">17.7.3</span> Análise de Alias</h3>
<p>Copy propagation requer cuidado com aliasing (ponteiros ou referências), o que geralmente exige uma análise mais complexa (alias analysis) do que a mostrada. O algoritmo acima é seguro para variáveis escalares simples.</p>
</section>
</section>
<section id="eliminação-de-subexpressões-comuns-common-subexpression-elimination" class="level2" data-number="17.8">
<h2 data-number="17.8" class="anchored" data-anchor-id="eliminação-de-subexpressões-comuns-common-subexpression-elimination"><span class="header-section-number">17.8</span> 6. Eliminação de Subexpressões Comuns (Common Subexpression Elimination)</h2>
<p>Identifica expressões calculadas múltiplas vezes com os mesmos operandos e reutiliza o resultado já computado.</p>
<section id="algoritmo-local" class="level3" data-number="17.8.1">
<h3 data-number="17.8.1" class="anchored" data-anchor-id="algoritmo-local"><span class="header-section-number">17.8.1</span> Algoritmo Local</h3>
<p>Este algoritmo usa uma forma de <em>value numbering</em> local.</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> invalidate_expressions(available, modified_var):</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Remove expressões que dependem de variável modificada."""</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {expr: var <span class="cf">for</span> expr, var <span class="kw">in</span> available.items()</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> modified_var <span class="kw">not</span> <span class="kw">in</span> [expr[<span class="dv">1</span>], expr[<span class="dv">2</span>]]}</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> local_cse(instructions):</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a><span class="co">    CSE dentro de um bloco básico.</span></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a><span class="co">        instructions: Lista de instruções sem branches</span></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a><span class="co">        Lista otimizada de instruções</span></span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>    available_expressions <span class="op">=</span> {}  <span class="co"># (op, arg1, arg2) -&gt; variável com resultado</span></span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> []</span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> instr <span class="kw">in</span> instructions:</span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 1. Invalidar expressões que usam a variável</span></span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a>        <span class="co">#    que *está prestes a ser definida*</span></span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> instr.dest:</span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a>            available_expressions <span class="op">=</span> invalidate_expressions(</span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a>                available_expressions, instr.dest</span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb33-28"><a href="#cb33-28" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 2. Verificar se é uma expressão aritmética</span></span>
<span id="cb33-29"><a href="#cb33-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> instr.op <span class="kw">in</span> [<span class="st">'+'</span>, <span class="st">'-'</span>, <span class="st">'*'</span>, <span class="st">'/'</span>, <span class="st">'&lt;&lt;'</span>, <span class="st">'&gt;&gt;'</span>]:</span>
<span id="cb33-30"><a href="#cb33-30" aria-hidden="true" tabindex="-1"></a>            expr <span class="op">=</span> (instr.op, instr.arg1, instr.arg2)</span>
<span id="cb33-31"><a href="#cb33-31" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb33-32"><a href="#cb33-32" aria-hidden="true" tabindex="-1"></a>            <span class="co"># 3. Expressão já foi computada?</span></span>
<span id="cb33-33"><a href="#cb33-33" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> expr <span class="kw">in</span> available_expressions:</span>
<span id="cb33-34"><a href="#cb33-34" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Reusar resultado</span></span>
<span id="cb33-35"><a href="#cb33-35" aria-hidden="true" tabindex="-1"></a>                cached_var <span class="op">=</span> available_expressions[expr]</span>
<span id="cb33-36"><a href="#cb33-36" aria-hidden="true" tabindex="-1"></a>                new_instr <span class="op">=</span> Instruction(<span class="st">'ASSIGN'</span>, instr.dest, cached_var)</span>
<span id="cb33-37"><a href="#cb33-37" aria-hidden="true" tabindex="-1"></a>                result.append(new_instr)</span>
<span id="cb33-38"><a href="#cb33-38" aria-hidden="true" tabindex="-1"></a>                <span class="co"># (Copy propagation pode usar esta nova atribuição)</span></span>
<span id="cb33-39"><a href="#cb33-39" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb33-40"><a href="#cb33-40" aria-hidden="true" tabindex="-1"></a>                <span class="co"># 4. Nova expressão</span></span>
<span id="cb33-41"><a href="#cb33-41" aria-hidden="true" tabindex="-1"></a>                result.append(instr)</span>
<span id="cb33-42"><a href="#cb33-42" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Disponibilizar o resultado</span></span>
<span id="cb33-43"><a href="#cb33-43" aria-hidden="true" tabindex="-1"></a>                available_expressions[expr] <span class="op">=</span> instr.dest</span>
<span id="cb33-44"><a href="#cb33-44" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb33-45"><a href="#cb33-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb33-46"><a href="#cb33-46" aria-hidden="true" tabindex="-1"></a>            <span class="co"># 5. Não é expressão aritmética (ASSIGN, GOTO, etc.)</span></span>
<span id="cb33-47"><a href="#cb33-47" aria-hidden="true" tabindex="-1"></a>            result.append(instr)</span>
<span id="cb33-48"><a href="#cb33-48" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb33-49"><a href="#cb33-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="cse-global" class="level3" data-number="17.8.2">
<h3 data-number="17.8.2" class="anchored" data-anchor-id="cse-global"><span class="header-section-number">17.8.2</span> CSE Global</h3>
<p>Para CSE entre blocos básicos, precisamos de análise de disponibilidade (available expressions):</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> global_cse(cfg):</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="co">    CSE global usando análise de disponibilidade (conceitual).</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Uma expressão está disponível em um ponto se:</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a><span class="co">    1. Foi computada em todos os caminhos que levam a esse ponto</span></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a><span class="co">    2. Nenhum operando foi modificado desde o cálculo</span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Passo 1: Identificar todas as expressões</span></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>    all_expressions <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> block <span class="kw">in</span> cfg.blocks:</span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> instr <span class="kw">in</span> block.instructions:</span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> instr.op <span class="kw">in</span> [<span class="st">'+'</span>, <span class="st">'-'</span>, <span class="st">'*'</span>, <span class="st">'/'</span>]:</span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>                all_expressions.add((instr.op, instr.arg1, instr.arg2))</span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Passo 2: Análise de disponibilidade (iteração até ponto fixo)</span></span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>    available_in <span class="op">=</span> {block: <span class="bu">set</span>() <span class="cf">for</span> block <span class="kw">in</span> cfg.blocks}</span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>    available_out <span class="op">=</span> {block: <span class="bu">set</span>() <span class="cf">for</span> block <span class="kw">in</span> cfg.blocks}</span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>    changed <span class="op">=</span> <span class="va">True</span></span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> changed:</span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a>        changed <span class="op">=</span> <span class="va">False</span></span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> block <span class="kw">in</span> cfg.blocks:</span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Available_in = intersecção dos available_out dos predecessores</span></span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> block.predecessors:</span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a>                new_in <span class="op">=</span> <span class="bu">set</span>.intersection(<span class="op">*</span>[available_out[pred] </span>
<span id="cb34-27"><a href="#cb34-27" aria-hidden="true" tabindex="-1"></a>                                          <span class="cf">for</span> pred <span class="kw">in</span> block.predecessors])</span>
<span id="cb34-28"><a href="#cb34-28" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb34-29"><a href="#cb34-29" aria-hidden="true" tabindex="-1"></a>                new_in <span class="op">=</span> <span class="bu">set</span>() <span class="co"># Bloco de entrada</span></span>
<span id="cb34-30"><a href="#cb34-30" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb34-31"><a href="#cb34-31" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Propagar através do bloco (GEN/KILL)</span></span>
<span id="cb34-32"><a href="#cb34-32" aria-hidden="true" tabindex="-1"></a>            new_out <span class="op">=</span> propagate_available(new_in.copy(), block)</span>
<span id="cb34-33"><a href="#cb34-33" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb34-34"><a href="#cb34-34" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> new_out <span class="op">!=</span> available_out[block]:</span>
<span id="cb34-35"><a href="#cb34-35" aria-hidden="true" tabindex="-1"></a>                available_out[block] <span class="op">=</span> new_out</span>
<span id="cb34-36"><a href="#cb34-36" aria-hidden="true" tabindex="-1"></a>                changed <span class="op">=</span> <span class="va">True</span></span>
<span id="cb34-37"><a href="#cb34-37" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb34-38"><a href="#cb34-38" aria-hidden="true" tabindex="-1"></a>            available_in[block] <span class="op">=</span> new_in</span>
<span id="cb34-39"><a href="#cb34-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-40"><a href="#cb34-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Passo 3: Transformar código usando informação de disponibilidade</span></span>
<span id="cb34-41"><a href="#cb34-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> transform_with_cse(cfg, available_in, available_out)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="exemplo-detalhado" class="level3" data-number="17.8.3">
<h3 data-number="17.8.3" class="anchored" data-anchor-id="exemplo-detalhado"><span class="header-section-number">17.8.3</span> Exemplo Detalhado</h3>
<p><strong>Entrada</strong>:</p>
<pre class="shell"><code>t1 = a + b
t2 = c * d
t3 = a + b    # Subexpressão comum
t4 = t1 + t2</code></pre>
<p><strong>Análise (Local CSE)</strong>: 1. <code>t1 = a + b</code>: <code>available = {('+', 'a', 'b'): 't1'}</code> 2. <code>t2 = c * d</code>: <code>available = {('+', 'a', 'b'): 't1', ('*', 'c', 'd'): 't2'}</code> 3. <code>t3 = a + b</code>: Expressão <code>('+', 'a', 'b')</code> encontrada. Substituir por <code>t3 = t1</code>. 4. <code>t4 = t1 + t2</code>: <code>available = {('+', 'a', 'b'): 't1', ('*', 'c', 'd'): 't2', ('+', 't1', 't2'): 't4'}</code></p>
<p><strong>Saída</strong>:</p>
<pre class="shell"><code>t1 = a + b
t2 = c * d
t3 = t1       # Reusar resultado
t4 = t1 + t2</code></pre>
</section>
</section>
<section id="otimização-de-branches" class="level2" data-number="17.9">
<h2 data-number="17.9" class="anchored" data-anchor-id="otimização-de-branches"><span class="header-section-number">17.9</span> 7. Otimização de Branches</h2>
<p>Simplifica estruturas de controle, eliminando saltos desnecessários e encadeamentos de branches.</p>
<section id="técnicas-implementadas" class="level3" data-number="17.9.1">
<h3 data-number="17.9.1" class="anchored" data-anchor-id="técnicas-implementadas"><span class="header-section-number">17.9.1</span> Técnicas Implementadas</h3>
<ol type="1">
<li><strong>Eliminação de Branch para Próxima Instrução</strong></li>
<li><strong>Branch Chaining</strong>: <code>goto L1; L1: goto L2</code> <span class="math inline">\(\rightarrow\)</span> <code>goto L2</code></li>
<li><strong>Eliminação de Blocos Vazios</strong> (implícito no chaining)</li>
</ol>
</section>
<section id="algoritmo-5" class="level3" data-number="17.9.2">
<h3 data-number="17.9.2" class="anchored" data-anchor-id="algoritmo-5"><span class="header-section-number">17.9.2</span> Algoritmo</h3>
<div class="sourceCode" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> build_label_map(instructions):</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Constrói mapa de labels para suas posições (índices).</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a><span class="co">        Dict {label: índice da instrução LABEL}</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>    label_map <span class="op">=</span> {}</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, instr <span class="kw">in</span> <span class="bu">enumerate</span>(instructions):</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> instr.op <span class="op">==</span> <span class="st">'LABEL'</span>:</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>            label_map[instr.dest] <span class="op">=</span> i</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> label_map</span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> find_target_instruction(start_index, instructions):</span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a><span class="co">    Encontra a próxima instrução que não seja LABEL ou GOTO.</span></span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a><span class="co">    Retorna o índice da instrução real ou o destino de um GOTO.</span></span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a>    i <span class="op">=</span> start_index</span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a>    visited <span class="op">=</span> {start_index}</span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> i <span class="op">&lt;</span> <span class="bu">len</span>(instructions):</span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a>        instr <span class="op">=</span> instructions[i]</span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> instr.op <span class="op">==</span> <span class="st">'LABEL'</span>:</span>
<span id="cb37-26"><a href="#cb37-26" aria-hidden="true" tabindex="-1"></a>            i <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb37-27"><a href="#cb37-27" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> i <span class="kw">in</span> visited: <span class="cf">return</span> i, <span class="va">None</span> <span class="co"># Ciclo de labels</span></span>
<span id="cb37-28"><a href="#cb37-28" aria-hidden="true" tabindex="-1"></a>            visited.add(i)</span>
<span id="cb37-29"><a href="#cb37-29" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb37-30"><a href="#cb37-30" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb37-31"><a href="#cb37-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> instr.op <span class="op">==</span> <span class="st">'GOTO'</span>:</span>
<span id="cb37-32"><a href="#cb37-32" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Deve retornar o *destino* do goto</span></span>
<span id="cb37-33"><a href="#cb37-33" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="op">-</span><span class="dv">1</span>, instr.dest <span class="co"># -1 indica GOTO</span></span>
<span id="cb37-34"><a href="#cb37-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-35"><a href="#cb37-35" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Encontrou instrução real</span></span>
<span id="cb37-36"><a href="#cb37-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> i, <span class="va">None</span></span>
<span id="cb37-37"><a href="#cb37-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-38"><a href="#cb37-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">-</span><span class="dv">1</span>, <span class="va">None</span> <span class="co"># Fim do código</span></span>
<span id="cb37-39"><a href="#cb37-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-40"><a href="#cb37-40" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> optimize_branches(instructions):</span>
<span id="cb37-41"><a href="#cb37-41" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb37-42"><a href="#cb37-42" aria-hidden="true" tabindex="-1"></a><span class="co">    Otimiza estruturas de controle.</span></span>
<span id="cb37-43"><a href="#cb37-43" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb37-44"><a href="#cb37-44" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> []</span>
<span id="cb37-45"><a href="#cb37-45" aria-hidden="true" tabindex="-1"></a>    label_map <span class="op">=</span> build_label_map(instructions)</span>
<span id="cb37-46"><a href="#cb37-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Mapeia labels para seus alvos finais (após chains)</span></span>
<span id="cb37-47"><a href="#cb37-47" aria-hidden="true" tabindex="-1"></a>    final_targets <span class="op">=</span> {}</span>
<span id="cb37-48"><a href="#cb37-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-49"><a href="#cb37-49" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> resolve_chain(label, visited):</span>
<span id="cb37-50"><a href="#cb37-50" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> label <span class="kw">in</span> final_targets:</span>
<span id="cb37-51"><a href="#cb37-51" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> final_targets[label]</span>
<span id="cb37-52"><a href="#cb37-52" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> label <span class="kw">in</span> visited:</span>
<span id="cb37-53"><a href="#cb37-53" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> label <span class="co"># Ciclo</span></span>
<span id="cb37-54"><a href="#cb37-54" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> label <span class="kw">not</span> <span class="kw">in</span> label_map:</span>
<span id="cb37-55"><a href="#cb37-55" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> label <span class="co"># Label externo?</span></span>
<span id="cb37-56"><a href="#cb37-56" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb37-57"><a href="#cb37-57" aria-hidden="true" tabindex="-1"></a>        visited.add(label)</span>
<span id="cb37-58"><a href="#cb37-58" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb37-59"><a href="#cb37-59" aria-hidden="true" tabindex="-1"></a>        target_idx <span class="op">=</span> label_map[label]</span>
<span id="cb37-60"><a href="#cb37-60" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb37-61"><a href="#cb37-61" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Encontrar próxima instrução real após o label</span></span>
<span id="cb37-62"><a href="#cb37-62" aria-hidden="true" tabindex="-1"></a>        next_idx <span class="op">=</span> target_idx <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb37-63"><a href="#cb37-63" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span> next_idx <span class="op">&lt;</span> <span class="bu">len</span>(instructions) <span class="kw">and</span> instructions[next_idx].op <span class="op">==</span> <span class="st">'LABEL'</span>:</span>
<span id="cb37-64"><a href="#cb37-64" aria-hidden="true" tabindex="-1"></a>            next_idx <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb37-65"><a href="#cb37-65" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb37-66"><a href="#cb37-66" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> next_idx <span class="op">&lt;</span> <span class="bu">len</span>(instructions):</span>
<span id="cb37-67"><a href="#cb37-67" aria-hidden="true" tabindex="-1"></a>            next_instr <span class="op">=</span> instructions[next_idx]</span>
<span id="cb37-68"><a href="#cb37-68" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> next_instr.op <span class="op">==</span> <span class="st">'GOTO'</span>:</span>
<span id="cb37-69"><a href="#cb37-69" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Seguir o chain</span></span>
<span id="cb37-70"><a href="#cb37-70" aria-hidden="true" tabindex="-1"></a>                final_dest <span class="op">=</span> resolve_chain(next_instr.dest, visited)</span>
<span id="cb37-71"><a href="#cb37-71" aria-hidden="true" tabindex="-1"></a>                final_targets[label] <span class="op">=</span> final_dest</span>
<span id="cb37-72"><a href="#cb37-72" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> final_dest</span>
<span id="cb37-73"><a href="#cb37-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-74"><a href="#cb37-74" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Chain termina (ou não é um chain)</span></span>
<span id="cb37-75"><a href="#cb37-75" aria-hidden="true" tabindex="-1"></a>        final_targets[label] <span class="op">=</span> label</span>
<span id="cb37-76"><a href="#cb37-76" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> label</span>
<span id="cb37-77"><a href="#cb37-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-78"><a href="#cb37-78" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Resolver todos os chains</span></span>
<span id="cb37-79"><a href="#cb37-79" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> label <span class="kw">in</span> label_map:</span>
<span id="cb37-80"><a href="#cb37-80" aria-hidden="true" tabindex="-1"></a>        resolve_chain(label, <span class="bu">set</span>())</span>
<span id="cb37-81"><a href="#cb37-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-82"><a href="#cb37-82" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Reconstruir código</span></span>
<span id="cb37-83"><a href="#cb37-83" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, instr <span class="kw">in</span> <span class="bu">enumerate</span>(instructions):</span>
<span id="cb37-84"><a href="#cb37-84" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> instr.op <span class="op">==</span> <span class="st">'GOTO'</span>:</span>
<span id="cb37-85"><a href="#cb37-85" aria-hidden="true" tabindex="-1"></a>            final_dest <span class="op">=</span> final_targets.get(instr.dest, instr.dest)</span>
<span id="cb37-86"><a href="#cb37-86" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb37-87"><a href="#cb37-87" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Eliminar goto para próxima instrução</span></span>
<span id="cb37-88"><a href="#cb37-88" aria-hidden="true" tabindex="-1"></a>            next_i <span class="op">=</span> i <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb37-89"><a href="#cb37-89" aria-hidden="true" tabindex="-1"></a>            <span class="cf">while</span> next_i <span class="op">&lt;</span> <span class="bu">len</span>(instructions) <span class="kw">and</span> instructions[next_i].op <span class="op">==</span> <span class="st">'LABEL'</span>:</span>
<span id="cb37-90"><a href="#cb37-90" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> instructions[next_i].dest <span class="op">==</span> final_dest:</span>
<span id="cb37-91"><a href="#cb37-91" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">break</span></span>
<span id="cb37-92"><a href="#cb37-92" aria-hidden="true" tabindex="-1"></a>                next_i <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb37-93"><a href="#cb37-93" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb37-94"><a href="#cb37-94" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> next_i <span class="op">&lt;</span> <span class="bu">len</span>(instructions) <span class="kw">and</span> <span class="op">\</span></span>
<span id="cb37-95"><a href="#cb37-95" aria-hidden="true" tabindex="-1"></a>               instructions[next_i].op <span class="op">==</span> <span class="st">'LABEL'</span> <span class="kw">and</span> <span class="op">\</span></span>
<span id="cb37-96"><a href="#cb37-96" aria-hidden="true" tabindex="-1"></a>               instructions[next_i].dest <span class="op">==</span> final_dest:</span>
<span id="cb37-97"><a href="#cb37-97" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span> <span class="co"># Omitir instrução</span></span>
<span id="cb37-98"><a href="#cb37-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-99"><a href="#cb37-99" aria-hidden="true" tabindex="-1"></a>            result.append(Instruction(<span class="st">'GOTO'</span>, final_dest))</span>
<span id="cb37-100"><a href="#cb37-100" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb37-101"><a href="#cb37-101" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> instr.op <span class="kw">in</span> [<span class="st">'IF_GT'</span>, <span class="st">'IF_LT'</span>, <span class="st">'IF_EQ'</span>]:</span>
<span id="cb37-102"><a href="#cb37-102" aria-hidden="true" tabindex="-1"></a>            final_dest <span class="op">=</span> final_targets.get(instr.dest, instr.dest)</span>
<span id="cb37-103"><a href="#cb37-103" aria-hidden="true" tabindex="-1"></a>            result.append(Instruction(instr.op, final_dest, instr.arg1, instr.arg2))</span>
<span id="cb37-104"><a href="#cb37-104" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb37-105"><a href="#cb37-105" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb37-106"><a href="#cb37-106" aria-hidden="true" tabindex="-1"></a>            result.append(instr)</span>
<span id="cb37-107"><a href="#cb37-107" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-108"><a href="#cb37-108" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="exemplo-complexo" class="level3" data-number="17.9.3">
<h3 data-number="17.9.3" class="anchored" data-anchor-id="exemplo-complexo"><span class="header-section-number">17.9.3</span> Exemplo Complexo</h3>
<p><strong>Entrada</strong>:</p>
<pre class="shell"><code>    if x &lt; 10 goto L1
    goto L3
L1: goto L2
L2: goto L4
L3: y = 0
L4: z = y + 1</code></pre>
<p><strong>Análise</strong>:</p>
<ul>
<li><code>resolve_chain('L2')</code> <span class="math inline">\(\rightarrow\)</span> L4;</li>
<li><code>resolve_chain('L1')</code> <span class="math inline">\(\rightarrow\)</span> <code>resolve_chain('L2')</code> <span class="math inline">\(\rightarrow\)</span> L4;</li>
<li><code>final_targets = {'L1': 'L4', 'L2': 'L4', 'L3': 'L3', 'L4': 'L4'}</code>.</li>
</ul>
<p><strong>Saída</strong>:</p>
<pre><code>    if x &lt; 10 goto L4
    goto L3
L3: y = 0
L4: z = y + 1</code></pre>
</section>
<section id="branch-prediction-e-otimização" class="level3" data-number="17.9.4">
<h3 data-number="17.9.4" class="anchored" data-anchor-id="branch-prediction-e-otimização"><span class="header-section-number">17.9.4</span> Branch Prediction e Otimização</h3>
<p>Compiladores modernos consideram predição de branches:</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> optimize_for_branch_prediction(cfg):</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Reorganiza código para melhorar predição de branches (Conceitual).</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Heurísticas:</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a><span class="co">    1. Colocar caso mais provável sequencialmente após o branch</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a><span class="co">    2. Evitar branches para trás (exceto loops)</span></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> block <span class="kw">in</span> cfg.blocks:</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(block.successors) <span class="op">==</span> <span class="dv">2</span>:  <span class="co"># Branch condicional</span></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>            likely, unlikely <span class="op">=</span> predict_branch(block) <span class="co"># (Usa PGO ou heurística)</span></span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Inverter condição se necessário para colocar caso</span></span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>            <span class="co"># provável como fall-through</span></span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> unlikely <span class="kw">is</span> block.next_sequential_block:</span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>                invert_branch_condition(block)</span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a>                swap_successors(block)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="eliminação-de-loadstore-redundantes" class="level2" data-number="17.10">
<h2 data-number="17.10" class="anchored" data-anchor-id="eliminação-de-loadstore-redundantes"><span class="header-section-number">17.10</span> 8. Eliminação de Load/Store Redundantes</h2>
<p>Remove operações redundantes de memória quando o valor já está disponível em registrador.</p>
<section id="padrões-detectados" class="level3" data-number="17.10.1">
<h3 data-number="17.10.1" class="anchored" data-anchor-id="padrões-detectados"><span class="header-section-number">17.10.1</span> Padrões Detectados</h3>
<ol type="1">
<li><strong>Store-Load</strong>: <code>store r1, M[addr]; load r2, M[addr]</code> <span class="math inline">\(\rightarrow\)</span> <code>r2 = r1</code></li>
<li><strong>Load-Load</strong>: <code>load r1, M[addr]; load r2, M[addr]</code> <span class="math inline">\(\rightarrow\)</span> <code>r2 = r1</code></li>
<li><strong>Store-Store</strong>: <code>store r1, M[addr]; store r2, M[addr]</code> <span class="math inline">\(\rightarrow\)</span> remover primeiro store</li>
</ol>
</section>
<section id="algoritmo-6" class="level3" data-number="17.10.2">
<h3 data-number="17.10.2" class="anchored" data-anchor-id="algoritmo-6"><span class="header-section-number">17.10.2</span> Algoritmo</h3>
<div class="sourceCode" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> eliminate_redundant_memory_ops(instructions):</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Elimina loads e stores redundantes (em um bloco básico).</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Mantém rastreamento de:</span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a><span class="co">    - Valor conhecido em cada endereço (addr -&gt; reg)</span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a><span class="co">    - Registradores que foram sobrescritos</span></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>    memory_state <span class="op">=</span> {}  <span class="co"># endereço -&gt; registrador que contém o valor</span></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>    last_store_to <span class="op">=</span> {} <span class="co"># endereço -&gt; instrução de store</span></span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> []</span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> instr <span class="kw">in</span> instructions:</span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> instr.op <span class="op">==</span> <span class="st">'STORE'</span>: <span class="co"># store arg1, arg2 (val, addr)</span></span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a>            addr <span class="op">=</span> instr.arg2</span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a>            value_reg <span class="op">=</span> instr.arg1</span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Store-Store: Se o último store foi para o</span></span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a>            <span class="co"># mesmo endereço, o anterior é morto.</span></span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> addr <span class="kw">in</span> last_store_to:</span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a>                prev_store_instr <span class="op">=</span> last_store_to[addr]</span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> prev_store_instr <span class="kw">in</span> result:</span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true" tabindex="-1"></a>                    result.remove(prev_store_instr) <span class="co"># Remove store anterior</span></span>
<span id="cb41-25"><a href="#cb41-25" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb41-26"><a href="#cb41-26" aria-hidden="true" tabindex="-1"></a>            result.append(instr)</span>
<span id="cb41-27"><a href="#cb41-27" aria-hidden="true" tabindex="-1"></a>            memory_state[addr] <span class="op">=</span> value_reg</span>
<span id="cb41-28"><a href="#cb41-28" aria-hidden="true" tabindex="-1"></a>            last_store_to[addr] <span class="op">=</span> instr</span>
<span id="cb41-29"><a href="#cb41-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-30"><a href="#cb41-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> instr.op <span class="op">==</span> <span class="st">'LOAD'</span>: <span class="co"># load dest, arg1 (dest, addr)</span></span>
<span id="cb41-31"><a href="#cb41-31" aria-hidden="true" tabindex="-1"></a>            addr <span class="op">=</span> instr.arg1</span>
<span id="cb41-32"><a href="#cb41-32" aria-hidden="true" tabindex="-1"></a>            dest_reg <span class="op">=</span> instr.dest</span>
<span id="cb41-33"><a href="#cb41-33" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb41-34"><a href="#cb41-34" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Store-Load ou Load-Load</span></span>
<span id="cb41-35"><a href="#cb41-35" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> addr <span class="kw">in</span> memory_state:</span>
<span id="cb41-36"><a href="#cb41-36" aria-hidden="true" tabindex="-1"></a>                src_reg <span class="op">=</span> memory_state[addr]</span>
<span id="cb41-37"><a href="#cb41-37" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Substituir load por cópia de registrador</span></span>
<span id="cb41-38"><a href="#cb41-38" aria-hidden="true" tabindex="-1"></a>                result.append(Instruction(<span class="st">'ASSIGN'</span>, dest_reg, src_reg))</span>
<span id="cb41-39"><a href="#cb41-39" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Agora o dest_reg também contém o valor</span></span>
<span id="cb41-40"><a href="#cb41-40" aria-hidden="true" tabindex="-1"></a>                memory_state[addr] <span class="op">=</span> dest_reg</span>
<span id="cb41-41"><a href="#cb41-41" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb41-42"><a href="#cb41-42" aria-hidden="true" tabindex="-1"></a>                result.append(instr)</span>
<span id="cb41-43"><a href="#cb41-43" aria-hidden="true" tabindex="-1"></a>                memory_state[addr] <span class="op">=</span> dest_reg</span>
<span id="cb41-44"><a href="#cb41-44" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb41-45"><a href="#cb41-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> instr.op <span class="op">==</span> <span class="st">'CALL'</span>:</span>
<span id="cb41-46"><a href="#cb41-46" aria-hidden="true" tabindex="-1"></a>             <span class="co"># Chamada de função invalida *toda* a memória</span></span>
<span id="cb41-47"><a href="#cb41-47" aria-hidden="true" tabindex="-1"></a>             memory_state <span class="op">=</span> {}</span>
<span id="cb41-48"><a href="#cb41-48" aria-hidden="true" tabindex="-1"></a>             last_store_to <span class="op">=</span> {}</span>
<span id="cb41-49"><a href="#cb41-49" aria-hidden="true" tabindex="-1"></a>             result.append(instr)</span>
<span id="cb41-50"><a href="#cb41-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-51"><a href="#cb41-51" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb41-52"><a href="#cb41-52" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Outra instrução (ex: t1 = a + b)</span></span>
<span id="cb41-53"><a href="#cb41-53" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> instr.dest:</span>
<span id="cb41-54"><a href="#cb41-54" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Se t1 foi modificado, invalida estados</span></span>
<span id="cb41-55"><a href="#cb41-55" aria-hidden="true" tabindex="-1"></a>                <span class="co"># que dependiam dele</span></span>
<span id="cb41-56"><a href="#cb41-56" aria-hidden="true" tabindex="-1"></a>                memory_state <span class="op">=</span> {addr: reg <span class="cf">for</span> addr, reg <span class="kw">in</span> memory_state.items()</span>
<span id="cb41-57"><a href="#cb41-57" aria-hidden="true" tabindex="-1"></a>                                <span class="cf">if</span> reg <span class="op">!=</span> instr.dest}</span>
<span id="cb41-58"><a href="#cb41-58" aria-hidden="true" tabindex="-1"></a>            result.append(instr)</span>
<span id="cb41-59"><a href="#cb41-59" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb41-60"><a href="#cb41-60" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="exemplo-com-store-load" class="level3" data-number="17.10.3">
<h3 data-number="17.10.3" class="anchored" data-anchor-id="exemplo-com-store-load"><span class="header-section-number">17.10.3</span> Exemplo com Store-Load</h3>
<p><strong>Entrada</strong>:</p>
<pre><code>t1 = 10
store t1, M[200]
t2 = load M[200]
t3 = t2 + 5</code></pre>
<p><strong>Análise</strong>: 1. <code>t1 = 10</code> 2. <code>store t1, M[200]</code>: <code>memory_state = {'M[200]': 't1'}</code> 3. <code>t2 = load M[200]</code>: Endereço <code>M[200]</code> está em <code>memory_state</code>, vindo de <code>t1</code>. Substituir. 4. Instrução gerada: <code>t2 = t1</code>. <code>memory_state = {'M[200]': 't2'}</code> (pois <code>t2</code> agora também tem o valor).</p>
<p><strong>Saída</strong>:</p>
<pre><code>t1 = 10
store t1, M[200]
t2 = t1            # Substituir load por cópia
t3 = t2 + 5</code></pre>
</section>
</section>
<section id="eliminação-de-código-inalcançável" class="level2" data-number="17.11">
<h2 data-number="17.11" class="anchored" data-anchor-id="eliminação-de-código-inalcançável"><span class="header-section-number">17.11</span> 9. Eliminação de Código Inalcançável</h2>
<p>Remove código que nunca pode ser executado porque não há caminho de controle que leve até ele.</p>
<section id="algoritmo-baseado-em-alcançabilidade" class="level3" data-number="17.11.1">
<h3 data-number="17.11.1" class="anchored" data-anchor-id="algoritmo-baseado-em-alcançabilidade"><span class="header-section-number">17.11.1</span> Algoritmo Baseado em Alcançabilidade</h3>
<div class="sourceCode" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> eliminate_unreachable_code(cfg):</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Remove código inalcançável usando busca em grafos.</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a><span class="co">        cfg: Control Flow Graph</span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a><span class="co">        CFG com blocos inalcançáveis removidos</span></span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Passo 1: Marcar blocos alcançáveis</span></span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>    reachable <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>    worklist <span class="op">=</span> [cfg.entry_block]</span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> worklist:</span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>        block <span class="op">=</span> worklist.pop()</span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> block <span class="kw">in</span> reachable:</span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb44-21"><a href="#cb44-21" aria-hidden="true" tabindex="-1"></a>        reachable.add(block)</span>
<span id="cb44-22"><a href="#cb44-22" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb44-23"><a href="#cb44-23" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Adicionar sucessores</span></span>
<span id="cb44-24"><a href="#cb44-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> successor <span class="kw">in</span> block.successors:</span>
<span id="cb44-25"><a href="#cb44-25" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> successor <span class="kw">not</span> <span class="kw">in</span> reachable:</span>
<span id="cb44-26"><a href="#cb44-26" aria-hidden="true" tabindex="-1"></a>                worklist.append(successor)</span>
<span id="cb44-27"><a href="#cb44-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb44-28"><a href="#cb44-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Passo 2: Remover blocos inalcançáveis</span></span>
<span id="cb44-29"><a href="#cb44-29" aria-hidden="true" tabindex="-1"></a>    cfg.blocks <span class="op">=</span> [b <span class="cf">for</span> b <span class="kw">in</span> cfg.blocks <span class="cf">if</span> b <span class="kw">in</span> reachable]</span>
<span id="cb44-30"><a href="#cb44-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb44-31"><a href="#cb44-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Passo 3: Limpar referências para blocos removidos</span></span>
<span id="cb44-32"><a href="#cb44-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> block <span class="kw">in</span> cfg.blocks:</span>
<span id="cb44-33"><a href="#cb44-33" aria-hidden="true" tabindex="-1"></a>        block.successors <span class="op">=</span> [s <span class="cf">for</span> s <span class="kw">in</span> block.successors <span class="cf">if</span> s <span class="kw">in</span> reachable]</span>
<span id="cb44-34"><a href="#cb44-34" aria-hidden="true" tabindex="-1"></a>        block.predecessors <span class="op">=</span> [p <span class="cf">for</span> p <span class="kw">in</span> block.predecessors <span class="cf">if</span> p <span class="kw">in</span> reachable]</span>
<span id="cb44-35"><a href="#cb44-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb44-36"><a href="#cb44-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> cfg</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="eliminação-de-código-após-return" class="level3" data-number="17.11.2">
<h3 data-number="17.11.2" class="anchored" data-anchor-id="eliminação-de-código-após-return"><span class="header-section-number">17.11.2</span> Eliminação de Código Após Return</h3>
<p>Caso especial comum: código após return incondicional.</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> eliminate_code_after_return(instructions):</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Remove instruções após return ou goto incondicional.</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a><span class="co">    (Em um bloco básico linear)</span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> []</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>    in_dead_code <span class="op">=</span> <span class="va">False</span></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> instr <span class="kw">in</span> instructions:</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> instr.op <span class="op">==</span> <span class="st">'LABEL'</span>:</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Label inicia novo bloco potencialmente alcançável</span></span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>            in_dead_code <span class="op">=</span> <span class="va">False</span></span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>            result.append(instr)</span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> <span class="kw">not</span> in_dead_code:</span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a>            result.append(instr)</span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Return ou goto incondicional tornam código seguinte morto</span></span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> instr.op <span class="kw">in</span> [<span class="st">'RETURN'</span>, <span class="st">'GOTO'</span>]:</span>
<span id="cb45-20"><a href="#cb45-20" aria-hidden="true" tabindex="-1"></a>                in_dead_code <span class="op">=</span> <span class="va">True</span></span>
<span id="cb45-21"><a href="#cb45-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb45-22"><a href="#cb45-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="análise-de-condições-constantes" class="level3" data-number="17.11.3">
<h3 data-number="17.11.3" class="anchored" data-anchor-id="análise-de-condições-constantes"><span class="header-section-number">17.11.3</span> Análise de Condições Constantes</h3>
<p>Branches com condições constantes revelam código inalcançável:</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> evaluate_condition(instr):</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Tenta avaliar condição em tempo de compilação.</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a><span class="co">        True, False, ou None (se não pode determinar)</span></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> is_constant(instr.arg1) <span class="kw">or</span> <span class="kw">not</span> is_constant(instr.arg2):</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>    val1, val2 <span class="op">=</span> instr.arg1, instr.arg2</span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> instr.op <span class="op">==</span> <span class="st">'IF_GT'</span>: <span class="cf">return</span> val1 <span class="op">&gt;</span> val2</span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> instr.op <span class="op">==</span> <span class="st">'IF_LT'</span>: <span class="cf">return</span> val1 <span class="op">&lt;</span> val2</span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> instr.op <span class="op">==</span> <span class="st">'IF_EQ'</span>: <span class="cf">return</span> val1 <span class="op">==</span> val2</span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> eliminate_constant_branches(instructions):</span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb46-21"><a href="#cb46-21" aria-hidden="true" tabindex="-1"></a><span class="co">    Remove código inalcançável devido a condições constantes.</span></span>
<span id="cb46-22"><a href="#cb46-22" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb46-23"><a href="#cb46-23" aria-hidden="true" tabindex="-1"></a><span class="co">    if true goto L1 → goto L1 (código após é inalcançável)</span></span>
<span id="cb46-24"><a href="#cb46-24" aria-hidden="true" tabindex="-1"></a><span class="co">    if false goto L1 → remove branch (código em L1 pode ser inalcançável)</span></span>
<span id="cb46-25"><a href="#cb46-25" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb46-26"><a href="#cb46-26" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> []</span>
<span id="cb46-27"><a href="#cb46-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb46-28"><a href="#cb46-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, instr <span class="kw">in</span> <span class="bu">enumerate</span>(instructions):</span>
<span id="cb46-29"><a href="#cb46-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> instr.op <span class="kw">in</span> [<span class="st">'IF_GT'</span>, <span class="st">'IF_LT'</span>, <span class="st">'IF_EQ'</span>]:</span>
<span id="cb46-30"><a href="#cb46-30" aria-hidden="true" tabindex="-1"></a>            condition_result <span class="op">=</span> evaluate_condition(instr)</span>
<span id="cb46-31"><a href="#cb46-31" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb46-32"><a href="#cb46-32" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> condition_result <span class="kw">is</span> <span class="va">True</span>:</span>
<span id="cb46-33"><a href="#cb46-33" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Condição sempre verdadeira</span></span>
<span id="cb46-34"><a href="#cb46-34" aria-hidden="true" tabindex="-1"></a>                result.append(Instruction(<span class="st">'GOTO'</span>, instr.dest))</span>
<span id="cb46-35"><a href="#cb46-35" aria-hidden="true" tabindex="-1"></a>                <span class="co"># O código seguinte (até um label) </span></span>
<span id="cb46-36"><a href="#cb46-36" aria-hidden="true" tabindex="-1"></a>                <span class="co"># será pego por eliminate_code_after_return</span></span>
<span id="cb46-37"><a href="#cb46-37" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb46-38"><a href="#cb46-38" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> condition_result <span class="kw">is</span> <span class="va">False</span>:</span>
<span id="cb46-39"><a href="#cb46-39" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Condição sempre falsa, remover branch</span></span>
<span id="cb46-40"><a href="#cb46-40" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb46-41"><a href="#cb46-41" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb46-42"><a href="#cb46-42" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb46-43"><a href="#cb46-43" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Condição não constante</span></span>
<span id="cb46-44"><a href="#cb46-44" aria-hidden="true" tabindex="-1"></a>                result.append(instr)</span>
<span id="cb46-45"><a href="#cb46-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb46-46"><a href="#cb46-46" aria-hidden="true" tabindex="-1"></a>            result.append(instr)</span>
<span id="cb46-47"><a href="#cb46-47" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb46-48"><a href="#cb46-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="exemplo-completo-1" class="level3" data-number="17.11.4">
<h3 data-number="17.11.4" class="anchored" data-anchor-id="exemplo-completo-1"><span class="header-section-number">17.11.4</span> Exemplo Completo</h3>
<p><strong>Entrada</strong>:</p>
<pre><code>if x &gt; 10 goto L2
goto L3
L1: a = 5         # Inalcançável - nenhum branch para L1
L2: b = 20
    goto L4
    c = 30        # Inalcançável - após goto
L3: d = 15
L4: result = b + d</code></pre>
<p><strong>Análise de Alcançabilidade</strong>: 1. <code>eliminate_code_after_return</code> remove <code>c = 30</code>. 2. <code>eliminate_unreachable_code(cfg)</code> (busca no grafo) não encontraria <code>L1</code>.</p>
<p><strong>Saída</strong>:</p>
<pre><code>if x &gt; 10 goto L2
goto L3
L2: b = 20
    goto L4
L3: d = 15
L4: result = b + d</code></pre>
</section>
</section>
<section id="integração-e-ordem-de-aplicação" class="level2" data-number="17.12">
<h2 data-number="17.12" class="anchored" data-anchor-id="integração-e-ordem-de-aplicação"><span class="header-section-number">17.12</span> Integração e Ordem de Aplicação</h2>
<p>As otimizações <em>peephole</em> devem ser aplicadas em ordem estratégica, pois uma pode habilitar outra.</p>
<section id="pipeline-de-otimização" class="level3" data-number="17.12.1">
<h3 data-number="17.12.1" class="anchored" data-anchor-id="pipeline-de-otimização"><span class="header-section-number">17.12.1</span> Pipeline de Otimização</h3>
<div class="sourceCode" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> optimize_code(instructions, max_iterations<span class="op">=</span><span class="dv">10</span>):</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Aplica otimizações _peephole_ iterativamente até convergência.</span></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a><span class="co">    (Assumindo que 'instructions' é um único bloco básico)</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a><span class="co">        instructions: Código TAC inicial</span></span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a><span class="co">        max_iterations: Limite de iterações</span></span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a><span class="co">        Código otimizado</span></span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>    code <span class="op">=</span> instructions</span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>    iteration <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> iteration <span class="op">&lt;</span> max_iterations:</span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a>        old_code <span class="op">=</span> code</span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb49-19"><a href="#cb49-19" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Fase 1: Simplificação e redução</span></span>
<span id="cb49-20"><a href="#cb49-20" aria-hidden="true" tabindex="-1"></a>        code <span class="op">=</span> algebraic_simplification(code)</span>
<span id="cb49-21"><a href="#cb49-21" aria-hidden="true" tabindex="-1"></a>        code <span class="op">=</span> strength_reduction(code)</span>
<span id="cb49-22"><a href="#cb49-22" aria-hidden="true" tabindex="-1"></a>        code <span class="op">=</span> constant_propagation(code) <span class="co"># Inclui folding</span></span>
<span id="cb49-23"><a href="#cb49-23" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb49-24"><a href="#cb49-24" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Fase 2: Eliminação de redundâncias</span></span>
<span id="cb49-25"><a href="#cb49-25" aria-hidden="true" tabindex="-1"></a>        code <span class="op">=</span> copy_propagation(code)</span>
<span id="cb49-26"><a href="#cb49-26" aria-hidden="true" tabindex="-1"></a>        code <span class="op">=</span> local_cse(code)</span>
<span id="cb49-27"><a href="#cb49-27" aria-hidden="true" tabindex="-1"></a>        code <span class="op">=</span> eliminate_redundant_memory_ops(code)</span>
<span id="cb49-28"><a href="#cb49-28" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb49-29"><a href="#cb49-29" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Fase 3: Otimização de controle (limitada a bloco básico)</span></span>
<span id="cb49-30"><a href="#cb49-30" aria-hidden="true" tabindex="-1"></a>        code <span class="op">=</span> eliminate_constant_branches(code)</span>
<span id="cb49-31"><a href="#cb49-31" aria-hidden="true" tabindex="-1"></a>        code <span class="op">=</span> eliminate_code_after_return(code)</span>
<span id="cb49-32"><a href="#cb49-32" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb49-33"><a href="#cb49-33" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Fase 4: Limpeza</span></span>
<span id="cb49-34"><a href="#cb49-34" aria-hidden="true" tabindex="-1"></a>        <span class="co"># (Dead Code Elimination total requer análise de liveness global)</span></span>
<span id="cb49-35"><a href="#cb49-35" aria-hidden="true" tabindex="-1"></a>        <span class="co"># code = eliminate_dead_code(code) # (Pode ser caro iterar)</span></span>
<span id="cb49-36"><a href="#cb49-36" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb49-37"><a href="#cb49-37" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Convergiu? (requer __eq__ na classe Instruction)</span></span>
<span id="cb49-38"><a href="#cb49-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> code <span class="op">==</span> old_code:</span>
<span id="cb49-39"><a href="#cb49-39" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="cb49-40"><a href="#cb49-40" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb49-41"><a href="#cb49-41" aria-hidden="true" tabindex="-1"></a>        iteration <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb49-42"><a href="#cb49-42" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb49-43"><a href="#cb49-43" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Executar DCE uma vez no final</span></span>
<span id="cb49-44"><a href="#cb49-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># (Requer análise de liveness global para ser 100% correto)</span></span>
<span id="cb49-45"><a href="#cb49-45" aria-hidden="true" tabindex="-1"></a>    code <span class="op">=</span> eliminate_dead_code(code) </span>
<span id="cb49-46"><a href="#cb49-46" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb49-47"><a href="#cb49-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> code</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="métricas-de-otimização" class="level3" data-number="17.12.2">
<h3 data-number="17.12.2" class="anchored" data-anchor-id="métricas-de-otimização"><span class="header-section-number">17.12.2</span> Métricas de Otimização</h3>
<div class="sourceCode" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> count_expensive_ops(instructions):</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Conta operações custosas (multiplicação, divisão, etc.)."""</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>    expensive <span class="op">=</span> [<span class="st">'*'</span>, <span class="st">'/'</span>, <span class="st">'**'</span>, <span class="st">'LOAD'</span>, <span class="st">'STORE'</span>]</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">sum</span>(<span class="dv">1</span> <span class="cf">for</span> instr <span class="kw">in</span> instructions <span class="cf">if</span> instr.op <span class="kw">in</span> expensive)</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> count_temporaries(instructions):</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>    temps <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> instr <span class="kw">in</span> instructions:</span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> instr.dest <span class="kw">and</span> instr.dest.startswith(<span class="st">'t'</span>):</span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>            temps.add(instr.dest)</span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">len</span>(temps)</span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_optimization_metrics(original, optimized):</span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a><span class="co">    Calcula métricas para avaliar eficácia das otimizações.</span></span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb50-17"><a href="#cb50-17" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb50-18"><a href="#cb50-18" aria-hidden="true" tabindex="-1"></a><span class="co">        Dict com métricas</span></span>
<span id="cb50-19"><a href="#cb50-19" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb50-20"><a href="#cb50-20" aria-hidden="true" tabindex="-1"></a>    original_len <span class="op">=</span> <span class="bu">len</span>(original)</span>
<span id="cb50-21"><a href="#cb50-21" aria-hidden="true" tabindex="-1"></a>    optimized_len <span class="op">=</span> <span class="bu">len</span>(optimized)</span>
<span id="cb50-22"><a href="#cb50-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb50-23"><a href="#cb50-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb50-24"><a href="#cb50-24" aria-hidden="true" tabindex="-1"></a>        <span class="st">'original_instructions'</span>: original_len,</span>
<span id="cb50-25"><a href="#cb50-25" aria-hidden="true" tabindex="-1"></a>        <span class="st">'optimized_instructions'</span>: optimized_len,</span>
<span id="cb50-26"><a href="#cb50-26" aria-hidden="true" tabindex="-1"></a>        <span class="st">'instructions_removed'</span>: original_len <span class="op">-</span> optimized_len,</span>
<span id="cb50-27"><a href="#cb50-27" aria-hidden="true" tabindex="-1"></a>        <span class="st">'reduction_percentage'</span>: </span>
<span id="cb50-28"><a href="#cb50-28" aria-hidden="true" tabindex="-1"></a>            <span class="dv">100</span> <span class="op">*</span> (original_len <span class="op">-</span> optimized_len) <span class="op">/</span> original_len <span class="cf">if</span> original_len <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span>,</span>
<span id="cb50-29"><a href="#cb50-29" aria-hidden="true" tabindex="-1"></a>        <span class="st">'expensive_ops_reduced'</span>: </span>
<span id="cb50-30"><a href="#cb50-30" aria-hidden="true" tabindex="-1"></a>            count_expensive_ops(original) <span class="op">-</span> count_expensive_ops(optimized),</span>
<span id="cb50-31"><a href="#cb50-31" aria-hidden="true" tabindex="-1"></a>        <span class="st">'temporary_vars_eliminated'</span>:</span>
<span id="cb50-32"><a href="#cb50-32" aria-hidden="true" tabindex="-1"></a>            count_temporaries(original) <span class="op">-</span> count_temporaries(optimized)</span>
<span id="cb50-33"><a href="#cb50-33" aria-hidden="true" tabindex="-1"></a>    }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="considerações-de-implementação" class="level2" data-number="17.13">
<h2 data-number="17.13" class="anchored" data-anchor-id="considerações-de-implementação"><span class="header-section-number">17.13</span> Considerações de Implementação</h2>
<section id="representação-eficiente" class="level3" data-number="17.13.1">
<h3 data-number="17.13.1" class="anchored" data-anchor-id="representação-eficiente"><span class="header-section-number">17.13.1</span> Representação Eficiente</h3>
<p>Para compiladores de produção, usar estruturas de dados mais sofisticadas:</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> BasicBlock:</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Bloco básico otimizado com caching de análises."""</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, instructions):</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.instructions <span class="op">=</span> instructions</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.predecessors <span class="op">=</span> []</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.successors <span class="op">=</span> []</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._use_def_cache <span class="op">=</span> <span class="va">None</span></span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._dominators_cache <span class="op">=</span> <span class="va">None</span></span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">@property</span></span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> use_def_chains(<span class="va">self</span>):</span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>._use_def_cache <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>._use_def_cache <span class="op">=</span> build_use_def_chains(<span class="va">self</span>.instructions)</span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>._use_def_cache</span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> invalidate_caches(<span class="va">self</span>):</span>
<span id="cb51-17"><a href="#cb51-17" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Invalida caches após modificação."""</span></span>
<span id="cb51-18"><a href="#cb51-18" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._use_def_cache <span class="op">=</span> <span class="va">None</span></span>
<span id="cb51-19"><a href="#cb51-19" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._dominators_cache <span class="op">=</span> <span class="va">None</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="tratamento-de-tipos" class="level3" data-number="17.13.2">
<h3 data-number="17.13.2" class="anchored" data-anchor-id="tratamento-de-tipos"><span class="header-section-number">17.13.2</span> Tratamento de Tipos</h3>
<p>Otimizações devem preservar semântica de tipos:</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> type_safe_optimization(instr):</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Verifica se otimização preserva semântica de tipos.</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> instr.op <span class="op">==</span> <span class="st">'*'</span> <span class="kw">and</span> is_power_of_2(instr.arg2):</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Só aplicar shift se tipos são inteiros</span></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> get_type(instr.arg1) <span class="op">==</span> <span class="st">'int'</span> <span class="kw">and</span> get_type(instr.dest) <span class="op">==</span> <span class="st">'int'</span>:</span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> reduce_strength(instr)</span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> instr</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="exercícios" class="level2" data-number="17.14">
<h2 data-number="17.14" class="anchored" data-anchor-id="exercícios"><span class="header-section-number">17.14</span> Exercícios</h2>
<section id="exercício-1-otimização-completa" class="level3" data-number="17.14.1">
<h3 data-number="17.14.1" class="anchored" data-anchor-id="exercício-1-otimização-completa"><span class="header-section-number">17.14.1</span> Exercício 1: Otimização Completa</h3>
<p>Aplique todas as otimizações ao seguinte código:</p>
<pre><code>a = 7
b = a + 0
c = b * 2
d = c - a
e = d / 1
f = a + 0
result = e + f
RETURN result</code></pre>
<p><strong>Solução</strong>:</p>
<ol type="1">
<li><strong>(Iteração 1) Alg. Simp</strong>:
<ul>
<li><code>b = a + 0</code> <span class="math inline">\(\rightarrow\)</span> <code>b = a</code></li>
<li><code>e = d / 1</code> <span class="math inline">\(\rightarrow\)</span> <code>e = d</code></li>
<li><code>f = a + 0</code> <span class="math inline">\(\rightarrow\)</span> <code>f = a</code> Código: <code>a=7, b=a, c=b*2, d=c-a, e=d, f=a, result=e+f, RETURN result</code></li>
</ul></li>
<li><strong>(Iteração 1) Const. Prop</strong>:
<ul>
<li><code>a = 7</code> <span class="math inline">\(\rightarrow\)</span> <code>constants = {a: 7}</code></li>
<li><code>b = a</code> (Copy Prop) <span class="math inline">\(\rightarrow\)</span> <code>b = 7</code> (Const Prop) <span class="math inline">\(\rightarrow\)</span> <code>constants = {a: 7, b: 7}</code></li>
<li><code>c = b * 2</code> <span class="math inline">\(\rightarrow\)</span> <code>c = 7 * 2</code> <span class="math inline">\(\rightarrow\)</span> <code>c = 14</code> <span class="math inline">\(\rightarrow\)</span> <code>constants = {..., c: 14}</code></li>
<li><code>d = c - a</code> <span class="math inline">\(\rightarrow\)</span> <code>d = 14 - 7</code> <span class="math inline">\(\rightarrow\)</span> <code>d = 7</code> <span class="math inline">\(\rightarrow\)</span> <code>constants = {..., d: 7}</code></li>
<li><code>e = d</code> <span class="math inline">\(\rightarrow\)</span> <code>e = 7</code> <span class="math inline">\(\rightarrow\)</span> <code>constants = {..., e: 7}</code></li>
<li><code>f = a</code> <span class="math inline">\(\rightarrow\)</span> <code>f = 7</code> <span class="math inline">\(\rightarrow\)</span> <code>constants = {..., f: 7}</code></li>
<li><code>result = e + f</code> <span class="math inline">\(\rightarrow\)</span> <code>result = 7 + 7</code> <span class="math inline">\(\rightarrow\)</span> <code>result = 14</code> <span class="math inline">\(\rightarrow\)</span> <code>constants = {..., result: 14}</code> Código: <code>a=7, b=7, c=14, d=7, e=7, f=7, result=14, RETURN 14</code></li>
</ul></li>
<li><strong>(Iteração 2) Dead Code Elimination</strong>:
<ul>
<li><code>RETURN 14</code> é essencial. (A instrução <code>result = 14</code> define <code>result</code>, que é usado por <code>RETURN result</code> no código <em>antes</em> da propagação para o <code>RETURN</code>).</li>
<li>Assumindo <code>RETURN result</code> é o final, <code>result</code> é vivo.</li>
<li><code>result = 14</code> define <code>result</code>. É vivo.</li>
<li><code>a, b, c, d, e, f</code> não são usados por nenhuma instrução viva.</li>
<li>Código: <code>result = 14, RETURN result</code></li>
</ul></li>
<li><strong>(Iteração 3) Const Prop / Copy Prop</strong>:
<ul>
<li><code>RETURN result</code> <span class="math inline">\(\rightarrow\)</span> <code>RETURN 14</code></li>
<li>Código: <code>result = 14, RETURN 14</code></li>
</ul></li>
<li><strong>(Iteração 4) Dead Code</strong>:
<ul>
<li><code>RETURN 14</code> é essencial.</li>
<li><code>result = 14</code> define <code>result</code>, que não é mais usado. É morto.</li>
</ul></li>
</ol>
<p><strong>Código final</strong>:</p>
<pre><code>RETURN 14</code></pre>
</section>
<section id="exercício-2-strength-reduction-em-loop" class="level3" data-number="17.14.2">
<h3 data-number="17.14.2" class="anchored" data-anchor-id="exercício-2-strength-reduction-em-loop"><span class="header-section-number">17.14.2</span> Exercício 2: Strength Reduction em Loop</h3>
<p>Otimize o seguinte loop:</p>
<pre><code>i = 0
L1: if i &gt;= n goto L2
    t1 = i * 4
    a[t1] = 0
    i = i + 1
    goto L1
L2: return</code></pre>
<p><strong>Solução</strong>: Aplicar strength reduction substituindo multiplicação por adição (variável de indução).</p>
<pre><code>i = 0
j = 0  # Variável de indução j = i * 4
L1: if i &gt;= n goto L2
    a[j] = 0
    i = i + 1
    j = j + 4  # Incrementar j pelo passo (4)
    goto L1
L2: return</code></pre>
</section>
<section id="exercício-3-cse-e-dead-code" class="level3" data-number="17.14.3">
<h3 data-number="17.14.3" class="anchored" data-anchor-id="exercício-3-cse-e-dead-code"><span class="header-section-number">17.14.3</span> Exercício 3: CSE e Dead Code</h3>
<p>Identifique subexpressões comuns e código morto:</p>
<pre><code>t1 = a + b
t2 = c * d
t3 = a + b
t4 = t1 + t3
t5 = t2 - t2
result = t4
RETURN result</code></pre>
<p><strong>Solução</strong>:</p>
<ol type="1">
<li><strong>CSE</strong>: <code>t3 = a + b</code> é comum com <code>t1</code>.
<ul>
<li>Substituir: <code>t3 = t1</code> Código: <code>t1=a+b, t2=c*d, t3=t1, t4=t1+t3, t5=t2-t2, result=t4, RETURN result</code></li>
</ul></li>
<li><strong>Copy Propagation</strong>:
<ul>
<li><code>t4 = t1 + t3</code> <span class="math inline">\(\rightarrow\)</span> <code>t4 = t1 + t1</code> Código: <code>t1=a+b, t2=c*d, t3=t1, t4=t1+t1, t5=t2-t2, result=t4, RETURN result</code></li>
</ul></li>
<li><strong>Algebraic Simplification</strong>:
<ul>
<li><code>t5 = t2 - t2</code> <span class="math inline">\(\rightarrow\)</span> <code>t5 = 0</code></li>
<li>(Opcional) <code>t4 = t1 + t1</code> <span class="math inline">\(\rightarrow\)</span> <code>t4 = t1 * 2</code> (ou <code>t4 = t1 &lt;&lt; 1</code>) Código: <code>t1=a+b, t2=c*d, t3=t1, t4=t1*2, t5=0, result=t4, RETURN result</code></li>
</ul></li>
<li><strong>Dead Code Elimination</strong>:
<ul>
<li><code>RETURN result</code> é vivo.</li>
<li><code>result = t4</code> é vivo.</li>
<li><code>t4 = t1 * 2</code> é vivo.</li>
<li><code>t1 = a + b</code> é vivo.</li>
<li><code>t2 = c * d</code>, <code>t3 = t1</code>, <code>t5 = 0</code> são mortos (seus resultados não são usados).</li>
</ul></li>
<li><strong>Código otimizado</strong>:</li>
</ol>
<pre><code>t1 = a + b
t4 = t1 * 2
result = t4
RETURN result</code></pre>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/frankalcantara\.com");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./15-llvmIR.html" class="pagination-link" aria-label="Introdução à Representação Intermediária (IR) do LLVM com C++">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Introdução à Representação Intermediária (IR) do LLVM com C++</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./fase1.html" class="pagination-link" aria-label="Fase 1 - Projeto Prático">
        <span class="nav-page-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Fase 1 - Projeto Prático</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
<p>Copyright © 2025 Frank de Alcantara</p>
<div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/frankalcantara/linguagens-formais/edit/main/16-peepOtimiza.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/frankalcantara/linguagens-formais/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>