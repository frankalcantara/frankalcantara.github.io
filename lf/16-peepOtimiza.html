<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.553">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Linguagens Formais e Autômatos - 17&nbsp; Otimizações Peephole: Algoritmos e Técnicas em Código Intermediário</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./19-mlir-sintaxe.html" rel="next">
<link href="./15-llvmIR.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles/custom.css">
</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./14-GeraInter.html">Geração de Código Intermediário</a></li><li class="breadcrumb-item"><a href="./16-peepOtimiza.html"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Otimizações Peephole: Algoritmos e Técnicas em Código Intermediário</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Linguagens Formais e Autômatos</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/frankalcantara/linguagens-formais" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Disciplina de Linguagens Formais</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Analisadores Léxicos</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-lexico.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Analisadores Léxicos</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01a-lexico.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Alfabetos, Linguagens e Strings: Fundamentos Matemáticos</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-lexico.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Autômatos Finitos Determinísticos</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">Analisadores Sintáticos</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04-Gramaticas.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Gramáticas e Linguagens Livres de Contexto</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05-parsersLL1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Parsers LL(1): Começando a Análise Sintática</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06-first-follow.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Conjuntos FIRST e FOLLOW</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07-parserLR1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Parsers <span class="math inline">\(LR(1)\)</span>: Análise Sintática <em>bottom-up</em></span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08-parserSLR1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Parsers <span class="math inline">\(SLR(1)\)</span>: A Ponte Entre Simplicidade e Poder</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
 <span class="menu-text">Analisadores Semânticos</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10-semantico.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Analisadores Semânticos: a determinação do significado</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10a-semantico.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Fundamentos Matemáticos da Semântica</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10b-semantico.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Julgamento de Tipos em Linguagens Imperativas</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10c-semantico.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">O Sistema de Tipos Hindley-Milner</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./11-tabelaSimbolos.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Tabela de Símbolos em Compiladores Modernos</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
 <span class="menu-text">Geração de Código Intermediário</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./14-GeraInter.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Geração de Código Intermediário: A Linguagem Universal do Compilador</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./15-llvmIR.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Introdução à Representação Intermediária (IR) do <strong>LLVM</strong> com C++</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./16-peepOtimiza.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Otimizações Peephole: Algoritmos e Técnicas em Código Intermediário</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./19-mlir-sintaxe.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title"><strong>MLIR</strong> 101: Nosso Primeiro Exemplo e Sintaxe Básica</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./20-mlir-plano.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Aula: Princípios e Abstrações do MLIR</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./21-mlir-arch.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title"><strong>MLIR: Uma Análise Exaustiva dos Passes e do Abaixamento Multi-Nível na Engenharia Moderna de Compiladores</strong></span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">
 <span class="menu-text">Projetos da Disciplina - 2025-2</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./fase1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Fase 1 - Projeto Prático</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./fase2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">Fase 2 - Analisador Sintático <span class="math inline">\(LL(1)\)</span></span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./fase3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">23</span>&nbsp; <span class="chapter-title">Fase 3 - Analisador Semântico</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./fase4.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">24</span>&nbsp; <span class="chapter-title">Fase 4 - Geração de Código Intermediário e Assembly</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./apend1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">25</span>&nbsp; <span class="chapter-title">Apêndice 1: A Relação de Myhill-Nerode</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./sol-exercicios.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">26</span>&nbsp; <span class="chapter-title">Solução dos Exercícios</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./referencias.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Referências</span></a>
  </div>
</li>
    </ul>
    </div>
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Sumário</h2>
   
  <ul>
  <li><a href="#primeiros-passos-conceitos-e-estruturas-de-dados" id="toc-primeiros-passos-conceitos-e-estruturas-de-dados" class="nav-link active" data-scroll-target="#primeiros-passos-conceitos-e-estruturas-de-dados"><span class="header-section-number">17.1</span> Primeiros passos, conceitos e Estruturas de Dados</a>
  <ul class="collapse">
  <li><a href="#estrutura-básica-do-tac" id="toc-estrutura-básica-do-tac" class="nav-link" data-scroll-target="#estrutura-básica-do-tac"><span class="header-section-number">17.1.1</span> Estrutura Básica do TAC</a></li>
  <li><a href="#estruturas-de-dados-fundamentais" id="toc-estruturas-de-dados-fundamentais" class="nav-link" data-scroll-target="#estruturas-de-dados-fundamentais"><span class="header-section-number">17.1.2</span> Estruturas de Dados Fundamentais</a></li>
  </ul></li>
  <li><a href="#eliminação-de-código-morto-dead-code-elimination" id="toc-eliminação-de-código-morto-dead-code-elimination" class="nav-link" data-scroll-target="#eliminação-de-código-morto-dead-code-elimination"><span class="header-section-number">17.2</span> Eliminação de Código Morto (<em>Dead Code Elimination</em>)</a>
  <ul class="collapse">
  <li><a href="#algoritmo-com-exemplo-em-python" id="toc-algoritmo-com-exemplo-em-python" class="nav-link" data-scroll-target="#algoritmo-com-exemplo-em-python"><span class="header-section-number">17.2.1</span> Algoritmo Com Exemplo em Python</a></li>
  <li><a href="#exemplo-completo-em-c23" id="toc-exemplo-completo-em-c23" class="nav-link" data-scroll-target="#exemplo-completo-em-c23"><span class="header-section-number">17.2.2</span> Exemplo Completo em C++23</a></li>
  </ul></li>
  <li><a href="#movimentação-de-código-invariante-de-laço-loop-invariant-code-motion---licm" id="toc-movimentação-de-código-invariante-de-laço-loop-invariant-code-motion---licm" class="nav-link" data-scroll-target="#movimentação-de-código-invariante-de-laço-loop-invariant-code-motion---licm"><span class="header-section-number">17.3</span> Movimentação de Código Invariante de Laço (<em>Loop Invariant Code Motion - LICM</em>)</a>
  <ul class="collapse">
  <li><a href="#condições-de-invariância" id="toc-condições-de-invariância" class="nav-link" data-scroll-target="#condições-de-invariância"><span class="header-section-number">17.3.1</span> Condições de Invariância</a></li>
  <li><a href="#algoritmo-simplificado-modelo-peephole-para-licm" id="toc-algoritmo-simplificado-modelo-peephole-para-licm" class="nav-link" data-scroll-target="#algoritmo-simplificado-modelo-peephole-para-licm"><span class="header-section-number">17.3.2</span> Algoritmo Simplificado (Modelo <em>Peephole</em> para LICM)</a></li>
  <li><a href="#exemplo-de-aplicação-e-benefício" id="toc-exemplo-de-aplicação-e-benefício" class="nav-link" data-scroll-target="#exemplo-de-aplicação-e-benefício"><span class="header-section-number">17.3.3</span> Exemplo de Aplicação e Benefício</a></li>
  <li><a href="#exemplo-em-c23" id="toc-exemplo-em-c23" class="nav-link" data-scroll-target="#exemplo-em-c23"><span class="header-section-number">17.3.4</span> Exemplo em C++23</a></li>
  </ul></li>
  <li><a href="#propagação-de-constantes-constant-propagation" id="toc-propagação-de-constantes-constant-propagation" class="nav-link" data-scroll-target="#propagação-de-constantes-constant-propagation"><span class="header-section-number">17.4</span> Propagação de Constantes (<em>Constant Propagation</em>)</a>
  <ul class="collapse">
  <li><a href="#algoritmo" id="toc-algoritmo" class="nav-link" data-scroll-target="#algoritmo"><span class="header-section-number">17.4.1</span> Algoritmo</a></li>
  <li><a href="#exemplo-completo" id="toc-exemplo-completo" class="nav-link" data-scroll-target="#exemplo-completo"><span class="header-section-number">17.4.2</span> Exemplo Completo</a></li>
  <li><a href="#propagação-condicional" id="toc-propagação-condicional" class="nav-link" data-scroll-target="#propagação-condicional"><span class="header-section-number">17.4.3</span> Propagação Condicional</a></li>
  </ul></li>
  <li><a href="#eliminação-de-subexpressões-comuns-common-subexpression-elimination---cse" id="toc-eliminação-de-subexpressões-comuns-common-subexpression-elimination---cse" class="nav-link" data-scroll-target="#eliminação-de-subexpressões-comuns-common-subexpression-elimination---cse"><span class="header-section-number">17.5</span> Eliminação de Subexpressões Comuns (<em>Common Subexpression Elimination - CSE</em>)</a>
  <ul class="collapse">
  <li><a href="#algoritmo-local-value-numbering-local" id="toc-algoritmo-local-value-numbering-local" class="nav-link" data-scroll-target="#algoritmo-local-value-numbering-local"><span class="header-section-number">17.5.1</span> Algoritmo Local (Value Numbering Local)</a></li>
  <li><a href="#exemplo-em-c23-1" id="toc-exemplo-em-c23-1" class="nav-link" data-scroll-target="#exemplo-em-c23-1"><span class="header-section-number">17.5.2</span> Exemplo em C++23</a></li>
  </ul></li>
  <li><a href="#simplificação-algébrica-algebraic-simplification" id="toc-simplificação-algébrica-algebraic-simplification" class="nav-link" data-scroll-target="#simplificação-algébrica-algebraic-simplification"><span class="header-section-number">17.6</span> Simplificação Algébrica (<em>Algebraic Simplification</em>)</a>
  <ul class="collapse">
  <li><a href="#identidades-implementadas" id="toc-identidades-implementadas" class="nav-link" data-scroll-target="#identidades-implementadas"><span class="header-section-number">17.6.1</span> Identidades Implementadas</a></li>
  <li><a href="#algoritmo-1" id="toc-algoritmo-1" class="nav-link" data-scroll-target="#algoritmo-1"><span class="header-section-number">17.6.2</span> Algoritmo</a></li>
  <li><a href="#exemplo-com-múltiplas-identidades" id="toc-exemplo-com-múltiplas-identidades" class="nav-link" data-scroll-target="#exemplo-com-múltiplas-identidades"><span class="header-section-number">17.6.3</span> Exemplo com Múltiplas Identidades</a></li>
  </ul></li>
  <li><a href="#strength-reduction" id="toc-strength-reduction" class="nav-link" data-scroll-target="#strength-reduction"><span class="header-section-number">17.7</span> Strength Reduction</a>
  <ul class="collapse">
  <li><a href="#hierarquia-de-custos" id="toc-hierarquia-de-custos" class="nav-link" data-scroll-target="#hierarquia-de-custos"><span class="header-section-number">17.7.1</span> Hierarquia de Custos</a></li>
  <li><a href="#algoritmo-2" id="toc-algoritmo-2" class="nav-link" data-scroll-target="#algoritmo-2"><span class="header-section-number">17.7.2</span> Algoritmo</a></li>
  <li><a href="#análise-de-economia" id="toc-análise-de-economia" class="nav-link" data-scroll-target="#análise-de-economia"><span class="header-section-number">17.7.3</span> Análise de Economia</a></li>
  <li><a href="#strength-reduction-em-loops" id="toc-strength-reduction-em-loops" class="nav-link" data-scroll-target="#strength-reduction-em-loops"><span class="header-section-number">17.7.4</span> Strength Reduction em Loops</a></li>
  <li><a href="#tabelas-de-strength-reduction-referência-completa" id="toc-tabelas-de-strength-reduction-referência-completa" class="nav-link" data-scroll-target="#tabelas-de-strength-reduction-referência-completa"><span class="header-section-number">17.7.5</span> Tabelas de Strength Reduction: Referência Completa</a></li>
  <li><a href="#notas-de-implementação" id="toc-notas-de-implementação" class="nav-link" data-scroll-target="#notas-de-implementação"><span class="header-section-number">17.7.6</span> Notas de Implementação</a></li>
  </ul></li>
  <li><a href="#propagação-de-cópias-copy-propagation" id="toc-propagação-de-cópias-copy-propagation" class="nav-link" data-scroll-target="#propagação-de-cópias-copy-propagation"><span class="header-section-number">17.8</span> Propagação de Cópias (Copy Propagation)</a>
  <ul class="collapse">
  <li><a href="#algoritmo-3" id="toc-algoritmo-3" class="nav-link" data-scroll-target="#algoritmo-3"><span class="header-section-number">17.8.1</span> Algoritmo</a></li>
  <li><a href="#interação-com-outras-otimizações" id="toc-interação-com-outras-otimizações" class="nav-link" data-scroll-target="#interação-com-outras-otimizações"><span class="header-section-number">17.8.2</span> Interação com Outras Otimizações</a></li>
  <li><a href="#análise-de-alias" id="toc-análise-de-alias" class="nav-link" data-scroll-target="#análise-de-alias"><span class="header-section-number">17.8.3</span> Análise de Alias</a></li>
  </ul></li>
  <li><a href="#eliminação-de-subexpressões-comuns-common-subexpression-elimination" id="toc-eliminação-de-subexpressões-comuns-common-subexpression-elimination" class="nav-link" data-scroll-target="#eliminação-de-subexpressões-comuns-common-subexpression-elimination"><span class="header-section-number">17.9</span> Eliminação de Subexpressões Comuns (Common Subexpression Elimination)</a>
  <ul class="collapse">
  <li><a href="#algoritmo-local" id="toc-algoritmo-local" class="nav-link" data-scroll-target="#algoritmo-local"><span class="header-section-number">17.9.1</span> Algoritmo Local</a></li>
  <li><a href="#cse-global" id="toc-cse-global" class="nav-link" data-scroll-target="#cse-global"><span class="header-section-number">17.9.2</span> CSE Global</a></li>
  <li><a href="#exemplo-detalhado" id="toc-exemplo-detalhado" class="nav-link" data-scroll-target="#exemplo-detalhado"><span class="header-section-number">17.9.3</span> Exemplo Detalhado</a></li>
  </ul></li>
  <li><a href="#otimização-de-branches" id="toc-otimização-de-branches" class="nav-link" data-scroll-target="#otimização-de-branches"><span class="header-section-number">17.10</span> Otimização de Branches</a>
  <ul class="collapse">
  <li><a href="#técnicas-implementadas" id="toc-técnicas-implementadas" class="nav-link" data-scroll-target="#técnicas-implementadas"><span class="header-section-number">17.10.1</span> Técnicas Implementadas</a></li>
  <li><a href="#algoritmo-4" id="toc-algoritmo-4" class="nav-link" data-scroll-target="#algoritmo-4"><span class="header-section-number">17.10.2</span> Algoritmo</a></li>
  <li><a href="#exemplo-complexo" id="toc-exemplo-complexo" class="nav-link" data-scroll-target="#exemplo-complexo"><span class="header-section-number">17.10.3</span> Exemplo Complexo</a></li>
  <li><a href="#branch-prediction-e-otimização" id="toc-branch-prediction-e-otimização" class="nav-link" data-scroll-target="#branch-prediction-e-otimização"><span class="header-section-number">17.10.4</span> Branch Prediction e Otimização</a></li>
  </ul></li>
  <li><a href="#eliminação-de-loadstore-redundantes" id="toc-eliminação-de-loadstore-redundantes" class="nav-link" data-scroll-target="#eliminação-de-loadstore-redundantes"><span class="header-section-number">17.11</span> Eliminação de Load/Store Redundantes</a>
  <ul class="collapse">
  <li><a href="#padrões-detectados" id="toc-padrões-detectados" class="nav-link" data-scroll-target="#padrões-detectados"><span class="header-section-number">17.11.1</span> Padrões Detectados</a></li>
  <li><a href="#algoritmo-5" id="toc-algoritmo-5" class="nav-link" data-scroll-target="#algoritmo-5"><span class="header-section-number">17.11.2</span> Algoritmo</a></li>
  <li><a href="#exemplo-com-store-load" id="toc-exemplo-com-store-load" class="nav-link" data-scroll-target="#exemplo-com-store-load"><span class="header-section-number">17.11.3</span> Exemplo com Store-Load</a></li>
  </ul></li>
  <li><a href="#eliminação-de-código-inalcançável" id="toc-eliminação-de-código-inalcançável" class="nav-link" data-scroll-target="#eliminação-de-código-inalcançável"><span class="header-section-number">17.12</span> Eliminação de Código Inalcançável</a>
  <ul class="collapse">
  <li><a href="#algoritmo-baseado-em-alcançabilidade" id="toc-algoritmo-baseado-em-alcançabilidade" class="nav-link" data-scroll-target="#algoritmo-baseado-em-alcançabilidade"><span class="header-section-number">17.12.1</span> Algoritmo Baseado em Alcançabilidade</a></li>
  <li><a href="#eliminação-de-código-após-return" id="toc-eliminação-de-código-após-return" class="nav-link" data-scroll-target="#eliminação-de-código-após-return"><span class="header-section-number">17.12.2</span> Eliminação de Código Após Return</a></li>
  <li><a href="#análise-de-condições-constantes" id="toc-análise-de-condições-constantes" class="nav-link" data-scroll-target="#análise-de-condições-constantes"><span class="header-section-number">17.12.3</span> Análise de Condições Constantes</a></li>
  <li><a href="#exemplo-completo-1" id="toc-exemplo-completo-1" class="nav-link" data-scroll-target="#exemplo-completo-1"><span class="header-section-number">17.12.4</span> Exemplo Completo</a></li>
  </ul></li>
  <li><a href="#integração-e-ordem-de-aplicação" id="toc-integração-e-ordem-de-aplicação" class="nav-link" data-scroll-target="#integração-e-ordem-de-aplicação"><span class="header-section-number">17.13</span> Integração e Ordem de Aplicação</a>
  <ul class="collapse">
  <li><a href="#pipeline-de-otimização" id="toc-pipeline-de-otimização" class="nav-link" data-scroll-target="#pipeline-de-otimização"><span class="header-section-number">17.13.1</span> Pipeline de Otimização</a></li>
  <li><a href="#métricas-de-otimização" id="toc-métricas-de-otimização" class="nav-link" data-scroll-target="#métricas-de-otimização"><span class="header-section-number">17.13.2</span> Métricas de Otimização</a></li>
  </ul></li>
  <li><a href="#considerações-de-implementação" id="toc-considerações-de-implementação" class="nav-link" data-scroll-target="#considerações-de-implementação"><span class="header-section-number">17.14</span> Considerações de Implementação</a>
  <ul class="collapse">
  <li><a href="#representação-eficiente" id="toc-representação-eficiente" class="nav-link" data-scroll-target="#representação-eficiente"><span class="header-section-number">17.14.1</span> Representação Eficiente</a></li>
  <li><a href="#tratamento-de-tipos" id="toc-tratamento-de-tipos" class="nav-link" data-scroll-target="#tratamento-de-tipos"><span class="header-section-number">17.14.2</span> Tratamento de Tipos</a></li>
  </ul></li>
  <li><a href="#exercícios" id="toc-exercícios" class="nav-link" data-scroll-target="#exercícios"><span class="header-section-number">17.15</span> Exercícios</a>
  <ul class="collapse">
  <li><a href="#exercício-1-otimização-completa" id="toc-exercício-1-otimização-completa" class="nav-link" data-scroll-target="#exercício-1-otimização-completa"><span class="header-section-number">17.15.1</span> Exercício 1: Otimização Completa</a></li>
  <li><a href="#exercício-2-strength-reduction-em-loop" id="toc-exercício-2-strength-reduction-em-loop" class="nav-link" data-scroll-target="#exercício-2-strength-reduction-em-loop"><span class="header-section-number">17.15.2</span> Exercício 2: Strength Reduction em Loop</a></li>
  <li><a href="#exercício-3-cse-e-dead-code" id="toc-exercício-3-cse-e-dead-code" class="nav-link" data-scroll-target="#exercício-3-cse-e-dead-code"><span class="header-section-number">17.15.3</span> Exercício 3: CSE e Dead Code</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/frankalcantara/linguagens-formais/edit/main/16-peepOtimiza.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/frankalcantara/linguagens-formais/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./14-GeraInter.html">Geração de Código Intermediário</a></li><li class="breadcrumb-item"><a href="./16-peepOtimiza.html"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Otimizações Peephole: Algoritmos e Técnicas em Código Intermediário</span></a></li></ol></nav>
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Otimizações Peephole: Algoritmos e Técnicas em Código Intermediário</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>As otimizações <em>peephole</em> são técnicas de otimização local que operam sobre uma pequena janela deslizante de instruções adjacentes no código intermediário. O termo “peephole” (buraco de fechadura) reflete a natureza dessas otimizações: elas “espiam” através de uma pequena abertura no código, identificando padrões específicos que podem ser melhorados. Diferentemente de otimizações globais, que exigem análise de fluxo de dados em todo o programa, as otimizações <em>peephole</em> são rápidas, simples de implementar e podem ser aplicadas repetidamente até convergência.</p>
<p>A eficácia das otimizações <em>peephole</em> reside em sua capacidade de eliminar ineficiências introduzidas durante a geração de código intermediário. Compiladores frequentemente geram código conservador e redundante para manter a correção e simplicidade do gerador de código. As otimizações <em>peephole</em> atuam como um pós-processador, refinando esse código através de transformações locais baseadas em padrões.</p>
<section id="primeiros-passos-conceitos-e-estruturas-de-dados" class="level2" data-number="17.1">
<h2 data-number="17.1" class="anchored" data-anchor-id="primeiros-passos-conceitos-e-estruturas-de-dados"><span class="header-section-number">17.1</span> Primeiros passos, conceitos e Estruturas de Dados</h2>
<p>Antes de explorarmos as técnicas específicas, é fundamental que a esforçada leitora relembre o básico da representação de código sobre a qual essas otimizações operam. O <strong>Three Address Code</strong> (TAC) é uma representação intermediária que se aproxima da linguagem de máquina mantendo independência de arquitetura. Cada instrução TAC tem no máximo três endereços, operandos, e realiza uma única operação elementar.</p>
<section id="estrutura-básica-do-tac" class="level3" data-number="17.1.1">
<h3 data-number="17.1.1" class="anchored" data-anchor-id="estrutura-básica-do-tac"><span class="header-section-number">17.1.1</span> Estrutura Básica do TAC</h3>
<p>Uma instrução TAC típica segue a forma:</p>
<pre class="shell"><code>resultado = operando1 operador operando2</code></pre>
<p>Exemplos de instruções TAC:</p>
<pre class="shell"><code>t1 = a + b        # Adição
t2 = t1 * c       # Multiplicação
x = t2            # Atribuição
if x &gt; 0 goto L1   # Branch condicional
goto L2           # Branch incondicional</code></pre>
<p>As variáveis temporárias (<span class="math inline">\(t1\)</span>, <span class="math inline">\(t2\)</span>, …) são criadas conforme necessário para armazenar resultados intermediários. Esta linearização de expressões complexas facilita tanto a análise quanto a transformação do código.</p>
</section>
<section id="estruturas-de-dados-fundamentais" class="level3" data-number="17.1.2">
<h3 data-number="17.1.2" class="anchored" data-anchor-id="estruturas-de-dados-fundamentais"><span class="header-section-number">17.1.2</span> Estruturas de Dados Fundamentais</h3>
<p>A implementação eficiente de otimizações <em>peephole</em> requer estruturas de dados apropriadas para representar e manipular o código intermediário.</p>
<section id="representação-de-instruções" class="level4" data-number="17.1.2.1">
<h4 data-number="17.1.2.1" class="anchored" data-anchor-id="representação-de-instruções"><span class="header-section-number">17.1.2.1</span> Representação de Instruções</h4>
<p>Considere o exemplo a seguir, que define uma classe simples para representar instruções TAC:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Instruction:</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, op, dest<span class="op">=</span><span class="va">None</span>, arg1<span class="op">=</span><span class="va">None</span>, arg2<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.op <span class="op">=</span> op        <span class="co"># Operador ('+', '-', '*', '/', 'ASSIGN', etc.)</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dest <span class="op">=</span> dest    <span class="co"># Variável destino</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.arg1 <span class="op">=</span> arg1    <span class="co"># Primeiro operando</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.arg2 <span class="op">=</span> arg2    <span class="co"># Segundo operando</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__str__</span>(<span class="va">self</span>):</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.op <span class="kw">in</span> [<span class="st">'+'</span>, <span class="st">'-'</span>, <span class="st">'*'</span>, <span class="st">'/'</span>, <span class="st">'&lt;&lt;'</span>, <span class="st">'&gt;&gt;'</span>, <span class="st">'**'</span>]:</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="ss">f"</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>dest<span class="sc">}</span><span class="ss"> = </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>arg1<span class="sc">}</span><span class="ss"> </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>op<span class="sc">}</span><span class="ss"> </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>arg2<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> <span class="va">self</span>.op <span class="op">==</span> <span class="st">'ASSIGN'</span>:</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="ss">f"</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>dest<span class="sc">}</span><span class="ss"> = </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>arg1<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> <span class="va">self</span>.op <span class="op">==</span> <span class="st">'GOTO'</span>:</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="ss">f"goto </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>dest<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> <span class="va">self</span>.op <span class="kw">in</span> [<span class="st">'IF_GT'</span>, <span class="st">'IF_LT'</span>, <span class="st">'IF_EQ'</span>]:</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="ss">f"if </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>arg1<span class="sc">}</span><span class="ss"> </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>op<span class="sc">}</span><span class="ss"> </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>arg2<span class="sc">}</span><span class="ss"> goto </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>dest<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> <span class="va">self</span>.op <span class="op">==</span> <span class="st">'LABEL'</span>:</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="ss">f"</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>dest<span class="sc">}</span><span class="ss">:"</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> <span class="va">self</span>.op <span class="op">==</span> <span class="st">'LOAD'</span>:</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="ss">f"</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>dest<span class="sc">}</span><span class="ss"> = load </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>arg1<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> <span class="va">self</span>.op <span class="op">==</span> <span class="st">'STORE'</span>:</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="ss">f"store </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>arg1<span class="sc">}</span><span class="ss">, </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>arg2<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="ss">f"</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>op<span class="sc">}</span><span class="ss"> </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>dest<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__eq__</span>(<span class="va">self</span>, other):</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Necessário para verificação de convergência."""</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="bu">isinstance</span>(other, Instruction):</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.op <span class="op">==</span> other.op <span class="kw">and</span> <span class="op">\</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>               <span class="va">self</span>.dest <span class="op">==</span> other.dest <span class="kw">and</span> <span class="op">\</span></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>               <span class="va">self</span>.arg1 <span class="op">==</span> other.arg1 <span class="kw">and</span> <span class="op">\</span></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>               <span class="va">self</span>.arg2 <span class="op">==</span> other.arg2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="tabela-de-definições" class="level4" data-number="17.1.2.2">
<h4 data-number="17.1.2.2" class="anchored" data-anchor-id="tabela-de-definições"><span class="header-section-number">17.1.2.2</span> Tabela de Definições</h4>
<p>Para rastrear em que ponto do código variáveis são definidas, podemos utilizar uma estrutura que mapeie cada variável à instrução que a define:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>definitions <span class="op">=</span> {}  <span class="co"># variável -&gt; instrução que a define</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>uses <span class="op">=</span> {}         <span class="co"># variável -&gt; conjunto de instruções que a usam</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
</section>
<section id="eliminação-de-código-morto-dead-code-elimination" class="level2" data-number="17.2">
<h2 data-number="17.2" class="anchored" data-anchor-id="eliminação-de-código-morto-dead-code-elimination"><span class="header-section-number">17.2</span> Eliminação de Código Morto (<em>Dead Code Elimination</em>)</h2>
<p>A eliminação de código morto remove instruções cujos resultados nunca são utilizados. Esta otimização é fundamental, pois código não utilizado consome recursos de compilação, aumenta o tamanho do executável e pode mascarar outras oportunidades de otimização.</p>
<section id="algoritmo-com-exemplo-em-python" class="level3" data-number="17.2.1">
<h3 data-number="17.2.1" class="anchored" data-anchor-id="algoritmo-com-exemplo-em-python"><span class="header-section-number">17.2.1</span> Algoritmo Com Exemplo em Python</h3>
<p>O algoritmo opera em duas fases: marcação (<em>mark</em>) e remoção (<em>sweep</em>), inspirado em algoritmos de coleta de lixo.</p>
<p><strong>Fase 1: Construção das Cadeias de Uso-Definição (<em>Use-Def Chains</em>)</strong></p>
<div class="sourceCode" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> build_use_def_chains(instructions):</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Constrói cadeias de uso-definição para todas as variáveis.</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="co">        instructions: Lista de instruções TAC</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="co">        definitions: Dicionário {variável: instrução que define}</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="co">        uses: Dicionário {variável: conjunto de instruções que usam}</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    definitions <span class="op">=</span> {}</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    uses <span class="op">=</span> {}</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># assumes is_variable() é uma função auxiliar</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> is_variable(val):</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">isinstance</span>(val, <span class="bu">str</span>) <span class="kw">and</span> (val[<span class="dv">0</span>].isalpha() <span class="kw">or</span> val[<span class="dv">0</span>] <span class="op">==</span> <span class="st">'t'</span>)</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> instr <span class="kw">in</span> instructions:</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Registrar definição</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Assumindo que 'dest' em GOTO/IF é um label, não uma variável</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> instr.dest <span class="kw">and</span> instr.op <span class="kw">not</span> <span class="kw">in</span> [<span class="st">'GOTO'</span>, <span class="st">'IF_GT'</span>, <span class="st">'IF_LT'</span>, <span class="st">'IF_EQ'</span>, <span class="st">'LABEL'</span>]:</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>            definitions[instr.dest] <span class="op">=</span> instr</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Registrar usos</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> var <span class="kw">in</span> [instr.arg1, instr.arg2]:</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> var <span class="kw">and</span> is_variable(var):</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> var <span class="kw">not</span> <span class="kw">in</span> uses:</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>                    uses[var] <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>                uses[var].add(instr)</span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Casos especiais de uso (e.g., branch condicional, store)</span></span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> instr.op <span class="kw">in</span> [<span class="st">'IF_GT'</span>, <span class="st">'IF_LT'</span>, <span class="st">'IF_EQ'</span>, <span class="st">'STORE'</span>, <span class="st">'RETURN'</span>]:</span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>             <span class="cf">if</span> instr.arg1 <span class="kw">and</span> is_variable(instr.arg1):</span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> instr.arg1 <span class="kw">not</span> <span class="kw">in</span> uses: uses[instr.arg1] <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>                uses[instr.arg1].add(instr)</span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>             <span class="cf">if</span> instr.arg2 <span class="kw">and</span> is_variable(instr.arg2):</span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> instr.arg2 <span class="kw">not</span> <span class="kw">in</span> uses: uses[instr.arg2] <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>                uses[instr.arg2].add(instr)</span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> definitions, uses</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Fase 2: Marcação de Código Vivo</strong></p>
<div class="sourceCode" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mark_live_code(instructions, definitions, uses):</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Marca instruções que são essenciais (live).</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Uma instrução é essencial se:</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="co">    1. Tem efeito colateral (I/O, chamada de função, store)</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="co">    2. Define uma variável usada por instrução essencial</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="co">    3. É uma instrução de controle (branch, return)</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    live <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    worklist <span class="op">=</span> []</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Inicializar com instruções essenciais</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> instr <span class="kw">in</span> instructions:</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> is_essential(instr):</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>            live.add(instr)</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>            worklist.append(instr)</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Propagar marcação</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> worklist:</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>        instr <span class="op">=</span> worklist.pop()</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Marcar instruções que definem operandos usados</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>        operands <span class="op">=</span> [instr.arg1, instr.arg2]</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> instr.op <span class="kw">in</span> [<span class="st">'STORE'</span>]: <span class="co"># store val, addr -&gt; val é arg1, addr é arg2</span></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>            operands <span class="op">=</span> [instr.arg1, instr.arg2]</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> instr.op <span class="kw">in</span> [<span class="st">'IF_GT'</span>, <span class="st">'IF_LT'</span>, <span class="st">'IF_EQ'</span>]: <span class="co"># if arg1 op arg2</span></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>            operands <span class="op">=</span> [instr.arg1, instr.arg2]</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> instr.op <span class="op">==</span> <span class="st">'RETURN'</span>: <span class="co"># return arg1</span></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>            operands <span class="op">=</span> [instr.arg1]</span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> var <span class="kw">in</span> operands:</span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> var <span class="kw">in</span> definitions:</span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>                def_instr <span class="op">=</span> definitions[var]</span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> def_instr <span class="kw">not</span> <span class="kw">in</span> live:</span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>                    live.add(def_instr)</span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>                    worklist.append(def_instr)</span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> live</span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> is_essential(instr):</span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Verifica se instrução tem efeito colateral ou é crítica."""</span></span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a>    <span class="co"># STORE é essencial (efeito colateral na memória)</span></span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> instr.op <span class="kw">in</span> [<span class="st">'RETURN'</span>, <span class="st">'CALL'</span>, <span class="st">'PRINT'</span>, <span class="st">'GOTO'</span>, </span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'IF_GT'</span>, <span class="st">'IF_LT'</span>, <span class="st">'IF_EQ'</span>, <span class="st">'STORE'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Fase 3: Remoção</strong></p>
<div class="sourceCode" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> eliminate_dead_code(instructions):</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Remove instruções mortas."""</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    definitions, uses <span class="op">=</span> build_use_def_chains(instructions)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    live <span class="op">=</span> mark_live_code(instructions, definitions, uses)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [instr <span class="cf">for</span> instr <span class="kw">in</span> instructions <span class="cf">if</span> instr <span class="kw">in</span> live]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section id="exemplo-de-aplicação" class="level4" data-number="17.2.1.1">
<h4 data-number="17.2.1.1" class="anchored" data-anchor-id="exemplo-de-aplicação"><span class="header-section-number">17.2.1.1</span> Exemplo de Aplicação</h4>
<p><strong>Antes</strong>:</p>
<pre class="shell"><code>t1 = a + b
t2 = c * d    # Código morto - t2 nunca usado
t3 = t1 + 5
x = t3
RETURN x      # Essencial (assumindo x é o retorno)</code></pre>
<p><strong>Depois</strong>: (O algoritmo marcaria <code>RETURN x</code> como essencial, depois <code>x = t3</code>, <code>t3 = t1 + 5</code>, <code>t1 = a + b</code>. <code>t2</code> não seria marcado).</p>
<pre class="shell"><code>t1 = a + b
t3 = t1 + 5
x = t3
RETURN x</code></pre>
</section>
<section id="complexidade" class="level4" data-number="17.2.1.2">
<h4 data-number="17.2.1.2" class="anchored" data-anchor-id="complexidade"><span class="header-section-number">17.2.1.2</span> Complexidade</h4>
<ul>
<li><strong>Tempo</strong>: <span class="math inline">\(O(n + e)\)</span>, onde <span class="math inline">\(n\)</span> é o número de instruções e <span class="math inline">\(e\)</span> o número de usos (visitas no grafo).</li>
<li><strong>Espaço</strong>: <span class="math inline">\(O(n)\)</span> para as estruturas de dados.</li>
</ul>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Iteração Múltipla</strong></p>
<p>A eliminação de código morto pode revelar novo código morto. Por exemplo, se <code>t2 = c * d</code> for removido e <code>c</code> e <code>d</code> não forem usados em outros lugares, as instruções que os definem também tornam-se mortas. Por isso, essa otimização frequentemente é aplicada iterativamente.</p>
</div>
</div>
</section>
</section>
<section id="exemplo-completo-em-c23" class="level3" data-number="17.2.2">
<h3 data-number="17.2.2" class="anchored" data-anchor-id="exemplo-completo-em-c23"><span class="header-section-number">17.2.2</span> Exemplo Completo em C++23</h3>
<div class="sourceCode" id="cb10"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@file</span><span class="co"> </span><span class="cv">dead_code_eliminator.cpp</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@author</span><span class="co"> Frank Alcantara </span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@date</span><span class="co"> 2025-10</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@brief</span><span class="co"> Implementação da otimização de eliminação de código morto (Dead Code Elimination - DCE)</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="co"> * usando análise de vivacidade (liveness analysis) simples para o Código de Três Endereços (Three-Address Code - TAC).</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="co"> * Esta otimização é um tipo de otimização peep-hole quando aplicada a um bloco básico</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="co"> * e remove instruções cujo resultado não é usado posteriormente no bloco ou fora dele.</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="co"> * Requer C++23.</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a><span class="co"> * Este código foi desenvolvido como parte de um material educacional sobre otimizações de </span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a><span class="co"> * compiladores e usou o Google Gemini e o Anthropic Claude como ferramentas de pesquisa e revisão.</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;iostream&gt;</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;vector&gt;</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;string&gt;</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;string_view&gt;</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unordered_set&gt;</span></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;algorithm&gt;</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;regex&gt;</span></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;ranges&gt;</span></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;print&gt;</span></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;optional&gt;</span></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;span&gt;</span></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;concepts&gt;</span></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;array&gt;</span></span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;cctype&gt;</span></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a><span class="co">// Namespace aliases para melhor legibilidade</span></span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a><span class="kw">namespace</span> ranges <span class="op">=</span> <span class="bu">std::</span>ranges<span class="op">;</span></span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a><span class="kw">namespace</span> views <span class="op">=</span> <span class="bu">std::</span>views<span class="op">;</span></span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@brief</span><span class="co"> Estrutura que representa uma instrução TAC parseada.</span></span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> TACInstruction <span class="op">{</span></span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>string lhs<span class="op">;</span>                       <span class="co">// Variável definida (lado esquerdo)</span></span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>unordered_set<span class="op">&lt;</span><span class="bu">std::</span>string<span class="op">&gt;</span> rhs_vars<span class="op">;</span> <span class="co">// Variáveis usadas (lado direito)</span></span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>string original_line<span class="op">;</span>             <span class="co">// Linha original da instrução</span></span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> has_side_effects<span class="op">;</span>                 <span class="co">// Indica se tem efeitos colaterais</span></span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@brief</span><span class="co"> Conceito que define tipos de string aceitos.</span></span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="in">@note</span><span class="co"> Este conceito pode ser usado para funções genéricas que aceitam strings.</span></span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span><span class="op">&lt;</span><span class="kw">typename</span> T<span class="op">&gt;</span></span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a><span class="kw">concept</span> StringLike <span class="op">=</span> <span class="bu">std::</span>convertible_to<span class="op">&lt;</span>T<span class="op">,</span> <span class="bu">std::</span>string_view<span class="op">&gt;;</span></span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@brief</span><span class="co"> Remove espaços em branco do início e do fim de uma string view.</span></span>
<span id="cb10-54"><a href="#cb10-54" aria-hidden="true" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb10-55"><a href="#cb10-55" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@param</span><span class="co"> </span><span class="cv">sv</span><span class="co"> A string view a ser processada.</span></span>
<span id="cb10-56"><a href="#cb10-56" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@return</span><span class="co"> std::string_view A string view sem espaços em branco nas extremidades.</span></span>
<span id="cb10-57"><a href="#cb10-57" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb10-58"><a href="#cb10-58" aria-hidden="true" tabindex="-1"></a><span class="op">[[</span><span class="at">nodiscard</span><span class="op">]]</span> <span class="kw">constexpr</span> <span class="bu">std::</span>string_view trim<span class="op">(</span><span class="bu">std::</span>string_view sv<span class="op">)</span> <span class="kw">noexcept</span> <span class="op">{</span></span>
<span id="cb10-59"><a href="#cb10-59" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> <span class="kw">auto</span> is_space <span class="op">=</span> <span class="op">[](</span><span class="dt">unsigned</span> <span class="dt">char</span> ch<span class="op">)</span> <span class="op">{</span> </span>
<span id="cb10-60"><a href="#cb10-60" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">std::</span>isspace<span class="op">(</span>ch<span class="op">);</span> </span>
<span id="cb10-61"><a href="#cb10-61" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb10-62"><a href="#cb10-62" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-63"><a href="#cb10-63" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Remove espaços do início</span></span>
<span id="cb10-64"><a href="#cb10-64" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> start <span class="op">=</span> ranges<span class="op">::</span>find_if_not<span class="op">(</span>sv<span class="op">,</span> is_space<span class="op">);</span></span>
<span id="cb10-65"><a href="#cb10-65" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>start <span class="op">==</span> sv<span class="op">.</span>end<span class="op">())</span> <span class="op">{</span></span>
<span id="cb10-66"><a href="#cb10-66" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="op">{};</span></span>
<span id="cb10-67"><a href="#cb10-67" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb10-68"><a href="#cb10-68" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-69"><a href="#cb10-69" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Remove espaços do final usando view reversa</span></span>
<span id="cb10-70"><a href="#cb10-70" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> end <span class="op">=</span> ranges<span class="op">::</span>find_if_not<span class="op">(</span>sv <span class="op">|</span> views<span class="op">::</span>reverse<span class="op">,</span> is_space<span class="op">).</span>base<span class="op">();</span></span>
<span id="cb10-71"><a href="#cb10-71" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-72"><a href="#cb10-72" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> sv<span class="op">.</span>substr<span class="op">(</span></span>
<span id="cb10-73"><a href="#cb10-73" aria-hidden="true" tabindex="-1"></a>        <span class="bu">std::</span>distance<span class="op">(</span>sv<span class="op">.</span>begin<span class="op">(),</span> start<span class="op">),</span></span>
<span id="cb10-74"><a href="#cb10-74" aria-hidden="true" tabindex="-1"></a>        <span class="bu">std::</span>distance<span class="op">(</span>start<span class="op">,</span> end<span class="op">)</span></span>
<span id="cb10-75"><a href="#cb10-75" aria-hidden="true" tabindex="-1"></a>    <span class="op">);</span></span>
<span id="cb10-76"><a href="#cb10-76" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb10-77"><a href="#cb10-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-78"><a href="#cb10-78" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb10-79"><a href="#cb10-79" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@brief</span><span class="co"> Verifica se uma instrução contém efeitos colaterais que não podem ser eliminados.</span></span>
<span id="cb10-80"><a href="#cb10-80" aria-hidden="true" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb10-81"><a href="#cb10-81" aria-hidden="true" tabindex="-1"></a><span class="co"> * Instruções com efeitos colaterais incluem: CALL, PRINT, WRITE, I/O operations, etc.</span></span>
<span id="cb10-82"><a href="#cb10-82" aria-hidden="true" tabindex="-1"></a><span class="co"> * Estas instruções devem sempre ser preservadas, independentemente da análise de vivacidade.</span></span>
<span id="cb10-83"><a href="#cb10-83" aria-hidden="true" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb10-84"><a href="#cb10-84" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@param</span><span class="co"> </span><span class="cv">instruction</span><span class="co"> A string view contendo a instrução TAC.</span></span>
<span id="cb10-85"><a href="#cb10-85" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@return</span><span class="co"> true se a instrução tem efeitos colaterais, false caso contrário.</span></span>
<span id="cb10-86"><a href="#cb10-86" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb10-87"><a href="#cb10-87" aria-hidden="true" tabindex="-1"></a><span class="op">[[</span><span class="at">nodiscard</span><span class="op">]]</span> <span class="dt">bool</span> has_side_effects<span class="op">(</span><span class="bu">std::</span>string_view instruction<span class="op">)</span> <span class="kw">noexcept</span> <span class="op">{</span></span>
<span id="cb10-88"><a href="#cb10-88" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Lista de palavras-chave que indicam efeitos colaterais</span></span>
<span id="cb10-89"><a href="#cb10-89" aria-hidden="true" tabindex="-1"></a>    <span class="kw">constexpr</span> <span class="bu">std::</span>array side_effect_keywords <span class="op">=</span> <span class="op">{</span></span>
<span id="cb10-90"><a href="#cb10-90" aria-hidden="true" tabindex="-1"></a>        <span class="st">"CALL"</span><span class="op">,</span> <span class="st">"PRINT"</span><span class="op">,</span> <span class="st">"WRITE"</span><span class="op">,</span> <span class="st">"READ"</span><span class="op">,</span> <span class="st">"GOTO"</span><span class="op">,</span> <span class="st">"LABEL"</span><span class="op">,</span></span>
<span id="cb10-91"><a href="#cb10-91" aria-hidden="true" tabindex="-1"></a>        <span class="st">"IF"</span><span class="op">,</span> <span class="st">"RETURN"</span><span class="op">,</span> <span class="st">"PARAM"</span><span class="op">,</span> <span class="st">"ENTER"</span><span class="op">,</span> <span class="st">"LEAVE"</span></span>
<span id="cb10-92"><a href="#cb10-92" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb10-93"><a href="#cb10-93" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-94"><a href="#cb10-94" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Converte a instrução para uppercase usando ranges</span></span>
<span id="cb10-95"><a href="#cb10-95" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> to_upper <span class="op">=</span> <span class="op">[](</span><span class="dt">char</span> ch<span class="op">)</span> <span class="op">{</span> </span>
<span id="cb10-96"><a href="#cb10-96" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">std::</span>toupper<span class="op">(</span><span class="kw">static_cast</span><span class="op">&lt;</span><span class="dt">unsigned</span> <span class="dt">char</span><span class="op">&gt;(</span>ch<span class="op">));</span> </span>
<span id="cb10-97"><a href="#cb10-97" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb10-98"><a href="#cb10-98" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-99"><a href="#cb10-99" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>string upper_str<span class="op">(</span>instruction <span class="op">|</span> views<span class="op">::</span>transform<span class="op">(</span>to_upper<span class="op">));</span></span>
<span id="cb10-100"><a href="#cb10-100" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-101"><a href="#cb10-101" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ranges<span class="op">::</span>any_of<span class="op">(</span>side_effect_keywords<span class="op">,</span> <span class="op">[&amp;</span>upper_str<span class="op">](</span><span class="bu">std::</span>string_view keyword<span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-102"><a href="#cb10-102" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> upper_str<span class="op">.</span>find<span class="op">(</span>keyword<span class="op">)</span> <span class="op">!=</span> <span class="bu">std::</span>string::npos<span class="op">;</span></span>
<span id="cb10-103"><a href="#cb10-103" aria-hidden="true" tabindex="-1"></a>    <span class="op">});</span></span>
<span id="cb10-104"><a href="#cb10-104" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb10-105"><a href="#cb10-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-106"><a href="#cb10-106" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb10-107"><a href="#cb10-107" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@brief</span><span class="co"> Verifica se um token é um literal numérico.</span></span>
<span id="cb10-108"><a href="#cb10-108" aria-hidden="true" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb10-109"><a href="#cb10-109" aria-hidden="true" tabindex="-1"></a><span class="co"> * Literais numéricos (inteiros ou ponto flutuante) não são considerados variáveis</span></span>
<span id="cb10-110"><a href="#cb10-110" aria-hidden="true" tabindex="-1"></a><span class="co"> * e não devem ser adicionados ao conjunto de variáveis vivas.</span></span>
<span id="cb10-111"><a href="#cb10-111" aria-hidden="true" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb10-112"><a href="#cb10-112" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@param</span><span class="co"> </span><span class="cv">token</span><span class="co"> A string view do token a ser verificado.</span></span>
<span id="cb10-113"><a href="#cb10-113" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@return</span><span class="co"> true se o token é um literal numérico, false caso contrário.</span></span>
<span id="cb10-114"><a href="#cb10-114" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb10-115"><a href="#cb10-115" aria-hidden="true" tabindex="-1"></a><span class="op">[[</span><span class="at">nodiscard</span><span class="op">]]</span> <span class="kw">inline</span> <span class="dt">bool</span> is_numeric_literal<span class="op">(</span><span class="bu">std::</span>string_view token<span class="op">)</span> <span class="kw">noexcept</span> <span class="op">{</span></span>
<span id="cb10-116"><a href="#cb10-116" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>token<span class="op">.</span>empty<span class="op">())</span> <span class="op">{</span></span>
<span id="cb10-117"><a href="#cb10-117" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb10-118"><a href="#cb10-118" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb10-119"><a href="#cb10-119" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-120"><a href="#cb10-120" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Expressão regular para números: inteiros ou ponto flutuante</span></span>
<span id="cb10-121"><a href="#cb10-121" aria-hidden="true" tabindex="-1"></a>    <span class="at">static</span> <span class="at">const</span> <span class="bu">std::</span>regex numeric_regex<span class="op">(</span><span class="st">R"(</span><span class="vs">^[+-]?(\d+\.?\d*|\.\d+)([eE][+-]?\d+)?$</span><span class="st">)"</span><span class="op">);</span></span>
<span id="cb10-122"><a href="#cb10-122" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-123"><a href="#cb10-123" aria-hidden="true" tabindex="-1"></a>    <span class="co">// std::regex_match requer iteradores contíguos</span></span>
<span id="cb10-124"><a href="#cb10-124" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">std::</span>regex_match<span class="op">(</span>token<span class="op">.</span>begin<span class="op">(),</span> token<span class="op">.</span>end<span class="op">(),</span> numeric_regex<span class="op">);</span></span>
<span id="cb10-125"><a href="#cb10-125" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb10-126"><a href="#cb10-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-127"><a href="#cb10-127" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb10-128"><a href="#cb10-128" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@brief</span><span class="co"> Extrai variáveis de uma expressão do lado direito (RHS).</span></span>
<span id="cb10-129"><a href="#cb10-129" aria-hidden="true" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb10-130"><a href="#cb10-130" aria-hidden="true" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb10-131"><a href="#cb10-131" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@param</span><span class="co"> </span><span class="cv">rhs</span><span class="co"> A string view contendo a expressão do lado direito.</span></span>
<span id="cb10-132"><a href="#cb10-132" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@return</span><span class="co"> std::unordered_set</span><span class="kw">&lt;std::string&gt;</span><span class="co"> Conjunto de variáveis encontradas.</span></span>
<span id="cb10-133"><a href="#cb10-133" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb10-134"><a href="#cb10-134" aria-hidden="true" tabindex="-1"></a><span class="op">[[</span><span class="at">nodiscard</span><span class="op">]]</span> <span class="bu">std::</span>unordered_set<span class="op">&lt;</span><span class="bu">std::</span>string<span class="op">&gt;</span> extract_rhs_variables<span class="op">(</span><span class="bu">std::</span>string_view rhs<span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-135"><a href="#cb10-135" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>unordered_set<span class="op">&lt;</span><span class="bu">std::</span>string<span class="op">&gt;</span> rhs_vars<span class="op">;</span></span>
<span id="cb10-136"><a href="#cb10-136" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-137"><a href="#cb10-137" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Expressão regular para encontrar identificadores (variáveis).</span></span>
<span id="cb10-138"><a href="#cb10-138" aria-hidden="true" tabindex="-1"></a>    <span class="at">static</span> <span class="at">const</span> <span class="bu">std::</span>regex var_regex<span class="op">(</span><span class="st">R"(</span><span class="vs">[a-zA-Z_][a-zA-Z0-9_]*</span><span class="st">)"</span><span class="op">);</span></span>
<span id="cb10-139"><a href="#cb10-139" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-140"><a href="#cb10-140" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Cria iteradores para a regex</span></span>
<span id="cb10-141"><a href="#cb10-141" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> begin <span class="op">=</span> <span class="bu">std::</span>cregex_iterator<span class="op">(</span>rhs<span class="op">.</span>begin<span class="op">(),</span> rhs<span class="op">.</span>end<span class="op">(),</span> var_regex<span class="op">);</span></span>
<span id="cb10-142"><a href="#cb10-142" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> end <span class="op">=</span> <span class="bu">std::</span>cregex_iterator<span class="op">();</span></span>
<span id="cb10-143"><a href="#cb10-143" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-144"><a href="#cb10-144" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Usa ranges::subrange para iteração moderna sobre os matches</span></span>
<span id="cb10-145"><a href="#cb10-145" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="at">const</span> <span class="kw">auto</span><span class="op">&amp;</span> match <span class="op">:</span> ranges<span class="op">::</span>subrange<span class="op">(</span>begin<span class="op">,</span> end<span class="op">))</span> <span class="op">{</span></span>
<span id="cb10-146"><a href="#cb10-146" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Constrói string_view usando os iteradores de início e fim.</span></span>
<span id="cb10-147"><a href="#cb10-147" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Isso é a forma canônica de criar uma string_view a partir de um intervalo.</span></span>
<span id="cb10-148"><a href="#cb10-148" aria-hidden="true" tabindex="-1"></a>        <span class="bu">std::</span>string_view var_view<span class="op">(</span>match<span class="op">[</span><span class="dv">0</span><span class="op">].</span>first<span class="op">,</span> match<span class="op">[</span><span class="dv">0</span><span class="op">].</span>second<span class="op">);</span> </span>
<span id="cb10-149"><a href="#cb10-149" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-150"><a href="#cb10-150" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Filtra literais numéricos usando a string_view</span></span>
<span id="cb10-151"><a href="#cb10-151" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(!</span>is_numeric_literal<span class="op">(</span>var_view<span class="op">))</span> <span class="op">{</span></span>
<span id="cb10-152"><a href="#cb10-152" aria-hidden="true" tabindex="-1"></a>            <span class="co">// emplace constrói a string in-place no set, usando o construtor que aceita string_view</span></span>
<span id="cb10-153"><a href="#cb10-153" aria-hidden="true" tabindex="-1"></a>            rhs_vars<span class="op">.</span>emplace<span class="op">(</span>var_view<span class="op">);</span> </span>
<span id="cb10-154"><a href="#cb10-154" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb10-155"><a href="#cb10-155" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb10-156"><a href="#cb10-156" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-157"><a href="#cb10-157" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> rhs_vars<span class="op">;</span></span>
<span id="cb10-158"><a href="#cb10-158" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb10-159"><a href="#cb10-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-160"><a href="#cb10-160" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb10-161"><a href="#cb10-161" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@brief</span><span class="co"> Extrai a variável definida (LHS) e as variáveis usadas (RHS) de uma instrução TAC.</span></span>
<span id="cb10-162"><a href="#cb10-162" aria-hidden="true" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb10-163"><a href="#cb10-163" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@param</span><span class="co"> </span><span class="cv">instruction</span><span class="co"> A string view contendo a instrução TAC (e.g., "t1 = a * 2").</span></span>
<span id="cb10-164"><a href="#cb10-164" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@return</span><span class="co"> std::optional</span><span class="kw">&lt;TACInstruction&gt;</span><span class="co"> Instrução parseada, ou std::nullopt se não puder ser processada.</span></span>
<span id="cb10-165"><a href="#cb10-165" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb10-166"><a href="#cb10-166" aria-hidden="true" tabindex="-1"></a><span class="op">[[</span><span class="at">nodiscard</span><span class="op">]]</span> <span class="bu">std::</span>optional<span class="op">&lt;</span>TACInstruction<span class="op">&gt;</span> parse_tac_instruction<span class="op">(</span><span class="bu">std::</span>string_view instruction<span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-167"><a href="#cb10-167" aria-hidden="true" tabindex="-1"></a>    TACInstruction result<span class="op">{</span></span>
<span id="cb10-168"><a href="#cb10-168" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>lhs <span class="op">=</span> <span class="op">{},</span></span>
<span id="cb10-169"><a href="#cb10-169" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>rhs_vars <span class="op">=</span> <span class="op">{},</span></span>
<span id="cb10-170"><a href="#cb10-170" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>original_line <span class="op">=</span> <span class="bu">std::</span>string<span class="op">(</span>instruction<span class="op">),</span></span>
<span id="cb10-171"><a href="#cb10-171" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>has_side_effects <span class="op">=</span> has_side_effects<span class="op">(</span>instruction<span class="op">)</span></span>
<span id="cb10-172"><a href="#cb10-172" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb10-173"><a href="#cb10-173" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-174"><a href="#cb10-174" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Verifica se a instrução tem efeitos colaterais que devem ser sempre preservados</span></span>
<span id="cb10-175"><a href="#cb10-175" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>result<span class="op">.</span>has_side_effects<span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-176"><a href="#cb10-176" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> result<span class="op">;</span></span>
<span id="cb10-177"><a href="#cb10-177" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb10-178"><a href="#cb10-178" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-179"><a href="#cb10-179" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Procura pelo separador '='.</span></span>
<span id="cb10-180"><a href="#cb10-180" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> eq_pos <span class="op">=</span> instruction<span class="op">.</span>find<span class="op">(</span><span class="ch">'='</span><span class="op">);</span></span>
<span id="cb10-181"><a href="#cb10-181" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>eq_pos <span class="op">==</span> <span class="bu">std::</span>string_view::npos<span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-182"><a href="#cb10-182" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Instruções sem atribuição (e.g., GOTO, CALL sem retorno, LABEL)</span></span>
<span id="cb10-183"><a href="#cb10-183" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">std::</span>nullopt<span class="op">;</span></span>
<span id="cb10-184"><a href="#cb10-184" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb10-185"><a href="#cb10-185" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-186"><a href="#cb10-186" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 1. Extração do Lado Esquerdo (LHS - variável definida)</span></span>
<span id="cb10-187"><a href="#cb10-187" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> lhs_view <span class="op">=</span> trim<span class="op">(</span>instruction<span class="op">.</span>substr<span class="op">(</span><span class="dv">0</span><span class="op">,</span> eq_pos<span class="op">));</span></span>
<span id="cb10-188"><a href="#cb10-188" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-189"><a href="#cb10-189" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>lhs_view<span class="op">.</span>empty<span class="op">())</span> <span class="op">{</span></span>
<span id="cb10-190"><a href="#cb10-190" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">std::</span>nullopt<span class="op">;</span></span>
<span id="cb10-191"><a href="#cb10-191" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb10-192"><a href="#cb10-192" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-193"><a href="#cb10-193" aria-hidden="true" tabindex="-1"></a>    result<span class="op">.</span>lhs <span class="op">=</span> <span class="bu">std::</span>string<span class="op">(</span>lhs_view<span class="op">);</span></span>
<span id="cb10-194"><a href="#cb10-194" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-195"><a href="#cb10-195" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 2. Extração do Lado Direito (RHS - variáveis usadas)</span></span>
<span id="cb10-196"><a href="#cb10-196" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> rhs_view <span class="op">=</span> instruction<span class="op">.</span>substr<span class="op">(</span>eq_pos <span class="op">+</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb10-197"><a href="#cb10-197" aria-hidden="true" tabindex="-1"></a>    result<span class="op">.</span>rhs_vars <span class="op">=</span> extract_rhs_variables<span class="op">(</span>rhs_view<span class="op">);</span></span>
<span id="cb10-198"><a href="#cb10-198" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-199"><a href="#cb10-199" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result<span class="op">;</span></span>
<span id="cb10-200"><a href="#cb10-200" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb10-201"><a href="#cb10-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-202"><a href="#cb10-202" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb10-203"><a href="#cb10-203" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@brief</span><span class="co"> Classe responsável pela otimização de eliminação de código morto.</span></span>
<span id="cb10-204"><a href="#cb10-204" aria-hidden="true" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb10-205"><a href="#cb10-205" aria-hidden="true" tabindex="-1"></a><span class="co"> * Encapsula o estado da análise de vivacidade e fornece interface clara</span></span>
<span id="cb10-206"><a href="#cb10-206" aria-hidden="true" tabindex="-1"></a><span class="co"> * para processar instruções individualmente.</span></span>
<span id="cb10-207"><a href="#cb10-207" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb10-208"><a href="#cb10-208" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> DeadCodeEliminator <span class="op">{</span></span>
<span id="cb10-209"><a href="#cb10-209" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span><span class="op">:</span></span>
<span id="cb10-210"><a href="#cb10-210" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>unordered_set<span class="op">&lt;</span><span class="bu">std::</span>string<span class="op">&gt;</span> <span class="va">live_vars_</span><span class="op">;</span></span>
<span id="cb10-211"><a href="#cb10-211" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-212"><a href="#cb10-212" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="cb10-213"><a href="#cb10-213" aria-hidden="true" tabindex="-1"></a>    <span class="co">/**</span></span>
<span id="cb10-214"><a href="#cb10-214" aria-hidden="true" tabindex="-1"></a><span class="co">     * </span><span class="an">@brief</span><span class="co"> Constrói um eliminador de código morto com conjunto inicial de variáveis vivas.</span></span>
<span id="cb10-215"><a href="#cb10-215" aria-hidden="true" tabindex="-1"></a><span class="co">     *</span></span>
<span id="cb10-216"><a href="#cb10-216" aria-hidden="true" tabindex="-1"></a><span class="co">     * </span><span class="an">@param</span><span class="co"> </span><span class="cv">initial_live_vars</span><span class="co"> Conjunto de variáveis vivas no final do bloco.</span></span>
<span id="cb10-217"><a href="#cb10-217" aria-hidden="true" tabindex="-1"></a><span class="co">     */</span></span>
<span id="cb10-218"><a href="#cb10-218" aria-hidden="true" tabindex="-1"></a>    <span class="kw">explicit</span> DeadCodeEliminator<span class="op">(</span><span class="bu">std::</span>unordered_set<span class="op">&lt;</span><span class="bu">std::</span>string<span class="op">&gt;</span> initial_live_vars<span class="op">)</span></span>
<span id="cb10-219"><a href="#cb10-219" aria-hidden="true" tabindex="-1"></a>        <span class="op">:</span> <span class="va">live_vars_</span><span class="op">(</span><span class="bu">std::</span>move<span class="op">(</span>initial_live_vars<span class="op">))</span> <span class="op">{}</span></span>
<span id="cb10-220"><a href="#cb10-220" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-221"><a href="#cb10-221" aria-hidden="true" tabindex="-1"></a>    <span class="co">/**</span></span>
<span id="cb10-222"><a href="#cb10-222" aria-hidden="true" tabindex="-1"></a><span class="co">     * </span><span class="an">@brief</span><span class="co"> Processa uma instrução para determinar se deve ser mantida.</span></span>
<span id="cb10-223"><a href="#cb10-223" aria-hidden="true" tabindex="-1"></a><span class="co">     *</span></span>
<span id="cb10-224"><a href="#cb10-224" aria-hidden="true" tabindex="-1"></a><span class="co">     * </span><span class="an">@param</span><span class="co"> </span><span class="cv">instruction</span><span class="co"> A instrução TAC parseada.</span></span>
<span id="cb10-225"><a href="#cb10-225" aria-hidden="true" tabindex="-1"></a><span class="co">     * </span><span class="an">@return</span><span class="co"> true se a instrução deve ser mantida, false se é código morto.</span></span>
<span id="cb10-226"><a href="#cb10-226" aria-hidden="true" tabindex="-1"></a><span class="co">     */</span></span>
<span id="cb10-227"><a href="#cb10-227" aria-hidden="true" tabindex="-1"></a>    <span class="op">[[</span><span class="at">nodiscard</span><span class="op">]]</span> <span class="dt">bool</span> process_instruction<span class="op">(</span><span class="at">const</span> TACInstruction<span class="op">&amp;</span> instruction<span class="op">)</span> <span class="kw">noexcept</span> <span class="op">{</span></span>
<span id="cb10-228"><a href="#cb10-228" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Instruções com efeitos colaterais nunca são eliminadas</span></span>
<span id="cb10-229"><a href="#cb10-229" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>instruction<span class="op">.</span>has_side_effects<span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-230"><a href="#cb10-230" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb10-231"><a href="#cb10-231" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb10-232"><a href="#cb10-232" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-233"><a href="#cb10-233" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Verifica se a variável definida está viva</span></span>
<span id="cb10-234"><a href="#cb10-234" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span><span class="va">live_vars_</span><span class="op">.</span>contains<span class="op">(</span>instruction<span class="op">.</span>lhs<span class="op">))</span> <span class="op">{</span></span>
<span id="cb10-235"><a href="#cb10-235" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Remove a variável definida do conjunto de vivas</span></span>
<span id="cb10-236"><a href="#cb10-236" aria-hidden="true" tabindex="-1"></a>            <span class="va">live_vars_</span><span class="op">.</span>erase<span class="op">(</span>instruction<span class="op">.</span>lhs<span class="op">);</span></span>
<span id="cb10-237"><a href="#cb10-237" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb10-238"><a href="#cb10-238" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Adiciona as variáveis usadas ao conjunto de vivas</span></span>
<span id="cb10-239"><a href="#cb10-239" aria-hidden="true" tabindex="-1"></a>            <span class="va">live_vars_</span><span class="op">.</span>insert<span class="op">(</span>instruction<span class="op">.</span>rhs_vars<span class="op">.</span>begin<span class="op">(),</span> instruction<span class="op">.</span>rhs_vars<span class="op">.</span>end<span class="op">());</span></span>
<span id="cb10-240"><a href="#cb10-240" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb10-241"><a href="#cb10-241" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb10-242"><a href="#cb10-242" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb10-243"><a href="#cb10-243" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-244"><a href="#cb10-244" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Instrução é código morto</span></span>
<span id="cb10-245"><a href="#cb10-245" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb10-246"><a href="#cb10-246" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb10-247"><a href="#cb10-247" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-248"><a href="#cb10-248" aria-hidden="true" tabindex="-1"></a>    <span class="co">/**</span></span>
<span id="cb10-249"><a href="#cb10-249" aria-hidden="true" tabindex="-1"></a><span class="co">     * </span><span class="an">@brief</span><span class="co"> Obtém o conjunto atual de variáveis vivas.</span></span>
<span id="cb10-250"><a href="#cb10-250" aria-hidden="true" tabindex="-1"></a><span class="co">     *</span></span>
<span id="cb10-251"><a href="#cb10-251" aria-hidden="true" tabindex="-1"></a><span class="co">     * </span><span class="an">@return</span><span class="co"> const std::unordered_set</span><span class="kw">&lt;std::string&gt;</span><span class="co">&amp; Conjunto de variáveis vivas.</span></span>
<span id="cb10-252"><a href="#cb10-252" aria-hidden="true" tabindex="-1"></a><span class="co">     */</span></span>
<span id="cb10-253"><a href="#cb10-253" aria-hidden="true" tabindex="-1"></a>    <span class="op">[[</span><span class="at">nodiscard</span><span class="op">]]</span> <span class="at">const</span> <span class="bu">std::</span>unordered_set<span class="op">&lt;</span><span class="bu">std::</span>string<span class="op">&gt;&amp;</span> live_variables<span class="op">()</span> <span class="at">const</span> <span class="kw">noexcept</span> <span class="op">{</span></span>
<span id="cb10-254"><a href="#cb10-254" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">live_vars_</span><span class="op">;</span></span>
<span id="cb10-255"><a href="#cb10-255" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb10-256"><a href="#cb10-256" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb10-257"><a href="#cb10-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-258"><a href="#cb10-258" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb10-259"><a href="#cb10-259" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@brief</span><span class="co"> Implementa a otimização de Eliminação de Código Morto (DCE) usando análise de vivacidade.</span></span>
<span id="cb10-260"><a href="#cb10-260" aria-hidden="true" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb10-261"><a href="#cb10-261" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@param</span><span class="co"> </span><span class="cv">tac</span><span class="co"> O código de três endereços (Three-Address Code) como um span de strings.</span></span>
<span id="cb10-262"><a href="#cb10-262" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@param</span><span class="co"> </span><span class="cv">used_vars</span><span class="co"> Um conjunto de variáveis consideradas vivas no *final* do bloco.</span></span>
<span id="cb10-263"><a href="#cb10-263" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@return</span><span class="co"> std::vector</span><span class="kw">&lt;std::string&gt;</span><span class="co"> O código TAC otimizado, sem instruções mortas.</span></span>
<span id="cb10-264"><a href="#cb10-264" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb10-265"><a href="#cb10-265" aria-hidden="true" tabindex="-1"></a><span class="op">[[</span><span class="at">nodiscard</span><span class="op">]]</span> <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="bu">std::</span>string<span class="op">&gt;</span> eliminate_dead_code<span class="op">(</span></span>
<span id="cb10-266"><a href="#cb10-266" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>span<span class="op">&lt;</span><span class="at">const</span> <span class="bu">std::</span>string<span class="op">&gt;</span> tac<span class="op">,</span></span>
<span id="cb10-267"><a href="#cb10-267" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> <span class="bu">std::</span>unordered_set<span class="op">&lt;</span><span class="bu">std::</span>string<span class="op">&gt;&amp;</span> used_vars<span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-268"><a href="#cb10-268" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-269"><a href="#cb10-269" aria-hidden="true" tabindex="-1"></a>    DeadCodeEliminator eliminator<span class="op">(</span>used_vars<span class="op">);</span></span>
<span id="cb10-270"><a href="#cb10-270" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-271"><a href="#cb10-271" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Vetor para armazenar o código otimizado.</span></span>
<span id="cb10-272"><a href="#cb10-272" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="bu">std::</span>string<span class="op">&gt;</span> optimized_code<span class="op">;</span></span>
<span id="cb10-273"><a href="#cb10-273" aria-hidden="true" tabindex="-1"></a>    optimized_code<span class="op">.</span>reserve<span class="op">(</span>tac<span class="op">.</span>size<span class="op">());</span></span>
<span id="cb10-274"><a href="#cb10-274" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-275"><a href="#cb10-275" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Itera sobre o código na ordem inversa usando ranges view</span></span>
<span id="cb10-276"><a href="#cb10-276" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> reversed_view <span class="op">=</span> tac <span class="op">|</span> views<span class="op">::</span>reverse<span class="op">;</span></span>
<span id="cb10-277"><a href="#cb10-277" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-278"><a href="#cb10-278" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="at">const</span> <span class="kw">auto</span><span class="op">&amp;</span> line <span class="op">:</span> reversed_view<span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-279"><a href="#cb10-279" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Ignora linhas vazias ou apenas com espaços em branco</span></span>
<span id="cb10-280"><a href="#cb10-280" aria-hidden="true" tabindex="-1"></a>        <span class="kw">auto</span> trimmed_line <span class="op">=</span> trim<span class="op">(</span>line<span class="op">);</span></span>
<span id="cb10-281"><a href="#cb10-281" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>trimmed_line<span class="op">.</span>empty<span class="op">())</span> <span class="op">{</span></span>
<span id="cb10-282"><a href="#cb10-282" aria-hidden="true" tabindex="-1"></a>            optimized_code<span class="op">.</span>emplace_back<span class="op">(</span>line<span class="op">);</span></span>
<span id="cb10-283"><a href="#cb10-283" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span><span class="op">;</span></span>
<span id="cb10-284"><a href="#cb10-284" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb10-285"><a href="#cb10-285" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-286"><a href="#cb10-286" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Tenta fazer o parsing da instrução</span></span>
<span id="cb10-287"><a href="#cb10-287" aria-hidden="true" tabindex="-1"></a>        <span class="kw">auto</span> parsed <span class="op">=</span> parse_tac_instruction<span class="op">(</span>line<span class="op">);</span></span>
<span id="cb10-288"><a href="#cb10-288" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-289"><a href="#cb10-289" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Se não puder ser parseada (e.g., é um LABEL ou instrução malformada), mantém</span></span>
<span id="cb10-290"><a href="#cb10-290" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(!</span>parsed<span class="op">.</span>has_value<span class="op">())</span> <span class="op">{</span></span>
<span id="cb10-291"><a href="#cb10-291" aria-hidden="true" tabindex="-1"></a>            optimized_code<span class="op">.</span>emplace_back<span class="op">(</span>line<span class="op">);</span></span>
<span id="cb10-292"><a href="#cb10-292" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span><span class="op">;</span></span>
<span id="cb10-293"><a href="#cb10-293" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb10-294"><a href="#cb10-294" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-295"><a href="#cb10-295" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Processa a instrução e determina se deve ser mantida</span></span>
<span id="cb10-296"><a href="#cb10-296" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>eliminator<span class="op">.</span>process_instruction<span class="op">(*</span>parsed<span class="op">))</span> <span class="op">{</span></span>
<span id="cb10-297"><a href="#cb10-297" aria-hidden="true" tabindex="-1"></a>            optimized_code<span class="op">.</span>emplace_back<span class="op">(</span>line<span class="op">);</span></span>
<span id="cb10-298"><a href="#cb10-298" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb10-299"><a href="#cb10-299" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb10-300"><a href="#cb10-300" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-301"><a href="#cb10-301" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Inverte o vetor para restaurar a ordem original usando ranges</span></span>
<span id="cb10-302"><a href="#cb10-302" aria-hidden="true" tabindex="-1"></a>    ranges<span class="op">::</span>reverse<span class="op">(</span>optimized_code<span class="op">);</span></span>
<span id="cb10-303"><a href="#cb10-303" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-304"><a href="#cb10-304" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> optimized_code<span class="op">;</span></span>
<span id="cb10-305"><a href="#cb10-305" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb10-306"><a href="#cb10-306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-307"><a href="#cb10-307" aria-hidden="true" tabindex="-1"></a><span class="co">// --------------------------------------------------------------------------------</span></span>
<span id="cb10-308"><a href="#cb10-308" aria-hidden="true" tabindex="-1"></a><span class="co">// Funções Auxiliares para Testes e Validação</span></span>
<span id="cb10-309"><a href="#cb10-309" aria-hidden="true" tabindex="-1"></a><span class="co">// --------------------------------------------------------------------------------</span></span>
<span id="cb10-310"><a href="#cb10-310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-311"><a href="#cb10-311" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb10-312"><a href="#cb10-312" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@brief</span><span class="co"> Estrutura para estatísticas de otimização.</span></span>
<span id="cb10-313"><a href="#cb10-313" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb10-314"><a href="#cb10-314" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> OptimizationStats <span class="op">{</span></span>
<span id="cb10-315"><a href="#cb10-315" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>size_t original_count<span class="op">;</span></span>
<span id="cb10-316"><a href="#cb10-316" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>size_t optimized_count<span class="op">;</span></span>
<span id="cb10-317"><a href="#cb10-317" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>size_t eliminated_count<span class="op">;</span></span>
<span id="cb10-318"><a href="#cb10-318" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> elimination_percentage<span class="op">;</span></span>
<span id="cb10-319"><a href="#cb10-319" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb10-320"><a href="#cb10-320" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-321"><a href="#cb10-321" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb10-322"><a href="#cb10-322" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@brief</span><span class="co"> Calcula estatísticas da otimização realizada.</span></span>
<span id="cb10-323"><a href="#cb10-323" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb10-324"><a href="#cb10-324" aria-hidden="true" tabindex="-1"></a><span class="op">[[</span><span class="at">nodiscard</span><span class="op">]]</span> <span class="kw">constexpr</span> OptimizationStats calculate_statistics<span class="op">(</span></span>
<span id="cb10-325"><a href="#cb10-325" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>size_t original_size<span class="op">,</span></span>
<span id="cb10-326"><a href="#cb10-326" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>size_t optimized_size<span class="op">)</span> <span class="kw">noexcept</span> <span class="op">{</span></span>
<span id="cb10-327"><a href="#cb10-327" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-328"><a href="#cb10-328" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> <span class="kw">auto</span> eliminated <span class="op">=</span> original_size <span class="op">-</span> optimized_size<span class="op">;</span></span>
<span id="cb10-329"><a href="#cb10-329" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> <span class="kw">auto</span> percentage <span class="op">=</span> original_size <span class="op">&gt;</span> <span class="dv">0</span></span>
<span id="cb10-330"><a href="#cb10-330" aria-hidden="true" tabindex="-1"></a>        <span class="op">?</span> <span class="op">(</span><span class="kw">static_cast</span><span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;(</span>eliminated<span class="op">)</span> <span class="op">*</span> <span class="fl">100.0</span><span class="op">)</span> <span class="op">/</span> <span class="kw">static_cast</span><span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;(</span>original_size<span class="op">)</span></span>
<span id="cb10-331"><a href="#cb10-331" aria-hidden="true" tabindex="-1"></a>        <span class="op">:</span> <span class="fl">0.0</span><span class="op">;</span></span>
<span id="cb10-332"><a href="#cb10-332" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-333"><a href="#cb10-333" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> OptimizationStats<span class="op">{</span></span>
<span id="cb10-334"><a href="#cb10-334" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>original_count <span class="op">=</span> original_size<span class="op">,</span></span>
<span id="cb10-335"><a href="#cb10-335" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>optimized_count <span class="op">=</span> optimized_size<span class="op">,</span></span>
<span id="cb10-336"><a href="#cb10-336" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>eliminated_count <span class="op">=</span> eliminated<span class="op">,</span></span>
<span id="cb10-337"><a href="#cb10-337" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>elimination_percentage <span class="op">=</span> percentage</span>
<span id="cb10-338"><a href="#cb10-338" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb10-339"><a href="#cb10-339" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb10-340"><a href="#cb10-340" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-341"><a href="#cb10-341" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb10-342"><a href="#cb10-342" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@brief</span><span class="co"> Imprime estatísticas da otimização realizada.</span></span>
<span id="cb10-343"><a href="#cb10-343" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb10-344"><a href="#cb10-344" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> print_statistics<span class="op">(</span><span class="at">const</span> OptimizationStats<span class="op">&amp;</span> stats<span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-345"><a href="#cb10-345" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>println<span class="op">(</span><span class="st">"</span><span class="sc">\n</span><span class="st">--- Estatísticas da Otimização ---"</span><span class="op">);</span></span>
<span id="cb10-346"><a href="#cb10-346" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>println<span class="op">(</span><span class="st">"Instruções originais: </span><span class="sc">{}</span><span class="st">"</span><span class="op">,</span> stats<span class="op">.</span>original_count<span class="op">);</span></span>
<span id="cb10-347"><a href="#cb10-347" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>println<span class="op">(</span><span class="st">"Instruções otimizadas: </span><span class="sc">{}</span><span class="st">"</span><span class="op">,</span> stats<span class="op">.</span>optimized_count<span class="op">);</span></span>
<span id="cb10-348"><a href="#cb10-348" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>println<span class="op">(</span><span class="st">"Instruções eliminadas: </span><span class="sc">{}</span><span class="st"> (</span><span class="sc">{:.2f}</span><span class="st">%)"</span><span class="op">,</span></span>
<span id="cb10-349"><a href="#cb10-349" aria-hidden="true" tabindex="-1"></a>                 stats<span class="op">.</span>eliminated_count<span class="op">,</span></span>
<span id="cb10-350"><a href="#cb10-350" aria-hidden="true" tabindex="-1"></a>                 stats<span class="op">.</span>elimination_percentage<span class="op">);</span></span>
<span id="cb10-351"><a href="#cb10-351" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb10-352"><a href="#cb10-352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-353"><a href="#cb10-353" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb10-354"><a href="#cb10-354" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@brief</span><span class="co"> Imprime código TAC com formatação.</span></span>
<span id="cb10-355"><a href="#cb10-355" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb10-356"><a href="#cb10-356" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> print_code<span class="op">(</span><span class="bu">std::</span>string_view title<span class="op">,</span> <span class="bu">std::</span>span<span class="op">&lt;</span><span class="at">const</span> <span class="bu">std::</span>string<span class="op">&gt;</span> code<span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-357"><a href="#cb10-357" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>println<span class="op">(</span><span class="st">"</span><span class="sc">{}</span><span class="st">"</span><span class="op">,</span> title<span class="op">);</span></span>
<span id="cb10-358"><a href="#cb10-358" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>println<span class="op">(</span><span class="st">"</span><span class="sc">{}</span><span class="st">"</span><span class="op">,</span> <span class="bu">std::</span>string<span class="op">(</span><span class="dv">50</span><span class="op">,</span> <span class="ch">'-'</span><span class="op">));</span></span>
<span id="cb10-359"><a href="#cb10-359" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-360"><a href="#cb10-360" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>code<span class="op">.</span>empty<span class="op">())</span> <span class="op">{</span></span>
<span id="cb10-361"><a href="#cb10-361" aria-hidden="true" tabindex="-1"></a>        <span class="bu">std::</span>println<span class="op">(</span><span class="st">"Nenhuma instrução."</span><span class="op">);</span></span>
<span id="cb10-362"><a href="#cb10-362" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span><span class="op">;</span></span>
<span id="cb10-363"><a href="#cb10-363" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb10-364"><a href="#cb10-364" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-365"><a href="#cb10-365" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="at">const</span> <span class="kw">auto</span><span class="op">&amp;</span> line <span class="op">:</span> code<span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-366"><a href="#cb10-366" aria-hidden="true" tabindex="-1"></a>        <span class="bu">std::</span>println<span class="op">(</span><span class="st">"</span><span class="sc">{}</span><span class="st">"</span><span class="op">,</span> line<span class="op">);</span></span>
<span id="cb10-367"><a href="#cb10-367" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb10-368"><a href="#cb10-368" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb10-369"><a href="#cb10-369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-370"><a href="#cb10-370" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb10-371"><a href="#cb10-371" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@brief</span><span class="co"> Imprime conjunto de variáveis de forma ordenada.</span></span>
<span id="cb10-372"><a href="#cb10-372" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb10-373"><a href="#cb10-373" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> print_variables<span class="op">(</span><span class="at">const</span> <span class="bu">std::</span>unordered_set<span class="op">&lt;</span><span class="bu">std::</span>string<span class="op">&gt;&amp;</span> vars<span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-374"><a href="#cb10-374" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>print<span class="op">(</span><span class="st">"Variáveis Vivas Finais (Used_Vars): "</span><span class="op">);</span></span>
<span id="cb10-375"><a href="#cb10-375" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-376"><a href="#cb10-376" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>vars<span class="op">.</span>empty<span class="op">())</span> <span class="op">{</span></span>
<span id="cb10-377"><a href="#cb10-377" aria-hidden="true" tabindex="-1"></a>        <span class="bu">std::</span>println<span class="op">(</span><span class="st">"(nenhuma)"</span><span class="op">);</span></span>
<span id="cb10-378"><a href="#cb10-378" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span><span class="op">;</span></span>
<span id="cb10-379"><a href="#cb10-379" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb10-380"><a href="#cb10-380" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-381"><a href="#cb10-381" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Ordena as variáveis para saída consistente</span></span>
<span id="cb10-382"><a href="#cb10-382" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> sorted_vars <span class="op">=</span> <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="bu">std::</span>string<span class="op">&gt;(</span>vars<span class="op">.</span>begin<span class="op">(),</span> vars<span class="op">.</span>end<span class="op">());</span></span>
<span id="cb10-383"><a href="#cb10-383" aria-hidden="true" tabindex="-1"></a>    ranges<span class="op">::</span>sort<span class="op">(</span>sorted_vars<span class="op">);</span></span>
<span id="cb10-384"><a href="#cb10-384" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-385"><a href="#cb10-385" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Imprime as variáveis separadas por vírgula</span></span>
<span id="cb10-386"><a href="#cb10-386" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="kw">auto</span> it <span class="op">=</span> sorted_vars<span class="op">.</span>begin<span class="op">();</span> it <span class="op">!=</span> sorted_vars<span class="op">.</span>end<span class="op">();</span> <span class="op">++</span>it<span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-387"><a href="#cb10-387" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>it <span class="op">!=</span> sorted_vars<span class="op">.</span>begin<span class="op">())</span> <span class="op">{</span></span>
<span id="cb10-388"><a href="#cb10-388" aria-hidden="true" tabindex="-1"></a>            <span class="bu">std::</span>print<span class="op">(</span><span class="st">", "</span><span class="op">);</span></span>
<span id="cb10-389"><a href="#cb10-389" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb10-390"><a href="#cb10-390" aria-hidden="true" tabindex="-1"></a>        <span class="bu">std::</span>print<span class="op">(</span><span class="st">"</span><span class="sc">{}</span><span class="st">"</span><span class="op">,</span> <span class="op">*</span>it<span class="op">);</span></span>
<span id="cb10-391"><a href="#cb10-391" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb10-392"><a href="#cb10-392" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>println<span class="op">(</span><span class="st">""</span><span class="op">);</span></span>
<span id="cb10-393"><a href="#cb10-393" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb10-394"><a href="#cb10-394" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-395"><a href="#cb10-395" aria-hidden="true" tabindex="-1"></a><span class="co">// --------------------------------------------------------------------------------</span></span>
<span id="cb10-396"><a href="#cb10-396" aria-hidden="true" tabindex="-1"></a><span class="co">// Exemplo de Uso</span></span>
<span id="cb10-397"><a href="#cb10-397" aria-hidden="true" tabindex="-1"></a><span class="co">// --------------------------------------------------------------------------------</span></span>
<span id="cb10-398"><a href="#cb10-398" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-399"><a href="#cb10-399" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb10-400"><a href="#cb10-400" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@brief</span><span class="co"> Função principal para demonstração.</span></span>
<span id="cb10-401"><a href="#cb10-401" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@return</span><span class="co"> int 0 em caso de sucesso.</span></span>
<span id="cb10-402"><a href="#cb10-402" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb10-403"><a href="#cb10-403" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb10-404"><a href="#cb10-404" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Exemplo de Código de Três Endereços (TAC)</span></span>
<span id="cb10-405"><a href="#cb10-405" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="bu">std::</span>string<span class="op">&gt;</span> tac_code <span class="op">=</span> <span class="op">{</span></span>
<span id="cb10-406"><a href="#cb10-406" aria-hidden="true" tabindex="-1"></a>        <span class="st">"t1 = a * 2"</span><span class="op">,</span>          <span class="co">// t1 é definida (necessária para t2)</span></span>
<span id="cb10-407"><a href="#cb10-407" aria-hidden="true" tabindex="-1"></a>        <span class="st">"t2 = t1 + b"</span><span class="op">,</span>         <span class="co">// t2 é definida (necessária para t4)</span></span>
<span id="cb10-408"><a href="#cb10-408" aria-hidden="true" tabindex="-1"></a>        <span class="st">"t3 = c * 3"</span><span class="op">,</span>          <span class="co">// t3 é definida (código morto - nunca usada)</span></span>
<span id="cb10-409"><a href="#cb10-409" aria-hidden="true" tabindex="-1"></a>        <span class="st">"t4 = t2 - b"</span><span class="op">,</span>         <span class="co">// t4 é definida (variável de saída)</span></span>
<span id="cb10-410"><a href="#cb10-410" aria-hidden="true" tabindex="-1"></a>        <span class="st">"t5 = 10"</span><span class="op">,</span>             <span class="co">// t5 é definida (variável de saída)</span></span>
<span id="cb10-411"><a href="#cb10-411" aria-hidden="true" tabindex="-1"></a>        <span class="st">"t6 = t5 + 5"</span><span class="op">,</span>         <span class="co">// t6 é definida (código morto - nunca usada)</span></span>
<span id="cb10-412"><a href="#cb10-412" aria-hidden="true" tabindex="-1"></a>        <span class="st">"PRINT t4"</span><span class="op">,</span>            <span class="co">// Efeito colateral (sempre preservado)</span></span>
<span id="cb10-413"><a href="#cb10-413" aria-hidden="true" tabindex="-1"></a>        <span class="st">"t7 = t4 * 2.5"</span><span class="op">,</span>       <span class="co">// t7 é definida (código morto - nunca usada)</span></span>
<span id="cb10-414"><a href="#cb10-414" aria-hidden="true" tabindex="-1"></a>        <span class="st">"goto Label1"</span><span class="op">,</span>         <span class="co">// Efeito colateral (sempre preservado)</span></span>
<span id="cb10-415"><a href="#cb10-415" aria-hidden="true" tabindex="-1"></a>        <span class="st">"t8 = t7 + 10"</span>         <span class="co">// t8 é definida (código morto - depende de t7 que é morta)</span></span>
<span id="cb10-416"><a href="#cb10-416" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb10-417"><a href="#cb10-417" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-418"><a href="#cb10-418" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Variáveis que são consideradas "vivas" no final do bloco (saídas).</span></span>
<span id="cb10-419"><a href="#cb10-419" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> <span class="bu">std::</span>unordered_set<span class="op">&lt;</span><span class="bu">std::</span>string<span class="op">&gt;</span> used_vars <span class="op">=</span> <span class="op">{</span><span class="st">"t4"</span><span class="op">,</span> <span class="st">"t5"</span><span class="op">};</span></span>
<span id="cb10-420"><a href="#cb10-420" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-421"><a href="#cb10-421" aria-hidden="true" tabindex="-1"></a>    print_code<span class="op">(</span><span class="st">"Código TAC Original:"</span><span class="op">,</span> tac_code<span class="op">);</span></span>
<span id="cb10-422"><a href="#cb10-422" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>println<span class="op">(</span><span class="st">""</span><span class="op">);</span></span>
<span id="cb10-423"><a href="#cb10-423" aria-hidden="true" tabindex="-1"></a>    print_variables<span class="op">(</span>used_vars<span class="op">);</span></span>
<span id="cb10-424"><a href="#cb10-424" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-425"><a href="#cb10-425" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Executa a otimização de eliminação de código morto.</span></span>
<span id="cb10-426"><a href="#cb10-426" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> <span class="kw">auto</span> optimized_code <span class="op">=</span> eliminate_dead_code<span class="op">(</span>tac_code<span class="op">,</span> used_vars<span class="op">);</span></span>
<span id="cb10-427"><a href="#cb10-427" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-428"><a href="#cb10-428" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>println<span class="op">(</span><span class="st">""</span><span class="op">);</span></span>
<span id="cb10-429"><a href="#cb10-429" aria-hidden="true" tabindex="-1"></a>    print_code<span class="op">(</span><span class="st">"Código TAC Otimizado (Eliminação de Código Morto):"</span><span class="op">,</span> optimized_code<span class="op">);</span></span>
<span id="cb10-430"><a href="#cb10-430" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-431"><a href="#cb10-431" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Calcula e imprime estatísticas</span></span>
<span id="cb10-432"><a href="#cb10-432" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> <span class="kw">auto</span> stats <span class="op">=</span> calculate_statistics<span class="op">(</span>tac_code<span class="op">.</span>size<span class="op">(),</span> optimized_code<span class="op">.</span>size<span class="op">());</span></span>
<span id="cb10-433"><a href="#cb10-433" aria-hidden="true" tabindex="-1"></a>    print_statistics<span class="op">(</span>stats<span class="op">);</span></span>
<span id="cb10-434"><a href="#cb10-434" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-435"><a href="#cb10-435" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb10-436"><a href="#cb10-436" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="movimentação-de-código-invariante-de-laço-loop-invariant-code-motion---licm" class="level2" data-number="17.3">
<h2 data-number="17.3" class="anchored" data-anchor-id="movimentação-de-código-invariante-de-laço-loop-invariant-code-motion---licm"><span class="header-section-number">17.3</span> Movimentação de Código Invariante de Laço (<em>Loop Invariant Code Motion - LICM</em>)</h2>
<p>A Movimentação de Código Invariante de Laço (LICM) é uma otimização que identifica expressões cujo valor não se altera durante as iterações de um laço (instruções <em>invariantes</em>) e as move para um ponto <em>antes</em> do laço, onde são calculadas apenas uma vez.</p>
<p>Embora o LICM seja tecnicamente classificado como uma otimização <strong>Global</strong> (pois depende da identificação da estrutura de laço no Grafo de Fluxo de Controle — CFG), sua aplicação é <strong>local</strong> ao corpo do laço. O principal benefício é a eliminação de cálculos repetitivos, permitindo que uma expressão seja avaliada apenas uma vez, independentemente do número de iterações do laço.</p>
<p>O LICM é uma otimização de altíssimo valor, pois laços frequentemente representam a maior parte do tempo de execução de um programa.</p>
<section id="condições-de-invariância" class="level3" data-number="17.3.1">
<h3 data-number="17.3.1" class="anchored" data-anchor-id="condições-de-invariância"><span class="header-section-number">17.3.1</span> Condições de Invariância</h3>
<p>Uma instrução de atribuição, <span class="math inline">\(destino = arg1\ op\ arg2\)</span>, é considerada <strong>invariante ao laço</strong> se atender às seguintes condições de segurança:</p>
<ol type="1">
<li><strong>Sem Efeitos Colaterais:</strong> A instrução não deve ter efeitos colaterais que impactem o programa (e.g., I/O, chamadas a funções com mutação de estado, ou instruções de controle de fluxo).</li>
<li><strong>Independência de Controle:</strong> Nenhum dos operandos (<code>arg1</code> e <code>arg2</code>) é modificado dentro do laço. Isto é:
<ul>
<li>Nenhum dos argumentos é uma variável de controle do laço (e.g., <span class="math inline">\(i\)</span> em <code>for i...</code>).</li>
<li>Nenhum dos argumentos é definido por uma instrução <strong>variante</strong> (não invariante) dentro do laço.</li>
</ul></li>
<li><strong>Segurança de Definição:</strong> A otimização não deve introduzir <em>faults</em> ou exceções. Se o laço puder ser evitado por uma condição, a instrução invariante não deve ser movida, a menos que se possa provar que o laço é sempre executado pelo menos uma vez. (Para fins de otimização <em>peephole</em> simplificada, assumimos que o movimento é seguro se não houver efeitos colaterais).</li>
</ol>
</section>
<section id="algoritmo-simplificado-modelo-peephole-para-licm" class="level3" data-number="17.3.2">
<h3 data-number="17.3.2" class="anchored" data-anchor-id="algoritmo-simplificado-modelo-peephole-para-licm"><span class="header-section-number">17.3.2</span> Algoritmo Simplificado (Modelo <em>Peephole</em> para LICM)</h3>
<p>Em um contexto de otimização local, a implementação foca na identificação sintática de <em>loops</em> e na verificação das regras de independência:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>variaveis_modificadas_no_laco <span class="op">=</span> {}</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>Para cada instrução I no corpo do laço:</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    Se (I não tem efeitos colaterais) E (I não usa variavel_de_controle) E (I não usa variaveis_modificadas_no_laco):</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>        Mover I para antes do laço.</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    Senão:</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>        Manter I no corpo.</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>        Adicionar I.destino à variaveis_modificadas_no_laco.</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="exemplo-de-aplicação-e-benefício" class="level3" data-number="17.3.3">
<h3 data-number="17.3.3" class="anchored" data-anchor-id="exemplo-de-aplicação-e-benefício"><span class="header-section-number">17.3.3</span> Exemplo de Aplicação e Benefício</h3>
<p>Considere o seguinte código:</p>
<p><strong>Antes (Sem Otimização):</strong></p>
<pre class="shell"><code>t1 = a + b &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Executa 1 vez
for i in range(N):
&nbsp; &nbsp; t2 = t1 * c &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # CÁLCULO REPETITIVO (N vezes)
&nbsp; &nbsp; t3 = array_base + t2 &nbsp; # CÁLCULO REPETITIVO (N vezes)
&nbsp; &nbsp; array[i] = t3 + i</code></pre>
<p>A expressão <span class="math inline">\(t2 = t1 * c\)</span> é invariante porque <span class="math inline">\(t1\)</span> foi definida antes do laço, e <span class="math inline">\(c\)</span> não é modificada dentro dele. A expressão <span class="math inline">\(t3 = array\_base + t2\)</span> também é invariante (depende apenas de invariantes).</p>
<p><strong>Depois (Com LICM):</strong></p>
<pre class="shell"><code>t1 = a + b
t2 = t1 * c &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # Movido (Executa 1 vez)
t3 = array_base + t2 &nbsp; &nbsp; &nbsp; # Movido (Executa 1 vez)
for i in range(N):
&nbsp; &nbsp; array[i] = t3 + i</code></pre>
<p>Otimização alcançada: Redução de <span class="math inline">\(2 \times (N-1)\)</span> operações de custo médio/alto (multiplicação e adição), o que é um ganho de desempenho exponencial em laços longos.</p>
</section>
<section id="exemplo-em-c23" class="level3" data-number="17.3.4">
<h3 data-number="17.3.4" class="anchored" data-anchor-id="exemplo-em-c23"><span class="header-section-number">17.3.4</span> Exemplo em C++23</h3>
<div class="sourceCode" id="cb14"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@file</span><span class="co"> </span><span class="cv">loop_invariant_code_motion.cpp</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@author</span><span class="co"> Frank Alcantara</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@date</span><span class="co"> 2025-10-10</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@brief</span><span class="co"> Implementação simplificada da otimização de Movimentação de Código Invariante de Laço (LICM).</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="co"> * Esta implementação simula a identificação de laços "for" e o movimento de instruções</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="co"> * que são invariantes em relação às variáveis de controle ou variáveis modificadas</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="co"> * dentro do laço. A detecção de laço é baseada na palavra-chave "for" com validação</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="co"> * estrutural e marcador explícito de fim de laço ("endloop:").</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a><span class="co"> * Limitações:</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a><span class="co"> * - Não suporta loops aninhados</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a><span class="co"> * - Não realiza análise de dominância (essencial para LICM real)</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a><span class="co"> * - Não considera aliasing de memória</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a><span class="co"> * - Parsing simplificado (não é um parser completo)</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="in">@note</span><span class="co"> Requer C++23 ou superior. Este código foi desenvolvido como parte de um</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a><span class="co"> * material educacional sobre otimizações de compiladores e usou o Google Gemini e</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a><span class="co"> * o Anthropic Claude como ferramentas de pesquisa e revisão.</span></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;iostream&gt;</span></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;vector&gt;</span></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;string&gt;</span></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;string_view&gt;</span></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unordered_set&gt;</span></span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;algorithm&gt;</span></span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;regex&gt;</span></span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;ranges&gt;</span></span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;print&gt;</span></span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;optional&gt;</span></span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;span&gt;</span></span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;array&gt;</span></span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;cctype&gt;</span></span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;format&gt;</span></span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a><span class="co">// Namespace aliases</span></span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a><span class="kw">namespace</span> ranges <span class="op">=</span> <span class="bu">std::</span>ranges<span class="op">;</span></span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a><span class="kw">namespace</span> views <span class="op">=</span> <span class="bu">std::</span>views<span class="op">;</span></span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a><span class="co">// Type aliases</span></span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> InstructionList <span class="op">=</span> <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="bu">std::</span>string<span class="op">&gt;;</span></span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> VarSet <span class="op">=</span> <span class="bu">std::</span>unordered_set<span class="op">&lt;</span><span class="bu">std::</span>string<span class="op">&gt;;</span></span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@brief</span><span class="co"> Estrutura que representa uma instrução TAC parseada.</span></span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb14-49"><a href="#cb14-49" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> TACInstruction <span class="op">{</span></span>
<span id="cb14-50"><a href="#cb14-50" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>string lhs<span class="op">;</span>                       <span class="co">///&lt; Variável definida (lado esquerdo)</span></span>
<span id="cb14-51"><a href="#cb14-51" aria-hidden="true" tabindex="-1"></a>    VarSet rhs_vars<span class="op">;</span>                       <span class="co">///&lt; Variáveis usadas (lado direito)</span></span>
<span id="cb14-52"><a href="#cb14-52" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>string original_line<span class="op">;</span>             <span class="co">///&lt; Linha original da instrução</span></span>
<span id="cb14-53"><a href="#cb14-53" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> has_side_effects<span class="op">;</span>                 <span class="co">///&lt; Indica se tem efeitos colaterais</span></span>
<span id="cb14-54"><a href="#cb14-54" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> is_assignment<span class="op">;</span>                    <span class="co">///&lt; Indica se a linha é uma atribuição</span></span>
<span id="cb14-55"><a href="#cb14-55" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> original_indent<span class="op">;</span>                <span class="co">///&lt; Indentação original da linha</span></span>
<span id="cb14-56"><a href="#cb14-56" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb14-57"><a href="#cb14-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-58"><a href="#cb14-58" aria-hidden="true" tabindex="-1"></a><span class="co">// --------------------------------------------------------------------------------</span></span>
<span id="cb14-59"><a href="#cb14-59" aria-hidden="true" tabindex="-1"></a><span class="co">// Funções Auxiliares de Parsing</span></span>
<span id="cb14-60"><a href="#cb14-60" aria-hidden="true" tabindex="-1"></a><span class="co">// --------------------------------------------------------------------------------</span></span>
<span id="cb14-61"><a href="#cb14-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-62"><a href="#cb14-62" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb14-63"><a href="#cb14-63" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@brief</span><span class="co"> Calcula a indentação (número de espaços) no início de uma string.</span></span>
<span id="cb14-64"><a href="#cb14-64" aria-hidden="true" tabindex="-1"></a><span class="co"> * * </span><span class="an">@param</span><span class="co"> </span><span class="cv">sv</span><span class="co"> String view a ser analisada</span></span>
<span id="cb14-65"><a href="#cb14-65" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@return</span><span class="co"> size_t Número de espaços no início</span></span>
<span id="cb14-66"><a href="#cb14-66" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb14-67"><a href="#cb14-67" aria-hidden="true" tabindex="-1"></a><span class="op">[[</span><span class="at">nodiscard</span><span class="op">]]</span> <span class="kw">constexpr</span> <span class="dt">size_t</span> count_leading_spaces<span class="op">(</span><span class="bu">std::</span>string_view sv<span class="op">)</span> <span class="kw">noexcept</span> <span class="op">{</span></span>
<span id="cb14-68"><a href="#cb14-68" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">static_cast</span><span class="op">&lt;</span><span class="dt">size_t</span><span class="op">&gt;(</span>ranges<span class="op">::</span>distance<span class="op">(</span></span>
<span id="cb14-69"><a href="#cb14-69" aria-hidden="true" tabindex="-1"></a>        sv<span class="op">.</span>begin<span class="op">(),</span></span>
<span id="cb14-70"><a href="#cb14-70" aria-hidden="true" tabindex="-1"></a>        ranges<span class="op">::</span>find_if_not<span class="op">(</span>sv<span class="op">,</span> <span class="op">[](</span><span class="dt">char</span> ch<span class="op">)</span> <span class="op">{</span> <span class="cf">return</span> ch <span class="op">==</span> <span class="ch">' '</span><span class="op">;</span> <span class="op">})</span></span>
<span id="cb14-71"><a href="#cb14-71" aria-hidden="true" tabindex="-1"></a>    <span class="op">));</span></span>
<span id="cb14-72"><a href="#cb14-72" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb14-73"><a href="#cb14-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-74"><a href="#cb14-74" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb14-75"><a href="#cb14-75" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@brief</span><span class="co"> Remove espaços em branco do início e do fim de uma string view.</span></span>
<span id="cb14-76"><a href="#cb14-76" aria-hidden="true" tabindex="-1"></a><span class="co"> * * </span><span class="an">@param</span><span class="co"> </span><span class="cv">sv</span><span class="co"> String view a ser processada</span></span>
<span id="cb14-77"><a href="#cb14-77" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@return</span><span class="co"> std::string_view String sem espaços nas extremidades</span></span>
<span id="cb14-78"><a href="#cb14-78" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb14-79"><a href="#cb14-79" aria-hidden="true" tabindex="-1"></a><span class="op">[[</span><span class="at">nodiscard</span><span class="op">]]</span> <span class="kw">constexpr</span> <span class="bu">std::</span>string_view trim<span class="op">(</span><span class="bu">std::</span>string_view sv<span class="op">)</span> <span class="kw">noexcept</span> <span class="op">{</span></span>
<span id="cb14-80"><a href="#cb14-80" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> <span class="kw">auto</span> is_space <span class="op">=</span> <span class="op">[](</span><span class="dt">unsigned</span> <span class="dt">char</span> ch<span class="op">)</span> <span class="op">{</span> <span class="cf">return</span> <span class="bu">std::</span>isspace<span class="op">(</span>ch<span class="op">);</span> <span class="op">};</span></span>
<span id="cb14-81"><a href="#cb14-81" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> start <span class="op">=</span> ranges<span class="op">::</span>find_if_not<span class="op">(</span>sv<span class="op">,</span> is_space<span class="op">);</span></span>
<span id="cb14-82"><a href="#cb14-82" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>start <span class="op">==</span> sv<span class="op">.</span>end<span class="op">())</span> <span class="op">{</span></span>
<span id="cb14-83"><a href="#cb14-83" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="op">{};</span></span>
<span id="cb14-84"><a href="#cb14-84" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb14-85"><a href="#cb14-85" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> end <span class="op">=</span> ranges<span class="op">::</span>find_if_not<span class="op">(</span>sv <span class="op">|</span> views<span class="op">::</span>reverse<span class="op">,</span> is_space<span class="op">).</span>base<span class="op">();</span></span>
<span id="cb14-86"><a href="#cb14-86" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> sv<span class="op">.</span>substr<span class="op">(</span><span class="bu">std::</span>distance<span class="op">(</span>sv<span class="op">.</span>begin<span class="op">(),</span> start<span class="op">),</span> <span class="bu">std::</span>distance<span class="op">(</span>start<span class="op">,</span> end<span class="op">));</span></span>
<span id="cb14-87"><a href="#cb14-87" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb14-88"><a href="#cb14-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-89"><a href="#cb14-89" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb14-90"><a href="#cb14-90" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@brief</span><span class="co"> Verifica se uma instrução contém efeitos colaterais que impedem o movimento.</span></span>
<span id="cb14-91"><a href="#cb14-91" aria-hidden="true" tabindex="-1"></a><span class="co"> * * Efeitos colaterais incluem chamadas de função, I/O, saltos e retornos.</span></span>
<span id="cb14-92"><a href="#cb14-92" aria-hidden="true" tabindex="-1"></a><span class="co"> * * </span><span class="an">@param</span><span class="co"> </span><span class="cv">instruction</span><span class="co"> Instrução a ser verificada</span></span>
<span id="cb14-93"><a href="#cb14-93" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@return</span><span class="co"> true Se a instrução tem efeitos colaterais</span></span>
<span id="cb14-94"><a href="#cb14-94" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb14-95"><a href="#cb14-95" aria-hidden="true" tabindex="-1"></a><span class="op">[[</span><span class="at">nodiscard</span><span class="op">]]</span> <span class="dt">bool</span> has_side_effects<span class="op">(</span><span class="bu">std::</span>string_view instruction<span class="op">)</span> <span class="kw">noexcept</span> <span class="op">{</span></span>
<span id="cb14-96"><a href="#cb14-96" aria-hidden="true" tabindex="-1"></a>    <span class="kw">constexpr</span> <span class="bu">std::</span>array side_effect_keywords <span class="op">=</span> <span class="op">{</span></span>
<span id="cb14-97"><a href="#cb14-97" aria-hidden="true" tabindex="-1"></a>        <span class="st">"CALL"</span><span class="op">,</span> <span class="st">"PRINT"</span><span class="op">,</span> <span class="st">"WRITE"</span><span class="op">,</span> <span class="st">"READ"</span><span class="op">,</span> <span class="st">"GOTO"</span><span class="op">,</span> <span class="st">"RETURN"</span><span class="op">,</span> <span class="st">"BREAK"</span><span class="op">,</span> <span class="st">"CONTINUE"</span></span>
<span id="cb14-98"><a href="#cb14-98" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb14-99"><a href="#cb14-99" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-100"><a href="#cb14-100" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Converte a instrução para maiúsculas para comparação case-insensitive</span></span>
<span id="cb14-101"><a href="#cb14-101" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> to_upper <span class="op">=</span> <span class="op">[](</span><span class="dt">char</span> ch<span class="op">)</span> <span class="op">{</span> </span>
<span id="cb14-102"><a href="#cb14-102" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">static_cast</span><span class="op">&lt;</span><span class="dt">char</span><span class="op">&gt;(</span><span class="bu">std::</span>toupper<span class="op">(</span><span class="kw">static_cast</span><span class="op">&lt;</span><span class="dt">unsigned</span> <span class="dt">char</span><span class="op">&gt;(</span>ch<span class="op">)));</span> </span>
<span id="cb14-103"><a href="#cb14-103" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb14-104"><a href="#cb14-104" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>string upper_str<span class="op">;</span></span>
<span id="cb14-105"><a href="#cb14-105" aria-hidden="true" tabindex="-1"></a>    upper_str<span class="op">.</span>reserve<span class="op">(</span>instruction<span class="op">.</span>size<span class="op">());</span></span>
<span id="cb14-106"><a href="#cb14-106" aria-hidden="true" tabindex="-1"></a>    ranges<span class="op">::</span>transform<span class="op">(</span>instruction<span class="op">,</span> <span class="bu">std::</span>back_inserter<span class="op">(</span>upper_str<span class="op">),</span> to_upper<span class="op">);</span></span>
<span id="cb14-107"><a href="#cb14-107" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-108"><a href="#cb14-108" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ranges<span class="op">::</span>any_of<span class="op">(</span>side_effect_keywords<span class="op">,</span> <span class="op">[&amp;</span>upper_str<span class="op">](</span><span class="bu">std::</span>string_view keyword<span class="op">)</span> <span class="op">{</span></span>
<span id="cb14-109"><a href="#cb14-109" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> upper_str<span class="op">.</span>find<span class="op">(</span>keyword<span class="op">)</span> <span class="op">!=</span> <span class="bu">std::</span>string::npos<span class="op">;</span></span>
<span id="cb14-110"><a href="#cb14-110" aria-hidden="true" tabindex="-1"></a>    <span class="op">});</span></span>
<span id="cb14-111"><a href="#cb14-111" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb14-112"><a href="#cb14-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-113"><a href="#cb14-113" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb14-114"><a href="#cb14-114" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@brief</span><span class="co"> Verifica se um token é um literal numérico.</span></span>
<span id="cb14-115"><a href="#cb14-115" aria-hidden="true" tabindex="-1"></a><span class="co"> * * </span><span class="an">@param</span><span class="co"> </span><span class="cv">token</span><span class="co"> Token a ser verificado</span></span>
<span id="cb14-116"><a href="#cb14-116" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@return</span><span class="co"> true Se é um literal numérico</span></span>
<span id="cb14-117"><a href="#cb14-117" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb14-118"><a href="#cb14-118" aria-hidden="true" tabindex="-1"></a><span class="op">[[</span><span class="at">nodiscard</span><span class="op">]]</span> <span class="kw">inline</span> <span class="dt">bool</span> is_numeric_literal<span class="op">(</span><span class="bu">std::</span>string_view token<span class="op">)</span> <span class="kw">noexcept</span> <span class="op">{</span></span>
<span id="cb14-119"><a href="#cb14-119" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>token<span class="op">.</span>empty<span class="op">())</span> <span class="op">{</span></span>
<span id="cb14-120"><a href="#cb14-120" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb14-121"><a href="#cb14-121" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb14-122"><a href="#cb14-122" aria-hidden="true" tabindex="-1"></a>    <span class="at">static</span> <span class="at">const</span> <span class="bu">std::</span>regex numeric_regex<span class="op">(</span><span class="st">R"(</span><span class="vs">^[+-]?(\d+\.?\d*|\.\d+)([eE][+-]?\d+)?$</span><span class="st">)"</span><span class="op">);</span></span>
<span id="cb14-123"><a href="#cb14-123" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">std::</span>regex_match<span class="op">(</span>token<span class="op">.</span>begin<span class="op">(),</span> token<span class="op">.</span>end<span class="op">(),</span> numeric_regex<span class="op">);</span></span>
<span id="cb14-124"><a href="#cb14-124" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb14-125"><a href="#cb14-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-126"><a href="#cb14-126" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb14-127"><a href="#cb14-127" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@brief</span><span class="co"> Verifica se um token é uma palavra-chave reservada do pseudo-código.</span></span>
<span id="cb14-128"><a href="#cb14-128" aria-hidden="true" tabindex="-1"></a><span class="co"> * * </span><span class="an">@param</span><span class="co"> </span><span class="cv">token</span><span class="co"> Token a ser verificado</span></span>
<span id="cb14-129"><a href="#cb14-129" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@return</span><span class="co"> true Se é uma palavra-chave</span></span>
<span id="cb14-130"><a href="#cb14-130" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb14-131"><a href="#cb14-131" aria-hidden="true" tabindex="-1"></a><span class="op">[[</span><span class="at">nodiscard</span><span class="op">]]</span> <span class="dt">bool</span> is_keyword<span class="op">(</span><span class="bu">std::</span>string_view token<span class="op">)</span> <span class="kw">noexcept</span> <span class="op">{</span></span>
<span id="cb14-132"><a href="#cb14-132" aria-hidden="true" tabindex="-1"></a>    <span class="kw">constexpr</span> <span class="bu">std::</span>array keywords <span class="op">=</span> <span class="op">{</span></span>
<span id="cb14-133"><a href="#cb14-133" aria-hidden="true" tabindex="-1"></a>        <span class="st">"for"</span><span class="op">,</span> <span class="st">"in"</span><span class="op">,</span> <span class="st">"range"</span><span class="op">,</span> <span class="st">"while"</span><span class="op">,</span> <span class="st">"if"</span><span class="op">,</span> <span class="st">"else"</span><span class="op">,</span> <span class="st">"elif"</span><span class="op">,</span></span>
<span id="cb14-134"><a href="#cb14-134" aria-hidden="true" tabindex="-1"></a>        <span class="st">"def"</span><span class="op">,</span> <span class="st">"return"</span><span class="op">,</span> <span class="st">"break"</span><span class="op">,</span> <span class="st">"continue"</span><span class="op">,</span> <span class="st">"pass"</span><span class="op">,</span> <span class="st">"endloop"</span></span>
<span id="cb14-135"><a href="#cb14-135" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb14-136"><a href="#cb14-136" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-137"><a href="#cb14-137" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ranges<span class="op">::</span>contains<span class="op">(</span>keywords<span class="op">,</span> token<span class="op">);</span></span>
<span id="cb14-138"><a href="#cb14-138" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb14-139"><a href="#cb14-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-140"><a href="#cb14-140" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb14-141"><a href="#cb14-141" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@brief</span><span class="co"> Extrai variáveis de uma expressão do lado direito (RHS).</span></span>
<span id="cb14-142"><a href="#cb14-142" aria-hidden="true" tabindex="-1"></a><span class="co"> * * Remove literais numéricos e palavras-chave da lista de variáveis.</span></span>
<span id="cb14-143"><a href="#cb14-143" aria-hidden="true" tabindex="-1"></a><span class="co"> * * </span><span class="an">@param</span><span class="co"> </span><span class="cv">rhs</span><span class="co"> Expressão do lado direito</span></span>
<span id="cb14-144"><a href="#cb14-144" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@return</span><span class="co"> VarSet Conjunto de variáveis encontradas</span></span>
<span id="cb14-145"><a href="#cb14-145" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb14-146"><a href="#cb14-146" aria-hidden="true" tabindex="-1"></a><span class="op">[[</span><span class="at">nodiscard</span><span class="op">]]</span> VarSet extract_rhs_variables<span class="op">(</span><span class="bu">std::</span>string_view rhs<span class="op">)</span> <span class="op">{</span></span>
<span id="cb14-147"><a href="#cb14-147" aria-hidden="true" tabindex="-1"></a>    VarSet rhs_vars<span class="op">;</span></span>
<span id="cb14-148"><a href="#cb14-148" aria-hidden="true" tabindex="-1"></a>    <span class="at">static</span> <span class="at">const</span> <span class="bu">std::</span>regex var_regex<span class="op">(</span><span class="st">R"(</span><span class="vs">[a-zA-Z_][a-zA-Z0-9_]*</span><span class="st">)"</span><span class="op">);</span></span>
<span id="cb14-149"><a href="#cb14-149" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-150"><a href="#cb14-150" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> begin <span class="op">=</span> <span class="bu">std::</span>cregex_iterator<span class="op">(</span>rhs<span class="op">.</span>begin<span class="op">(),</span> rhs<span class="op">.</span>end<span class="op">(),</span> var_regex<span class="op">);</span></span>
<span id="cb14-151"><a href="#cb14-151" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> end <span class="op">=</span> <span class="bu">std::</span>cregex_iterator<span class="op">();</span></span>
<span id="cb14-152"><a href="#cb14-152" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-153"><a href="#cb14-153" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="at">const</span> <span class="kw">auto</span><span class="op">&amp;</span> match <span class="op">:</span> ranges<span class="op">::</span>subrange<span class="op">(</span>begin<span class="op">,</span> end<span class="op">))</span> <span class="op">{</span></span>
<span id="cb14-154"><a href="#cb14-154" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Usa construtor de string_view a partir de iteradores do match</span></span>
<span id="cb14-155"><a href="#cb14-155" aria-hidden="true" tabindex="-1"></a>        <span class="bu">std::</span>string_view var_view<span class="op">(</span>match<span class="op">[</span><span class="dv">0</span><span class="op">].</span>first<span class="op">,</span> match<span class="op">[</span><span class="dv">0</span><span class="op">].</span>second<span class="op">);</span></span>
<span id="cb14-156"><a href="#cb14-156" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-157"><a href="#cb14-157" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Filtra literais numéricos e palavras-chave</span></span>
<span id="cb14-158"><a href="#cb14-158" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(!</span>is_numeric_literal<span class="op">(</span>var_view<span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="op">!</span>is_keyword<span class="op">(</span>var_view<span class="op">))</span> <span class="op">{</span></span>
<span id="cb14-159"><a href="#cb14-159" aria-hidden="true" tabindex="-1"></a>            rhs_vars<span class="op">.</span>emplace<span class="op">(</span>var_view<span class="op">);</span></span>
<span id="cb14-160"><a href="#cb14-160" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb14-161"><a href="#cb14-161" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb14-162"><a href="#cb14-162" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-163"><a href="#cb14-163" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> rhs_vars<span class="op">;</span></span>
<span id="cb14-164"><a href="#cb14-164" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb14-165"><a href="#cb14-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-166"><a href="#cb14-166" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb14-167"><a href="#cb14-167" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@brief</span><span class="co"> Extrai a variável definida (LHS) e as variáveis usadas (RHS) de uma instrução TAC.</span></span>
<span id="cb14-168"><a href="#cb14-168" aria-hidden="true" tabindex="-1"></a><span class="co"> * * </span><span class="an">@param</span><span class="co"> </span><span class="cv">instruction</span><span class="co"> Instrução TAC a ser parseada</span></span>
<span id="cb14-169"><a href="#cb14-169" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@return</span><span class="co"> TACInstruction Estrutura com informações da instrução</span></span>
<span id="cb14-170"><a href="#cb14-170" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb14-171"><a href="#cb14-171" aria-hidden="true" tabindex="-1"></a><span class="op">[[</span><span class="at">nodiscard</span><span class="op">]]</span> TACInstruction parse_tac_instruction<span class="op">(</span><span class="bu">std::</span>string_view instruction<span class="op">)</span> <span class="op">{</span></span>
<span id="cb14-172"><a href="#cb14-172" aria-hidden="true" tabindex="-1"></a>    TACInstruction result<span class="op">{</span></span>
<span id="cb14-173"><a href="#cb14-173" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>lhs <span class="op">=</span> <span class="op">{},</span></span>
<span id="cb14-174"><a href="#cb14-174" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>rhs_vars <span class="op">=</span> <span class="op">{},</span></span>
<span id="cb14-175"><a href="#cb14-175" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>original_line <span class="op">=</span> <span class="bu">std::</span>string<span class="op">(</span>instruction<span class="op">),</span></span>
<span id="cb14-176"><a href="#cb14-176" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>has_side_effects <span class="op">=</span> has_side_effects<span class="op">(</span>instruction<span class="op">),</span></span>
<span id="cb14-177"><a href="#cb14-177" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>is_assignment <span class="op">=</span> <span class="kw">false</span><span class="op">,</span></span>
<span id="cb14-178"><a href="#cb14-178" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>original_indent <span class="op">=</span> count_leading_spaces<span class="op">(</span>instruction<span class="op">)</span></span>
<span id="cb14-179"><a href="#cb14-179" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb14-180"><a href="#cb14-180" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-181"><a href="#cb14-181" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> trimmed <span class="op">=</span> trim<span class="op">(</span>instruction<span class="op">);</span></span>
<span id="cb14-182"><a href="#cb14-182" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-183"><a href="#cb14-183" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Verifica se é uma atribuição (contém '=' e não tem efeitos colaterais conhecidos)</span></span>
<span id="cb14-184"><a href="#cb14-184" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> eq_pos <span class="op">=</span> trimmed<span class="op">.</span>find<span class="op">(</span><span class="ch">'='</span><span class="op">);</span></span>
<span id="cb14-185"><a href="#cb14-185" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>eq_pos <span class="op">!=</span> <span class="bu">std::</span>string_view::npos <span class="op">&amp;&amp;</span> <span class="op">!</span>result<span class="op">.</span>has_side_effects<span class="op">)</span> <span class="op">{</span></span>
<span id="cb14-186"><a href="#cb14-186" aria-hidden="true" tabindex="-1"></a>        result<span class="op">.</span>is_assignment <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb14-187"><a href="#cb14-187" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-188"><a href="#cb14-188" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Extrai LHS</span></span>
<span id="cb14-189"><a href="#cb14-189" aria-hidden="true" tabindex="-1"></a>        <span class="kw">auto</span> lhs_view <span class="op">=</span> trim<span class="op">(</span>trimmed<span class="op">.</span>substr<span class="op">(</span><span class="dv">0</span><span class="op">,</span> eq_pos<span class="op">));</span></span>
<span id="cb14-190"><a href="#cb14-190" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(!</span>lhs_view<span class="op">.</span>empty<span class="op">()</span> <span class="op">&amp;&amp;</span> <span class="op">!</span>is_keyword<span class="op">(</span>lhs_view<span class="op">))</span> <span class="op">{</span></span>
<span id="cb14-191"><a href="#cb14-191" aria-hidden="true" tabindex="-1"></a>            result<span class="op">.</span>lhs <span class="op">=</span> <span class="bu">std::</span>string<span class="op">(</span>lhs_view<span class="op">);</span></span>
<span id="cb14-192"><a href="#cb14-192" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb14-193"><a href="#cb14-193" aria-hidden="true" tabindex="-1"></a>            result<span class="op">.</span>is_assignment <span class="op">=</span> <span class="kw">false</span><span class="op">;</span> <span class="co">// Atribuição malformada ou palavra-chave</span></span>
<span id="cb14-194"><a href="#cb14-194" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb14-195"><a href="#cb14-195" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-196"><a href="#cb14-196" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Extrai RHS</span></span>
<span id="cb14-197"><a href="#cb14-197" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>eq_pos <span class="op">+</span> <span class="dv">1</span> <span class="op">&lt;</span> trimmed<span class="op">.</span>size<span class="op">())</span> <span class="op">{</span></span>
<span id="cb14-198"><a href="#cb14-198" aria-hidden="true" tabindex="-1"></a>            <span class="kw">auto</span> rhs_view <span class="op">=</span> trimmed<span class="op">.</span>substr<span class="op">(</span>eq_pos <span class="op">+</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb14-199"><a href="#cb14-199" aria-hidden="true" tabindex="-1"></a>            result<span class="op">.</span>rhs_vars <span class="op">=</span> extract_rhs_variables<span class="op">(</span>rhs_view<span class="op">);</span></span>
<span id="cb14-200"><a href="#cb14-200" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb14-201"><a href="#cb14-201" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb14-202"><a href="#cb14-202" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-203"><a href="#cb14-203" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result<span class="op">;</span></span>
<span id="cb14-204"><a href="#cb14-204" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb14-205"><a href="#cb14-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-206"><a href="#cb14-206" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb14-207"><a href="#cb14-207" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@brief</span><span class="co"> Valida e extrai a variável de controle de um loop "for".</span></span>
<span id="cb14-208"><a href="#cb14-208" aria-hidden="true" tabindex="-1"></a><span class="co"> * * Espera o formato: "for </span><span class="kw">&lt;var&gt;</span><span class="co"> in </span><span class="kw">&lt;expr&gt;</span><span class="co">:"</span></span>
<span id="cb14-209"><a href="#cb14-209" aria-hidden="true" tabindex="-1"></a><span class="co"> * * </span><span class="an">@param</span><span class="co"> </span><span class="cv">loop_line</span><span class="co"> Linha contendo a declaração do loop</span></span>
<span id="cb14-210"><a href="#cb14-210" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@return</span><span class="co"> std::optional</span><span class="kw">&lt;std::string&gt;</span><span class="co"> Variável de controle, se válida</span></span>
<span id="cb14-211"><a href="#cb14-211" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb14-212"><a href="#cb14-212" aria-hidden="true" tabindex="-1"></a><span class="op">[[</span><span class="at">nodiscard</span><span class="op">]]</span> <span class="bu">std::</span>optional<span class="op">&lt;</span><span class="bu">std::</span>string<span class="op">&gt;</span> extract_loop_variable<span class="op">(</span><span class="bu">std::</span>string_view loop_line<span class="op">)</span> <span class="op">{</span></span>
<span id="cb14-213"><a href="#cb14-213" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> trimmed <span class="op">=</span> trim<span class="op">(</span>loop_line<span class="op">);</span></span>
<span id="cb14-214"><a href="#cb14-214" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-215"><a href="#cb14-215" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Deve começar com "for" e terminar com ":"</span></span>
<span id="cb14-216"><a href="#cb14-216" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>trimmed<span class="op">.</span>starts_with<span class="op">(</span><span class="st">"for"</span><span class="op">)</span> <span class="op">||</span> <span class="op">!</span>trimmed<span class="op">.</span>ends_with<span class="op">(</span><span class="st">":"</span><span class="op">))</span> <span class="op">{</span></span>
<span id="cb14-217"><a href="#cb14-217" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">std::</span>nullopt<span class="op">;</span></span>
<span id="cb14-218"><a href="#cb14-218" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb14-219"><a href="#cb14-219" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-220"><a href="#cb14-220" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Remove "for" e ":"</span></span>
<span id="cb14-221"><a href="#cb14-221" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> content <span class="op">=</span> trim<span class="op">(</span>trimmed<span class="op">.</span>substr<span class="op">(</span><span class="dv">3</span><span class="op">,</span> trimmed<span class="op">.</span>size<span class="op">()</span> <span class="op">-</span> <span class="dv">4</span><span class="op">));</span></span>
<span id="cb14-222"><a href="#cb14-222" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-223"><a href="#cb14-223" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Procura pela palavra-chave "in"</span></span>
<span id="cb14-224"><a href="#cb14-224" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> in_pos <span class="op">=</span> content<span class="op">.</span>find<span class="op">(</span><span class="st">" in "</span><span class="op">);</span></span>
<span id="cb14-225"><a href="#cb14-225" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>in_pos <span class="op">==</span> <span class="bu">std::</span>string_view::npos<span class="op">)</span> <span class="op">{</span></span>
<span id="cb14-226"><a href="#cb14-226" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">std::</span>nullopt<span class="op">;</span></span>
<span id="cb14-227"><a href="#cb14-227" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb14-228"><a href="#cb14-228" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-229"><a href="#cb14-229" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Extrai a variável (parte antes de "in")</span></span>
<span id="cb14-230"><a href="#cb14-230" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> var <span class="op">=</span> trim<span class="op">(</span>content<span class="op">.</span>substr<span class="op">(</span><span class="dv">0</span><span class="op">,</span> in_pos<span class="op">));</span></span>
<span id="cb14-231"><a href="#cb14-231" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-232"><a href="#cb14-232" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Valida: deve ser um identificador válido e não uma palavra-chave/literal</span></span>
<span id="cb14-233"><a href="#cb14-233" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>var<span class="op">.</span>empty<span class="op">()</span> <span class="op">||</span> is_keyword<span class="op">(</span>var<span class="op">)</span> <span class="op">||</span> is_numeric_literal<span class="op">(</span>var<span class="op">))</span> <span class="op">{</span></span>
<span id="cb14-234"><a href="#cb14-234" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">std::</span>nullopt<span class="op">;</span></span>
<span id="cb14-235"><a href="#cb14-235" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb14-236"><a href="#cb14-236" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-237"><a href="#cb14-237" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Validação adicional de identificador</span></span>
<span id="cb14-238"><a href="#cb14-238" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span><span class="bu">std::</span>isalpha<span class="op">(</span><span class="kw">static_cast</span><span class="op">&lt;</span><span class="dt">unsigned</span> <span class="dt">char</span><span class="op">&gt;(</span>var<span class="op">[</span><span class="dv">0</span><span class="op">]))</span> <span class="op">&amp;&amp;</span> var<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">!=</span> <span class="ch">'_'</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb14-239"><a href="#cb14-239" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">std::</span>nullopt<span class="op">;</span></span>
<span id="cb14-240"><a href="#cb14-240" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb14-241"><a href="#cb14-241" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-242"><a href="#cb14-242" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">std::</span>string<span class="op">(</span>var<span class="op">);</span></span>
<span id="cb14-243"><a href="#cb14-243" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb14-244"><a href="#cb14-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-245"><a href="#cb14-245" aria-hidden="true" tabindex="-1"></a><span class="co">// --------------------------------------------------------------------------------</span></span>
<span id="cb14-246"><a href="#cb14-246" aria-hidden="true" tabindex="-1"></a><span class="co">// Classe Principal da Otimização (LICM)</span></span>
<span id="cb14-247"><a href="#cb14-247" aria-hidden="true" tabindex="-1"></a><span class="co">// --------------------------------------------------------------------------------</span></span>
<span id="cb14-248"><a href="#cb14-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-249"><a href="#cb14-249" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb14-250"><a href="#cb14-250" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@brief</span><span class="co"> Implementa a otimização de Movimentação de Código Invariante de Laço.</span></span>
<span id="cb14-251"><a href="#cb14-251" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb14-252"><a href="#cb14-252" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> LoopInvariantCodeMotion <span class="op">{</span></span>
<span id="cb14-253"><a href="#cb14-253" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span><span class="op">:</span></span>
<span id="cb14-254"><a href="#cb14-254" aria-hidden="true" tabindex="-1"></a>    InstructionList <span class="va">optimized_code_</span><span class="op">;</span>       <span class="co">///&lt; Código final otimizado</span></span>
<span id="cb14-255"><a href="#cb14-255" aria-hidden="true" tabindex="-1"></a>    InstructionList <span class="va">pre_loop_invariants_</span><span class="op">;</span>  <span class="co">///&lt; Invariantes a mover para ANTES do loop</span></span>
<span id="cb14-256"><a href="#cb14-256" aria-hidden="true" tabindex="-1"></a>    InstructionList <span class="va">loop_instructions_</span><span class="op">;</span>    <span class="co">///&lt; Instruções que permanecem DENTRO do loop</span></span>
<span id="cb14-257"><a href="#cb14-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-258"><a href="#cb14-258" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> <span class="va">loop_detected_</span> <span class="op">=</span> <span class="kw">false</span><span class="op">;</span>           <span class="co">///&lt; Indica se estamos processando um loop</span></span>
<span id="cb14-259"><a href="#cb14-259" aria-hidden="true" tabindex="-1"></a>    VarSet <span class="va">loop_vars_</span><span class="op">;</span>                     <span class="co">///&lt; Variáveis de controle do laço</span></span>
<span id="cb14-260"><a href="#cb14-260" aria-hidden="true" tabindex="-1"></a>    VarSet <span class="va">loop_mod_vars_</span><span class="op">;</span>                 <span class="co">///&lt; Variáveis modificadas dentro do laço</span></span>
<span id="cb14-261"><a href="#cb14-261" aria-hidden="true" tabindex="-1"></a>    VarSet <span class="va">pre_loop_defined_vars_</span><span class="op">;</span>         <span class="co">///&lt; Variáveis definidas antes do loop atual</span></span>
<span id="cb14-262"><a href="#cb14-262" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-263"><a href="#cb14-263" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> <span class="va">loop_indent_</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span>               <span class="co">///&lt; Indentação da linha "for"</span></span>
<span id="cb14-264"><a href="#cb14-264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-265"><a href="#cb14-265" aria-hidden="true" tabindex="-1"></a>    <span class="co">/**</span></span>
<span id="cb14-266"><a href="#cb14-266" aria-hidden="true" tabindex="-1"></a><span class="co">     * </span><span class="an">@brief</span><span class="co"> Verifica se uma instrução é invariante em relação ao loop.</span></span>
<span id="cb14-267"><a href="#cb14-267" aria-hidden="true" tabindex="-1"></a><span class="co">     * * </span><span class="an">@param</span><span class="co"> </span><span class="cv">parsed</span><span class="co"> Instrução parseada</span></span>
<span id="cb14-268"><a href="#cb14-268" aria-hidden="true" tabindex="-1"></a><span class="co">     * </span><span class="an">@return</span><span class="co"> true Se a instrução é invariante e pode ser movida</span></span>
<span id="cb14-269"><a href="#cb14-269" aria-hidden="true" tabindex="-1"></a><span class="co">     */</span></span>
<span id="cb14-270"><a href="#cb14-270" aria-hidden="true" tabindex="-1"></a>    <span class="op">[[</span><span class="at">nodiscard</span><span class="op">]]</span> <span class="dt">bool</span> is_loop_invariant<span class="op">(</span><span class="at">const</span> TACInstruction<span class="op">&amp;</span> parsed<span class="op">)</span> <span class="at">const</span> <span class="kw">noexcept</span> <span class="op">{</span></span>
<span id="cb14-271"><a href="#cb14-271" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(!</span>parsed<span class="op">.</span>is_assignment <span class="op">||</span> parsed<span class="op">.</span>has_side_effects<span class="op">)</span> <span class="op">{</span></span>
<span id="cb14-272"><a href="#cb14-272" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb14-273"><a href="#cb14-273" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb14-274"><a href="#cb14-274" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-275"><a href="#cb14-275" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 1. Verifica se depende da variável de controle</span></span>
<span id="cb14-276"><a href="#cb14-276" aria-hidden="true" tabindex="-1"></a>        <span class="dt">bool</span> depends_on_loop_var <span class="op">=</span> ranges<span class="op">::</span>any_of<span class="op">(</span>parsed<span class="op">.</span>rhs_vars<span class="op">,</span> </span>
<span id="cb14-277"><a href="#cb14-277" aria-hidden="true" tabindex="-1"></a>            <span class="op">[</span><span class="kw">this</span><span class="op">](</span><span class="at">const</span> <span class="bu">std::</span>string<span class="op">&amp;</span> var<span class="op">)</span> <span class="op">{</span> </span>
<span id="cb14-278"><a href="#cb14-278" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="va">loop_vars_</span><span class="op">.</span>contains<span class="op">(</span>var<span class="op">);</span> </span>
<span id="cb14-279"><a href="#cb14-279" aria-hidden="true" tabindex="-1"></a>            <span class="op">});</span></span>
<span id="cb14-280"><a href="#cb14-280" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-281"><a href="#cb14-281" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 2. Verifica se depende de variáveis modificadas dentro do loop</span></span>
<span id="cb14-282"><a href="#cb14-282" aria-hidden="true" tabindex="-1"></a>        <span class="dt">bool</span> depends_on_modified_var <span class="op">=</span> ranges<span class="op">::</span>any_of<span class="op">(</span>parsed<span class="op">.</span>rhs_vars<span class="op">,</span> </span>
<span id="cb14-283"><a href="#cb14-283" aria-hidden="true" tabindex="-1"></a>            <span class="op">[</span><span class="kw">this</span><span class="op">](</span><span class="at">const</span> <span class="bu">std::</span>string<span class="op">&amp;</span> var<span class="op">)</span> <span class="op">{</span> </span>
<span id="cb14-284"><a href="#cb14-284" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="va">loop_mod_vars_</span><span class="op">.</span>contains<span class="op">(</span>var<span class="op">);</span> </span>
<span id="cb14-285"><a href="#cb14-285" aria-hidden="true" tabindex="-1"></a>            <span class="op">});</span></span>
<span id="cb14-286"><a href="#cb14-286" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-287"><a href="#cb14-287" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="op">!</span>depends_on_loop_var <span class="op">&amp;&amp;</span> <span class="op">!</span>depends_on_modified_var<span class="op">;</span></span>
<span id="cb14-288"><a href="#cb14-288" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb14-289"><a href="#cb14-289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-290"><a href="#cb14-290" aria-hidden="true" tabindex="-1"></a>    <span class="co">/**</span></span>
<span id="cb14-291"><a href="#cb14-291" aria-hidden="true" tabindex="-1"></a><span class="co">     * </span><span class="an">@brief</span><span class="co"> Reconstrói a linha de código com a indentação apropriada.</span></span>
<span id="cb14-292"><a href="#cb14-292" aria-hidden="true" tabindex="-1"></a><span class="co">     */</span></span>
<span id="cb14-293"><a href="#cb14-293" aria-hidden="true" tabindex="-1"></a>    <span class="op">[[</span><span class="at">nodiscard</span><span class="op">]]</span> <span class="at">static</span> <span class="bu">std::</span>string format_with_indent<span class="op">(</span><span class="bu">std::</span>string_view line<span class="op">,</span> <span class="dt">size_t</span> indent<span class="op">)</span> <span class="op">{</span></span>
<span id="cb14-294"><a href="#cb14-294" aria-hidden="true" tabindex="-1"></a>        <span class="kw">auto</span> trimmed <span class="op">=</span> trim<span class="op">(</span>line<span class="op">);</span></span>
<span id="cb14-295"><a href="#cb14-295" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>trimmed<span class="op">.</span>empty<span class="op">())</span> <span class="op">{</span></span>
<span id="cb14-296"><a href="#cb14-296" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="bu">std::</span>string<span class="op">(</span>line<span class="op">);</span></span>
<span id="cb14-297"><a href="#cb14-297" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb14-298"><a href="#cb14-298" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">std::</span>format<span class="op">(</span><span class="st">"</span><span class="sc">{}{}</span><span class="st">"</span><span class="op">,</span> <span class="bu">std::</span>string<span class="op">(</span>indent<span class="op">,</span> <span class="ch">' '</span><span class="op">),</span> trimmed<span class="op">);</span></span>
<span id="cb14-299"><a href="#cb14-299" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb14-300"><a href="#cb14-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-301"><a href="#cb14-301" aria-hidden="true" tabindex="-1"></a>    <span class="co">/**</span></span>
<span id="cb14-302"><a href="#cb14-302" aria-hidden="true" tabindex="-1"></a><span class="co">     * </span><span class="an">@brief</span><span class="co"> Finaliza o processamento do laço atual e monta o bloco otimizado.</span></span>
<span id="cb14-303"><a href="#cb14-303" aria-hidden="true" tabindex="-1"></a><span class="co">     */</span></span>
<span id="cb14-304"><a href="#cb14-304" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> finalize_loop_block<span class="op">(</span><span class="bu">std::</span>optional<span class="op">&lt;</span><span class="bu">std::</span>string<span class="op">&gt;</span> end_marker <span class="op">=</span> <span class="bu">std::</span>nullopt<span class="op">)</span> <span class="op">{</span></span>
<span id="cb14-305"><a href="#cb14-305" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 1. Adiciona invariantes movidas para ANTES do loop</span></span>
<span id="cb14-306"><a href="#cb14-306" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="at">const</span> <span class="kw">auto</span><span class="op">&amp;</span> inv <span class="op">:</span> <span class="va">pre_loop_invariants_</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb14-307"><a href="#cb14-307" aria-hidden="true" tabindex="-1"></a>            <span class="va">optimized_code_</span><span class="op">.</span>push_back<span class="op">(</span>format_with_indent<span class="op">(</span>inv<span class="op">,</span> <span class="va">loop_indent_</span><span class="op">));</span></span>
<span id="cb14-308"><a href="#cb14-308" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb14-309"><a href="#cb14-309" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-310"><a href="#cb14-310" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 2. Adiciona a declaração do loop e seu corpo</span></span>
<span id="cb14-311"><a href="#cb14-311" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(!</span><span class="va">loop_instructions_</span><span class="op">.</span>empty<span class="op">())</span> <span class="op">{</span></span>
<span id="cb14-312"><a href="#cb14-312" aria-hidden="true" tabindex="-1"></a>            <span class="va">optimized_code_</span><span class="op">.</span>push_back<span class="op">(</span><span class="va">loop_instructions_</span><span class="op">[</span><span class="dv">0</span><span class="op">]);</span> <span class="co">// Linha "for"</span></span>
<span id="cb14-313"><a href="#cb14-313" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb14-314"><a href="#cb14-314" aria-hidden="true" tabindex="-1"></a>            <span class="co">// 3. Adiciona o corpo do loop com indentação correta</span></span>
<span id="cb14-315"><a href="#cb14-315" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">1</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="va">loop_instructions_</span><span class="op">.</span>size<span class="op">();</span> <span class="op">++</span>i<span class="op">)</span> <span class="op">{</span></span>
<span id="cb14-316"><a href="#cb14-316" aria-hidden="true" tabindex="-1"></a>                <span class="at">const</span> <span class="kw">auto</span><span class="op">&amp;</span> instr <span class="op">=</span> <span class="va">loop_instructions_</span><span class="op">[</span>i<span class="op">];</span></span>
<span id="cb14-317"><a href="#cb14-317" aria-hidden="true" tabindex="-1"></a>                <span class="kw">auto</span> trimmed <span class="op">=</span> trim<span class="op">(</span>instr<span class="op">);</span></span>
<span id="cb14-318"><a href="#cb14-318" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb14-319"><a href="#cb14-319" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(</span>trimmed<span class="op">.</span>empty<span class="op">())</span> <span class="op">{</span></span>
<span id="cb14-320"><a href="#cb14-320" aria-hidden="true" tabindex="-1"></a>                    <span class="va">optimized_code_</span><span class="op">.</span>push_back<span class="op">(</span>instr<span class="op">);</span> <span class="co">// Linhas vazias</span></span>
<span id="cb14-321"><a href="#cb14-321" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb14-322"><a href="#cb14-322" aria-hidden="true" tabindex="-1"></a>                    <span class="co">// Adiciona a indentação base do loop + 4 espaços relativos</span></span>
<span id="cb14-323"><a href="#cb14-323" aria-hidden="true" tabindex="-1"></a>                    <span class="va">optimized_code_</span><span class="op">.</span>push_back<span class="op">(</span>format_with_indent<span class="op">(</span>instr<span class="op">,</span> <span class="va">loop_indent_</span> <span class="op">+</span> <span class="dv">4</span><span class="op">));</span></span>
<span id="cb14-324"><a href="#cb14-324" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb14-325"><a href="#cb14-325" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb14-326"><a href="#cb14-326" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb14-327"><a href="#cb14-327" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-328"><a href="#cb14-328" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 4. Adiciona o marcador de fim de loop, se existir</span></span>
<span id="cb14-329"><a href="#cb14-329" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>end_marker<span class="op">.</span>has_value<span class="op">())</span> <span class="op">{</span></span>
<span id="cb14-330"><a href="#cb14-330" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Assume que o marcador de fim de loop tem a mesma indentação da declaração do loop</span></span>
<span id="cb14-331"><a href="#cb14-331" aria-hidden="true" tabindex="-1"></a>            <span class="va">optimized_code_</span><span class="op">.</span>push_back<span class="op">(</span>format_with_indent<span class="op">(</span>end_marker<span class="op">.</span>value<span class="op">(),</span> <span class="va">loop_indent_</span><span class="op">));</span></span>
<span id="cb14-332"><a href="#cb14-332" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb14-333"><a href="#cb14-333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-334"><a href="#cb14-334" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 5. Reseta o estado do loop</span></span>
<span id="cb14-335"><a href="#cb14-335" aria-hidden="true" tabindex="-1"></a>        reset_loop_state<span class="op">();</span></span>
<span id="cb14-336"><a href="#cb14-336" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb14-337"><a href="#cb14-337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-338"><a href="#cb14-338" aria-hidden="true" tabindex="-1"></a>    <span class="co">/**</span></span>
<span id="cb14-339"><a href="#cb14-339" aria-hidden="true" tabindex="-1"></a><span class="co">     * </span><span class="an">@brief</span><span class="co"> Reseta todas as variáveis de estado relacionadas ao loop.</span></span>
<span id="cb14-340"><a href="#cb14-340" aria-hidden="true" tabindex="-1"></a><span class="co">     */</span></span>
<span id="cb14-341"><a href="#cb14-341" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> reset_loop_state<span class="op">()</span> <span class="kw">noexcept</span> <span class="op">{</span></span>
<span id="cb14-342"><a href="#cb14-342" aria-hidden="true" tabindex="-1"></a>        <span class="va">loop_detected_</span> <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb14-343"><a href="#cb14-343" aria-hidden="true" tabindex="-1"></a>        <span class="va">pre_loop_invariants_</span><span class="op">.</span>clear<span class="op">();</span></span>
<span id="cb14-344"><a href="#cb14-344" aria-hidden="true" tabindex="-1"></a>        <span class="va">loop_instructions_</span><span class="op">.</span>clear<span class="op">();</span></span>
<span id="cb14-345"><a href="#cb14-345" aria-hidden="true" tabindex="-1"></a>        <span class="va">loop_vars_</span><span class="op">.</span>clear<span class="op">();</span></span>
<span id="cb14-346"><a href="#cb14-346" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-347"><a href="#cb14-347" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Variáveis modificadas no loop tornam-se parte do contexto definido fora do loop</span></span>
<span id="cb14-348"><a href="#cb14-348" aria-hidden="true" tabindex="-1"></a>        <span class="va">pre_loop_defined_vars_</span><span class="op">.</span>merge<span class="op">(</span><span class="bu">std::</span>move<span class="op">(</span><span class="va">loop_mod_vars_</span><span class="op">));</span></span>
<span id="cb14-349"><a href="#cb14-349" aria-hidden="true" tabindex="-1"></a>        <span class="va">loop_mod_vars_</span><span class="op">.</span>clear<span class="op">();</span></span>
<span id="cb14-350"><a href="#cb14-350" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-351"><a href="#cb14-351" aria-hidden="true" tabindex="-1"></a>        <span class="va">loop_indent_</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb14-352"><a href="#cb14-352" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb14-353"><a href="#cb14-353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-354"><a href="#cb14-354" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="cb14-355"><a href="#cb14-355" aria-hidden="true" tabindex="-1"></a>    <span class="co">/**</span></span>
<span id="cb14-356"><a href="#cb14-356" aria-hidden="true" tabindex="-1"></a><span class="co">     * </span><span class="an">@brief</span><span class="co"> Processa o código TAC linha por linha para mover instruções invariantes.</span></span>
<span id="cb14-357"><a href="#cb14-357" aria-hidden="true" tabindex="-1"></a><span class="co">     * * </span><span class="an">@param</span><span class="co"> </span><span class="cv">tac</span><span class="co"> Span de strings contendo o código de três endereços</span></span>
<span id="cb14-358"><a href="#cb14-358" aria-hidden="true" tabindex="-1"></a><span class="co">     * </span><span class="an">@return</span><span class="co"> InstructionList O código TAC otimizado</span></span>
<span id="cb14-359"><a href="#cb14-359" aria-hidden="true" tabindex="-1"></a><span class="co">     */</span></span>
<span id="cb14-360"><a href="#cb14-360" aria-hidden="true" tabindex="-1"></a>    <span class="op">[[</span><span class="at">nodiscard</span><span class="op">]]</span> InstructionList optimize<span class="op">(</span><span class="bu">std::</span>span<span class="op">&lt;</span><span class="at">const</span> <span class="bu">std::</span>string<span class="op">&gt;</span> tac<span class="op">)</span> <span class="op">{</span></span>
<span id="cb14-361"><a href="#cb14-361" aria-hidden="true" tabindex="-1"></a>        <span class="va">optimized_code_</span><span class="op">.</span>clear<span class="op">();</span></span>
<span id="cb14-362"><a href="#cb14-362" aria-hidden="true" tabindex="-1"></a>        <span class="va">optimized_code_</span><span class="op">.</span>reserve<span class="op">(</span>tac<span class="op">.</span>size<span class="op">());</span></span>
<span id="cb14-363"><a href="#cb14-363" aria-hidden="true" tabindex="-1"></a>        <span class="va">pre_loop_defined_vars_</span><span class="op">.</span>clear<span class="op">();</span></span>
<span id="cb14-364"><a href="#cb14-364" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-365"><a href="#cb14-365" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="at">const</span> <span class="kw">auto</span><span class="op">&amp;</span> line <span class="op">:</span> tac<span class="op">)</span> <span class="op">{</span></span>
<span id="cb14-366"><a href="#cb14-366" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Preserva linhas vazias</span></span>
<span id="cb14-367"><a href="#cb14-367" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>trim<span class="op">(</span>line<span class="op">).</span>empty<span class="op">())</span> <span class="op">{</span></span>
<span id="cb14-368"><a href="#cb14-368" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(</span><span class="va">loop_detected_</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb14-369"><a href="#cb14-369" aria-hidden="true" tabindex="-1"></a>                    <span class="va">loop_instructions_</span><span class="op">.</span>push_back<span class="op">(</span>line<span class="op">);</span></span>
<span id="cb14-370"><a href="#cb14-370" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb14-371"><a href="#cb14-371" aria-hidden="true" tabindex="-1"></a>                    <span class="va">optimized_code_</span><span class="op">.</span>push_back<span class="op">(</span>line<span class="op">);</span></span>
<span id="cb14-372"><a href="#cb14-372" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb14-373"><a href="#cb14-373" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span><span class="op">;</span></span>
<span id="cb14-374"><a href="#cb14-374" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb14-375"><a href="#cb14-375" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb14-376"><a href="#cb14-376" aria-hidden="true" tabindex="-1"></a>            <span class="kw">auto</span> trimmed <span class="op">=</span> trim<span class="op">(</span>line<span class="op">);</span></span>
<span id="cb14-377"><a href="#cb14-377" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb14-378"><a href="#cb14-378" aria-hidden="true" tabindex="-1"></a>            <span class="co">// A. Detecção de INÍCIO de Loop ("for")</span></span>
<span id="cb14-379"><a href="#cb14-379" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>trimmed<span class="op">.</span>starts_with<span class="op">(</span><span class="st">"for"</span><span class="op">))</span> <span class="op">{</span></span>
<span id="cb14-380"><a href="#cb14-380" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(</span><span class="va">loop_detected_</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb14-381"><a href="#cb14-381" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">std::</span>println<span class="op">(</span><span class="bu">std::</span>cerr<span class="op">,</span> </span>
<span id="cb14-382"><a href="#cb14-382" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"Aviso: Loops aninhados não são suportados. Ignorando loop interno."</span><span class="op">);</span></span>
<span id="cb14-383"><a href="#cb14-383" aria-hidden="true" tabindex="-1"></a>                    <span class="va">optimized_code_</span><span class="op">.</span>push_back<span class="op">(</span>line<span class="op">);</span></span>
<span id="cb14-384"><a href="#cb14-384" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">continue</span><span class="op">;</span></span>
<span id="cb14-385"><a href="#cb14-385" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb14-386"><a href="#cb14-386" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb14-387"><a href="#cb14-387" aria-hidden="true" tabindex="-1"></a>                <span class="kw">auto</span> loop_var <span class="op">=</span> extract_loop_variable<span class="op">(</span>trimmed<span class="op">);</span></span>
<span id="cb14-388"><a href="#cb14-388" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(!</span>loop_var<span class="op">.</span>has_value<span class="op">())</span> <span class="op">{</span></span>
<span id="cb14-389"><a href="#cb14-389" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">std::</span>println<span class="op">(</span><span class="bu">std::</span>cerr<span class="op">,</span> </span>
<span id="cb14-390"><a href="#cb14-390" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"Aviso: Declaração de loop inválida: '</span><span class="sc">{}</span><span class="st">'"</span><span class="op">,</span> trimmed<span class="op">);</span></span>
<span id="cb14-391"><a href="#cb14-391" aria-hidden="true" tabindex="-1"></a>                    <span class="va">optimized_code_</span><span class="op">.</span>push_back<span class="op">(</span>line<span class="op">);</span></span>
<span id="cb14-392"><a href="#cb14-392" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">continue</span><span class="op">;</span></span>
<span id="cb14-393"><a href="#cb14-393" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb14-394"><a href="#cb14-394" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb14-395"><a href="#cb14-395" aria-hidden="true" tabindex="-1"></a>                <span class="va">loop_detected_</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb14-396"><a href="#cb14-396" aria-hidden="true" tabindex="-1"></a>                <span class="va">loop_vars_</span><span class="op">.</span>insert<span class="op">(</span>loop_var<span class="op">.</span>value<span class="op">());</span></span>
<span id="cb14-397"><a href="#cb14-397" aria-hidden="true" tabindex="-1"></a>                <span class="va">loop_instructions_</span><span class="op">.</span>push_back<span class="op">(</span>line<span class="op">);</span></span>
<span id="cb14-398"><a href="#cb14-398" aria-hidden="true" tabindex="-1"></a>                <span class="va">loop_indent_</span> <span class="op">=</span> count_leading_spaces<span class="op">(</span>line<span class="op">);</span></span>
<span id="cb14-399"><a href="#cb14-399" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span><span class="op">;</span></span>
<span id="cb14-400"><a href="#cb14-400" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb14-401"><a href="#cb14-401" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb14-402"><a href="#cb14-402" aria-hidden="true" tabindex="-1"></a>            <span class="co">// B. Processamento DENTRO do Loop</span></span>
<span id="cb14-403"><a href="#cb14-403" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span><span class="va">loop_detected_</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb14-404"><a href="#cb14-404" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb14-405"><a href="#cb14-405" aria-hidden="true" tabindex="-1"></a>                <span class="co">// B1. Detecção de FIM de Loop (marcador explícito "endloop:")</span></span>
<span id="cb14-406"><a href="#cb14-406" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(</span>trimmed<span class="op">.</span>starts_with<span class="op">(</span><span class="st">"endloop:"</span><span class="op">))</span> <span class="op">{</span></span>
<span id="cb14-407"><a href="#cb14-407" aria-hidden="true" tabindex="-1"></a>                    finalize_loop_block<span class="op">(</span>line<span class="op">);</span></span>
<span id="cb14-408"><a href="#cb14-408" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">continue</span><span class="op">;</span></span>
<span id="cb14-409"><a href="#cb14-409" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb14-410"><a href="#cb14-410" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb14-411"><a href="#cb14-411" aria-hidden="true" tabindex="-1"></a>                <span class="co">// B2. Análise de Invariância</span></span>
<span id="cb14-412"><a href="#cb14-412" aria-hidden="true" tabindex="-1"></a>                <span class="at">const</span> <span class="kw">auto</span> parsed <span class="op">=</span> parse_tac_instruction<span class="op">(</span>line<span class="op">);</span> <span class="co">// Usa a linha completa para indentação original</span></span>
<span id="cb14-413"><a href="#cb14-413" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb14-414"><a href="#cb14-414" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Instruções que não são atribuições ou têm efeitos colaterais permanecem</span></span>
<span id="cb14-415"><a href="#cb14-415" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(!</span>parsed<span class="op">.</span>is_assignment <span class="op">||</span> parsed<span class="op">.</span>has_side_effects<span class="op">)</span> <span class="op">{</span></span>
<span id="cb14-416"><a href="#cb14-416" aria-hidden="true" tabindex="-1"></a>                    <span class="va">loop_instructions_</span><span class="op">.</span>push_back<span class="op">(</span>line<span class="op">);</span></span>
<span id="cb14-417"><a href="#cb14-417" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">continue</span><span class="op">;</span></span>
<span id="cb14-418"><a href="#cb14-418" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb14-419"><a href="#cb14-419" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb14-420"><a href="#cb14-420" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Verifica se é invariante</span></span>
<span id="cb14-421"><a href="#cb14-421" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(</span>is_loop_invariant<span class="op">(</span>parsed<span class="op">))</span> <span class="op">{</span></span>
<span id="cb14-422"><a href="#cb14-422" aria-hidden="true" tabindex="-1"></a>                    <span class="co">// Move para antes do loop</span></span>
<span id="cb14-423"><a href="#cb14-423" aria-hidden="true" tabindex="-1"></a>                    <span class="va">pre_loop_invariants_</span><span class="op">.</span>push_back<span class="op">(</span>line<span class="op">);</span></span>
<span id="cb14-424"><a href="#cb14-424" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb14-425"><a href="#cb14-425" aria-hidden="true" tabindex="-1"></a>                    <span class="co">// Instrução variante permanece no loop</span></span>
<span id="cb14-426"><a href="#cb14-426" aria-hidden="true" tabindex="-1"></a>                    <span class="va">loop_instructions_</span><span class="op">.</span>push_back<span class="op">(</span>line<span class="op">);</span></span>
<span id="cb14-427"><a href="#cb14-427" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb14-428"><a href="#cb14-428" aria-hidden="true" tabindex="-1"></a>                    <span class="co">// Registra que essa variável é modificada dentro do loop</span></span>
<span id="cb14-429"><a href="#cb14-429" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> <span class="op">(!</span>parsed<span class="op">.</span>lhs<span class="op">.</span>empty<span class="op">())</span> <span class="op">{</span></span>
<span id="cb14-430"><a href="#cb14-430" aria-hidden="true" tabindex="-1"></a>                        <span class="va">loop_mod_vars_</span><span class="op">.</span>insert<span class="op">(</span>parsed<span class="op">.</span>lhs<span class="op">);</span></span>
<span id="cb14-431"><a href="#cb14-431" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span></span>
<span id="cb14-432"><a href="#cb14-432" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb14-433"><a href="#cb14-433" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb14-434"><a href="#cb14-434" aria-hidden="true" tabindex="-1"></a>            <span class="co">// C. Fora do Loop</span></span>
<span id="cb14-435"><a href="#cb14-435" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb14-436"><a href="#cb14-436" aria-hidden="true" tabindex="-1"></a>                <span class="va">optimized_code_</span><span class="op">.</span>push_back<span class="op">(</span>line<span class="op">);</span></span>
<span id="cb14-437"><a href="#cb14-437" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb14-438"><a href="#cb14-438" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Rastreia variáveis definidas fora do loop</span></span>
<span id="cb14-439"><a href="#cb14-439" aria-hidden="true" tabindex="-1"></a>                <span class="at">const</span> <span class="kw">auto</span> parsed <span class="op">=</span> parse_tac_instruction<span class="op">(</span>trimmed<span class="op">);</span></span>
<span id="cb14-440"><a href="#cb14-440" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(</span>parsed<span class="op">.</span>is_assignment <span class="op">&amp;&amp;</span> <span class="op">!</span>parsed<span class="op">.</span>lhs<span class="op">.</span>empty<span class="op">())</span> <span class="op">{</span></span>
<span id="cb14-441"><a href="#cb14-441" aria-hidden="true" tabindex="-1"></a>                    <span class="co">// Adicionamos a variável definida ao conjunto global de definições</span></span>
<span id="cb14-442"><a href="#cb14-442" aria-hidden="true" tabindex="-1"></a>                    <span class="va">pre_loop_defined_vars_</span><span class="op">.</span>insert<span class="op">(</span>parsed<span class="op">.</span>lhs<span class="op">);</span></span>
<span id="cb14-443"><a href="#cb14-443" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb14-444"><a href="#cb14-444" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb14-445"><a href="#cb14-445" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb14-446"><a href="#cb14-446" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-447"><a href="#cb14-447" aria-hidden="true" tabindex="-1"></a>        <span class="co">// D. Finaliza o último bloco (se o loop não foi fechado)</span></span>
<span id="cb14-448"><a href="#cb14-448" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span><span class="va">loop_detected_</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb14-449"><a href="#cb14-449" aria-hidden="true" tabindex="-1"></a>            <span class="bu">std::</span>println<span class="op">(</span><span class="bu">std::</span>cerr<span class="op">,</span> </span>
<span id="cb14-450"><a href="#cb14-450" aria-hidden="true" tabindex="-1"></a>                <span class="st">"Aviso: Loop não foi finalizado com 'endloop:'. Finalizando implicitamente."</span><span class="op">);</span></span>
<span id="cb14-451"><a href="#cb14-451" aria-hidden="true" tabindex="-1"></a>            finalize_loop_block<span class="op">();</span></span>
<span id="cb14-452"><a href="#cb14-452" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb14-453"><a href="#cb14-453" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-454"><a href="#cb14-454" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">optimized_code_</span><span class="op">;</span></span>
<span id="cb14-455"><a href="#cb14-455" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb14-456"><a href="#cb14-456" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb14-457"><a href="#cb14-457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-458"><a href="#cb14-458" aria-hidden="true" tabindex="-1"></a><span class="co">// --------------------------------------------------------------------------------</span></span>
<span id="cb14-459"><a href="#cb14-459" aria-hidden="true" tabindex="-1"></a><span class="co">// Exemplo de Uso e Testes</span></span>
<span id="cb14-460"><a href="#cb14-460" aria-hidden="true" tabindex="-1"></a><span class="co">// --------------------------------------------------------------------------------</span></span>
<span id="cb14-461"><a href="#cb14-461" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-462"><a href="#cb14-462" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb14-463"><a href="#cb14-463" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@brief</span><span class="co"> Imprime código TAC com formatação.</span></span>
<span id="cb14-464"><a href="#cb14-464" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb14-465"><a href="#cb14-465" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> print_code<span class="op">(</span><span class="bu">std::</span>string_view title<span class="op">,</span> <span class="bu">std::</span>span<span class="op">&lt;</span><span class="at">const</span> <span class="bu">std::</span>string<span class="op">&gt;</span> code<span class="op">)</span> <span class="op">{</span></span>
<span id="cb14-466"><a href="#cb14-466" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>println<span class="op">(</span><span class="st">"</span><span class="sc">\n{}</span><span class="st">"</span><span class="op">,</span> title<span class="op">);</span></span>
<span id="cb14-467"><a href="#cb14-467" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>println<span class="op">(</span><span class="st">"</span><span class="sc">{}</span><span class="st">"</span><span class="op">,</span> <span class="bu">std::</span>string<span class="op">(</span><span class="dv">70</span><span class="op">,</span> <span class="ch">'='</span><span class="op">));</span></span>
<span id="cb14-468"><a href="#cb14-468" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-469"><a href="#cb14-469" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>code<span class="op">.</span>empty<span class="op">())</span> <span class="op">{</span></span>
<span id="cb14-470"><a href="#cb14-470" aria-hidden="true" tabindex="-1"></a>        <span class="bu">std::</span>println<span class="op">(</span><span class="st">"(vazio)"</span><span class="op">);</span></span>
<span id="cb14-471"><a href="#cb14-471" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span><span class="op">;</span></span>
<span id="cb14-472"><a href="#cb14-472" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb14-473"><a href="#cb14-473" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-474"><a href="#cb14-474" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> code<span class="op">.</span>size<span class="op">();</span> <span class="op">++</span>i<span class="op">)</span> <span class="op">{</span></span>
<span id="cb14-475"><a href="#cb14-475" aria-hidden="true" tabindex="-1"></a>        <span class="bu">std::</span>println<span class="op">(</span><span class="st">"</span><span class="sc">{:3}</span><span class="st">: </span><span class="sc">{}</span><span class="st">"</span><span class="op">,</span> i <span class="op">+</span> <span class="dv">1</span><span class="op">,</span> code<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb14-476"><a href="#cb14-476" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb14-477"><a href="#cb14-477" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb14-478"><a href="#cb14-478" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-479"><a href="#cb14-479" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb14-480"><a href="#cb14-480" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@brief</span><span class="co"> Executa um caso de teste da otimização LICM.</span></span>
<span id="cb14-481"><a href="#cb14-481" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb14-482"><a href="#cb14-482" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> run_test<span class="op">(</span><span class="bu">std::</span>string_view test_name<span class="op">,</span> <span class="at">const</span> InstructionList<span class="op">&amp;</span> tac_code<span class="op">)</span> <span class="op">{</span></span>
<span id="cb14-483"><a href="#cb14-483" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>println<span class="op">(</span><span class="st">"</span><span class="sc">\n{}</span><span class="st">"</span><span class="op">,</span> <span class="bu">std::</span>string<span class="op">(</span><span class="dv">70</span><span class="op">,</span> <span class="ch">'#'</span><span class="op">));</span></span>
<span id="cb14-484"><a href="#cb14-484" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>println<span class="op">(</span><span class="st">"Teste: </span><span class="sc">{}</span><span class="st">"</span><span class="op">,</span> test_name<span class="op">);</span></span>
<span id="cb14-485"><a href="#cb14-485" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>println<span class="op">(</span><span class="st">"</span><span class="sc">{}</span><span class="st">"</span><span class="op">,</span> <span class="bu">std::</span>string<span class="op">(</span><span class="dv">70</span><span class="op">,</span> <span class="ch">'#'</span><span class="op">));</span></span>
<span id="cb14-486"><a href="#cb14-486" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-487"><a href="#cb14-487" aria-hidden="true" tabindex="-1"></a>    print_code<span class="op">(</span><span class="st">"Código Original"</span><span class="op">,</span> tac_code<span class="op">);</span></span>
<span id="cb14-488"><a href="#cb14-488" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-489"><a href="#cb14-489" aria-hidden="true" tabindex="-1"></a>    LoopInvariantCodeMotion optimizer<span class="op">;</span></span>
<span id="cb14-490"><a href="#cb14-490" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> <span class="kw">auto</span> optimized <span class="op">=</span> optimizer<span class="op">.</span>optimize<span class="op">(</span>tac_code<span class="op">);</span></span>
<span id="cb14-491"><a href="#cb14-491" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-492"><a href="#cb14-492" aria-hidden="true" tabindex="-1"></a>    print_code<span class="op">(</span><span class="st">"Código Otimizado"</span><span class="op">,</span> optimized<span class="op">);</span></span>
<span id="cb14-493"><a href="#cb14-493" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb14-494"><a href="#cb14-494" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-495"><a href="#cb14-495" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb14-496"><a href="#cb14-496" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@brief</span><span class="co"> Função principal para demonstração e testes.</span></span>
<span id="cb14-497"><a href="#cb14-497" aria-hidden="true" tabindex="-1"></a><span class="co"> * * </span><span class="an">@return</span><span class="co"> int 0 em caso de sucesso</span></span>
<span id="cb14-498"><a href="#cb14-498" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb14-499"><a href="#cb14-499" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb14-500"><a href="#cb14-500" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Teste 1: Caso básico com invariantes e efeitos colaterais</span></span>
<span id="cb14-501"><a href="#cb14-501" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> InstructionList test1 <span class="op">=</span> <span class="op">{</span></span>
<span id="cb14-502"><a href="#cb14-502" aria-hidden="true" tabindex="-1"></a>        <span class="st">"t1 = a + b"</span><span class="op">,</span></span>
<span id="cb14-503"><a href="#cb14-503" aria-hidden="true" tabindex="-1"></a>        <span class="st">"t2 = t1 * c"</span><span class="op">,</span></span>
<span id="cb14-504"><a href="#cb14-504" aria-hidden="true" tabindex="-1"></a>        <span class="st">"for i in range(n):"</span><span class="op">,</span></span>
<span id="cb14-505"><a href="#cb14-505" aria-hidden="true" tabindex="-1"></a>        <span class="st">"    k = 100"</span><span class="op">,</span>           <span class="co">// Invariante</span></span>
<span id="cb14-506"><a href="#cb14-506" aria-hidden="true" tabindex="-1"></a>        <span class="st">"    j = t2 + 50"</span><span class="op">,</span>       <span class="co">// Invariante (t2 definido antes)</span></span>
<span id="cb14-507"><a href="#cb14-507" aria-hidden="true" tabindex="-1"></a>        <span class="st">"    t3 = j * i"</span><span class="op">,</span>        <span class="co">// Variante (depende de i)</span></span>
<span id="cb14-508"><a href="#cb14-508" aria-hidden="true" tabindex="-1"></a>        <span class="st">"    t4 = t3 + d"</span><span class="op">,</span>       <span class="co">// Variante (depende de t3)</span></span>
<span id="cb14-509"><a href="#cb14-509" aria-hidden="true" tabindex="-1"></a>        <span class="st">"    print(t4)"</span><span class="op">,</span>         <span class="co">// Efeito colateral (permanece)</span></span>
<span id="cb14-510"><a href="#cb14-510" aria-hidden="true" tabindex="-1"></a>        <span class="st">"endloop:"</span><span class="op">,</span></span>
<span id="cb14-511"><a href="#cb14-511" aria-hidden="true" tabindex="-1"></a>        <span class="st">"t5 = e + f"</span></span>
<span id="cb14-512"><a href="#cb14-512" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb14-513"><a href="#cb14-513" aria-hidden="true" tabindex="-1"></a>    run_test<span class="op">(</span><span class="st">"Caso Básico com Invariantes e Efeitos Colaterais"</span><span class="op">,</span> test1<span class="op">);</span></span>
<span id="cb14-514"><a href="#cb14-514" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-515"><a href="#cb14-515" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Teste 2: Todas as instruções são variantes</span></span>
<span id="cb14-516"><a href="#cb14-516" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> InstructionList test2 <span class="op">=</span> <span class="op">{</span></span>
<span id="cb14-517"><a href="#cb14-517" aria-hidden="true" tabindex="-1"></a>        <span class="st">"x = 0"</span><span class="op">,</span></span>
<span id="cb14-518"><a href="#cb14-518" aria-hidden="true" tabindex="-1"></a>        <span class="st">"for i in range(10):"</span><span class="op">,</span></span>
<span id="cb14-519"><a href="#cb14-519" aria-hidden="true" tabindex="-1"></a>        <span class="st">"    x = x + i"</span><span class="op">,</span>        <span class="co">// x é modificado e depende de i</span></span>
<span id="cb14-520"><a href="#cb14-520" aria-hidden="true" tabindex="-1"></a>        <span class="st">"    y = x * 2"</span><span class="op">,</span>        <span class="co">// y depende de x (modificado)</span></span>
<span id="cb14-521"><a href="#cb14-521" aria-hidden="true" tabindex="-1"></a>        <span class="st">"    z = y + i"</span><span class="op">,</span>        <span class="co">// z depende de y e i</span></span>
<span id="cb14-522"><a href="#cb14-522" aria-hidden="true" tabindex="-1"></a>        <span class="st">"endloop:"</span><span class="op">,</span></span>
<span id="cb14-523"><a href="#cb14-523" aria-hidden="true" tabindex="-1"></a>        <span class="st">"result = x"</span></span>
<span id="cb14-524"><a href="#cb14-524" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb14-525"><a href="#cb14-525" aria-hidden="true" tabindex="-1"></a>    run_test<span class="op">(</span><span class="st">"Todas Instruções Variantes"</span><span class="op">,</span> test2<span class="op">);</span></span>
<span id="cb14-526"><a href="#cb14-526" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-527"><a href="#cb14-527" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Teste 3: Dependências em cadeia de invariantes</span></span>
<span id="cb14-528"><a href="#cb14-528" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> InstructionList test3 <span class="op">=</span> <span class="op">{</span></span>
<span id="cb14-529"><a href="#cb14-529" aria-hidden="true" tabindex="-1"></a>        <span class="st">"base = 100"</span><span class="op">,</span></span>
<span id="cb14-530"><a href="#cb14-530" aria-hidden="true" tabindex="-1"></a>        <span class="st">"for i in range(n):"</span><span class="op">,</span></span>
<span id="cb14-531"><a href="#cb14-531" aria-hidden="true" tabindex="-1"></a>        <span class="st">"    k1 = base + 10"</span><span class="op">,</span>    <span class="co">// Invariante</span></span>
<span id="cb14-532"><a href="#cb14-532" aria-hidden="true" tabindex="-1"></a>        <span class="st">"    k2 = k1 + 20"</span><span class="op">,</span>      <span class="co">// Invariante (depende de k1, que é invariante)</span></span>
<span id="cb14-533"><a href="#cb14-533" aria-hidden="true" tabindex="-1"></a>        <span class="st">"    t = k2 * i"</span><span class="op">,</span>        <span class="co">// Variante</span></span>
<span id="cb14-534"><a href="#cb14-534" aria-hidden="true" tabindex="-1"></a>        <span class="st">"    result = t + base"</span><span class="op">,</span> <span class="co">// Variante</span></span>
<span id="cb14-535"><a href="#cb14-535" aria-hidden="true" tabindex="-1"></a>        <span class="st">"endloop:"</span></span>
<span id="cb14-536"><a href="#cb14-536" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb14-537"><a href="#cb14-537" aria-hidden="true" tabindex="-1"></a>    run_test<span class="op">(</span><span class="st">"Dependências em Cadeia de Invariantes"</span><span class="op">,</span> test3<span class="op">);</span></span>
<span id="cb14-538"><a href="#cb14-538" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-539"><a href="#cb14-539" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Teste 4: Loop sem corpo e loop não fechado (testa finalização)</span></span>
<span id="cb14-540"><a href="#cb14-540" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> InstructionList test4 <span class="op">=</span> <span class="op">{</span></span>
<span id="cb14-541"><a href="#cb14-541" aria-hidden="true" tabindex="-1"></a>        <span class="st">"x = 5"</span><span class="op">,</span></span>
<span id="cb14-542"><a href="#cb14-542" aria-hidden="true" tabindex="-1"></a>        <span class="st">"for i in range(3):"</span><span class="op">,</span> <span class="co">// Loop 1</span></span>
<span id="cb14-543"><a href="#cb14-543" aria-hidden="true" tabindex="-1"></a>        <span class="st">"endloop:"</span><span class="op">,</span></span>
<span id="cb14-544"><a href="#cb14-544" aria-hidden="true" tabindex="-1"></a>        <span class="st">"for j in range(5):"</span><span class="op">,</span> <span class="co">// Loop 2 (não fechado)</span></span>
<span id="cb14-545"><a href="#cb14-545" aria-hidden="true" tabindex="-1"></a>        <span class="st">"    y = 1"</span></span>
<span id="cb14-546"><a href="#cb14-546" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb14-547"><a href="#cb14-547" aria-hidden="true" tabindex="-1"></a>    run_test<span class="op">(</span><span class="st">"Loops Sequenciais e Finalização Implícita"</span><span class="op">,</span> test4<span class="op">);</span></span>
<span id="cb14-548"><a href="#cb14-548" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-549"><a href="#cb14-549" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb14-550"><a href="#cb14-550" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="propagação-de-constantes-constant-propagation" class="level2" data-number="17.4">
<h2 data-number="17.4" class="anchored" data-anchor-id="propagação-de-constantes-constant-propagation"><span class="header-section-number">17.4</span> Propagação de Constantes (<em>Constant Propagation</em>)</h2>
<p>A propagação de constantes substitui usos de variáveis por seus valores constantes conhecidos, permitindo avaliação em tempo de compilação (constant folding).</p>
<section id="algoritmo" class="level3" data-number="17.4.1">
<h3 data-number="17.4.1" class="anchored" data-anchor-id="algoritmo"><span class="header-section-number">17.4.1</span> Algoritmo</h3>
<div class="sourceCode" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> is_constant(value):</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Verifica se valor é constante numérica."""</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">isinstance</span>(value, (<span class="bu">int</span>, <span class="bu">float</span>))</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> evaluate(val1, op, val2):</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Avalia expressão constante."""</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> is_constant(val1) <span class="kw">or</span> <span class="kw">not</span> is_constant(val2):</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> op <span class="op">==</span> <span class="st">'+'</span>: <span class="cf">return</span> val1 <span class="op">+</span> val2</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> op <span class="op">==</span> <span class="st">'-'</span>: <span class="cf">return</span> val1 <span class="op">-</span> val2</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> op <span class="op">==</span> <span class="st">'*'</span>: <span class="cf">return</span> val1 <span class="op">*</span> val2</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> op <span class="op">==</span> <span class="st">'/'</span>: <span class="cf">return</span> val1 <span class="op">/</span> val2 <span class="co"># Cuidado com divisão por zero</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span>:</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> constant_propagation(instructions):</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a><span class="co">    Propaga valores constantes e realiza constant folding </span></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a><span class="co">    (em um único bloco básico).</span></span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a><span class="co">        instructions: Lista de instruções TAC</span></span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a><span class="co">        Lista otimizada de instruções</span></span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>    constants <span class="op">=</span> {}  <span class="co"># Mapa de variável -&gt; valor constante</span></span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> []</span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> instr <span class="kw">in</span> instructions:</span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Substituir operandos por constantes conhecidas</span></span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a>        arg1 <span class="op">=</span> constants.get(instr.arg1, instr.arg1)</span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a>        arg2 <span class="op">=</span> constants.get(instr.arg2, instr.arg2)</span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Constant folding se ambos operandos são constantes</span></span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> instr.op <span class="kw">in</span> [<span class="st">'+'</span>, <span class="st">'-'</span>, <span class="st">'*'</span>, <span class="st">'/'</span>]:</span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a>            value <span class="op">=</span> evaluate(arg1, instr.op, arg2)</span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> value <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb15-41"><a href="#cb15-41" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Dobramos para uma constante</span></span>
<span id="cb15-42"><a href="#cb15-42" aria-hidden="true" tabindex="-1"></a>                constants[instr.dest] <span class="op">=</span> value</span>
<span id="cb15-43"><a href="#cb15-43" aria-hidden="true" tabindex="-1"></a>                result.append(Instruction(<span class="st">'ASSIGN'</span>, instr.dest, value))</span>
<span id="cb15-44"><a href="#cb15-44" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb15-45"><a href="#cb15-45" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Não é constante, invalidar destino</span></span>
<span id="cb15-46"><a href="#cb15-46" aria-hidden="true" tabindex="-1"></a>                constants.pop(instr.dest, <span class="va">None</span>)</span>
<span id="cb15-47"><a href="#cb15-47" aria-hidden="true" tabindex="-1"></a>                result.append(Instruction(instr.op, instr.dest, arg1, arg2))</span>
<span id="cb15-48"><a href="#cb15-48" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb15-49"><a href="#cb15-49" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Atribuição de constante</span></span>
<span id="cb15-50"><a href="#cb15-50" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> instr.op <span class="op">==</span> <span class="st">'ASSIGN'</span>:</span>
<span id="cb15-51"><a href="#cb15-51" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> is_constant(arg1):</span>
<span id="cb15-52"><a href="#cb15-52" aria-hidden="true" tabindex="-1"></a>                constants[instr.dest] <span class="op">=</span> arg1</span>
<span id="cb15-53"><a href="#cb15-53" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb15-54"><a href="#cb15-54" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Atribuição de variável (e.g., x = y)</span></span>
<span id="cb15-55"><a href="#cb15-55" aria-hidden="true" tabindex="-1"></a>                constants.pop(instr.dest, <span class="va">None</span>)</span>
<span id="cb15-56"><a href="#cb15-56" aria-hidden="true" tabindex="-1"></a>            result.append(Instruction(<span class="st">'ASSIGN'</span>, instr.dest, arg1))</span>
<span id="cb15-57"><a href="#cb15-57" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb15-58"><a href="#cb15-58" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Outras instruções (LOAD, CALL) invalidam destino</span></span>
<span id="cb15-59"><a href="#cb15-59" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> instr.dest:</span>
<span id="cb15-60"><a href="#cb15-60" aria-hidden="true" tabindex="-1"></a>             constants.pop(instr.dest, <span class="va">None</span>)</span>
<span id="cb15-61"><a href="#cb15-61" aria-hidden="true" tabindex="-1"></a>             result.append(Instruction(instr.op, instr.dest, arg1, arg2))</span>
<span id="cb15-62"><a href="#cb15-62" aria-hidden="true" tabindex="-1"></a>             </span>
<span id="cb15-63"><a href="#cb15-63" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb15-64"><a href="#cb15-64" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Instruções sem destino (GOTO, IF, STORE)</span></span>
<span id="cb15-65"><a href="#cb15-65" aria-hidden="true" tabindex="-1"></a>            result.append(Instruction(instr.op, instr.dest, arg1, arg2))</span>
<span id="cb15-66"><a href="#cb15-66" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-67"><a href="#cb15-67" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="exemplo-completo" class="level3" data-number="17.4.2">
<h3 data-number="17.4.2" class="anchored" data-anchor-id="exemplo-completo"><span class="header-section-number">17.4.2</span> Exemplo Completo</h3>
<p><strong>Entrada</strong>:</p>
<pre class="shell"><code>x = 10
y = x + 5
z = y * 2
w = z + x</code></pre>
<p><strong>Trace da Execução</strong>:</p>
<table class="table">
<thead>
<tr class="header">
<th>Instrução</th>
<th><code>constants</code> após</th>
<th>Instrução gerada</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>x = 10</td>
<td>{x: 10}</td>
<td>x = 10</td>
</tr>
<tr class="even">
<td>y = x + 5</td>
<td>{x: 10, y: 15}</td>
<td>y = 15</td>
</tr>
<tr class="odd">
<td>z = y * 2</td>
<td>{x: 10, y: 15, z: 30}</td>
<td>z = 30</td>
</tr>
<tr class="even">
<td>w = z + x</td>
<td>{x: 10, y: 15, z: 30, w: 40}</td>
<td>w = 40</td>
</tr>
</tbody>
</table>
<p><strong>Saída</strong>:</p>
<pre class="shell"><code>x = 10
y = 15
z = 30
w = 40</code></pre>
</section>
<section id="propagação-condicional" class="level3" data-number="17.4.3">
<h3 data-number="17.4.3" class="anchored" data-anchor-id="propagação-condicional"><span class="header-section-number">17.4.3</span> Propagação Condicional</h3>
<p>Em programas com controle de fluxo, a propagação de constantes torna-se mais complexa, exigindo análise de fluxo de dados (<em>dataflow analysis</em>) e um algoritmo de ponto fixo sobre o Grafo de Fluxo de Controle (CFG).</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> conditional_constant_propagation(cfg):</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Propagação de constantes sensível ao fluxo de controle (conceitual).</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Usa algoritmo de ponto fixo sobre o grafo de fluxo de controle.</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Para cada bloco básico, manter mapa de constantes (IN e OUT)</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    constants_in <span class="op">=</span> {block: {} <span class="cf">for</span> block <span class="kw">in</span> cfg.blocks}</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>    constants_out <span class="op">=</span> {block: {} <span class="cf">for</span> block <span class="kw">in</span> cfg.blocks}</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>    worklist <span class="op">=</span> <span class="bu">list</span>(cfg.blocks)</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> worklist:</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>        block <span class="op">=</span> worklist.pop()</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Mergear constantes dos predecessores</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> block.predecessors:</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>            new_in <span class="op">=</span> merge_constants([constants_out[p] <span class="cf">for</span> p <span class="kw">in</span> block.predecessors])</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>            new_in <span class="op">=</span> {} <span class="co"># Bloco de entrada</span></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>        constants_in[block] <span class="op">=</span> new_in</span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Propagar constantes dentro do bloco</span></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>        new_out <span class="op">=</span> propagate_in_block(block.instructions, new_in.copy())</span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Se constantes mudaram, adicionar sucessores à worklist</span></span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> new_out <span class="op">!=</span> constants_out[block]:</span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>            constants_out[block] <span class="op">=</span> new_out</span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>            worklist.extend(block.successors)</span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Após convergência, reescrever o código (não mostrado)</span></span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> constants_in, constants_out</span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> merge_constants(maps):</span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a><span class="co">    Merge de mapas de constantes. </span></span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a><span class="co">    Uma variável só é constante se tiver o *mesmo* valor constante</span></span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a><span class="co">    em *todos* os caminhos.</span></span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> maps: <span class="cf">return</span> {}</span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a>    merged <span class="op">=</span> maps[<span class="dv">0</span>].copy()</span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> var <span class="kw">in</span> <span class="bu">list</span>(merged.keys()):</span>
<span id="cb18-43"><a href="#cb18-43" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> other_map <span class="kw">in</span> maps[<span class="dv">1</span>:]:</span>
<span id="cb18-44"><a href="#cb18-44" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> var <span class="kw">not</span> <span class="kw">in</span> other_map <span class="kw">or</span> other_map[var] <span class="op">!=</span> merged[var]:</span>
<span id="cb18-45"><a href="#cb18-45" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Conflito ou valor não disponível</span></span>
<span id="cb18-46"><a href="#cb18-46" aria-hidden="true" tabindex="-1"></a>                merged.pop(var)</span>
<span id="cb18-47"><a href="#cb18-47" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb18-48"><a href="#cb18-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> merged</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="eliminação-de-subexpressões-comuns-common-subexpression-elimination---cse" class="level2" data-number="17.5">
<h2 data-number="17.5" class="anchored" data-anchor-id="eliminação-de-subexpressões-comuns-common-subexpression-elimination---cse"><span class="header-section-number">17.5</span> Eliminação de Subexpressões Comuns (<em>Common Subexpression Elimination - CSE</em>)</h2>
<p>A Eliminação de Subexpressões Comuns (CSE) é uma otimização que identifica expressões calculadas múltiplas vezes com os mesmos operandos e operadores, reutilizando o resultado já computado da primeira ocorrência. O objetivo é evitar cálculos redundantes, reduzindo o número total de operações executadas.</p>
<p>Existem duas formas principais de CSE:</p>
<ol type="1">
<li><strong>Local CSE:</strong> Opera dentro de um único bloco básico (sem <em>branches</em>). Esta é uma otimização <em>peephole</em> clássica.</li>
<li><strong>Global CSE:</strong> Opera em todo o Grafo de Fluxo de Controle (CFG), exigindo análise de disponibilidade (<em>available expressions</em>) para garantir que o resultado da subexpressão persista em todos os caminhos que chegam ao ponto de uso.</li>
</ol>
<section id="algoritmo-local-value-numbering-local" class="level3" data-number="17.5.1">
<h3 data-number="17.5.1" class="anchored" data-anchor-id="algoritmo-local-value-numbering-local"><span class="header-section-number">17.5.1</span> Algoritmo Local (Value Numbering Local)</h3>
<p>O algoritmo Local CSE, ideal para otimizações <em>peephole</em>, implementa uma forma de <em>Value Numbering</em> local, rastreando o resultado de cada expressão única encontrada.</p>
<table class="table">
<colgroup>
<col style="width: 50%">
<col style="width: 50%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Estrutura de Dados</th>
<th style="text-align: left;">Função no Local CSE</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><strong>Mapa de Expressões (<span class="math inline">\(E_{disp}\)</span>)</strong></td>
<td style="text-align: left;">Mapeia a tupla da expressão <span class="math inline">\((op, arg1, arg2)\)</span> para a variável temporária (<span class="math inline">\(t_x\)</span>) que armazena o resultado.</td>
</tr>
</tbody>
</table>
<p><strong>Processamento de Instrução:</strong></p>
<p>Para cada instrução de atribuição, <span class="math inline">\(I\)</span>:</p>
<ol type="1">
<li><strong>Invalidação:</strong> Antes de processar <span class="math inline">\(I\)</span>, todas as expressões em <span class="math inline">\(E_{disp}\)</span> que usam o destino de <span class="math inline">\(I\)</span> como operando (<code>arg1</code> ou <code>arg2</code>) devem ser removidas.</li>
<li><strong>Verificação de Reuso:</strong> Se <span class="math inline">\(I\)</span> for uma expressão aritmética, verifique se a tupla <span class="math inline">\((op, arg1, arg2)\)</span> já existe em <span class="math inline">\(E_{disp}\)</span>.
<ul>
<li><strong>Se Sim:</strong> <span class="math inline">\(I\)</span> é uma subexpressão comum. Substitua <span class="math inline">\(I\)</span> por uma cópia simples: <span class="math inline">\(destino = E_{disp}[(op, arg1, arg2)]\)</span>.</li>
<li><strong>Se Não:</strong> Mantenha <span class="math inline">\(I\)</span> e adicione a nova expressão e seu destino ao mapa <span class="math inline">\(E_{disp}\)</span>.</li>
</ul></li>
</ol>
<section id="exemplo-de-aplicação-1" class="level4" data-number="17.5.1.1">
<h4 data-number="17.5.1.1" class="anchored" data-anchor-id="exemplo-de-aplicação-1"><span class="header-section-number">17.5.1.1</span> Exemplo de Aplicação</h4>
<p><strong>Entrada</strong>:</p>
<pre class="shell"><code>t1 = a + b
t2 = c * d
t3 = a + b &nbsp;# Subexpressão comum com t1
t4 = c * d &nbsp;# Subexpressão comum com t2</code></pre>
<p>Saída Local CSE:</p>
<pre class="shell"><code>t1 = a + b
t2 = c * d
t3 = t1 &nbsp; &nbsp;# Reuso de t1
t4 = t2 &nbsp; &nbsp;# Reuso de t2</code></pre>
</section>
</section>
<section id="exemplo-em-c23-1" class="level3" data-number="17.5.2">
<h3 data-number="17.5.2" class="anchored" data-anchor-id="exemplo-em-c23-1"><span class="header-section-number">17.5.2</span> Exemplo em C++23</h3>
<p>O código a seguir implementa a otimização de Eliminação de Subexpressões Comuns Local (Local CSE) usando a técnica de <em>Value Numbering</em> de acordo com o digrama mostrado na <span class="citation" data-cites="fit-cselgoritmo">(<a href="referencias.html#ref-fit-cselgoritmo" role="doc-biblioref"><strong>fit-cselgoritmo?</strong></a>)</span>.</p>
<div id="fig-cselgoritmo" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-cselgoritmo-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<p><a href="\images\CSEOptimizer.webp">Figura: Diagrama do Algoritmo de Eliminação de Subexpressões Comuns Local (Local CSE) usando Value Numbering</a></p>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-cselgoritmo-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;17.1
</figcaption>
</figure>
</div>
<div class="sourceCode" id="cb21"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@file</span><span class="co"> </span><span class="cv">local_cse.cpp</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@author</span><span class="co"> Frank Alcantara</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@date</span><span class="co"> 2025-10</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@brief</span><span class="co"> Implementação didática da otimização de Eliminação de Subexpressões Comuns Local (Local CSE).</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="co"> * O Local CSE identifica e remove cálculos idênticos dentro de um único bloco básico,</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="co"> * reutilizando o resultado da primeira ocorrência através da técnica de Value Numbering.</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a><span class="co"> * Técnica: Value Numbering</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a><span class="co"> * - Cada expressão (op, arg1, arg2) recebe um "número de valor" representado pela variável que a computa</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a><span class="co"> * - Expressões com mesma forma são mapeadas para o mesmo número de valor</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a><span class="co"> * - Expressões redundantes são substituídas por cópias do valor já computado</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="in">@note</span><span class="co"> Requer C++23 ou superior. Este código foi desenvolvido como parte de um</span></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a><span class="co"> * material educacional sobre otimizações de compiladores e usou o Google Gemini e</span></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a><span class="co"> * o Anthropic Claude como ferramentas de pesquisa e revisão.</span></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;iostream&gt;</span></span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;vector&gt;</span></span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;string&gt;</span></span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;string_view&gt;</span></span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unordered_set&gt;</span></span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unordered_map&gt;</span></span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;algorithm&gt;</span></span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;regex&gt;</span></span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;ranges&gt;</span></span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;print&gt;</span></span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;span&gt;</span></span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;optional&gt;</span></span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;cctype&gt;</span></span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;format&gt;</span></span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;utility&gt;</span></span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a><span class="co">// --------------------------------------------------------------------------------</span></span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a><span class="co">// Type Aliases</span></span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a><span class="co">// --------------------------------------------------------------------------------</span></span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> InstructionList <span class="op">=</span> <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="bu">std::</span>string<span class="op">&gt;;</span></span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> VarSet <span class="op">=</span> <span class="bu">std::</span>unordered_set<span class="op">&lt;</span><span class="bu">std::</span>string<span class="op">&gt;;</span></span>
<span id="cb21-42"><a href="#cb21-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-43"><a href="#cb21-43" aria-hidden="true" tabindex="-1"></a><span class="co">// --------------------------------------------------------------------------------</span></span>
<span id="cb21-44"><a href="#cb21-44" aria-hidden="true" tabindex="-1"></a><span class="co">// Funções Auxiliares de String</span></span>
<span id="cb21-45"><a href="#cb21-45" aria-hidden="true" tabindex="-1"></a><span class="co">// --------------------------------------------------------------------------------</span></span>
<span id="cb21-46"><a href="#cb21-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-47"><a href="#cb21-47" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb21-48"><a href="#cb21-48" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@brief</span><span class="co"> Remove espaços em branco do início e fim de uma string.</span></span>
<span id="cb21-49"><a href="#cb21-49" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@param</span><span class="co"> </span><span class="cv">str</span><span class="co"> String a ser processada.</span></span>
<span id="cb21-50"><a href="#cb21-50" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@return</span><span class="co"> String sem espaços nas extremidades.</span></span>
<span id="cb21-51"><a href="#cb21-51" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb21-52"><a href="#cb21-52" aria-hidden="true" tabindex="-1"></a><span class="op">[[</span><span class="at">nodiscard</span><span class="op">]]</span> <span class="bu">std::</span>string trim<span class="op">(</span><span class="at">const</span> <span class="bu">std::</span>string<span class="op">&amp;</span> str<span class="op">)</span> <span class="op">{</span></span>
<span id="cb21-53"><a href="#cb21-53" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> start <span class="op">=</span> <span class="bu">std::</span>find_if_not<span class="op">(</span>str<span class="op">.</span>begin<span class="op">(),</span> str<span class="op">.</span>end<span class="op">(),</span> </span>
<span id="cb21-54"><a href="#cb21-54" aria-hidden="true" tabindex="-1"></a>                                   <span class="op">[](</span><span class="dt">unsigned</span> <span class="dt">char</span> ch<span class="op">)</span> <span class="op">{</span> <span class="cf">return</span> <span class="bu">std::</span>isspace<span class="op">(</span>ch<span class="op">);</span> <span class="op">});</span></span>
<span id="cb21-55"><a href="#cb21-55" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> end <span class="op">=</span> <span class="bu">std::</span>find_if_not<span class="op">(</span>str<span class="op">.</span>rbegin<span class="op">(),</span> str<span class="op">.</span>rend<span class="op">(),</span> </span>
<span id="cb21-56"><a href="#cb21-56" aria-hidden="true" tabindex="-1"></a>                                 <span class="op">[](</span><span class="dt">unsigned</span> <span class="dt">char</span> ch<span class="op">)</span> <span class="op">{</span> <span class="cf">return</span> <span class="bu">std::</span>isspace<span class="op">(</span>ch<span class="op">);</span> <span class="op">}).</span>base<span class="op">();</span></span>
<span id="cb21-57"><a href="#cb21-57" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">(</span>start <span class="op">&lt;</span> end<span class="op">)</span> <span class="op">?</span> <span class="bu">std::</span>string<span class="op">(</span>start<span class="op">,</span> end<span class="op">)</span> <span class="op">:</span> <span class="bu">std::</span>string<span class="op">();</span></span>
<span id="cb21-58"><a href="#cb21-58" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb21-59"><a href="#cb21-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-60"><a href="#cb21-60" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb21-61"><a href="#cb21-61" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@brief</span><span class="co"> Verifica se uma string representa um literal numérico.</span></span>
<span id="cb21-62"><a href="#cb21-62" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@param</span><span class="co"> </span><span class="cv">str</span><span class="co"> String a ser verificada.</span></span>
<span id="cb21-63"><a href="#cb21-63" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@return</span><span class="co"> true se for um número, false caso contrário.</span></span>
<span id="cb21-64"><a href="#cb21-64" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb21-65"><a href="#cb21-65" aria-hidden="true" tabindex="-1"></a><span class="op">[[</span><span class="at">nodiscard</span><span class="op">]]</span> <span class="dt">bool</span> is_numeric_literal<span class="op">(</span><span class="bu">std::</span>string_view str<span class="op">)</span> <span class="op">{</span></span>
<span id="cb21-66"><a href="#cb21-66" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>str<span class="op">.</span>empty<span class="op">())</span> <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb21-67"><a href="#cb21-67" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-68"><a href="#cb21-68" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Fast path: inteiros simples (caso comum)</span></span>
<span id="cb21-69"><a href="#cb21-69" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>str<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">!=</span> <span class="ch">'.'</span> <span class="op">&amp;&amp;</span> str<span class="op">.</span>find<span class="op">(</span><span class="ch">'.'</span><span class="op">)</span> <span class="op">==</span> <span class="bu">std::</span>string_view::npos <span class="op">&amp;&amp;</span> </span>
<span id="cb21-70"><a href="#cb21-70" aria-hidden="true" tabindex="-1"></a>        str<span class="op">.</span>find<span class="op">(</span><span class="ch">'e'</span><span class="op">)</span> <span class="op">==</span> <span class="bu">std::</span>string_view::npos <span class="op">&amp;&amp;</span> str<span class="op">.</span>find<span class="op">(</span><span class="ch">'E'</span><span class="op">)</span> <span class="op">==</span> <span class="bu">std::</span>string_view::npos<span class="op">)</span> <span class="op">{</span></span>
<span id="cb21-71"><a href="#cb21-71" aria-hidden="true" tabindex="-1"></a>        <span class="dt">size_t</span> start <span class="op">=</span> <span class="op">(</span>str<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">==</span> <span class="ch">'-'</span> <span class="op">||</span> str<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">==</span> <span class="ch">'+'</span><span class="op">)</span> <span class="op">?</span> <span class="dv">1</span> <span class="op">:</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb21-72"><a href="#cb21-72" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">std::</span>all_of<span class="op">(</span>str<span class="op">.</span>begin<span class="op">()</span> <span class="op">+</span> start<span class="op">,</span> str<span class="op">.</span>end<span class="op">(),</span> </span>
<span id="cb21-73"><a href="#cb21-73" aria-hidden="true" tabindex="-1"></a>                          <span class="op">[](</span><span class="dt">unsigned</span> <span class="dt">char</span> c<span class="op">)</span> <span class="op">{</span> <span class="cf">return</span> <span class="bu">std::</span>isdigit<span class="op">(</span>c<span class="op">);</span> <span class="op">});</span></span>
<span id="cb21-74"><a href="#cb21-74" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb21-75"><a href="#cb21-75" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-76"><a href="#cb21-76" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Slow path: floats e notação científica</span></span>
<span id="cb21-77"><a href="#cb21-77" aria-hidden="true" tabindex="-1"></a>    <span class="at">static</span> <span class="at">const</span> <span class="bu">std::</span>regex numeric_regex<span class="op">(</span><span class="st">R"(</span><span class="vs">^[+-]?(\d+\.?\d*|\.\d+)([eE][+-]?\d+)?$</span><span class="st">)"</span><span class="op">);</span></span>
<span id="cb21-78"><a href="#cb21-78" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">std::</span>regex_match<span class="op">(</span><span class="bu">std::</span>string<span class="op">(</span>str<span class="op">),</span> numeric_regex<span class="op">);</span></span>
<span id="cb21-79"><a href="#cb21-79" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb21-80"><a href="#cb21-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-81"><a href="#cb21-81" aria-hidden="true" tabindex="-1"></a><span class="co">// --------------------------------------------------------------------------------</span></span>
<span id="cb21-82"><a href="#cb21-82" aria-hidden="true" tabindex="-1"></a><span class="co">// Estruturas de Dados para Value Numbering</span></span>
<span id="cb21-83"><a href="#cb21-83" aria-hidden="true" tabindex="-1"></a><span class="co">// --------------------------------------------------------------------------------</span></span>
<span id="cb21-84"><a href="#cb21-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-85"><a href="#cb21-85" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb21-86"><a href="#cb21-86" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@brief</span><span class="co"> Representa uma expressão para fins de Value Numbering.</span></span>
<span id="cb21-87"><a href="#cb21-87" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span></span>
<span id="cb21-88"><a href="#cb21-88" aria-hidden="true" tabindex="-1"></a><span class="co"> * A chave de uma expressão é formada por:</span></span>
<span id="cb21-89"><a href="#cb21-89" aria-hidden="true" tabindex="-1"></a><span class="co"> * - Operador (op): +, -, *, /, etc.</span></span>
<span id="cb21-90"><a href="#cb21-90" aria-hidden="true" tabindex="-1"></a><span class="co"> * - Operandos (arg1, arg2): variáveis ou constantes</span></span>
<span id="cb21-91"><a href="#cb21-91" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span></span>
<span id="cb21-92"><a href="#cb21-92" aria-hidden="true" tabindex="-1"></a><span class="co"> * Para operadores comutativos, os operandos são normalizados em ordem lexicográfica.</span></span>
<span id="cb21-93"><a href="#cb21-93" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb21-94"><a href="#cb21-94" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> ExpressionKey <span class="op">{</span></span>
<span id="cb21-95"><a href="#cb21-95" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>string op<span class="op">;</span></span>
<span id="cb21-96"><a href="#cb21-96" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>string arg1<span class="op">;</span></span>
<span id="cb21-97"><a href="#cb21-97" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>string arg2<span class="op">;</span></span>
<span id="cb21-98"><a href="#cb21-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-99"><a href="#cb21-99" aria-hidden="true" tabindex="-1"></a>    <span class="co">/**</span></span>
<span id="cb21-100"><a href="#cb21-100" aria-hidden="true" tabindex="-1"></a><span class="co">     * </span><span class="an">@brief</span><span class="co"> Construtor que normaliza automaticamente operadores comutativos.</span></span>
<span id="cb21-101"><a href="#cb21-101" aria-hidden="true" tabindex="-1"></a><span class="co">     * </span></span>
<span id="cb21-102"><a href="#cb21-102" aria-hidden="true" tabindex="-1"></a><span class="co">     * Operadores comutativos (+, *) têm seus operandos ordenados para garantir</span></span>
<span id="cb21-103"><a href="#cb21-103" aria-hidden="true" tabindex="-1"></a><span class="co">     * que "a + b" e "b + a" sejam reconhecidos como a mesma expressão.</span></span>
<span id="cb21-104"><a href="#cb21-104" aria-hidden="true" tabindex="-1"></a><span class="co">     */</span></span>
<span id="cb21-105"><a href="#cb21-105" aria-hidden="true" tabindex="-1"></a>    ExpressionKey<span class="op">(</span><span class="bu">std::</span>string operation<span class="op">,</span> <span class="bu">std::</span>string operand1<span class="op">,</span> <span class="bu">std::</span>string operand2<span class="op">)</span></span>
<span id="cb21-106"><a href="#cb21-106" aria-hidden="true" tabindex="-1"></a>        <span class="op">:</span> op<span class="op">(</span><span class="bu">std::</span>move<span class="op">(</span>operation<span class="op">))</span></span>
<span id="cb21-107"><a href="#cb21-107" aria-hidden="true" tabindex="-1"></a>        <span class="op">,</span> arg1<span class="op">(</span><span class="bu">std::</span>move<span class="op">(</span>operand1<span class="op">))</span></span>
<span id="cb21-108"><a href="#cb21-108" aria-hidden="true" tabindex="-1"></a>        <span class="op">,</span> arg2<span class="op">(</span><span class="bu">std::</span>move<span class="op">(</span>operand2<span class="op">))</span></span>
<span id="cb21-109"><a href="#cb21-109" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb21-110"><a href="#cb21-110" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Normalização para operadores comutativos</span></span>
<span id="cb21-111"><a href="#cb21-111" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">((</span>op <span class="op">==</span> <span class="st">"+"</span> <span class="op">||</span> op <span class="op">==</span> <span class="st">"*"</span><span class="op">)</span> <span class="op">&amp;&amp;</span> arg1 <span class="op">&gt;</span> arg2<span class="op">)</span> <span class="op">{</span></span>
<span id="cb21-112"><a href="#cb21-112" aria-hidden="true" tabindex="-1"></a>            <span class="bu">std::</span>swap<span class="op">(</span>arg1<span class="op">,</span> arg2<span class="op">);</span></span>
<span id="cb21-113"><a href="#cb21-113" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb21-114"><a href="#cb21-114" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb21-115"><a href="#cb21-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-116"><a href="#cb21-116" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> <span class="kw">operator</span><span class="op">==(</span><span class="at">const</span> ExpressionKey<span class="op">&amp;</span> other<span class="op">)</span> <span class="at">const</span> <span class="op">{</span></span>
<span id="cb21-117"><a href="#cb21-117" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> op <span class="op">==</span> other<span class="op">.</span>op <span class="op">&amp;&amp;</span> arg1 <span class="op">==</span> other<span class="op">.</span>arg1 <span class="op">&amp;&amp;</span> arg2 <span class="op">==</span> other<span class="op">.</span>arg2<span class="op">;</span></span>
<span id="cb21-118"><a href="#cb21-118" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb21-119"><a href="#cb21-119" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb21-120"><a href="#cb21-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-121"><a href="#cb21-121" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb21-122"><a href="#cb21-122" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@brief</span><span class="co"> Functor de hash para ExpressionKey usando técnica de combinação de hashes.</span></span>
<span id="cb21-123"><a href="#cb21-123" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span></span>
<span id="cb21-124"><a href="#cb21-124" aria-hidden="true" tabindex="-1"></a><span class="co"> * Implementa hash combinado baseado na técnica descrita em:</span></span>
<span id="cb21-125"><a href="#cb21-125" aria-hidden="true" tabindex="-1"></a><span class="co"> * Boost.Hash (https://www.boost.org/doc/libs/1_55_0/doc/html/hash/reference.html#boost.hash_combine)</span></span>
<span id="cb21-126"><a href="#cb21-126" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb21-127"><a href="#cb21-127" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> ExpressionKeyHasher <span class="op">{</span></span>
<span id="cb21-128"><a href="#cb21-128" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>size_t <span class="kw">operator</span><span class="op">()(</span><span class="at">const</span> ExpressionKey<span class="op">&amp;</span> k<span class="op">)</span> <span class="at">const</span> <span class="op">{</span></span>
<span id="cb21-129"><a href="#cb21-129" aria-hidden="true" tabindex="-1"></a>        <span class="bu">std::</span>size_t seed <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb21-130"><a href="#cb21-130" aria-hidden="true" tabindex="-1"></a>        hash_combine<span class="op">(</span>seed<span class="op">,</span> k<span class="op">.</span>op<span class="op">);</span></span>
<span id="cb21-131"><a href="#cb21-131" aria-hidden="true" tabindex="-1"></a>        hash_combine<span class="op">(</span>seed<span class="op">,</span> k<span class="op">.</span>arg1<span class="op">);</span></span>
<span id="cb21-132"><a href="#cb21-132" aria-hidden="true" tabindex="-1"></a>        hash_combine<span class="op">(</span>seed<span class="op">,</span> k<span class="op">.</span>arg2<span class="op">);</span></span>
<span id="cb21-133"><a href="#cb21-133" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> seed<span class="op">;</span></span>
<span id="cb21-134"><a href="#cb21-134" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb21-135"><a href="#cb21-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-136"><a href="#cb21-136" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span><span class="op">:</span></span>
<span id="cb21-137"><a href="#cb21-137" aria-hidden="true" tabindex="-1"></a>    <span class="at">static</span> <span class="dt">void</span> hash_combine<span class="op">(</span><span class="bu">std::</span>size_t<span class="op">&amp;</span> seed<span class="op">,</span> <span class="at">const</span> <span class="bu">std::</span>string<span class="op">&amp;</span> value<span class="op">)</span> <span class="op">{</span></span>
<span id="cb21-138"><a href="#cb21-138" aria-hidden="true" tabindex="-1"></a>        seed <span class="op">^=</span> <span class="bu">std::</span>hash<span class="op">&lt;</span><span class="bu">std::</span>string<span class="op">&gt;{}(</span>value<span class="op">)</span> <span class="op">+</span> <span class="bn">0x9e3779b9</span> <span class="op">+</span> <span class="op">(</span>seed <span class="op">&lt;&lt;</span> <span class="dv">6</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span>seed <span class="op">&gt;&gt;</span> <span class="dv">2</span><span class="op">);</span></span>
<span id="cb21-139"><a href="#cb21-139" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb21-140"><a href="#cb21-140" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb21-141"><a href="#cb21-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-142"><a href="#cb21-142" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb21-143"><a href="#cb21-143" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@brief</span><span class="co"> Mapa de expressões disponíveis (Available Expressions).</span></span>
<span id="cb21-144"><a href="#cb21-144" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span></span>
<span id="cb21-145"><a href="#cb21-145" aria-hidden="true" tabindex="-1"></a><span class="co"> * Mapeia cada expressão única para a variável que contém seu resultado.</span></span>
<span id="cb21-146"><a href="#cb21-146" aria-hidden="true" tabindex="-1"></a><span class="co"> * Exemplo: {("+", "a", "b") -&gt; "t1"} indica que t1 = a + b já foi computado.</span></span>
<span id="cb21-147"><a href="#cb21-147" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb21-148"><a href="#cb21-148" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> AvailableExpressions <span class="op">=</span> <span class="bu">std::</span>unordered_map<span class="op">&lt;</span>ExpressionKey<span class="op">,</span> <span class="bu">std::</span>string<span class="op">,</span> ExpressionKeyHasher<span class="op">&gt;;</span></span>
<span id="cb21-149"><a href="#cb21-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-150"><a href="#cb21-150" aria-hidden="true" tabindex="-1"></a><span class="co">// --------------------------------------------------------------------------------</span></span>
<span id="cb21-151"><a href="#cb21-151" aria-hidden="true" tabindex="-1"></a><span class="co">// Parser Simplificado</span></span>
<span id="cb21-152"><a href="#cb21-152" aria-hidden="true" tabindex="-1"></a><span class="co">// --------------------------------------------------------------------------------</span></span>
<span id="cb21-153"><a href="#cb21-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-154"><a href="#cb21-154" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb21-155"><a href="#cb21-155" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@brief</span><span class="co"> Estrutura que representa uma instrução TAC parseada.</span></span>
<span id="cb21-156"><a href="#cb21-156" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb21-157"><a href="#cb21-157" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> ParsedInstruction <span class="op">{</span></span>
<span id="cb21-158"><a href="#cb21-158" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>string dest<span class="op">;</span>              <span class="co">///&lt; Variável de destino (LHS)</span></span>
<span id="cb21-159"><a href="#cb21-159" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>string op<span class="op">;</span>                <span class="co">///&lt; Operador ou tipo de instrução</span></span>
<span id="cb21-160"><a href="#cb21-160" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>string arg1<span class="op">;</span>              <span class="co">///&lt; Primeiro operando</span></span>
<span id="cb21-161"><a href="#cb21-161" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>string arg2<span class="op">;</span>              <span class="co">///&lt; Segundo operando (vazio se unário)</span></span>
<span id="cb21-162"><a href="#cb21-162" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>string original_line<span class="op">;</span>     <span class="co">///&lt; Linha original completa</span></span>
<span id="cb21-163"><a href="#cb21-163" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> is_arithmetic<span class="op">;</span>            <span class="co">///&lt; true se for operação aritmética binária</span></span>
<span id="cb21-164"><a href="#cb21-164" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> modifies_memory<span class="op">;</span>          <span class="co">///&lt; true se modificar memória (store, call)</span></span>
<span id="cb21-165"><a href="#cb21-165" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb21-166"><a href="#cb21-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-167"><a href="#cb21-167" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb21-168"><a href="#cb21-168" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@brief</span><span class="co"> Parser simplificado para instruções TAC.</span></span>
<span id="cb21-169"><a href="#cb21-169" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span></span>
<span id="cb21-170"><a href="#cb21-170" aria-hidden="true" tabindex="-1"></a><span class="co"> * Formato esperado:</span></span>
<span id="cb21-171"><a href="#cb21-171" aria-hidden="true" tabindex="-1"></a><span class="co"> * - Aritmético: "dest = arg1 op arg2" onde op é +, -, *, /</span></span>
<span id="cb21-172"><a href="#cb21-172" aria-hidden="true" tabindex="-1"></a><span class="co"> * - Atribuição: "dest = arg1"</span></span>
<span id="cb21-173"><a href="#cb21-173" aria-hidden="true" tabindex="-1"></a><span class="co"> * - Memória: instruções contendo "store" ou "call"</span></span>
<span id="cb21-174"><a href="#cb21-174" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span></span>
<span id="cb21-175"><a href="#cb21-175" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@param</span><span class="co"> </span><span class="cv">line</span><span class="co"> Linha de código TAC.</span></span>
<span id="cb21-176"><a href="#cb21-176" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@return</span><span class="co"> ParsedInstruction Estrutura com os componentes da instrução.</span></span>
<span id="cb21-177"><a href="#cb21-177" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb21-178"><a href="#cb21-178" aria-hidden="true" tabindex="-1"></a><span class="op">[[</span><span class="at">nodiscard</span><span class="op">]]</span> ParsedInstruction parse_tac_instruction<span class="op">(</span><span class="at">const</span> <span class="bu">std::</span>string<span class="op">&amp;</span> line<span class="op">)</span> <span class="op">{</span></span>
<span id="cb21-179"><a href="#cb21-179" aria-hidden="true" tabindex="-1"></a>    ParsedInstruction p <span class="op">=</span> <span class="op">{</span></span>
<span id="cb21-180"><a href="#cb21-180" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>dest <span class="op">=</span> <span class="st">""</span><span class="op">,</span> </span>
<span id="cb21-181"><a href="#cb21-181" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>op <span class="op">=</span> <span class="st">""</span><span class="op">,</span> </span>
<span id="cb21-182"><a href="#cb21-182" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>arg1 <span class="op">=</span> <span class="st">""</span><span class="op">,</span> </span>
<span id="cb21-183"><a href="#cb21-183" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>arg2 <span class="op">=</span> <span class="st">""</span><span class="op">,</span> </span>
<span id="cb21-184"><a href="#cb21-184" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>original_line <span class="op">=</span> line<span class="op">,</span> </span>
<span id="cb21-185"><a href="#cb21-185" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>is_arithmetic <span class="op">=</span> <span class="kw">false</span><span class="op">,</span> </span>
<span id="cb21-186"><a href="#cb21-186" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>modifies_memory <span class="op">=</span> <span class="kw">false</span></span>
<span id="cb21-187"><a href="#cb21-187" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb21-188"><a href="#cb21-188" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-189"><a href="#cb21-189" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Verifica se instrução modifica memória</span></span>
<span id="cb21-190"><a href="#cb21-190" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>line<span class="op">.</span>find<span class="op">(</span><span class="st">"store"</span><span class="op">)</span> <span class="op">!=</span> <span class="bu">std::</span>string::npos <span class="op">||</span> </span>
<span id="cb21-191"><a href="#cb21-191" aria-hidden="true" tabindex="-1"></a>        line<span class="op">.</span>find<span class="op">(</span><span class="st">"call"</span><span class="op">)</span> <span class="op">!=</span> <span class="bu">std::</span>string::npos<span class="op">)</span> <span class="op">{</span></span>
<span id="cb21-192"><a href="#cb21-192" aria-hidden="true" tabindex="-1"></a>        p<span class="op">.</span>modifies_memory <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb21-193"><a href="#cb21-193" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> p<span class="op">;</span></span>
<span id="cb21-194"><a href="#cb21-194" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb21-195"><a href="#cb21-195" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-196"><a href="#cb21-196" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Procura pelo símbolo de atribuição</span></span>
<span id="cb21-197"><a href="#cb21-197" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> eq_pos <span class="op">=</span> line<span class="op">.</span>find<span class="op">(</span><span class="ch">'='</span><span class="op">);</span></span>
<span id="cb21-198"><a href="#cb21-198" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>eq_pos <span class="op">==</span> <span class="bu">std::</span>string::npos<span class="op">)</span> <span class="op">{</span></span>
<span id="cb21-199"><a href="#cb21-199" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> p<span class="op">;</span> <span class="co">// Não é uma atribuição</span></span>
<span id="cb21-200"><a href="#cb21-200" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb21-201"><a href="#cb21-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-202"><a href="#cb21-202" aria-hidden="true" tabindex="-1"></a>    p<span class="op">.</span>dest <span class="op">=</span> trim<span class="op">(</span>line<span class="op">.</span>substr<span class="op">(</span><span class="dv">0</span><span class="op">,</span> eq_pos<span class="op">));</span></span>
<span id="cb21-203"><a href="#cb21-203" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>string rhs <span class="op">=</span> trim<span class="op">(</span>line<span class="op">.</span>substr<span class="op">(</span>eq_pos <span class="op">+</span> <span class="dv">1</span><span class="op">));</span></span>
<span id="cb21-204"><a href="#cb21-204" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-205"><a href="#cb21-205" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Tenta fazer match com operação aritmética binária</span></span>
<span id="cb21-206"><a href="#cb21-206" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Padrão: operando operador operando</span></span>
<span id="cb21-207"><a href="#cb21-207" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Aceita espaços opcionais ao redor do operador</span></span>
<span id="cb21-208"><a href="#cb21-208" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>regex arithmetic_regex<span class="op">(</span><span class="st">R"(</span><span class="vs">^([a-zA-Z_][a-zA-Z0-9_]*|\d+)\s*([\+\-\*\/])\s*([a-zA-Z_][a-zA-Z0-9_]*|\d+)$</span><span class="st">)"</span><span class="op">);</span></span>
<span id="cb21-209"><a href="#cb21-209" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>smatch match<span class="op">;</span></span>
<span id="cb21-210"><a href="#cb21-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-211"><a href="#cb21-211" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span><span class="bu">std::</span>regex_match<span class="op">(</span>rhs<span class="op">,</span> match<span class="op">,</span> arithmetic_regex<span class="op">))</span> <span class="op">{</span></span>
<span id="cb21-212"><a href="#cb21-212" aria-hidden="true" tabindex="-1"></a>        p<span class="op">.</span>is_arithmetic <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb21-213"><a href="#cb21-213" aria-hidden="true" tabindex="-1"></a>        p<span class="op">.</span>arg1 <span class="op">=</span> trim<span class="op">(</span>match<span class="op">[</span><span class="dv">1</span><span class="op">].</span>str<span class="op">());</span></span>
<span id="cb21-214"><a href="#cb21-214" aria-hidden="true" tabindex="-1"></a>        p<span class="op">.</span>op <span class="op">=</span> trim<span class="op">(</span>match<span class="op">[</span><span class="dv">2</span><span class="op">].</span>str<span class="op">());</span></span>
<span id="cb21-215"><a href="#cb21-215" aria-hidden="true" tabindex="-1"></a>        p<span class="op">.</span>arg2 <span class="op">=</span> trim<span class="op">(</span>match<span class="op">[</span><span class="dv">3</span><span class="op">].</span>str<span class="op">());</span></span>
<span id="cb21-216"><a href="#cb21-216" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb21-217"><a href="#cb21-217" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Atribuição simples ou valor único</span></span>
<span id="cb21-218"><a href="#cb21-218" aria-hidden="true" tabindex="-1"></a>        p<span class="op">.</span>arg1 <span class="op">=</span> rhs<span class="op">;</span></span>
<span id="cb21-219"><a href="#cb21-219" aria-hidden="true" tabindex="-1"></a>        p<span class="op">.</span>op <span class="op">=</span> <span class="st">"ASSIGN"</span><span class="op">;</span></span>
<span id="cb21-220"><a href="#cb21-220" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb21-221"><a href="#cb21-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-222"><a href="#cb21-222" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> p<span class="op">;</span></span>
<span id="cb21-223"><a href="#cb21-223" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb21-224"><a href="#cb21-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-225"><a href="#cb21-225" aria-hidden="true" tabindex="-1"></a><span class="co">// --------------------------------------------------------------------------------</span></span>
<span id="cb21-226"><a href="#cb21-226" aria-hidden="true" tabindex="-1"></a><span class="co">// Classe Principal: Local CSE Optimizer</span></span>
<span id="cb21-227"><a href="#cb21-227" aria-hidden="true" tabindex="-1"></a><span class="co">// --------------------------------------------------------------------------------</span></span>
<span id="cb21-228"><a href="#cb21-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-229"><a href="#cb21-229" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb21-230"><a href="#cb21-230" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@brief</span><span class="co"> Implementa Local CSE usando algoritmo de Value Numbering.</span></span>
<span id="cb21-231"><a href="#cb21-231" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span></span>
<span id="cb21-232"><a href="#cb21-232" aria-hidden="true" tabindex="-1"></a><span class="co"> * Algoritmo:</span></span>
<span id="cb21-233"><a href="#cb21-233" aria-hidden="true" tabindex="-1"></a><span class="co"> * 1. Para cada instrução no bloco básico:</span></span>
<span id="cb21-234"><a href="#cb21-234" aria-hidden="true" tabindex="-1"></a><span class="co"> *    a. Invalida expressões que dependem da variável sendo definida</span></span>
<span id="cb21-235"><a href="#cb21-235" aria-hidden="true" tabindex="-1"></a><span class="co"> *    b. Se a instrução computa uma expressão aritmética:</span></span>
<span id="cb21-236"><a href="#cb21-236" aria-hidden="true" tabindex="-1"></a><span class="co"> *       - Verifica se a expressão já está disponível</span></span>
<span id="cb21-237"><a href="#cb21-237" aria-hidden="true" tabindex="-1"></a><span class="co"> *       - Se sim: substitui por uma cópia (CSE aplicado)</span></span>
<span id="cb21-238"><a href="#cb21-238" aria-hidden="true" tabindex="-1"></a><span class="co"> *       - Se não: adiciona aos disponíveis</span></span>
<span id="cb21-239"><a href="#cb21-239" aria-hidden="true" tabindex="-1"></a><span class="co"> *    c. Se a instrução modifica memória: invalida todas as expressões</span></span>
<span id="cb21-240"><a href="#cb21-240" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span></span>
<span id="cb21-241"><a href="#cb21-241" aria-hidden="true" tabindex="-1"></a><span class="co"> * Exemplo de transformação:</span></span>
<span id="cb21-242"><a href="#cb21-242" aria-hidden="true" tabindex="-1"></a><span class="co"> * Antes:          Depois:</span></span>
<span id="cb21-243"><a href="#cb21-243" aria-hidden="true" tabindex="-1"></a><span class="co"> * t1 = a + b      t1 = a + b</span></span>
<span id="cb21-244"><a href="#cb21-244" aria-hidden="true" tabindex="-1"></a><span class="co"> * t2 = c * d      t2 = c * d</span></span>
<span id="cb21-245"><a href="#cb21-245" aria-hidden="true" tabindex="-1"></a><span class="co"> * t3 = a + b      t3 = t1      (CSE: reutiliza t1)</span></span>
<span id="cb21-246"><a href="#cb21-246" aria-hidden="true" tabindex="-1"></a><span class="co"> * t4 = c * d      t4 = t2      (CSE: reutiliza t2)</span></span>
<span id="cb21-247"><a href="#cb21-247" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb21-248"><a href="#cb21-248" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> LocalCSEOptimizer <span class="op">{</span></span>
<span id="cb21-249"><a href="#cb21-249" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span><span class="op">:</span></span>
<span id="cb21-250"><a href="#cb21-250" aria-hidden="true" tabindex="-1"></a>    AvailableExpressions <span class="va">available_expressions_</span><span class="op">;</span></span>
<span id="cb21-251"><a href="#cb21-251" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> <span class="va">temp_counter_</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb21-252"><a href="#cb21-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-253"><a href="#cb21-253" aria-hidden="true" tabindex="-1"></a>    <span class="co">/**</span></span>
<span id="cb21-254"><a href="#cb21-254" aria-hidden="true" tabindex="-1"></a><span class="co">     * </span><span class="an">@brief</span><span class="co"> Invalida expressões que dependem da variável modificada.</span></span>
<span id="cb21-255"><a href="#cb21-255" aria-hidden="true" tabindex="-1"></a><span class="co">     * </span></span>
<span id="cb21-256"><a href="#cb21-256" aria-hidden="true" tabindex="-1"></a><span class="co">     * Quando uma variável é redefinida, todas as expressões que a utilizam</span></span>
<span id="cb21-257"><a href="#cb21-257" aria-hidden="true" tabindex="-1"></a><span class="co">     * como operando devem ser removidas do conjunto de disponíveis.</span></span>
<span id="cb21-258"><a href="#cb21-258" aria-hidden="true" tabindex="-1"></a><span class="co">     * </span></span>
<span id="cb21-259"><a href="#cb21-259" aria-hidden="true" tabindex="-1"></a><span class="co">     * Exemplo:</span></span>
<span id="cb21-260"><a href="#cb21-260" aria-hidden="true" tabindex="-1"></a><span class="co">     * t1 = a + b   // Adiciona ("+", "a", "b") -&gt; "t1"</span></span>
<span id="cb21-261"><a href="#cb21-261" aria-hidden="true" tabindex="-1"></a><span class="co">     * a = 5        // Invalida ("+", "a", "b") pois 'a' foi modificado</span></span>
<span id="cb21-262"><a href="#cb21-262" aria-hidden="true" tabindex="-1"></a><span class="co">     * t2 = a + b   // Não pode reutilizar t1, pois 'a' mudou</span></span>
<span id="cb21-263"><a href="#cb21-263" aria-hidden="true" tabindex="-1"></a><span class="co">     * </span></span>
<span id="cb21-264"><a href="#cb21-264" aria-hidden="true" tabindex="-1"></a><span class="co">     * </span><span class="an">@param</span><span class="co"> </span><span class="cv">modified_var</span><span class="co"> Variável que foi redefinida.</span></span>
<span id="cb21-265"><a href="#cb21-265" aria-hidden="true" tabindex="-1"></a><span class="co">     */</span></span>
<span id="cb21-266"><a href="#cb21-266" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> invalidate_expressions<span class="op">(</span><span class="at">const</span> <span class="bu">std::</span>string<span class="op">&amp;</span> modified_var<span class="op">)</span> <span class="op">{</span></span>
<span id="cb21-267"><a href="#cb21-267" aria-hidden="true" tabindex="-1"></a>        AvailableExpressions new_available<span class="op">;</span></span>
<span id="cb21-268"><a href="#cb21-268" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb21-269"><a href="#cb21-269" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="at">const</span> <span class="kw">auto</span><span class="op">&amp;</span> <span class="op">[</span>key<span class="op">,</span> value<span class="op">]</span> <span class="op">:</span> <span class="va">available_expressions_</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb21-270"><a href="#cb21-270" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Mantém a expressão apenas se não depender de modified_var</span></span>
<span id="cb21-271"><a href="#cb21-271" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Constantes numéricas nunca são "modificadas"</span></span>
<span id="cb21-272"><a href="#cb21-272" aria-hidden="true" tabindex="-1"></a>            <span class="dt">bool</span> depends_on_modified <span class="op">=</span> </span>
<span id="cb21-273"><a href="#cb21-273" aria-hidden="true" tabindex="-1"></a>                <span class="op">(</span>key<span class="op">.</span>arg1 <span class="op">==</span> modified_var <span class="op">&amp;&amp;</span> <span class="op">!</span>is_numeric_literal<span class="op">(</span>key<span class="op">.</span>arg1<span class="op">))</span> <span class="op">||</span></span>
<span id="cb21-274"><a href="#cb21-274" aria-hidden="true" tabindex="-1"></a>                <span class="op">(</span>key<span class="op">.</span>arg2 <span class="op">==</span> modified_var <span class="op">&amp;&amp;</span> <span class="op">!</span>is_numeric_literal<span class="op">(</span>key<span class="op">.</span>arg2<span class="op">));</span></span>
<span id="cb21-275"><a href="#cb21-275" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb21-276"><a href="#cb21-276" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(!</span>depends_on_modified<span class="op">)</span> <span class="op">{</span></span>
<span id="cb21-277"><a href="#cb21-277" aria-hidden="true" tabindex="-1"></a>                new_available<span class="op">.</span>insert<span class="op">({</span>key<span class="op">,</span> value<span class="op">});</span></span>
<span id="cb21-278"><a href="#cb21-278" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb21-279"><a href="#cb21-279" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb21-280"><a href="#cb21-280" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb21-281"><a href="#cb21-281" aria-hidden="true" tabindex="-1"></a>        <span class="va">available_expressions_</span> <span class="op">=</span> <span class="bu">std::</span>move<span class="op">(</span>new_available<span class="op">);</span></span>
<span id="cb21-282"><a href="#cb21-282" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb21-283"><a href="#cb21-283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-284"><a href="#cb21-284" aria-hidden="true" tabindex="-1"></a>    <span class="co">/**</span></span>
<span id="cb21-285"><a href="#cb21-285" aria-hidden="true" tabindex="-1"></a><span class="co">     * </span><span class="an">@brief</span><span class="co"> Processa uma instrução aritmética aplicando CSE.</span></span>
<span id="cb21-286"><a href="#cb21-286" aria-hidden="true" tabindex="-1"></a><span class="co">     * </span></span>
<span id="cb21-287"><a href="#cb21-287" aria-hidden="true" tabindex="-1"></a><span class="co">     * </span><span class="an">@param</span><span class="co"> </span><span class="cv">parsed</span><span class="co"> Instrução parseada.</span></span>
<span id="cb21-288"><a href="#cb21-288" aria-hidden="true" tabindex="-1"></a><span class="co">     * </span><span class="an">@return</span><span class="co"> String com a instrução otimizada (original ou modificada).</span></span>
<span id="cb21-289"><a href="#cb21-289" aria-hidden="true" tabindex="-1"></a><span class="co">     */</span></span>
<span id="cb21-290"><a href="#cb21-290" aria-hidden="true" tabindex="-1"></a>    <span class="op">[[</span><span class="at">nodiscard</span><span class="op">]]</span> <span class="bu">std::</span>string process_arithmetic<span class="op">(</span><span class="at">const</span> ParsedInstruction<span class="op">&amp;</span> parsed<span class="op">)</span> <span class="op">{</span></span>
<span id="cb21-291"><a href="#cb21-291" aria-hidden="true" tabindex="-1"></a>        ExpressionKey current_expr<span class="op">(</span>parsed<span class="op">.</span>op<span class="op">,</span> parsed<span class="op">.</span>arg1<span class="op">,</span> parsed<span class="op">.</span>arg2<span class="op">);</span></span>
<span id="cb21-292"><a href="#cb21-292" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb21-293"><a href="#cb21-293" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Verifica se a expressão já foi computada anteriormente</span></span>
<span id="cb21-294"><a href="#cb21-294" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span><span class="va">available_expressions_</span><span class="op">.</span>contains<span class="op">(</span>current_expr<span class="op">))</span> <span class="op">{</span></span>
<span id="cb21-295"><a href="#cb21-295" aria-hidden="true" tabindex="-1"></a>            <span class="co">// CSE: Reutiliza o resultado da expressão anterior</span></span>
<span id="cb21-296"><a href="#cb21-296" aria-hidden="true" tabindex="-1"></a>            <span class="at">const</span> <span class="bu">std::</span>string<span class="op">&amp;</span> cached_var <span class="op">=</span> <span class="va">available_expressions_</span><span class="op">.</span>at<span class="op">(</span>current_expr<span class="op">);</span></span>
<span id="cb21-297"><a href="#cb21-297" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb21-298"><a href="#cb21-298" aria-hidden="true" tabindex="-1"></a>            <span class="bu">std::</span>string optimized <span class="op">=</span> <span class="bu">std::</span>format<span class="op">(</span><span class="st">"</span><span class="sc">{}</span><span class="st"> = </span><span class="sc">{}</span><span class="st">"</span><span class="op">,</span> parsed<span class="op">.</span>dest<span class="op">,</span> cached_var<span class="op">);</span></span>
<span id="cb21-299"><a href="#cb21-299" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb21-300"><a href="#cb21-300" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Adiciona a nova atribuição simples ao conjunto disponível</span></span>
<span id="cb21-301"><a href="#cb21-301" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Isso permite Copy Propagation em otimizações subsequentes</span></span>
<span id="cb21-302"><a href="#cb21-302" aria-hidden="true" tabindex="-1"></a>            ExpressionKey assign_key<span class="op">(</span><span class="st">"ASSIGN"</span><span class="op">,</span> cached_var<span class="op">,</span> <span class="st">""</span><span class="op">);</span></span>
<span id="cb21-303"><a href="#cb21-303" aria-hidden="true" tabindex="-1"></a>            <span class="va">available_expressions_</span><span class="op">[</span>assign_key<span class="op">]</span> <span class="op">=</span> parsed<span class="op">.</span>dest<span class="op">;</span></span>
<span id="cb21-304"><a href="#cb21-304" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb21-305"><a href="#cb21-305" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> optimized<span class="op">;</span></span>
<span id="cb21-306"><a href="#cb21-306" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb21-307"><a href="#cb21-307" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Expressão nova: adiciona ao conjunto de disponíveis</span></span>
<span id="cb21-308"><a href="#cb21-308" aria-hidden="true" tabindex="-1"></a>            <span class="va">available_expressions_</span><span class="op">[</span>current_expr<span class="op">]</span> <span class="op">=</span> parsed<span class="op">.</span>dest<span class="op">;</span></span>
<span id="cb21-309"><a href="#cb21-309" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> parsed<span class="op">.</span>original_line<span class="op">;</span></span>
<span id="cb21-310"><a href="#cb21-310" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb21-311"><a href="#cb21-311" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb21-312"><a href="#cb21-312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-313"><a href="#cb21-313" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="cb21-314"><a href="#cb21-314" aria-hidden="true" tabindex="-1"></a>    <span class="co">/**</span></span>
<span id="cb21-315"><a href="#cb21-315" aria-hidden="true" tabindex="-1"></a><span class="co">     * </span><span class="an">@brief</span><span class="co"> Otimiza um bloco básico aplicando Local CSE.</span></span>
<span id="cb21-316"><a href="#cb21-316" aria-hidden="true" tabindex="-1"></a><span class="co">     * </span></span>
<span id="cb21-317"><a href="#cb21-317" aria-hidden="true" tabindex="-1"></a><span class="co">     * </span><span class="an">@param</span><span class="co"> </span><span class="cv">instructions</span><span class="co"> Lista de instruções TAC do bloco.</span></span>
<span id="cb21-318"><a href="#cb21-318" aria-hidden="true" tabindex="-1"></a><span class="co">     * </span><span class="an">@return</span><span class="co"> InstructionList Código otimizado.</span></span>
<span id="cb21-319"><a href="#cb21-319" aria-hidden="true" tabindex="-1"></a><span class="co">     */</span></span>
<span id="cb21-320"><a href="#cb21-320" aria-hidden="true" tabindex="-1"></a>    <span class="op">[[</span><span class="at">nodiscard</span><span class="op">]]</span> InstructionList optimize<span class="op">(</span><span class="bu">std::</span>span<span class="op">&lt;</span><span class="at">const</span> <span class="bu">std::</span>string<span class="op">&gt;</span> instructions<span class="op">)</span> <span class="op">{</span></span>
<span id="cb21-321"><a href="#cb21-321" aria-hidden="true" tabindex="-1"></a>        InstructionList result<span class="op">;</span></span>
<span id="cb21-322"><a href="#cb21-322" aria-hidden="true" tabindex="-1"></a>        <span class="va">available_expressions_</span><span class="op">.</span>clear<span class="op">();</span></span>
<span id="cb21-323"><a href="#cb21-323" aria-hidden="true" tabindex="-1"></a>        <span class="va">temp_counter_</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb21-324"><a href="#cb21-324" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb21-325"><a href="#cb21-325" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="at">const</span> <span class="kw">auto</span><span class="op">&amp;</span> line <span class="op">:</span> instructions<span class="op">)</span> <span class="op">{</span></span>
<span id="cb21-326"><a href="#cb21-326" aria-hidden="true" tabindex="-1"></a>            ParsedInstruction parsed <span class="op">=</span> parse_tac_instruction<span class="op">(</span>line<span class="op">);</span></span>
<span id="cb21-327"><a href="#cb21-327" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb21-328"><a href="#cb21-328" aria-hidden="true" tabindex="-1"></a>            <span class="co">// PASSO 1: Invalida expressões que dependem do destino</span></span>
<span id="cb21-329"><a href="#cb21-329" aria-hidden="true" tabindex="-1"></a>            <span class="co">// (deve ocorrer antes de processar a instrução atual)</span></span>
<span id="cb21-330"><a href="#cb21-330" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(!</span>parsed<span class="op">.</span>dest<span class="op">.</span>empty<span class="op">())</span> <span class="op">{</span></span>
<span id="cb21-331"><a href="#cb21-331" aria-hidden="true" tabindex="-1"></a>                invalidate_expressions<span class="op">(</span>parsed<span class="op">.</span>dest<span class="op">);</span></span>
<span id="cb21-332"><a href="#cb21-332" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb21-333"><a href="#cb21-333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-334"><a href="#cb21-334" aria-hidden="true" tabindex="-1"></a>            <span class="co">// PASSO 2: Tratamento de instruções que modificam memória</span></span>
<span id="cb21-335"><a href="#cb21-335" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Invalidação conservadora: limpa todas as expressões</span></span>
<span id="cb21-336"><a href="#cb21-336" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>parsed<span class="op">.</span>modifies_memory<span class="op">)</span> <span class="op">{</span></span>
<span id="cb21-337"><a href="#cb21-337" aria-hidden="true" tabindex="-1"></a>                <span class="va">available_expressions_</span><span class="op">.</span>clear<span class="op">();</span></span>
<span id="cb21-338"><a href="#cb21-338" aria-hidden="true" tabindex="-1"></a>                result<span class="op">.</span>push_back<span class="op">(</span>parsed<span class="op">.</span>original_line<span class="op">);</span></span>
<span id="cb21-339"><a href="#cb21-339" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span><span class="op">;</span></span>
<span id="cb21-340"><a href="#cb21-340" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb21-341"><a href="#cb21-341" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb21-342"><a href="#cb21-342" aria-hidden="true" tabindex="-1"></a>            <span class="co">// PASSO 3: Processa instrução aritmética (aplica CSE)</span></span>
<span id="cb21-343"><a href="#cb21-343" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>parsed<span class="op">.</span>is_arithmetic<span class="op">)</span> <span class="op">{</span></span>
<span id="cb21-344"><a href="#cb21-344" aria-hidden="true" tabindex="-1"></a>                result<span class="op">.</span>push_back<span class="op">(</span>process_arithmetic<span class="op">(</span>parsed<span class="op">));</span></span>
<span id="cb21-345"><a href="#cb21-345" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span> </span>
<span id="cb21-346"><a href="#cb21-346" aria-hidden="true" tabindex="-1"></a>            <span class="co">// PASSO 4: Outras instruções (atribuições simples, controle de fluxo)</span></span>
<span id="cb21-347"><a href="#cb21-347" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb21-348"><a href="#cb21-348" aria-hidden="true" tabindex="-1"></a>                result<span class="op">.</span>push_back<span class="op">(</span>parsed<span class="op">.</span>original_line<span class="op">);</span></span>
<span id="cb21-349"><a href="#cb21-349" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb21-350"><a href="#cb21-350" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Registra atribuições simples para possível Copy Propagation</span></span>
<span id="cb21-351"><a href="#cb21-351" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(</span>parsed<span class="op">.</span>op <span class="op">==</span> <span class="st">"ASSIGN"</span> <span class="op">&amp;&amp;</span> <span class="op">!</span>parsed<span class="op">.</span>arg1<span class="op">.</span>empty<span class="op">())</span> <span class="op">{</span></span>
<span id="cb21-352"><a href="#cb21-352" aria-hidden="true" tabindex="-1"></a>                    ExpressionKey assign_key<span class="op">(</span><span class="st">"ASSIGN"</span><span class="op">,</span> parsed<span class="op">.</span>arg1<span class="op">,</span> <span class="st">""</span><span class="op">);</span></span>
<span id="cb21-353"><a href="#cb21-353" aria-hidden="true" tabindex="-1"></a>                    <span class="va">available_expressions_</span><span class="op">[</span>assign_key<span class="op">]</span> <span class="op">=</span> parsed<span class="op">.</span>dest<span class="op">;</span></span>
<span id="cb21-354"><a href="#cb21-354" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb21-355"><a href="#cb21-355" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb21-356"><a href="#cb21-356" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb21-357"><a href="#cb21-357" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb21-358"><a href="#cb21-358" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> result<span class="op">;</span></span>
<span id="cb21-359"><a href="#cb21-359" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb21-360"><a href="#cb21-360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-361"><a href="#cb21-361" aria-hidden="true" tabindex="-1"></a>    <span class="co">/**</span></span>
<span id="cb21-362"><a href="#cb21-362" aria-hidden="true" tabindex="-1"></a><span class="co">     * </span><span class="an">@brief</span><span class="co"> Retorna o número de expressões atualmente disponíveis.</span></span>
<span id="cb21-363"><a href="#cb21-363" aria-hidden="true" tabindex="-1"></a><span class="co">     * </span><span class="an">@return</span><span class="co"> size_t Quantidade de expressões no mapa.</span></span>
<span id="cb21-364"><a href="#cb21-364" aria-hidden="true" tabindex="-1"></a><span class="co">     */</span></span>
<span id="cb21-365"><a href="#cb21-365" aria-hidden="true" tabindex="-1"></a>    <span class="op">[[</span><span class="at">nodiscard</span><span class="op">]]</span> <span class="dt">size_t</span> get_available_count<span class="op">()</span> <span class="at">const</span> <span class="op">{</span></span>
<span id="cb21-366"><a href="#cb21-366" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">available_expressions_</span><span class="op">.</span>size<span class="op">();</span></span>
<span id="cb21-367"><a href="#cb21-367" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb21-368"><a href="#cb21-368" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb21-369"><a href="#cb21-369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-370"><a href="#cb21-370" aria-hidden="true" tabindex="-1"></a><span class="co">// --------------------------------------------------------------------------------</span></span>
<span id="cb21-371"><a href="#cb21-371" aria-hidden="true" tabindex="-1"></a><span class="co">// Funções de Demonstração</span></span>
<span id="cb21-372"><a href="#cb21-372" aria-hidden="true" tabindex="-1"></a><span class="co">// --------------------------------------------------------------------------------</span></span>
<span id="cb21-373"><a href="#cb21-373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-374"><a href="#cb21-374" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb21-375"><a href="#cb21-375" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@brief</span><span class="co"> Imprime código TAC formatado.</span></span>
<span id="cb21-376"><a href="#cb21-376" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb21-377"><a href="#cb21-377" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> print_code<span class="op">(</span><span class="bu">std::</span>string_view title<span class="op">,</span> <span class="bu">std::</span>span<span class="op">&lt;</span><span class="at">const</span> <span class="bu">std::</span>string<span class="op">&gt;</span> code<span class="op">)</span> <span class="op">{</span></span>
<span id="cb21-378"><a href="#cb21-378" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>println<span class="op">(</span><span class="st">"</span><span class="sc">\n{}</span><span class="st">"</span><span class="op">,</span> title<span class="op">);</span></span>
<span id="cb21-379"><a href="#cb21-379" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>println<span class="op">(</span><span class="st">"</span><span class="sc">{}</span><span class="st">"</span><span class="op">,</span> <span class="bu">std::</span>string<span class="op">(</span><span class="dv">70</span><span class="op">,</span> <span class="ch">'-'</span><span class="op">));</span></span>
<span id="cb21-380"><a href="#cb21-380" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> code<span class="op">.</span>size<span class="op">();</span> <span class="op">++</span>i<span class="op">)</span> <span class="op">{</span></span>
<span id="cb21-381"><a href="#cb21-381" aria-hidden="true" tabindex="-1"></a>        <span class="bu">std::</span>println<span class="op">(</span><span class="st">"</span><span class="sc">{:2}</span><span class="st">. </span><span class="sc">{}</span><span class="st">"</span><span class="op">,</span> i <span class="op">+</span> <span class="dv">1</span><span class="op">,</span> code<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb21-382"><a href="#cb21-382" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb21-383"><a href="#cb21-383" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb21-384"><a href="#cb21-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-385"><a href="#cb21-385" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb21-386"><a href="#cb21-386" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@brief</span><span class="co"> Demonstra a otimização Local CSE em diferentes cenários.</span></span>
<span id="cb21-387"><a href="#cb21-387" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb21-388"><a href="#cb21-388" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> demonstrate_cse<span class="op">()</span> <span class="op">{</span></span>
<span id="cb21-389"><a href="#cb21-389" aria-hidden="true" tabindex="-1"></a>    LocalCSEOptimizer optimizer<span class="op">;</span></span>
<span id="cb21-390"><a href="#cb21-390" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-391"><a href="#cb21-391" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ========================================================================</span></span>
<span id="cb21-392"><a href="#cb21-392" aria-hidden="true" tabindex="-1"></a>    <span class="co">// EXEMPLO 1: CSE Básico</span></span>
<span id="cb21-393"><a href="#cb21-393" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ========================================================================</span></span>
<span id="cb21-394"><a href="#cb21-394" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>println<span class="op">(</span><span class="st">"</span><span class="sc">\n{}</span><span class="st">"</span><span class="op">,</span> <span class="bu">std::</span>string<span class="op">(</span><span class="dv">70</span><span class="op">,</span> <span class="ch">'='</span><span class="op">));</span></span>
<span id="cb21-395"><a href="#cb21-395" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>println<span class="op">(</span><span class="st">"EXEMPLO 1: Eliminação de Subexpressões Comuns Básica"</span><span class="op">);</span></span>
<span id="cb21-396"><a href="#cb21-396" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>println<span class="op">(</span><span class="st">"</span><span class="sc">{}</span><span class="st">"</span><span class="op">,</span> <span class="bu">std::</span>string<span class="op">(</span><span class="dv">70</span><span class="op">,</span> <span class="ch">'='</span><span class="op">));</span></span>
<span id="cb21-397"><a href="#cb21-397" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-398"><a href="#cb21-398" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> InstructionList example1 <span class="op">=</span> <span class="op">{</span></span>
<span id="cb21-399"><a href="#cb21-399" aria-hidden="true" tabindex="-1"></a>        <span class="st">"t1 = a + b"</span><span class="op">,</span></span>
<span id="cb21-400"><a href="#cb21-400" aria-hidden="true" tabindex="-1"></a>        <span class="st">"t2 = c * d"</span><span class="op">,</span></span>
<span id="cb21-401"><a href="#cb21-401" aria-hidden="true" tabindex="-1"></a>        <span class="st">"t3 = e + f"</span><span class="op">,</span></span>
<span id="cb21-402"><a href="#cb21-402" aria-hidden="true" tabindex="-1"></a>        <span class="st">"t4 = a + b"</span><span class="op">,</span>      <span class="co">// Redundante com t1</span></span>
<span id="cb21-403"><a href="#cb21-403" aria-hidden="true" tabindex="-1"></a>        <span class="st">"t5 = t3 * t4"</span><span class="op">,</span></span>
<span id="cb21-404"><a href="#cb21-404" aria-hidden="true" tabindex="-1"></a>        <span class="st">"t6 = c * d"</span><span class="op">,</span>      <span class="co">// Redundante com t2</span></span>
<span id="cb21-405"><a href="#cb21-405" aria-hidden="true" tabindex="-1"></a>        <span class="st">"t7 = t6 - t1"</span></span>
<span id="cb21-406"><a href="#cb21-406" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb21-407"><a href="#cb21-407" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-408"><a href="#cb21-408" aria-hidden="true" tabindex="-1"></a>    print_code<span class="op">(</span><span class="st">"Código Original:"</span><span class="op">,</span> example1<span class="op">);</span></span>
<span id="cb21-409"><a href="#cb21-409" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> <span class="kw">auto</span> optimized1 <span class="op">=</span> optimizer<span class="op">.</span>optimize<span class="op">(</span>example1<span class="op">);</span></span>
<span id="cb21-410"><a href="#cb21-410" aria-hidden="true" tabindex="-1"></a>    print_code<span class="op">(</span><span class="st">"Código Otimizado (CSE aplicado):"</span><span class="op">,</span> optimized1<span class="op">);</span></span>
<span id="cb21-411"><a href="#cb21-411" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-412"><a href="#cb21-412" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ========================================================================</span></span>
<span id="cb21-413"><a href="#cb21-413" aria-hidden="true" tabindex="-1"></a>    <span class="co">// EXEMPLO 2: Comutatividade</span></span>
<span id="cb21-414"><a href="#cb21-414" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ========================================================================</span></span>
<span id="cb21-415"><a href="#cb21-415" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>println<span class="op">(</span><span class="st">"</span><span class="sc">\n{}</span><span class="st">"</span><span class="op">,</span> <span class="bu">std::</span>string<span class="op">(</span><span class="dv">70</span><span class="op">,</span> <span class="ch">'='</span><span class="op">));</span></span>
<span id="cb21-416"><a href="#cb21-416" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>println<span class="op">(</span><span class="st">"EXEMPLO 2: Reconhecimento de Operadores Comutativos"</span><span class="op">);</span></span>
<span id="cb21-417"><a href="#cb21-417" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>println<span class="op">(</span><span class="st">"</span><span class="sc">{}</span><span class="st">"</span><span class="op">,</span> <span class="bu">std::</span>string<span class="op">(</span><span class="dv">70</span><span class="op">,</span> <span class="ch">'='</span><span class="op">));</span></span>
<span id="cb21-418"><a href="#cb21-418" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-419"><a href="#cb21-419" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> InstructionList example2 <span class="op">=</span> <span class="op">{</span></span>
<span id="cb21-420"><a href="#cb21-420" aria-hidden="true" tabindex="-1"></a>        <span class="st">"t1 = a + b"</span><span class="op">,</span></span>
<span id="cb21-421"><a href="#cb21-421" aria-hidden="true" tabindex="-1"></a>        <span class="st">"t2 = b + a"</span><span class="op">,</span>      <span class="co">// Comutativo: equivalente a a + b</span></span>
<span id="cb21-422"><a href="#cb21-422" aria-hidden="true" tabindex="-1"></a>        <span class="st">"t3 = x * y"</span><span class="op">,</span></span>
<span id="cb21-423"><a href="#cb21-423" aria-hidden="true" tabindex="-1"></a>        <span class="st">"t4 = y * x"</span>       <span class="co">// Comutativo: equivalente a x * y</span></span>
<span id="cb21-424"><a href="#cb21-424" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb21-425"><a href="#cb21-425" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-426"><a href="#cb21-426" aria-hidden="true" tabindex="-1"></a>    print_code<span class="op">(</span><span class="st">"Código Original:"</span><span class="op">,</span> example2<span class="op">);</span></span>
<span id="cb21-427"><a href="#cb21-427" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> <span class="kw">auto</span> optimized2 <span class="op">=</span> optimizer<span class="op">.</span>optimize<span class="op">(</span>example2<span class="op">);</span></span>
<span id="cb21-428"><a href="#cb21-428" aria-hidden="true" tabindex="-1"></a>    print_code<span class="op">(</span><span class="st">"Código Otimizado (comutatividade normalizada):"</span><span class="op">,</span> optimized2<span class="op">);</span></span>
<span id="cb21-429"><a href="#cb21-429" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-430"><a href="#cb21-430" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ========================================================================</span></span>
<span id="cb21-431"><a href="#cb21-431" aria-hidden="true" tabindex="-1"></a>    <span class="co">// EXEMPLO 3: Invalidação por Redefinição</span></span>
<span id="cb21-432"><a href="#cb21-432" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ========================================================================</span></span>
<span id="cb21-433"><a href="#cb21-433" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>println<span class="op">(</span><span class="st">"</span><span class="sc">\n{}</span><span class="st">"</span><span class="op">,</span> <span class="bu">std::</span>string<span class="op">(</span><span class="dv">70</span><span class="op">,</span> <span class="ch">'='</span><span class="op">));</span></span>
<span id="cb21-434"><a href="#cb21-434" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>println<span class="op">(</span><span class="st">"EXEMPLO 3: Invalidação de Expressões por Redefinição"</span><span class="op">);</span></span>
<span id="cb21-435"><a href="#cb21-435" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>println<span class="op">(</span><span class="st">"</span><span class="sc">{}</span><span class="st">"</span><span class="op">,</span> <span class="bu">std::</span>string<span class="op">(</span><span class="dv">70</span><span class="op">,</span> <span class="ch">'='</span><span class="op">));</span></span>
<span id="cb21-436"><a href="#cb21-436" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-437"><a href="#cb21-437" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> InstructionList example3 <span class="op">=</span> <span class="op">{</span></span>
<span id="cb21-438"><a href="#cb21-438" aria-hidden="true" tabindex="-1"></a>        <span class="st">"t1 = a + b"</span><span class="op">,</span></span>
<span id="cb21-439"><a href="#cb21-439" aria-hidden="true" tabindex="-1"></a>        <span class="st">"t2 = c + d"</span><span class="op">,</span></span>
<span id="cb21-440"><a href="#cb21-440" aria-hidden="true" tabindex="-1"></a>        <span class="st">"a = 10"</span><span class="op">,</span>          <span class="co">// Redefine 'a': invalida expressões com 'a'</span></span>
<span id="cb21-441"><a href="#cb21-441" aria-hidden="true" tabindex="-1"></a>        <span class="st">"t3 = a + b"</span><span class="op">,</span>      <span class="co">// NÃO pode reutilizar t1 (a foi modificado)</span></span>
<span id="cb21-442"><a href="#cb21-442" aria-hidden="true" tabindex="-1"></a>        <span class="st">"t4 = c + d"</span>       <span class="co">// PODE reutilizar t2 (c e d não mudaram)</span></span>
<span id="cb21-443"><a href="#cb21-443" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb21-444"><a href="#cb21-444" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-445"><a href="#cb21-445" aria-hidden="true" tabindex="-1"></a>    print_code<span class="op">(</span><span class="st">"Código Original:"</span><span class="op">,</span> example3<span class="op">);</span></span>
<span id="cb21-446"><a href="#cb21-446" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> <span class="kw">auto</span> optimized3 <span class="op">=</span> optimizer<span class="op">.</span>optimize<span class="op">(</span>example3<span class="op">);</span></span>
<span id="cb21-447"><a href="#cb21-447" aria-hidden="true" tabindex="-1"></a>    print_code<span class="op">(</span><span class="st">"Código Otimizado (invalidação correta):"</span><span class="op">,</span> optimized3<span class="op">);</span></span>
<span id="cb21-448"><a href="#cb21-448" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-449"><a href="#cb21-449" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ========================================================================</span></span>
<span id="cb21-450"><a href="#cb21-450" aria-hidden="true" tabindex="-1"></a>    <span class="co">// EXEMPLO 4: Constantes Numéricas</span></span>
<span id="cb21-451"><a href="#cb21-451" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ========================================================================</span></span>
<span id="cb21-452"><a href="#cb21-452" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>println<span class="op">(</span><span class="st">"</span><span class="sc">\n{}</span><span class="st">"</span><span class="op">,</span> <span class="bu">std::</span>string<span class="op">(</span><span class="dv">70</span><span class="op">,</span> <span class="ch">'='</span><span class="op">));</span></span>
<span id="cb21-453"><a href="#cb21-453" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>println<span class="op">(</span><span class="st">"EXEMPLO 4: CSE com Constantes Numéricas"</span><span class="op">);</span></span>
<span id="cb21-454"><a href="#cb21-454" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>println<span class="op">(</span><span class="st">"</span><span class="sc">{}</span><span class="st">"</span><span class="op">,</span> <span class="bu">std::</span>string<span class="op">(</span><span class="dv">70</span><span class="op">,</span> <span class="ch">'='</span><span class="op">));</span></span>
<span id="cb21-455"><a href="#cb21-455" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-456"><a href="#cb21-456" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> InstructionList example4 <span class="op">=</span> <span class="op">{</span></span>
<span id="cb21-457"><a href="#cb21-457" aria-hidden="true" tabindex="-1"></a>        <span class="st">"t1 = x + 5"</span><span class="op">,</span></span>
<span id="cb21-458"><a href="#cb21-458" aria-hidden="true" tabindex="-1"></a>        <span class="st">"t2 = y * 10"</span><span class="op">,</span></span>
<span id="cb21-459"><a href="#cb21-459" aria-hidden="true" tabindex="-1"></a>        <span class="st">"t3 = x + 5"</span><span class="op">,</span>      <span class="co">// Redundante com t1</span></span>
<span id="cb21-460"><a href="#cb21-460" aria-hidden="true" tabindex="-1"></a>        <span class="st">"x = 100"</span><span class="op">,</span>         <span class="co">// Redefine x</span></span>
<span id="cb21-461"><a href="#cb21-461" aria-hidden="true" tabindex="-1"></a>        <span class="st">"t4 = x + 5"</span><span class="op">,</span>      <span class="co">// NÃO pode reutilizar t1 (x mudou)</span></span>
<span id="cb21-462"><a href="#cb21-462" aria-hidden="true" tabindex="-1"></a>        <span class="st">"t5 = y * 10"</span>      <span class="co">// PODE reutilizar t2 (y não mudou)</span></span>
<span id="cb21-463"><a href="#cb21-463" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb21-464"><a href="#cb21-464" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-465"><a href="#cb21-465" aria-hidden="true" tabindex="-1"></a>    print_code<span class="op">(</span><span class="st">"Código Original:"</span><span class="op">,</span> example4<span class="op">);</span></span>
<span id="cb21-466"><a href="#cb21-466" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> <span class="kw">auto</span> optimized4 <span class="op">=</span> optimizer<span class="op">.</span>optimize<span class="op">(</span>example4<span class="op">);</span></span>
<span id="cb21-467"><a href="#cb21-467" aria-hidden="true" tabindex="-1"></a>    print_code<span class="op">(</span><span class="st">"Código Otimizado (constantes preservadas):"</span><span class="op">,</span> optimized4<span class="op">);</span></span>
<span id="cb21-468"><a href="#cb21-468" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb21-469"><a href="#cb21-469" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-470"><a href="#cb21-470" aria-hidden="true" tabindex="-1"></a><span class="co">// --------------------------------------------------------------------------------</span></span>
<span id="cb21-471"><a href="#cb21-471" aria-hidden="true" tabindex="-1"></a><span class="co">// Main</span></span>
<span id="cb21-472"><a href="#cb21-472" aria-hidden="true" tabindex="-1"></a><span class="co">// --------------------------------------------------------------------------------</span></span>
<span id="cb21-473"><a href="#cb21-473" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-474"><a href="#cb21-474" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb21-475"><a href="#cb21-475" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>println<span class="op">(</span><span class="st">"</span><span class="sc">{}</span><span class="st">"</span><span class="op">,</span> <span class="bu">std::</span>string<span class="op">(</span><span class="dv">70</span><span class="op">,</span> <span class="ch">'='</span><span class="op">));</span></span>
<span id="cb21-476"><a href="#cb21-476" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>println<span class="op">(</span><span class="st">"Local CSE (Common Subexpression Elimination) - Demonstração Didática"</span><span class="op">);</span></span>
<span id="cb21-477"><a href="#cb21-477" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>println<span class="op">(</span><span class="st">"Técnica: Value Numbering"</span><span class="op">);</span></span>
<span id="cb21-478"><a href="#cb21-478" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>println<span class="op">(</span><span class="st">"</span><span class="sc">{}</span><span class="st">"</span><span class="op">,</span> <span class="bu">std::</span>string<span class="op">(</span><span class="dv">70</span><span class="op">,</span> <span class="ch">'='</span><span class="op">));</span></span>
<span id="cb21-479"><a href="#cb21-479" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-480"><a href="#cb21-480" aria-hidden="true" tabindex="-1"></a>    demonstrate_cse<span class="op">();</span></span>
<span id="cb21-481"><a href="#cb21-481" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-482"><a href="#cb21-482" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>println<span class="op">(</span><span class="st">"</span><span class="sc">\n{}</span><span class="st">"</span><span class="op">,</span> <span class="bu">std::</span>string<span class="op">(</span><span class="dv">70</span><span class="op">,</span> <span class="ch">'='</span><span class="op">));</span></span>
<span id="cb21-483"><a href="#cb21-483" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>println<span class="op">(</span><span class="st">"Análise de Benefícios:"</span><span class="op">);</span></span>
<span id="cb21-484"><a href="#cb21-484" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>println<span class="op">(</span><span class="st">"</span><span class="sc">{}</span><span class="st">"</span><span class="op">,</span> <span class="bu">std::</span>string<span class="op">(</span><span class="dv">70</span><span class="op">,</span> <span class="ch">'-'</span><span class="op">));</span></span>
<span id="cb21-485"><a href="#cb21-485" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>println<span class="op">(</span><span class="st">"- Reduz número de operações aritméticas redundantes"</span><span class="op">);</span></span>
<span id="cb21-486"><a href="#cb21-486" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>println<span class="op">(</span><span class="st">"- Diminui uso de registradores temporários"</span><span class="op">);</span></span>
<span id="cb21-487"><a href="#cb21-487" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>println<span class="op">(</span><span class="st">"- Preserva semântica do programa original"</span><span class="op">);</span></span>
<span id="cb21-488"><a href="#cb21-488" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>println<span class="op">(</span><span class="st">"- Facilita otimizações subsequentes (Copy Propagation, Dead Code Elimination)"</span><span class="op">);</span></span>
<span id="cb21-489"><a href="#cb21-489" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>println<span class="op">(</span><span class="st">"</span><span class="sc">{}</span><span class="st">"</span><span class="op">,</span> <span class="bu">std::</span>string<span class="op">(</span><span class="dv">70</span><span class="op">,</span> <span class="ch">'='</span><span class="op">));</span></span>
<span id="cb21-490"><a href="#cb21-490" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-491"><a href="#cb21-491" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb21-492"><a href="#cb21-492" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="simplificação-algébrica-algebraic-simplification" class="level2" data-number="17.6">
<h2 data-number="17.6" class="anchored" data-anchor-id="simplificação-algébrica-algebraic-simplification"><span class="header-section-number">17.6</span> Simplificação Algébrica (<em>Algebraic Simplification</em>)</h2>
<p>Aplica identidades matemáticas para simplificar expressões, eliminando operações redundantes.</p>
<section id="identidades-implementadas" class="level3" data-number="17.6.1">
<h3 data-number="17.6.1" class="anchored" data-anchor-id="identidades-implementadas"><span class="header-section-number">17.6.1</span> Identidades Implementadas</h3>
<table class="table">
<thead>
<tr class="header">
<th>Padrão</th>
<th>Simplificação</th>
<th>Justificativa</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>x + 0</code></td>
<td><code>x</code></td>
<td>Elemento neutro da adição</td>
</tr>
<tr class="even">
<td><code>x - 0</code></td>
<td><code>x</code></td>
<td>Subtração de zero</td>
</tr>
<tr class="odd">
<td><code>x * 1</code></td>
<td><code>x</code></td>
<td>Elemento neutro da multiplicação</td>
</tr>
<tr class="even">
<td><code>x / 1</code></td>
<td><code>x</code></td>
<td>Divisão por um</td>
</tr>
<tr class="odd">
<td><code>x * 0</code></td>
<td><code>0</code></td>
<td>Propriedade do zero</td>
</tr>
<tr class="even">
<td><code>x - x</code></td>
<td><code>0</code></td>
<td>Diferença nula</td>
</tr>
<tr class="odd">
<td><code>x / x</code></td>
<td><code>1</code></td>
<td>Quociente unitário (<span class="math inline">\(x \neq 0\)</span>)</td>
</tr>
</tbody>
</table>
</section>
<section id="algoritmo-1" class="level3" data-number="17.6.2">
<h3 data-number="17.6.2" class="anchored" data-anchor-id="algoritmo-1"><span class="header-section-number">17.6.2</span> Algoritmo</h3>
<div class="sourceCode" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> algebraic_simplification(instructions):</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Aplica identidades algébricas para simplificar expressões.</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="co">        Lista otimizada de instruções</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> []</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> instr <span class="kw">in</span> instructions:</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>        simplified <span class="op">=</span> apply_identities(instr)</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>        result.append(simplified)</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> apply_identities(instr):</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Aplica identidades algébricas a uma instrução."""</span></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> instr.op <span class="kw">not</span> <span class="kw">in</span> [<span class="st">'+'</span>, <span class="st">'-'</span>, <span class="st">'*'</span>, <span class="st">'/'</span>]:</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> instr</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>    arg1, arg2 <span class="op">=</span> instr.arg1, instr.arg2</span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># x + 0 = x ou 0 + x = x</span></span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> instr.op <span class="op">==</span> <span class="st">'+'</span>:</span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> arg2 <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> Instruction(<span class="st">'ASSIGN'</span>, instr.dest, arg1)</span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> arg1 <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> Instruction(<span class="st">'ASSIGN'</span>, instr.dest, arg2)</span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># x - 0 = x</span></span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> instr.op <span class="op">==</span> <span class="st">'-'</span>:</span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> arg2 <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> Instruction(<span class="st">'ASSIGN'</span>, instr.dest, arg1)</span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a>        <span class="co"># x - x = 0</span></span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> arg1 <span class="op">==</span> arg2:</span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> Instruction(<span class="st">'ASSIGN'</span>, instr.dest, <span class="dv">0</span>)</span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># x * 1 = x ou 1 * x = x</span></span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> instr.op <span class="op">==</span> <span class="st">'*'</span>:</span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> arg2 <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> Instruction(<span class="st">'ASSIGN'</span>, instr.dest, arg1)</span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> arg1 <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> Instruction(<span class="st">'ASSIGN'</span>, instr.dest, arg2)</span>
<span id="cb22-44"><a href="#cb22-44" aria-hidden="true" tabindex="-1"></a>        <span class="co"># x * 0 = 0 ou 0 * x = 0</span></span>
<span id="cb22-45"><a href="#cb22-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> arg2 <span class="op">==</span> <span class="dv">0</span> <span class="kw">or</span> arg1 <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb22-46"><a href="#cb22-46" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> Instruction(<span class="st">'ASSIGN'</span>, instr.dest, <span class="dv">0</span>)</span>
<span id="cb22-47"><a href="#cb22-47" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-48"><a href="#cb22-48" aria-hidden="true" tabindex="-1"></a>    <span class="co"># x / 1 = x</span></span>
<span id="cb22-49"><a href="#cb22-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> instr.op <span class="op">==</span> <span class="st">'/'</span>:</span>
<span id="cb22-50"><a href="#cb22-50" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> arg2 <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb22-51"><a href="#cb22-51" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> Instruction(<span class="st">'ASSIGN'</span>, instr.dest, arg1)</span>
<span id="cb22-52"><a href="#cb22-52" aria-hidden="true" tabindex="-1"></a>        <span class="co"># x / x = 1 (assumindo x != 0)</span></span>
<span id="cb22-53"><a href="#cb22-53" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> arg1 <span class="op">==</span> arg2 <span class="kw">and</span> arg1 <span class="op">!=</span> <span class="dv">0</span>: <span class="co"># Adiciona verificação simples</span></span>
<span id="cb22-54"><a href="#cb22-54" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> Instruction(<span class="st">'ASSIGN'</span>, instr.dest, <span class="dv">1</span>)</span>
<span id="cb22-55"><a href="#cb22-55" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-56"><a href="#cb22-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> instr</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="exemplo-com-múltiplas-identidades" class="level3" data-number="17.6.3">
<h3 data-number="17.6.3" class="anchored" data-anchor-id="exemplo-com-múltiplas-identidades"><span class="header-section-number">17.6.3</span> Exemplo com Múltiplas Identidades</h3>
<p><strong>Entrada</strong>:</p>
<pre class="shell"><code>t1 = x * 1
t2 = y + 0
t3 = z - 0
t4 = t1 + t2</code></pre>
<p><strong>Simplificação Passo a Passo</strong>:</p>
<ol type="1">
<li><code>t1 = x * 1</code> <span class="math inline">\(\rightarrow\)</span> <code>t1 = x</code> (identidade multiplicativa)</li>
<li><code>t2 = y + 0</code> <span class="math inline">\(\rightarrow\)</span> <code>t2 = y</code> (identidade aditiva)</li>
<li><code>t3 = z - 0</code> <span class="math inline">\(\rightarrow\)</span> <code>t3 = z</code> (subtração de zero)</li>
<li><code>t4 = t1 + t2</code> (Esta etapa requer copy propagation para se tornar <code>t4 = x + y</code>)</li>
</ol>
<p><strong>Saída (Apenas Simplificação Algébrica)</strong>:</p>
<pre class="shell"><code>t1 = x
t2 = y
t3 = z
t4 = t1 + t2</code></pre>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Cuidado com Overflow e Precisão</strong></p>
<p>Algumas simplificações podem alterar o comportamento em casos extremos:</p>
<ul>
<li><code>x - x</code> pode não ser zero se <code>x</code> é NaN em ponto flutuante;</li>
<li><code>x / x</code> é indefinido quando <code>x = 0</code>;</li>
<li>Operações com infinito requerem tratamento especial.</li>
</ul>
<p>Compiladores devem considerar flags como <code>-ffast-math</code> que permitem otimizações algebricamente corretas, mas numericamente potencialmente imprecisas.</p>
</div>
</div>
</section>
</section>
<section id="strength-reduction" class="level2" data-number="17.7">
<h2 data-number="17.7" class="anchored" data-anchor-id="strength-reduction"><span class="header-section-number">17.7</span> Strength Reduction</h2>
<p>Substitui operações custosas por equivalentes mais eficientes. O nome vem da ideia de reduzir a “força” (complexidade/custo) da operação.</p>
<section id="hierarquia-de-custos" class="level3" data-number="17.7.1">
<h3 data-number="17.7.1" class="anchored" data-anchor-id="hierarquia-de-custos"><span class="header-section-number">17.7.1</span> Hierarquia de Custos</h3>
<p>Em arquiteturas típicas, as operações têm custos relativos:</p>
<table class="table">
<thead>
<tr class="header">
<th>Operação</th>
<th>Custo Relativo</th>
<th>Ciclos (típico)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Shift</td>
<td>1x</td>
<td>1</td>
</tr>
<tr class="even">
<td>Adição</td>
<td>1x</td>
<td>1</td>
</tr>
<tr class="odd">
<td>Multiplicação</td>
<td>3-5x</td>
<td>3-5</td>
</tr>
<tr class="even">
<td>Divisão</td>
<td>10-40x</td>
<td>10-40</td>
</tr>
<tr class="odd">
<td>Exponenciação</td>
<td>100+x</td>
<td>100+</td>
</tr>
</tbody>
</table>
</section>
<section id="algoritmo-2" class="level3" data-number="17.7.2">
<h3 data-number="17.7.2" class="anchored" data-anchor-id="algoritmo-2"><span class="header-section-number">17.7.2</span> Algoritmo</h3>
<div class="sourceCode" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> strength_reduction(instructions):</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Substitui operações custosas por equivalentes mais eficientes.</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Transformações principais:</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="co">    - x * 2^n → x &lt;&lt; n</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a><span class="co">    - x / 2^n → x &gt;&gt; n  (para inteiros positivos)</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a><span class="co">    - x ** 2 → x * x</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> []</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> instr <span class="kw">in</span> instructions:</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>        reduced <span class="op">=</span> reduce_strength(instr)</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>        result.append(reduced)</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> is_power_of_2(n):</span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Verifica se n é potência de 2."""</span></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">isinstance</span>(n, <span class="bu">int</span>) <span class="kw">and</span> n <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">and</span> (n <span class="op">&amp;</span> (n <span class="op">-</span> <span class="dv">1</span>)) <span class="op">==</span> <span class="dv">0</span></span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> log2(n):</span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Calcula log₂(n) para potências de 2."""</span></span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># n.bit_length() - 1</span></span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ex: n=2 (10b), bit_length=2, log2=1</span></span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ex: n=4 (100b), bit_length=3, log2=2</span></span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ex: n=8 (1000b), bit_length=4, log2=3</span></span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> is_power_of_2(n):</span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span> <span class="co"># Ou levantar erro</span></span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> n.bit_length() <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> reduce_strength(instr):</span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Aplica strength reduction a uma instrução."""</span></span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> instr.op <span class="kw">not</span> <span class="kw">in</span> [<span class="st">'*'</span>, <span class="st">'/'</span>, <span class="st">'**'</span>]:</span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> instr</span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-37"><a href="#cb25-37" aria-hidden="true" tabindex="-1"></a>    arg1, arg2 <span class="op">=</span> instr.arg1, instr.arg2</span>
<span id="cb25-38"><a href="#cb25-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-39"><a href="#cb25-39" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Multiplicação por potência de 2</span></span>
<span id="cb25-40"><a href="#cb25-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> instr.op <span class="op">==</span> <span class="st">'*'</span> <span class="kw">and</span> is_power_of_2(arg2):</span>
<span id="cb25-41"><a href="#cb25-41" aria-hidden="true" tabindex="-1"></a>        shift <span class="op">=</span> log2(arg2)</span>
<span id="cb25-42"><a href="#cb25-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> Instruction(<span class="st">'&lt;&lt;'</span>, instr.dest, arg1, shift)</span>
<span id="cb25-43"><a href="#cb25-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> instr.op <span class="op">==</span> <span class="st">'*'</span> <span class="kw">and</span> is_power_of_2(arg1):</span>
<span id="cb25-44"><a href="#cb25-44" aria-hidden="true" tabindex="-1"></a>        shift <span class="op">=</span> log2(arg1)</span>
<span id="cb25-45"><a href="#cb25-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> Instruction(<span class="st">'&lt;&lt;'</span>, instr.dest, arg2, shift)</span>
<span id="cb25-46"><a href="#cb25-46" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-47"><a href="#cb25-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Divisão por potência de 2 (inteiros sem sinal)</span></span>
<span id="cb25-48"><a href="#cb25-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> instr.op <span class="op">==</span> <span class="st">'/'</span> <span class="kw">and</span> is_power_of_2(arg2):</span>
<span id="cb25-49"><a href="#cb25-49" aria-hidden="true" tabindex="-1"></a>        shift <span class="op">=</span> log2(arg2)</span>
<span id="cb25-50"><a href="#cb25-50" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> Instruction(<span class="st">'&gt;&gt;'</span>, instr.dest, arg1, shift)</span>
<span id="cb25-51"><a href="#cb25-51" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-52"><a href="#cb25-52" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Exponenciação por 2</span></span>
<span id="cb25-53"><a href="#cb25-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> instr.op <span class="op">==</span> <span class="st">'**'</span> <span class="kw">and</span> arg2 <span class="op">==</span> <span class="dv">2</span>:</span>
<span id="cb25-54"><a href="#cb25-54" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> Instruction(<span class="st">'*'</span>, instr.dest, arg1, arg1)</span>
<span id="cb25-55"><a href="#cb25-55" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-56"><a href="#cb25-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> instr</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="análise-de-economia" class="level3" data-number="17.7.3">
<h3 data-number="17.7.3" class="anchored" data-anchor-id="análise-de-economia"><span class="header-section-number">17.7.3</span> Análise de Economia</h3>
<p><strong>Exemplo de ganho de desempenho</strong>:</p>
<pre class="shell"><code># Original
t1 = x * 8      # ~4 ciclos

# Otimizado  
t1 = x &lt;&lt; 3     # ~1 ciclo</code></pre>
<p>Economia: 3 ciclos por operação (~75% redução)</p>
</section>
<section id="strength-reduction-em-loops" class="level3" data-number="17.7.4">
<h3 data-number="17.7.4" class="anchored" data-anchor-id="strength-reduction-em-loops"><span class="header-section-number">17.7.4</span> Strength Reduction em Loops</h3>
<p>A aplicação mais impactante de strength reduction ocorre em loops:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> loop_strength_reduction(loop):</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Reduz força de multiplicações em loops através de </span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="co">    variáveis de indução. (Conceitual)</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Transforma: i * c (em cada iteração)</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a><span class="co">    Em: variável acumuladora incrementada por c</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>    induction_vars <span class="op">=</span> find_induction_variables(loop)</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> var <span class="kw">in</span> induction_vars:</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> has_multiplication_by_constant(var, loop):</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>            strength_reduce_induction(var, loop)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Exemplo</strong>:</p>
<pre class="shell"><code># Original
for i = 0 to n:
    a[i * 4] = 0</code></pre>
<p><strong>Otimizado</strong>:</p>
<pre class="shell"><code># Substitui multiplicação por incremento
j = 0
for i = 0 to n:
    a[j] = 0
    j = j + 4</code></pre>
</section>
<section id="tabelas-de-strength-reduction-referência-completa" class="level3" data-number="17.7.5">
<h3 data-number="17.7.5" class="anchored" data-anchor-id="tabelas-de-strength-reduction-referência-completa"><span class="header-section-number">17.7.5</span> Tabelas de Strength Reduction: Referência Completa</h3>
<section id="multiplicação-por-constantes-não-potências-de-2" class="level4" data-number="17.7.5.1">
<h4 data-number="17.7.5.1" class="anchored" data-anchor-id="multiplicação-por-constantes-não-potências-de-2"><span class="header-section-number">17.7.5.1</span> Multiplicação por Constantes (Não-Potências de 2)</h4>
<p>A técnica decompõe multiplicações em sequências de shifts e adições/subtrações.</p>
<section id="tabela-de-conversões-para-multiplicação" class="level5" data-number="17.7.5.1.1">
<h5 data-number="17.7.5.1.1" class="anchored" data-anchor-id="tabela-de-conversões-para-multiplicação"><span class="header-section-number">17.7.5.1.1</span> Tabela de Conversões para Multiplicação</h5>
<table class="table">
<colgroup>
<col style="width: 23%">
<col style="width: 33%">
<col style="width: 26%">
<col style="width: 16%">
</colgroup>
<thead>
<tr class="header">
<th>Original</th>
<th>Transformação</th>
<th>Operações</th>
<th>Ganho</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>x * 3</td>
<td>(x &lt;&lt; 1) + x</td>
<td>1 shift + 1 add</td>
<td>~60%</td>
</tr>
<tr class="even">
<td>x * 5</td>
<td>(x &lt;&lt; 2) + x</td>
<td>1 shift + 1 add</td>
<td>~60%</td>
</tr>
<tr class="odd">
<td>x * 6</td>
<td>(x &lt;&lt; 1) + (x &lt;&lt; 2)</td>
<td>2 shifts + 1 add</td>
<td>~50%</td>
</tr>
<tr class="even">
<td>x * 7</td>
<td>(x &lt;&lt; 3) - x</td>
<td>1 shift + 1 sub</td>
<td>~60%</td>
</tr>
<tr class="odd">
<td>x * 9</td>
<td>(x &lt;&lt; 3) + x</td>
<td>1 shift + 1 add</td>
<td>~60%</td>
</tr>
<tr class="even">
<td>x * 10</td>
<td>(x &lt;&lt; 3) + (x &lt;&lt; 1)</td>
<td>2 shifts + 1 add</td>
<td>~50%</td>
</tr>
<tr class="odd">
<td>x * 11</td>
<td>(x &lt;&lt; 3) + (x &lt;&lt; 1) + x</td>
<td>2 shifts + 2 adds</td>
<td>~40%</td>
</tr>
<tr class="even">
<td>x * 12</td>
<td>(x &lt;&lt; 3) + (x &lt;&lt; 2)</td>
<td>2 shifts + 1 add</td>
<td>~50%</td>
</tr>
<tr class="odd">
<td>x * 15</td>
<td>(x &lt;&lt; 4) - x</td>
<td>1 shift + 1 sub</td>
<td>~60%</td>
</tr>
<tr class="even">
<td>x * 17</td>
<td>(x &lt;&lt; 4) + x</td>
<td>1 shift + 1 add</td>
<td>~60%</td>
</tr>
<tr class="odd">
<td>x * 18</td>
<td>(x &lt;&lt; 4) + (x &lt;&lt; 1)</td>
<td>2 shifts + 1 add</td>
<td>~50%</td>
</tr>
<tr class="even">
<td>x * 20</td>
<td>(x &lt;&lt; 4) + (x &lt;&lt; 2)</td>
<td>2 shifts + 1 add</td>
<td>~50%</td>
</tr>
<tr class="odd">
<td>x * 21</td>
<td>(x &lt;&lt; 4) + (x &lt;&lt; 2) + x</td>
<td>2 shifts + 2 adds</td>
<td>~40%</td>
</tr>
<tr class="even">
<td>x * 24</td>
<td>(x &lt;&lt; 4) + (x &lt;&lt; 3)</td>
<td>2 shifts + 1 add</td>
<td>~50%</td>
</tr>
<tr class="odd">
<td>x * 25</td>
<td>(x &lt;&lt; 4) + (x &lt;&lt; 3) + x</td>
<td>2 shifts + 2 adds</td>
<td>~40%</td>
</tr>
<tr class="even">
<td>x * 27</td>
<td>(x &lt;&lt; 4) + (x &lt;&lt; 3) + (x &lt;&lt; 1) + x</td>
<td>3 shifts + 3 adds</td>
<td>~20%</td>
</tr>
<tr class="odd">
<td>x * 31</td>
<td>(x &lt;&lt; 5) - x</td>
<td>1 shift + 1 sub</td>
<td>~60%</td>
</tr>
<tr class="even">
<td>x * 32</td>
<td>x &lt;&lt; 5</td>
<td>1 shift</td>
<td>~75%</td>
</tr>
<tr class="odd">
<td>x * 33</td>
<td>(x &lt;&lt; 5) + x</td>
<td>1 shift + 1 add</td>
<td>~60%</td>
</tr>
<tr class="even">
<td>x * 63</td>
<td>(x &lt;&lt; 6) - x</td>
<td>1 shift + 1 sub</td>
<td>~60%</td>
</tr>
<tr class="odd">
<td>x * 64</td>
<td>x &lt;&lt; 6</td>
<td>1 shift</td>
<td>~75%</td>
</tr>
<tr class="even">
<td>x * 65</td>
<td>(x &lt;&lt; 6) + x</td>
<td>1 shift + 1 add</td>
<td>~60%</td>
</tr>
<tr class="odd">
<td>x * 100</td>
<td>(x &lt;&lt; 6) + (x &lt;&lt; 5) + (x &lt;&lt; 2)</td>
<td>3 shifts + 2 adds</td>
<td>~40%</td>
</tr>
<tr class="even">
<td>x * 127</td>
<td>(x &lt;&lt; 7) - x</td>
<td>1 shift + 1 sub</td>
<td>~60%</td>
</tr>
<tr class="odd">
<td>x * 255</td>
<td>(x &lt;&lt; 8) - x</td>
<td>1 shift + 1 sub</td>
<td>~60%</td>
</tr>
</tbody>
</table>
</section>
<section id="algoritmo-para-gerar-sequência-ótima" class="level5" data-number="17.7.5.1.2">
<h5 data-number="17.7.5.1.2" class="anchored" data-anchor-id="algoritmo-para-gerar-sequência-ótima"><span class="header-section-number">17.7.5.1.2</span> Algoritmo para Gerar Sequência Ótima</h5>
<div class="sourceCode" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> multiply_by_constant(n):</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Gera sequência ótima de shifts e adds para multiplicar por n.</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Usa algoritmo de adição-subtração de cadeia (addition chain).</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> n <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">"0"</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> n <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">"x"</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Verificar se é potência de 2</span></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> n <span class="op">&amp;</span> (n <span class="op">-</span> <span class="dv">1</span>) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>        shift <span class="op">=</span> n.bit_length() <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="ss">f"x &lt;&lt; </span><span class="sc">{</span>shift<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Verificar padrão 2^k - 1</span></span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (n <span class="op">+</span> <span class="dv">1</span>) <span class="op">&amp;</span> n <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>        shift <span class="op">=</span> (n <span class="op">+</span> <span class="dv">1</span>).bit_length() <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="ss">f"(x &lt;&lt; </span><span class="sc">{</span>shift<span class="sc">}</span><span class="ss">) - x"</span></span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Verificar padrão 2^k + 1</span></span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (n <span class="op">-</span> <span class="dv">1</span>) <span class="op">&amp;</span> (n <span class="op">-</span> <span class="dv">2</span>) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a>        shift <span class="op">=</span> (n <span class="op">-</span> <span class="dv">1</span>).bit_length() <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="ss">f"(x &lt;&lt; </span><span class="sc">{</span>shift<span class="sc">}</span><span class="ss">) + x"</span></span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Decomposição em soma de potências de 2</span></span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a>    operations <span class="op">=</span> []</span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a>    temp <span class="op">=</span> n</span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a>    shift <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-31"><a href="#cb30-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> temp <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb30-32"><a href="#cb30-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> temp <span class="op">&amp;</span> <span class="dv">1</span>:</span>
<span id="cb30-33"><a href="#cb30-33" aria-hidden="true" tabindex="-1"></a>            operations.append(<span class="ss">f"(x &lt;&lt; </span><span class="sc">{</span>shift<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb30-34"><a href="#cb30-34" aria-hidden="true" tabindex="-1"></a>        temp <span class="op">&gt;&gt;=</span> <span class="dv">1</span></span>
<span id="cb30-35"><a href="#cb30-35" aria-hidden="true" tabindex="-1"></a>        shift <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb30-36"><a href="#cb30-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-37"><a href="#cb30-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">" + "</span>.join(operations)</span>
<span id="cb30-38"><a href="#cb30-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-39"><a href="#cb30-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Exemplos</span></span>
<span id="cb30-40"><a href="#cb30-40" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"x * 7  = </span><span class="sc">{</span>multiply_by_constant(<span class="dv">7</span>)<span class="sc">}</span><span class="ss">"</span>)   <span class="co"># (x &lt;&lt; 3) - x</span></span>
<span id="cb30-41"><a href="#cb30-41" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"x * 9  = </span><span class="sc">{</span>multiply_by_constant(<span class="dv">9</span>)<span class="sc">}</span><span class="ss">"</span>)   <span class="co"># (x &lt;&lt; 3) + x</span></span>
<span id="cb30-42"><a href="#cb30-42" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"x * 15 = </span><span class="sc">{</span>multiply_by_constant(<span class="dv">15</span>)<span class="sc">}</span><span class="ss">"</span>)  <span class="co"># (x &lt;&lt; 4) - x</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="divisão-por-constantes-magic-numbers" class="level4" data-number="17.7.5.2">
<h4 data-number="17.7.5.2" class="anchored" data-anchor-id="divisão-por-constantes-magic-numbers"><span class="header-section-number">17.7.5.2</span> Divisão por Constantes (Magic Numbers)</h4>
<p>Divisão inteira pode ser substituída por multiplicação + shift usando “números mágicos”.</p>
<section id="fórmula-geral" class="level5" data-number="17.7.5.2.1">
<h5 data-number="17.7.5.2.1" class="anchored" data-anchor-id="fórmula-geral"><span class="header-section-number">17.7.5.2.1</span> Fórmula Geral</h5>
<p>Para divisão inteira <code>x / d</code>, usar:</p>
<pre><code>resultado = (x * M) &gt;&gt; s</code></pre>
<p>Onde <code>M</code> é o “número mágico” e <code>s</code> é o shift.</p>
</section>
<section id="tabela-de-números-mágicos-32-bit" class="level5" data-number="17.7.5.2.2">
<h5 data-number="17.7.5.2.2" class="anchored" data-anchor-id="tabela-de-números-mágicos-32-bit"><span class="header-section-number">17.7.5.2.2</span> Tabela de Números Mágicos (32-bit)</h5>
<table class="table">
<thead>
<tr class="header">
<th>Divisor</th>
<th>M (hex)</th>
<th>Shift</th>
<th>Comentário</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>3</td>
<td>0xAAAAAAAB</td>
<td>33</td>
<td>(x * M) &gt;&gt; 33</td>
</tr>
<tr class="even">
<td>5</td>
<td>0xCCCCCCCD</td>
<td>34</td>
<td>(x * M) &gt;&gt; 34</td>
</tr>
<tr class="odd">
<td>6</td>
<td>0xAAAAAAAB</td>
<td>34</td>
<td>(x * M) &gt;&gt; 34</td>
</tr>
<tr class="even">
<td>7</td>
<td>0x92492493</td>
<td>34</td>
<td>(x * M) &gt;&gt; 34</td>
</tr>
<tr class="odd">
<td>9</td>
<td>0x38E38E39</td>
<td>33</td>
<td>(x * M) &gt;&gt; 33</td>
</tr>
<tr class="even">
<td>10</td>
<td>0xCCCCCCCD</td>
<td>35</td>
<td>(x * M) &gt;&gt; 35</td>
</tr>
<tr class="odd">
<td>11</td>
<td>0xBA2E8BA3</td>
<td>35</td>
<td>(x * M) &gt;&gt; 35</td>
</tr>
<tr class="even">
<td>12</td>
<td>0xAAAAAAAB</td>
<td>35</td>
<td>(x * M) &gt;&gt; 35</td>
</tr>
<tr class="odd">
<td>13</td>
<td>0x4EC4EC4F</td>
<td>34</td>
<td>(x * M) &gt;&gt; 34</td>
</tr>
<tr class="even">
<td>25</td>
<td>0x51EB851F</td>
<td>37</td>
<td>(x * M) &gt;&gt; 37</td>
</tr>
<tr class="odd">
<td>100</td>
<td>0x51EB851F</td>
<td>37</td>
<td>(x * M) &gt;&gt; 37</td>
</tr>
<tr class="even">
<td>1000</td>
<td>0x431BDE83</td>
<td>41</td>
<td>(x * M) &gt;&gt; 41</td>
</tr>
</tbody>
</table>
</section>
<section id="algoritmo-para-calcular-número-mágico" class="level5" data-number="17.7.5.2.3">
<h5 data-number="17.7.5.2.3" class="anchored" data-anchor-id="algoritmo-para-calcular-número-mágico"><span class="header-section-number">17.7.5.2.3</span> Algoritmo para Calcular Número Mágico</h5>
<div class="sourceCode" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_magic_number(divisor, bits<span class="op">=</span><span class="dv">32</span>):</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Calcula número mágico para divisão por constante.</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Baseado no algoritmo de Granlund-Montgomery.</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a><span class="co">        divisor: inteiro positivo</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a><span class="co">        bits: tamanho do inteiro (32 ou 64)</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a><span class="co">        (magic, shift): tupla com número mágico e shift</span></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> divisor <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"Divisor não pode ser zero"</span>)</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Para potências de 2, usar shift direto</span></span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> divisor <span class="op">&amp;</span> (divisor <span class="op">-</span> <span class="dv">1</span>) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>        shift <span class="op">=</span> (divisor <span class="op">-</span> <span class="dv">1</span>).bit_length()</span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> (<span class="dv">1</span>, shift)</span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calcular número mágico</span></span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>    nc <span class="op">=</span> ((<span class="dv">1</span> <span class="op">&lt;&lt;</span> bits) <span class="op">-</span> <span class="dv">1</span>) <span class="op">//</span> divisor</span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>    nbits_nc <span class="op">=</span> nc.bit_length()</span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> p <span class="kw">in</span> <span class="bu">range</span>(nbits_nc, <span class="dv">2</span> <span class="op">*</span> bits <span class="op">+</span> <span class="dv">1</span>):</span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a>        q <span class="op">=</span> (<span class="dv">1</span> <span class="op">&lt;&lt;</span> p) <span class="op">//</span> divisor</span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a>        r <span class="op">=</span> (<span class="dv">1</span> <span class="op">&lt;&lt;</span> p) <span class="op">-</span> q <span class="op">*</span> divisor</span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> r <span class="op">&lt;=</span> (<span class="dv">1</span> <span class="op">&lt;&lt;</span> p) <span class="op">-</span> nc:</span>
<span id="cb32-30"><a href="#cb32-30" aria-hidden="true" tabindex="-1"></a>            m <span class="op">=</span> q <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb32-31"><a href="#cb32-31" aria-hidden="true" tabindex="-1"></a>            s <span class="op">=</span> p <span class="op">-</span> bits</span>
<span id="cb32-32"><a href="#cb32-32" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> (m, s)</span>
<span id="cb32-33"><a href="#cb32-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-34"><a href="#cb32-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"Não conseguiu calcular número mágico"</span>)</span>
<span id="cb32-35"><a href="#cb32-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-36"><a href="#cb32-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Exemplo de uso</span></span>
<span id="cb32-37"><a href="#cb32-37" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> divide_by_constant(x, divisor):</span>
<span id="cb32-38"><a href="#cb32-38" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Divide x por divisor usando número mágico."""</span></span>
<span id="cb32-39"><a href="#cb32-39" aria-hidden="true" tabindex="-1"></a>    magic, shift <span class="op">=</span> compute_magic_number(divisor)</span>
<span id="cb32-40"><a href="#cb32-40" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-41"><a href="#cb32-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> divisor <span class="op">&amp;</span> (divisor <span class="op">-</span> <span class="dv">1</span>) <span class="op">==</span> <span class="dv">0</span>:  <span class="co"># Potência de 2</span></span>
<span id="cb32-42"><a href="#cb32-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> x <span class="op">&gt;&gt;</span> shift</span>
<span id="cb32-43"><a href="#cb32-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb32-44"><a href="#cb32-44" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Multiplicação de precisão alta</span></span>
<span id="cb32-45"><a href="#cb32-45" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> (x <span class="op">*</span> magic) <span class="op">&gt;&gt;</span> (<span class="dv">32</span> <span class="op">+</span> shift)</span>
<span id="cb32-46"><a href="#cb32-46" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> result</span>
<span id="cb32-47"><a href="#cb32-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-48"><a href="#cb32-48" aria-hidden="true" tabindex="-1"></a><span class="co"># Teste</span></span>
<span id="cb32-49"><a href="#cb32-49" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> d <span class="kw">in</span> [<span class="dv">3</span>, <span class="dv">5</span>, <span class="dv">7</span>, <span class="dv">10</span>]:</span>
<span id="cb32-50"><a href="#cb32-50" aria-hidden="true" tabindex="-1"></a>    m, s <span class="op">=</span> compute_magic_number(d)</span>
<span id="cb32-51"><a href="#cb32-51" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Divisão por </span><span class="sc">{</span>d<span class="sc">}</span><span class="ss">: magic=0x</span><span class="sc">{</span>m<span class="sc">:X}</span><span class="ss">, shift=</span><span class="sc">{</span>s<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="operações-modulares" class="level4" data-number="17.7.5.3">
<h4 data-number="17.7.5.3" class="anchored" data-anchor-id="operações-modulares"><span class="header-section-number">17.7.5.3</span> Operações Modulares</h4>
<section id="tabela-para-módulo-com-potências-de-2" class="level5" data-number="17.7.5.3.1">
<h5 data-number="17.7.5.3.1" class="anchored" data-anchor-id="tabela-para-módulo-com-potências-de-2"><span class="header-section-number">17.7.5.3.1</span> Tabela para Módulo com Potências de 2</h5>
<table class="table">
<thead>
<tr class="header">
<th>Original</th>
<th>Transformação</th>
<th>Explicação</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>x % 2</td>
<td>x &amp; 1</td>
<td>Bit menos significativo</td>
</tr>
<tr class="even">
<td>x % 4</td>
<td>x &amp; 3</td>
<td>2 bits menos significativos</td>
</tr>
<tr class="odd">
<td>x % 8</td>
<td>x &amp; 7</td>
<td>3 bits menos significativos</td>
</tr>
<tr class="even">
<td>x % 16</td>
<td>x &amp; 15</td>
<td>4 bits menos significativos</td>
</tr>
<tr class="odd">
<td>x % 32</td>
<td>x &amp; 31</td>
<td>5 bits menos significativos</td>
</tr>
<tr class="even">
<td>x % 64</td>
<td>x &amp; 63</td>
<td>6 bits menos significativos</td>
</tr>
<tr class="odd">
<td>x % 2^n</td>
<td>x &amp; (2^n - 1)</td>
<td>n bits menos significativos</td>
</tr>
</tbody>
</table>
</section>
<section id="módulo-por-constantes-especiais" class="level5" data-number="17.7.5.3.2">
<h5 data-number="17.7.5.3.2" class="anchored" data-anchor-id="módulo-por-constantes-especiais"><span class="header-section-number">17.7.5.3.2</span> Módulo por Constantes Especiais</h5>
<div class="sourceCode" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> modulo_strength_reduction(x, divisor):</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Otimiza operação de módulo."""</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Potência de 2</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> divisor <span class="op">&amp;</span> (divisor <span class="op">-</span> <span class="dv">1</span>) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>        mask <span class="op">=</span> divisor <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="ss">f"</span><span class="sc">{</span>x<span class="sc">}</span><span class="ss"> &amp; </span><span class="sc">{</span>mask<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Módulo 3 (caso especial)</span></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> divisor <span class="op">==</span> <span class="dv">3</span>:</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>        <span class="co"># x % 3 pode usar soma de dígitos</span></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">"modulo_3_special(x)"</span></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Módulo 5 (caso especial)</span></span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> divisor <span class="op">==</span> <span class="dv">5</span>:</span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">"modulo_5_special(x)"</span></span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Caso geral: usar divisão otimizada + multiplicação</span></span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="ss">f"x - (x / </span><span class="sc">{</span>divisor<span class="sc">}</span><span class="ss">) * </span><span class="sc">{</span>divisor<span class="sc">}</span><span class="ss">"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="exponenciação" class="level4" data-number="17.7.5.4">
<h4 data-number="17.7.5.4" class="anchored" data-anchor-id="exponenciação"><span class="header-section-number">17.7.5.4</span> Exponenciação</h4>
<section id="tabela-para-exponenciação-por-constantes-pequenas" class="level5" data-number="17.7.5.4.1">
<h5 data-number="17.7.5.4.1" class="anchored" data-anchor-id="tabela-para-exponenciação-por-constantes-pequenas"><span class="header-section-number">17.7.5.4.1</span> Tabela para Exponenciação por Constantes Pequenas</h5>
<table class="table">
<thead>
<tr class="header">
<th>Original</th>
<th>Transformação</th>
<th>Operações</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>x^2</td>
<td>x * x</td>
<td>1 mult</td>
</tr>
<tr class="even">
<td>x^3</td>
<td>x * x * x</td>
<td>2 mults</td>
</tr>
<tr class="odd">
<td>x^4</td>
<td>(x * x) * (x * x)</td>
<td>2 mults</td>
</tr>
<tr class="even">
<td>x^5</td>
<td>x^4 * x</td>
<td>3 mults</td>
</tr>
<tr class="odd">
<td>x^6</td>
<td>(x^3) * (x^3)</td>
<td>3 mults</td>
</tr>
<tr class="even">
<td>x^7</td>
<td>x^6 * x</td>
<td>4 mults</td>
</tr>
<tr class="odd">
<td>x^8</td>
<td>((x * x) * (x * x)) * ((x * x) * (x * x))</td>
<td>3 mults</td>
</tr>
<tr class="even">
<td>x^10</td>
<td>(x^5) * (x^5)</td>
<td>4 mults</td>
</tr>
</tbody>
</table>
</section>
<section id="exponenciação-rápida-square-and-multiply" class="level5" data-number="17.7.5.4.2">
<h5 data-number="17.7.5.4.2" class="anchored" data-anchor-id="exponenciação-rápida-square-and-multiply"><span class="header-section-number">17.7.5.4.2</span> Exponenciação Rápida (Square-and-Multiply)</h5>
<div class="sourceCode" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> power_strength_reduction(base, exponent):</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Gera código otimizado para exponenciação.</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Usa algoritmo de exponenciação binária.</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> exponent <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">"1"</span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> exponent <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> base</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> exponent <span class="op">==</span> <span class="dv">2</span>:</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="ss">f"</span><span class="sc">{</span>base<span class="sc">}</span><span class="ss"> * </span><span class="sc">{</span>base<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Decomposição binária</span></span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>    operations <span class="op">=</span> []</span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>    binary <span class="op">=</span> <span class="bu">bin</span>(exponent)[<span class="dv">2</span>:]  <span class="co"># Remover '0b'</span></span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> base</span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, bit <span class="kw">in</span> <span class="bu">enumerate</span>(binary[<span class="dv">1</span>:], <span class="dv">1</span>):</span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> <span class="ss">f"(</span><span class="sc">{</span>result<span class="sc">}</span><span class="ss">) * (</span><span class="sc">{</span>result<span class="sc">}</span><span class="ss">)"</span>  <span class="co"># Square</span></span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> bit <span class="op">==</span> <span class="st">'1'</span>:</span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a>            result <span class="op">=</span> <span class="ss">f"(</span><span class="sc">{</span>result<span class="sc">}</span><span class="ss">) * </span><span class="sc">{</span>base<span class="sc">}</span><span class="ss">"</span>   <span class="co"># Multiply</span></span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result</span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Exemplos</span></span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"x^5 = </span><span class="sc">{</span>power_strength_reduction(<span class="st">'x'</span>, <span class="dv">5</span>)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb34-27"><a href="#cb34-27" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"x^10 = </span><span class="sc">{</span>power_strength_reduction(<span class="st">'x'</span>, <span class="dv">10</span>)<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="operações-em-loops-variáveis-de-indução" class="level4" data-number="17.7.5.5">
<h4 data-number="17.7.5.5" class="anchored" data-anchor-id="operações-em-loops-variáveis-de-indução"><span class="header-section-number">17.7.5.5</span> Operações em Loops (Variáveis de Indução)</h4>
<section id="transformações-clássicas" class="level5" data-number="17.7.5.5.1">
<h5 data-number="17.7.5.5.1" class="anchored" data-anchor-id="transformações-clássicas"><span class="header-section-number">17.7.5.5.1</span> Transformações Clássicas</h5>
<table class="table">
<thead>
<tr class="header">
<th>Padrão Original</th>
<th>Transformação</th>
<th>Ganho</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>i * c</code> em loop</td>
<td>Acumulador += c</td>
<td>Elimina mult/iteração</td>
</tr>
<tr class="even">
<td><code>i * i</code> em loop</td>
<td>Acumulador += 2i + 1</td>
<td>Elimina mult/iteração</td>
</tr>
<tr class="odd">
<td><code>a[i * stride]</code></td>
<td>Ponteiro += stride</td>
<td>Elimina mult + add</td>
</tr>
</tbody>
</table>
</section>
<section id="exemplo-multiplicação-em-loop" class="level5" data-number="17.7.5.5.2">
<h5 data-number="17.7.5.5.2" class="anchored" data-anchor-id="exemplo-multiplicação-em-loop"><span class="header-section-number">17.7.5.5.2</span> Exemplo: Multiplicação em Loop</h5>
<div class="sourceCode" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Original (multiplicação por iteração)</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n):</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> i <span class="op">*</span> <span class="dv">5</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(result)</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Otimizado (adição por iteração)</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>result <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n):</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(result)</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>    result <span class="op">+=</span> <span class="dv">5</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="exemplo-quadrados-em-loop" class="level5" data-number="17.7.5.5.3">
<h5 data-number="17.7.5.5.3" class="anchored" data-anchor-id="exemplo-quadrados-em-loop"><span class="header-section-number">17.7.5.5.3</span> Exemplo: Quadrados em Loop</h5>
<div class="sourceCode" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Original (multiplicação por iteração)</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n):</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>    square <span class="op">=</span> i <span class="op">*</span> i</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(square)</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Otimizado (série de ímpares)</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>square <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>odd <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n):</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(square)</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>    square <span class="op">+=</span> odd</span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>    odd <span class="op">+=</span> <span class="dv">2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="funções-trigonométricas-em-ângulos-especiais" class="level4" data-number="17.7.5.6">
<h4 data-number="17.7.5.6" class="anchored" data-anchor-id="funções-trigonométricas-em-ângulos-especiais"><span class="header-section-number">17.7.5.6</span> Funções Trigonométricas em Ângulos Especiais</h4>
<section id="tabela-de-valores-exatos" class="level5" data-number="17.7.5.6.1">
<h5 data-number="17.7.5.6.1" class="anchored" data-anchor-id="tabela-de-valores-exatos"><span class="header-section-number">17.7.5.6.1</span> Tabela de Valores Exatos</h5>
<table class="table">
<thead>
<tr class="header">
<th>Função</th>
<th>Transformação</th>
<th>Valor</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>sin(0)</td>
<td>0</td>
<td>constante</td>
</tr>
<tr class="even">
<td>sin(π/6)</td>
<td>0.5</td>
<td>constante</td>
</tr>
<tr class="odd">
<td>sin(π/4)</td>
<td>√2/2 ≈ 0.707</td>
<td>constante</td>
</tr>
<tr class="even">
<td>sin(π/3)</td>
<td>√3/2 ≈ 0.866</td>
<td>constante</td>
</tr>
<tr class="odd">
<td>sin(π/2)</td>
<td>1.0</td>
<td>constante</td>
</tr>
<tr class="even">
<td>cos(0)</td>
<td>1.0</td>
<td>constante</td>
</tr>
<tr class="odd">
<td>cos(π/2)</td>
<td>0</td>
<td>constante</td>
</tr>
<tr class="even">
<td>tan(0)</td>
<td>0</td>
<td>constante</td>
</tr>
<tr class="odd">
<td>tan(π/4)</td>
<td>1.0</td>
<td>constante</td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="operações-de-ponto-flutuante" class="level4" data-number="17.7.5.7">
<h4 data-number="17.7.5.7" class="anchored" data-anchor-id="operações-de-ponto-flutuante"><span class="header-section-number">17.7.5.7</span> Operações de Ponto Flutuante</h4>
<section id="divisão-por-constantes-float" class="level5" data-number="17.7.5.7.1">
<h5 data-number="17.7.5.7.1" class="anchored" data-anchor-id="divisão-por-constantes-float"><span class="header-section-number">17.7.5.7.1</span> Divisão por Constantes Float</h5>
<table class="table">
<thead>
<tr class="header">
<th>Original</th>
<th>Transformação</th>
<th>Ganho</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>x / 2.0</td>
<td>x * 0.5</td>
<td>~30%</td>
</tr>
<tr class="even">
<td>x / 4.0</td>
<td>x * 0.25</td>
<td>~30%</td>
</tr>
<tr class="odd">
<td>x / 10.0</td>
<td>x * 0.1</td>
<td>~30%</td>
</tr>
</tbody>
</table>
<p><strong>Nota</strong>: Multiplicação é geralmente mais rápida que divisão em FPUs modernas.</p>
</section>
</section>
<section id="operações-bit-a-bit" class="level4" data-number="17.7.5.8">
<h4 data-number="17.7.5.8" class="anchored" data-anchor-id="operações-bit-a-bit"><span class="header-section-number">17.7.5.8</span> Operações Bit a Bit</h4>
<section id="tabela-de-truques-com-bits" class="level5" data-number="17.7.5.8.1">
<h5 data-number="17.7.5.8.1" class="anchored" data-anchor-id="tabela-de-truques-com-bits"><span class="header-section-number">17.7.5.8.1</span> Tabela de Truques com Bits</h5>
<table class="table">
<thead>
<tr class="header">
<th>Operação</th>
<th>Transformação</th>
<th>Uso</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>x % 2 == 0</td>
<td>(x &amp; 1) == 0</td>
<td>Testar paridade</td>
</tr>
<tr class="even">
<td>x / 2^n</td>
<td>x &gt;&gt; n</td>
<td>Divisão por pot. de 2</td>
</tr>
<tr class="odd">
<td>x * 2^n</td>
<td>x &lt;&lt; n</td>
<td>Multiplicação pot. 2</td>
</tr>
<tr class="even">
<td>abs(x)</td>
<td>(x ^ (x &gt;&gt; 31)) - (x &gt;&gt; 31)</td>
<td>Valor absoluto sem branch</td>
</tr>
<tr class="odd">
<td>max(a, b)</td>
<td>b ^ ((a ^ b) &amp; -(a &gt; b))</td>
<td>Máximo sem branch</td>
</tr>
<tr class="even">
<td>min(a, b)</td>
<td>a ^ ((a ^ b) &amp; -(a &gt; b))</td>
<td>Mínimo sem branch</td>
</tr>
<tr class="odd">
<td>swap(a, b)</td>
<td>a^=b; b^=a; a^=b</td>
<td>Trocar sem temp</td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="seleção-de-técnica-por-arquitetura" class="level4" data-number="17.7.5.9">
<h4 data-number="17.7.5.9" class="anchored" data-anchor-id="seleção-de-técnica-por-arquitetura"><span class="header-section-number">17.7.5.9</span> Seleção de Técnica por Arquitetura</h4>
<section id="custos-relativos-ciclos-típicos-em-x86-64" class="level5" data-number="17.7.5.9.1">
<h5 data-number="17.7.5.9.1" class="anchored" data-anchor-id="custos-relativos-ciclos-típicos-em-x86-64"><span class="header-section-number">17.7.5.9.1</span> Custos Relativos (ciclos típicos em x86-64)</h5>
<table class="table">
<thead>
<tr class="header">
<th>Operação</th>
<th>Latência</th>
<th>Throughput</th>
<th>Observações</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>ADD</td>
<td>1</td>
<td>0.25-0.5</td>
<td>Muito rápido</td>
</tr>
<tr class="even">
<td>SHIFT</td>
<td>1</td>
<td>0.5</td>
<td>Muito rápido</td>
</tr>
<tr class="odd">
<td>MUL (int)</td>
<td>3-4</td>
<td>0.5-1</td>
<td>Rápido moderno</td>
</tr>
<tr class="even">
<td>DIV (int)</td>
<td>20-80</td>
<td>20-80</td>
<td>Muito lento</td>
</tr>
<tr class="odd">
<td>MUL (float)</td>
<td>4-5</td>
<td>0.5</td>
<td>Razoável</td>
</tr>
<tr class="even">
<td>DIV (float)</td>
<td>10-15</td>
<td>10-15</td>
<td>Lento</td>
</tr>
</tbody>
</table>
</section>
<section id="heurística-de-decisão" class="level5" data-number="17.7.5.9.2">
<h5 data-number="17.7.5.9.2" class="anchored" data-anchor-id="heurística-de-decisão"><span class="header-section-number">17.7.5.9.2</span> Heurística de Decisão</h5>
<div class="sourceCode" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> should_apply_strength_reduction(operation, operand, target_arch<span class="op">=</span><span class="st">"x86-64"</span>):</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Decide se vale a pena aplicar strength reduction.</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a><span class="co">        operation: 'mul', 'div', 'mod', 'pow'</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a><span class="co">        operand: valor da constante</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a><span class="co">        target_arch: arquitetura alvo</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a><span class="co">        bool: True se deve otimizar</span></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> operation <span class="op">==</span> <span class="st">'mul'</span>:</span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Multiplicação moderna é rápida</span></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Só vale a pena para constantes muito usadas ou em loops críticos</span></span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> is_power_of_2(operand):</span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">True</span>  <span class="co"># Shift sempre vale a pena</span></span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Decomposição em &lt;= 3 operações</span></span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a>        ops_count <span class="op">=</span> count_operations_needed(operand)</span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> ops_count <span class="op">&lt;=</span> <span class="dv">3</span></span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> operation <span class="op">==</span> <span class="st">'div'</span>:</span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Divisão é sempre lenta, sempre otimizar</span></span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb37-26"><a href="#cb37-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-27"><a href="#cb37-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> operation <span class="op">==</span> <span class="st">'mod'</span>:</span>
<span id="cb37-28"><a href="#cb37-28" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Módulo é lento, otimizar quando possível</span></span>
<span id="cb37-29"><a href="#cb37-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> is_power_of_2(operand)</span>
<span id="cb37-30"><a href="#cb37-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-31"><a href="#cb37-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> operation <span class="op">==</span> <span class="st">'pow'</span>:</span>
<span id="cb37-32"><a href="#cb37-32" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Exponenciação: otimizar para expoentes pequenos</span></span>
<span id="cb37-33"><a href="#cb37-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> operand <span class="op">&lt;=</span> <span class="dv">10</span></span>
<span id="cb37-34"><a href="#cb37-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-35"><a href="#cb37-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb37-36"><a href="#cb37-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-37"><a href="#cb37-37" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> count_operations_needed(n):</span>
<span id="cb37-38"><a href="#cb37-38" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Conta quantas ops são necessárias para multiplicar por n."""</span></span>
<span id="cb37-39"><a href="#cb37-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> is_power_of_2(n):</span>
<span id="cb37-40"><a href="#cb37-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">1</span>  <span class="co"># Apenas shift</span></span>
<span id="cb37-41"><a href="#cb37-41" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-42"><a href="#cb37-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Contar bits set (aproximação simples)</span></span>
<span id="cb37-43"><a href="#cb37-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">bin</span>(n).count(<span class="st">'1'</span>)</span>
<span id="cb37-44"><a href="#cb37-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-45"><a href="#cb37-45" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> is_power_of_2(n):</span>
<span id="cb37-46"><a href="#cb37-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> n <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">and</span> (n <span class="op">&amp;</span> (n <span class="op">-</span> <span class="dv">1</span>)) <span class="op">==</span> <span class="dv">0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="implementação-prática-em-compilador" class="level4" data-number="17.7.5.10">
<h4 data-number="17.7.5.10" class="anchored" data-anchor-id="implementação-prática-em-compilador"><span class="header-section-number">17.7.5.10</span> Implementação Prática em Compilador</h4>
<section id="framework-de-strength-reduction" class="level5" data-number="17.7.5.10.1">
<h5 data-number="17.7.5.10.1" class="anchored" data-anchor-id="framework-de-strength-reduction"><span class="header-section-number">17.7.5.10.1</span> Framework de Strength Reduction</h5>
<div class="sourceCode" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> StrengthReducer:</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Framework para aplicar strength reduction."""</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, target_arch<span class="op">=</span><span class="st">'generic'</span>):</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.target_arch <span class="op">=</span> target_arch</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.transformations <span class="op">=</span> <span class="va">self</span>._build_transformation_table()</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _build_transformation_table(<span class="va">self</span>):</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Constrói tabela de transformações."""</span></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {</span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>            <span class="st">'mul'</span>: <span class="va">self</span>._optimize_multiply,</span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>            <span class="st">'div'</span>: <span class="va">self</span>._optimize_divide,</span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>            <span class="st">'mod'</span>: <span class="va">self</span>._optimize_modulo,</span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>            <span class="st">'pow'</span>: <span class="va">self</span>._optimize_power,</span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> optimize(<span class="va">self</span>, instruction):</span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a><span class="co">        Otimiza uma instrução.</span></span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a><span class="co">        Args:</span></span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a><span class="co">            instruction: objeto Instruction</span></span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a><span class="co">            </span></span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true" tabindex="-1"></a><span class="co">        Returns:</span></span>
<span id="cb38-25"><a href="#cb38-25" aria-hidden="true" tabindex="-1"></a><span class="co">            lista de instruções otimizadas</span></span>
<span id="cb38-26"><a href="#cb38-26" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb38-27"><a href="#cb38-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> instruction.op <span class="kw">not</span> <span class="kw">in</span> <span class="va">self</span>.transformations:</span>
<span id="cb38-28"><a href="#cb38-28" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> [instruction]</span>
<span id="cb38-29"><a href="#cb38-29" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb38-30"><a href="#cb38-30" aria-hidden="true" tabindex="-1"></a>        optimizer <span class="op">=</span> <span class="va">self</span>.transformations[instruction.op]</span>
<span id="cb38-31"><a href="#cb38-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> optimizer(instruction)</span>
<span id="cb38-32"><a href="#cb38-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-33"><a href="#cb38-33" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _optimize_multiply(<span class="va">self</span>, instr):</span>
<span id="cb38-34"><a href="#cb38-34" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Otimiza multiplicação."""</span></span>
<span id="cb38-35"><a href="#cb38-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="bu">isinstance</span>(instr.arg2, <span class="bu">int</span>):</span>
<span id="cb38-36"><a href="#cb38-36" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> [instr]</span>
<span id="cb38-37"><a href="#cb38-37" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb38-38"><a href="#cb38-38" aria-hidden="true" tabindex="-1"></a>        n <span class="op">=</span> instr.arg2</span>
<span id="cb38-39"><a href="#cb38-39" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb38-40"><a href="#cb38-40" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Potência de 2</span></span>
<span id="cb38-41"><a href="#cb38-41" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> n <span class="op">&amp;</span> (n <span class="op">-</span> <span class="dv">1</span>) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb38-42"><a href="#cb38-42" aria-hidden="true" tabindex="-1"></a>            shift <span class="op">=</span> (n <span class="op">-</span> <span class="dv">1</span>).bit_length()</span>
<span id="cb38-43"><a href="#cb38-43" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> [Instruction(<span class="st">'&lt;&lt;'</span>, instr.dest, instr.arg1, shift)]</span>
<span id="cb38-44"><a href="#cb38-44" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb38-45"><a href="#cb38-45" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Padrão 2^k - 1 (ex: 7 = 8-1)</span></span>
<span id="cb38-46"><a href="#cb38-46" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (n <span class="op">+</span> <span class="dv">1</span>) <span class="op">&amp;</span> n <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb38-47"><a href="#cb38-47" aria-hidden="true" tabindex="-1"></a>            shift <span class="op">=</span> (n <span class="op">+</span> <span class="dv">1</span>).bit_length() <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb38-48"><a href="#cb38-48" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> [</span>
<span id="cb38-49"><a href="#cb38-49" aria-hidden="true" tabindex="-1"></a>                Instruction(<span class="st">'&lt;&lt;'</span>, <span class="st">'t_temp'</span>, instr.arg1, shift),</span>
<span id="cb38-50"><a href="#cb38-50" aria-hidden="true" tabindex="-1"></a>                Instruction(<span class="st">'-'</span>, instr.dest, <span class="st">'t_temp'</span>, instr.arg1)</span>
<span id="cb38-51"><a href="#cb38-51" aria-hidden="true" tabindex="-1"></a>            ]</span>
<span id="cb38-52"><a href="#cb38-52" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb38-53"><a href="#cb38-53" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Padrão 2^k + 1 (ex: 9 = 8+1)</span></span>
<span id="cb38-54"><a href="#cb38-54" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (n <span class="op">-</span> <span class="dv">1</span>) <span class="op">&amp;</span> (n <span class="op">-</span> <span class="dv">2</span>) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb38-55"><a href="#cb38-55" aria-hidden="true" tabindex="-1"></a>            shift <span class="op">=</span> (n <span class="op">-</span> <span class="dv">1</span>).bit_length() <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb38-56"><a href="#cb38-56" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> [</span>
<span id="cb38-57"><a href="#cb38-57" aria-hidden="true" tabindex="-1"></a>                Instruction(<span class="st">'&lt;&lt;'</span>, <span class="st">'t_temp'</span>, instr.arg1, shift),</span>
<span id="cb38-58"><a href="#cb38-58" aria-hidden="true" tabindex="-1"></a>                Instruction(<span class="st">'+'</span>, instr.dest, <span class="st">'t_temp'</span>, instr.arg1)</span>
<span id="cb38-59"><a href="#cb38-59" aria-hidden="true" tabindex="-1"></a>            ]</span>
<span id="cb38-60"><a href="#cb38-60" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb38-61"><a href="#cb38-61" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Decomposição geral (limitar a 3 operações)</span></span>
<span id="cb38-62"><a href="#cb38-62" aria-hidden="true" tabindex="-1"></a>        decomp <span class="op">=</span> <span class="va">self</span>._decompose_multiply(n)</span>
<span id="cb38-63"><a href="#cb38-63" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(decomp) <span class="op">&lt;=</span> <span class="dv">3</span>:</span>
<span id="cb38-64"><a href="#cb38-64" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">self</span>._generate_multiply_sequence(instr, decomp)</span>
<span id="cb38-65"><a href="#cb38-65" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb38-66"><a href="#cb38-66" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Não vale a pena, manter original</span></span>
<span id="cb38-67"><a href="#cb38-67" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> [instr]</span>
<span id="cb38-68"><a href="#cb38-68" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-69"><a href="#cb38-69" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _optimize_divide(<span class="va">self</span>, instr):</span>
<span id="cb38-70"><a href="#cb38-70" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Otimiza divisão."""</span></span>
<span id="cb38-71"><a href="#cb38-71" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="bu">isinstance</span>(instr.arg2, <span class="bu">int</span>):</span>
<span id="cb38-72"><a href="#cb38-72" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> [instr]</span>
<span id="cb38-73"><a href="#cb38-73" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb38-74"><a href="#cb38-74" aria-hidden="true" tabindex="-1"></a>        divisor <span class="op">=</span> instr.arg2</span>
<span id="cb38-75"><a href="#cb38-75" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb38-76"><a href="#cb38-76" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Potência de 2: usar shift</span></span>
<span id="cb38-77"><a href="#cb38-77" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> divisor <span class="op">&amp;</span> (divisor <span class="op">-</span> <span class="dv">1</span>) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb38-78"><a href="#cb38-78" aria-hidden="true" tabindex="-1"></a>            shift <span class="op">=</span> (divisor <span class="op">-</span> <span class="dv">1</span>).bit_length()</span>
<span id="cb38-79"><a href="#cb38-79" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> [Instruction(<span class="st">'&gt;&gt;'</span>, instr.dest, instr.arg1, shift)]</span>
<span id="cb38-80"><a href="#cb38-80" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb38-81"><a href="#cb38-81" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Usar número mágico</span></span>
<span id="cb38-82"><a href="#cb38-82" aria-hidden="true" tabindex="-1"></a>        magic, shift <span class="op">=</span> <span class="va">self</span>._compute_magic_number(divisor)</span>
<span id="cb38-83"><a href="#cb38-83" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> [</span>
<span id="cb38-84"><a href="#cb38-84" aria-hidden="true" tabindex="-1"></a>            Instruction(<span class="st">'*'</span>, <span class="st">'t_temp'</span>, instr.arg1, magic),</span>
<span id="cb38-85"><a href="#cb38-85" aria-hidden="true" tabindex="-1"></a>            Instruction(<span class="st">'&gt;&gt;'</span>, instr.dest, <span class="st">'t_temp'</span>, <span class="dv">32</span> <span class="op">+</span> shift)</span>
<span id="cb38-86"><a href="#cb38-86" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb38-87"><a href="#cb38-87" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-88"><a href="#cb38-88" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _optimize_modulo(<span class="va">self</span>, instr):</span>
<span id="cb38-89"><a href="#cb38-89" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Otimiza módulo."""</span></span>
<span id="cb38-90"><a href="#cb38-90" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="bu">isinstance</span>(instr.arg2, <span class="bu">int</span>):</span>
<span id="cb38-91"><a href="#cb38-91" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> [instr]</span>
<span id="cb38-92"><a href="#cb38-92" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb38-93"><a href="#cb38-93" aria-hidden="true" tabindex="-1"></a>        divisor <span class="op">=</span> instr.arg2</span>
<span id="cb38-94"><a href="#cb38-94" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb38-95"><a href="#cb38-95" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Potência de 2: usar AND</span></span>
<span id="cb38-96"><a href="#cb38-96" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> divisor <span class="op">&amp;</span> (divisor <span class="op">-</span> <span class="dv">1</span>) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb38-97"><a href="#cb38-97" aria-hidden="true" tabindex="-1"></a>            mask <span class="op">=</span> divisor <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb38-98"><a href="#cb38-98" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> [Instruction(<span class="st">'&amp;'</span>, instr.dest, instr.arg1, mask)]</span>
<span id="cb38-99"><a href="#cb38-99" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb38-100"><a href="#cb38-100" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Não otimizar outros casos</span></span>
<span id="cb38-101"><a href="#cb38-101" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> [instr]</span>
<span id="cb38-102"><a href="#cb38-102" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-103"><a href="#cb38-103" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _optimize_power(<span class="va">self</span>, instr):</span>
<span id="cb38-104"><a href="#cb38-104" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Otimiza exponenciação."""</span></span>
<span id="cb38-105"><a href="#cb38-105" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="bu">isinstance</span>(instr.arg2, <span class="bu">int</span>):</span>
<span id="cb38-106"><a href="#cb38-106" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> [instr]</span>
<span id="cb38-107"><a href="#cb38-107" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb38-108"><a href="#cb38-108" aria-hidden="true" tabindex="-1"></a>        exp <span class="op">=</span> instr.arg2</span>
<span id="cb38-109"><a href="#cb38-109" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb38-110"><a href="#cb38-110" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> exp <span class="op">==</span> <span class="dv">2</span>:</span>
<span id="cb38-111"><a href="#cb38-111" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> [Instruction(<span class="st">'*'</span>, instr.dest, instr.arg1, instr.arg1)]</span>
<span id="cb38-112"><a href="#cb38-112" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb38-113"><a href="#cb38-113" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> exp <span class="op">&lt;=</span> <span class="dv">10</span>:</span>
<span id="cb38-114"><a href="#cb38-114" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">self</span>._generate_power_sequence(instr, exp)</span>
<span id="cb38-115"><a href="#cb38-115" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb38-116"><a href="#cb38-116" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> [instr]</span>
<span id="cb38-117"><a href="#cb38-117" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-118"><a href="#cb38-118" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _decompose_multiply(<span class="va">self</span>, n):</span>
<span id="cb38-119"><a href="#cb38-119" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Decompõe multiplicação em shifts e adds."""</span></span>
<span id="cb38-120"><a href="#cb38-120" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Implementação simplificada</span></span>
<span id="cb38-121"><a href="#cb38-121" aria-hidden="true" tabindex="-1"></a>        decomposition <span class="op">=</span> []</span>
<span id="cb38-122"><a href="#cb38-122" aria-hidden="true" tabindex="-1"></a>        shift <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb38-123"><a href="#cb38-123" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span> n <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb38-124"><a href="#cb38-124" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> n <span class="op">&amp;</span> <span class="dv">1</span>:</span>
<span id="cb38-125"><a href="#cb38-125" aria-hidden="true" tabindex="-1"></a>                decomposition.append((<span class="st">'shift'</span>, shift))</span>
<span id="cb38-126"><a href="#cb38-126" aria-hidden="true" tabindex="-1"></a>            n <span class="op">&gt;&gt;=</span> <span class="dv">1</span></span>
<span id="cb38-127"><a href="#cb38-127" aria-hidden="true" tabindex="-1"></a>            shift <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb38-128"><a href="#cb38-128" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> decomposition</span>
<span id="cb38-129"><a href="#cb38-129" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-130"><a href="#cb38-130" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _generate_multiply_sequence(<span class="va">self</span>, instr, decomposition):</span>
<span id="cb38-131"><a href="#cb38-131" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Gera sequência de instruções para multiplicação."""</span></span>
<span id="cb38-132"><a href="#cb38-132" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Implementação simplificada</span></span>
<span id="cb38-133"><a href="#cb38-133" aria-hidden="true" tabindex="-1"></a>        instructions <span class="op">=</span> []</span>
<span id="cb38-134"><a href="#cb38-134" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ... gerar instruções baseadas na decomposição</span></span>
<span id="cb38-135"><a href="#cb38-135" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> instructions</span>
<span id="cb38-136"><a href="#cb38-136" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-137"><a href="#cb38-137" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _compute_magic_number(<span class="va">self</span>, divisor):</span>
<span id="cb38-138"><a href="#cb38-138" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Calcula número mágico para divisão."""</span></span>
<span id="cb38-139"><a href="#cb38-139" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Implementação do algoritmo Granlund-Montgomery</span></span>
<span id="cb38-140"><a href="#cb38-140" aria-hidden="true" tabindex="-1"></a>        <span class="co"># (simplificado aqui)</span></span>
<span id="cb38-141"><a href="#cb38-141" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> (<span class="bn">0xAAAAAAAB</span>, <span class="dv">1</span>)  <span class="co"># Placeholder</span></span>
<span id="cb38-142"><a href="#cb38-142" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-143"><a href="#cb38-143" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _generate_power_sequence(<span class="va">self</span>, instr, exp):</span>
<span id="cb38-144"><a href="#cb38-144" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Gera sequência para exponenciação."""</span></span>
<span id="cb38-145"><a href="#cb38-145" aria-hidden="true" tabindex="-1"></a>        instructions <span class="op">=</span> []</span>
<span id="cb38-146"><a href="#cb38-146" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Implementar exponenciação binária</span></span>
<span id="cb38-147"><a href="#cb38-147" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> instructions</span>
<span id="cb38-148"><a href="#cb38-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-149"><a href="#cb38-149" aria-hidden="true" tabindex="-1"></a><span class="co"># Uso</span></span>
<span id="cb38-150"><a href="#cb38-150" aria-hidden="true" tabindex="-1"></a>reducer <span class="op">=</span> StrengthReducer()</span>
<span id="cb38-151"><a href="#cb38-151" aria-hidden="true" tabindex="-1"></a>optimized <span class="op">=</span> reducer.optimize(Instruction(<span class="st">'*'</span>, <span class="st">'t1'</span>, <span class="st">'x'</span>, <span class="dv">7</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
</section>
<section id="notas-de-implementação" class="level3" data-number="17.7.6">
<h3 data-number="17.7.6" class="anchored" data-anchor-id="notas-de-implementação"><span class="header-section-number">17.7.6</span> Notas de Implementação</h3>
<section id="quando-não-aplicar-strength-reduction" class="level4" data-number="17.7.6.1">
<h4 data-number="17.7.6.1" class="anchored" data-anchor-id="quando-não-aplicar-strength-reduction"><span class="header-section-number">17.7.6.1</span> Quando NÃO Aplicar Strength Reduction</h4>
<ol type="1">
<li><strong>Processadores modernos com multiplicadores rápidos</strong>: Em CPUs modernas (desde ~2010), multiplicação inteira é quase tão rápida quanto adição</li>
<li><strong>Código já otimizado</strong>: Evitar sobre-otimização que prejudica legibilidade</li>
<li><strong>Constantes variáveis</strong>: Se o “constante” pode mudar (ex: configuração)</li>
<li><strong>Debugging</strong>: Código otimizado é mais difícil de debugar</li>
</ol>
</section>
<section id="considerações-de-arquitetura" class="level4" data-number="17.7.6.2">
<h4 data-number="17.7.6.2" class="anchored" data-anchor-id="considerações-de-arquitetura"><span class="header-section-number">17.7.6.2</span> Considerações de Arquitetura</h4>
<ul>
<li><strong>ARM</strong>: multiplicação pode ser mais lenta, <em>strength reduction</em> mais benéfico</li>
<li><strong>x86-64</strong>: multiplicação moderna é rápida, focar em divisão e módulo</li>
<li><strong>Microcontroladores</strong>: <em>strength reduction</em> é importante, sem <strong>FPU</strong>, as multiplicações são caras</li>
<li><strong>GPUs</strong>: evitar divergência de branches, preferir operações uniformes</li>
</ul>
</section>
</section>
</section>
<section id="propagação-de-cópias-copy-propagation" class="level2" data-number="17.8">
<h2 data-number="17.8" class="anchored" data-anchor-id="propagação-de-cópias-copy-propagation"><span class="header-section-number">17.8</span> Propagação de Cópias (Copy Propagation)</h2>
<p>Substitui usos de variáveis copiadas pela variável original, eliminando cópias intermediárias desnecessárias.</p>
<section id="algoritmo-3" class="level3" data-number="17.8.1">
<h3 data-number="17.8.1" class="anchored" data-anchor-id="algoritmo-3"><span class="header-section-number">17.8.1</span> Algoritmo</h3>
<div class="sourceCode" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> copy_propagation(instructions):</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Propaga cópias (em um bloco básico).</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Transforma: x = y; z = x + 1</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Em: x = y; z = y + 1</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># assumes is_variable()</span></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> is_variable(val):</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">isinstance</span>(val, <span class="bu">str</span>) <span class="kw">and</span> (val[<span class="dv">0</span>].isalpha() <span class="kw">or</span> val[<span class="dv">0</span>] <span class="op">==</span> <span class="st">'t'</span>)</span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>    copies <span class="op">=</span> {}  <span class="co"># Mapa: variável -&gt; variável que contém mesmo valor</span></span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> []</span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> instr <span class="kw">in</span> instructions:</span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Substituir usos por originais</span></span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a>        arg1 <span class="op">=</span> copies.get(instr.arg1, instr.arg1)</span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a>        arg2 <span class="op">=</span> copies.get(instr.arg2, instr.arg2)</span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a>        new_instr <span class="op">=</span> Instruction(instr.op, instr.dest, arg1, arg2)</span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Invalidar cópias se variável for redefinida</span></span>
<span id="cb39-23"><a href="#cb39-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> instr.dest:</span>
<span id="cb39-24"><a href="#cb39-24" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Remover dest de copies (se dest = z, remove z)</span></span>
<span id="cb39-25"><a href="#cb39-25" aria-hidden="true" tabindex="-1"></a>            copies.pop(instr.dest, <span class="va">None</span>)</span>
<span id="cb39-26"><a href="#cb39-26" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Remover entradas que apontam para dest (se w = dest, remove w)</span></span>
<span id="cb39-27"><a href="#cb39-27" aria-hidden="true" tabindex="-1"></a>            copies <span class="op">=</span> {k: v <span class="cf">for</span> k, v <span class="kw">in</span> copies.items() <span class="cf">if</span> v <span class="op">!=</span> instr.dest}</span>
<span id="cb39-28"><a href="#cb39-28" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb39-29"><a href="#cb39-29" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Detectar nova cópia</span></span>
<span id="cb39-30"><a href="#cb39-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> new_instr.op <span class="op">==</span> <span class="st">'ASSIGN'</span> <span class="kw">and</span> is_variable(new_instr.arg1):</span>
<span id="cb39-31"><a href="#cb39-31" aria-hidden="true" tabindex="-1"></a>            copies[new_instr.dest] <span class="op">=</span> new_instr.arg1</span>
<span id="cb39-32"><a href="#cb39-32" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb39-33"><a href="#cb39-33" aria-hidden="true" tabindex="-1"></a>        result.append(new_instr)</span>
<span id="cb39-34"><a href="#cb39-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb39-35"><a href="#cb39-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="interação-com-outras-otimizações" class="level3" data-number="17.8.2">
<h3 data-number="17.8.2" class="anchored" data-anchor-id="interação-com-outras-otimizações"><span class="header-section-number">17.8.2</span> Interação com Outras Otimizações</h3>
<p>Copy propagation frequentemente habilita outras otimizações:</p>
<p><strong>Exemplo</strong>:</p>
<pre class="shell"><code># Original
x = a
y = x + 5
z = x * 2

# Após copy propagation
x = a
y = a + 5
z = a * 2

# 'x = a' pode ser eliminado como código morto se 'x' não usado depois
y = a + 5
z = a * 2</code></pre>
</section>
<section id="análise-de-alias" class="level3" data-number="17.8.3">
<h3 data-number="17.8.3" class="anchored" data-anchor-id="análise-de-alias"><span class="header-section-number">17.8.3</span> Análise de Alias</h3>
<p>Copy propagation requer cuidado com aliasing (ponteiros ou referências), o que geralmente exige uma análise mais complexa (alias analysis) do que a mostrada. O algoritmo acima é seguro para variáveis escalares simples.</p>
</section>
</section>
<section id="eliminação-de-subexpressões-comuns-common-subexpression-elimination" class="level2" data-number="17.9">
<h2 data-number="17.9" class="anchored" data-anchor-id="eliminação-de-subexpressões-comuns-common-subexpression-elimination"><span class="header-section-number">17.9</span> Eliminação de Subexpressões Comuns (Common Subexpression Elimination)</h2>
<p>Identifica expressões calculadas múltiplas vezes com os mesmos operandos e reutiliza o resultado já computado.</p>
<section id="algoritmo-local" class="level3" data-number="17.9.1">
<h3 data-number="17.9.1" class="anchored" data-anchor-id="algoritmo-local"><span class="header-section-number">17.9.1</span> Algoritmo Local</h3>
<p>Este algoritmo usa uma forma de <em>value numbering</em> local.</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> invalidate_expressions(available, modified_var):</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Remove expressões que dependem de variável modificada."""</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {expr: var <span class="cf">for</span> expr, var <span class="kw">in</span> available.items()</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> modified_var <span class="kw">not</span> <span class="kw">in</span> [expr[<span class="dv">1</span>], expr[<span class="dv">2</span>]]}</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> local_cse(instructions):</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a><span class="co">    CSE dentro de um bloco básico.</span></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a><span class="co">        instructions: Lista de instruções sem branches</span></span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a><span class="co">        Lista otimizada de instruções</span></span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a>    available_expressions <span class="op">=</span> {}  <span class="co"># (op, arg1, arg2) -&gt; variável com resultado</span></span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> []</span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> instr <span class="kw">in</span> instructions:</span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 1. Invalidar expressões que usam a variável</span></span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a>        <span class="co">#    que *está prestes a ser definida*</span></span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> instr.dest:</span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true" tabindex="-1"></a>            available_expressions <span class="op">=</span> invalidate_expressions(</span>
<span id="cb41-25"><a href="#cb41-25" aria-hidden="true" tabindex="-1"></a>                available_expressions, instr.dest</span>
<span id="cb41-26"><a href="#cb41-26" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb41-27"><a href="#cb41-27" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb41-28"><a href="#cb41-28" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 2. Verificar se é uma expressão aritmética</span></span>
<span id="cb41-29"><a href="#cb41-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> instr.op <span class="kw">in</span> [<span class="st">'+'</span>, <span class="st">'-'</span>, <span class="st">'*'</span>, <span class="st">'/'</span>, <span class="st">'&lt;&lt;'</span>, <span class="st">'&gt;&gt;'</span>]:</span>
<span id="cb41-30"><a href="#cb41-30" aria-hidden="true" tabindex="-1"></a>            expr <span class="op">=</span> (instr.op, instr.arg1, instr.arg2)</span>
<span id="cb41-31"><a href="#cb41-31" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb41-32"><a href="#cb41-32" aria-hidden="true" tabindex="-1"></a>            <span class="co"># 3. Expressão já foi computada?</span></span>
<span id="cb41-33"><a href="#cb41-33" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> expr <span class="kw">in</span> available_expressions:</span>
<span id="cb41-34"><a href="#cb41-34" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Reusar resultado</span></span>
<span id="cb41-35"><a href="#cb41-35" aria-hidden="true" tabindex="-1"></a>                cached_var <span class="op">=</span> available_expressions[expr]</span>
<span id="cb41-36"><a href="#cb41-36" aria-hidden="true" tabindex="-1"></a>                new_instr <span class="op">=</span> Instruction(<span class="st">'ASSIGN'</span>, instr.dest, cached_var)</span>
<span id="cb41-37"><a href="#cb41-37" aria-hidden="true" tabindex="-1"></a>                result.append(new_instr)</span>
<span id="cb41-38"><a href="#cb41-38" aria-hidden="true" tabindex="-1"></a>                <span class="co"># (Copy propagation pode usar esta nova atribuição)</span></span>
<span id="cb41-39"><a href="#cb41-39" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb41-40"><a href="#cb41-40" aria-hidden="true" tabindex="-1"></a>                <span class="co"># 4. Nova expressão</span></span>
<span id="cb41-41"><a href="#cb41-41" aria-hidden="true" tabindex="-1"></a>                result.append(instr)</span>
<span id="cb41-42"><a href="#cb41-42" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Disponibilizar o resultado</span></span>
<span id="cb41-43"><a href="#cb41-43" aria-hidden="true" tabindex="-1"></a>                available_expressions[expr] <span class="op">=</span> instr.dest</span>
<span id="cb41-44"><a href="#cb41-44" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb41-45"><a href="#cb41-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb41-46"><a href="#cb41-46" aria-hidden="true" tabindex="-1"></a>            <span class="co"># 5. Não é expressão aritmética (ASSIGN, GOTO, etc.)</span></span>
<span id="cb41-47"><a href="#cb41-47" aria-hidden="true" tabindex="-1"></a>            result.append(instr)</span>
<span id="cb41-48"><a href="#cb41-48" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb41-49"><a href="#cb41-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="cse-global" class="level3" data-number="17.9.2">
<h3 data-number="17.9.2" class="anchored" data-anchor-id="cse-global"><span class="header-section-number">17.9.2</span> CSE Global</h3>
<p>Para CSE entre blocos básicos, precisamos de análise de disponibilidade (available expressions):</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> global_cse(cfg):</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a><span class="co">    CSE global usando análise de disponibilidade (conceitual).</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Uma expressão está disponível em um ponto se:</span></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a><span class="co">    1. Foi computada em todos os caminhos que levam a esse ponto</span></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a><span class="co">    2. Nenhum operando foi modificado desde o cálculo</span></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Passo 1: Identificar todas as expressões</span></span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>    all_expressions <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> block <span class="kw">in</span> cfg.blocks:</span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> instr <span class="kw">in</span> block.instructions:</span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> instr.op <span class="kw">in</span> [<span class="st">'+'</span>, <span class="st">'-'</span>, <span class="st">'*'</span>, <span class="st">'/'</span>]:</span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a>                all_expressions.add((instr.op, instr.arg1, instr.arg2))</span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Passo 2: Análise de disponibilidade (iteração até ponto fixo)</span></span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a>    available_in <span class="op">=</span> {block: <span class="bu">set</span>() <span class="cf">for</span> block <span class="kw">in</span> cfg.blocks}</span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a>    available_out <span class="op">=</span> {block: <span class="bu">set</span>() <span class="cf">for</span> block <span class="kw">in</span> cfg.blocks}</span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a>    changed <span class="op">=</span> <span class="va">True</span></span>
<span id="cb42-21"><a href="#cb42-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> changed:</span>
<span id="cb42-22"><a href="#cb42-22" aria-hidden="true" tabindex="-1"></a>        changed <span class="op">=</span> <span class="va">False</span></span>
<span id="cb42-23"><a href="#cb42-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> block <span class="kw">in</span> cfg.blocks:</span>
<span id="cb42-24"><a href="#cb42-24" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Available_in = intersecção dos available_out dos predecessores</span></span>
<span id="cb42-25"><a href="#cb42-25" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> block.predecessors:</span>
<span id="cb42-26"><a href="#cb42-26" aria-hidden="true" tabindex="-1"></a>                new_in <span class="op">=</span> <span class="bu">set</span>.intersection(<span class="op">*</span>[available_out[pred] </span>
<span id="cb42-27"><a href="#cb42-27" aria-hidden="true" tabindex="-1"></a>                                          <span class="cf">for</span> pred <span class="kw">in</span> block.predecessors])</span>
<span id="cb42-28"><a href="#cb42-28" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb42-29"><a href="#cb42-29" aria-hidden="true" tabindex="-1"></a>                new_in <span class="op">=</span> <span class="bu">set</span>() <span class="co"># Bloco de entrada</span></span>
<span id="cb42-30"><a href="#cb42-30" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb42-31"><a href="#cb42-31" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Propagar através do bloco (GEN/KILL)</span></span>
<span id="cb42-32"><a href="#cb42-32" aria-hidden="true" tabindex="-1"></a>            new_out <span class="op">=</span> propagate_available(new_in.copy(), block)</span>
<span id="cb42-33"><a href="#cb42-33" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb42-34"><a href="#cb42-34" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> new_out <span class="op">!=</span> available_out[block]:</span>
<span id="cb42-35"><a href="#cb42-35" aria-hidden="true" tabindex="-1"></a>                available_out[block] <span class="op">=</span> new_out</span>
<span id="cb42-36"><a href="#cb42-36" aria-hidden="true" tabindex="-1"></a>                changed <span class="op">=</span> <span class="va">True</span></span>
<span id="cb42-37"><a href="#cb42-37" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb42-38"><a href="#cb42-38" aria-hidden="true" tabindex="-1"></a>            available_in[block] <span class="op">=</span> new_in</span>
<span id="cb42-39"><a href="#cb42-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-40"><a href="#cb42-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Passo 3: Transformar código usando informação de disponibilidade</span></span>
<span id="cb42-41"><a href="#cb42-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> transform_with_cse(cfg, available_in, available_out)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="exemplo-detalhado" class="level3" data-number="17.9.3">
<h3 data-number="17.9.3" class="anchored" data-anchor-id="exemplo-detalhado"><span class="header-section-number">17.9.3</span> Exemplo Detalhado</h3>
<p><strong>Entrada</strong>:</p>
<pre class="shell"><code>t1 = a + b
t2 = c * d
t3 = a + b    # Subexpressão comum
t4 = t1 + t2</code></pre>
<p><strong>Análise (Local CSE)</strong>: 1. <code>t1 = a + b</code>: <code>available = {('+', 'a', 'b'): 't1'}</code> 2. <code>t2 = c * d</code>: <code>available = {('+', 'a', 'b'): 't1', ('*', 'c', 'd'): 't2'}</code> 3. <code>t3 = a + b</code>: Expressão <code>('+', 'a', 'b')</code> encontrada. Substituir por <code>t3 = t1</code>. 4. <code>t4 = t1 + t2</code>: <code>available = {('+', 'a', 'b'): 't1', ('*', 'c', 'd'): 't2', ('+', 't1', 't2'): 't4'}</code></p>
<p><strong>Saída</strong>:</p>
<pre class="shell"><code>t1 = a + b
t2 = c * d
t3 = t1       # Reusar resultado
t4 = t1 + t2</code></pre>
</section>
</section>
<section id="otimização-de-branches" class="level2" data-number="17.10">
<h2 data-number="17.10" class="anchored" data-anchor-id="otimização-de-branches"><span class="header-section-number">17.10</span> Otimização de Branches</h2>
<p>Simplifica estruturas de controle, eliminando saltos desnecessários e encadeamentos de branches.</p>
<section id="técnicas-implementadas" class="level3" data-number="17.10.1">
<h3 data-number="17.10.1" class="anchored" data-anchor-id="técnicas-implementadas"><span class="header-section-number">17.10.1</span> Técnicas Implementadas</h3>
<ol type="1">
<li><strong>Eliminação de Branch para Próxima Instrução</strong></li>
<li><strong>Branch Chaining</strong>: <code>goto L1; L1: goto L2</code> <span class="math inline">\(\rightarrow\)</span> <code>goto L2</code></li>
<li><strong>Eliminação de Blocos Vazios</strong> (implícito no chaining)</li>
</ol>
</section>
<section id="algoritmo-4" class="level3" data-number="17.10.2">
<h3 data-number="17.10.2" class="anchored" data-anchor-id="algoritmo-4"><span class="header-section-number">17.10.2</span> Algoritmo</h3>
<div class="sourceCode" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> build_label_map(instructions):</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Constrói mapa de labels para suas posições (índices).</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a><span class="co">        Dict {label: índice da instrução LABEL}</span></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>    label_map <span class="op">=</span> {}</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, instr <span class="kw">in</span> <span class="bu">enumerate</span>(instructions):</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> instr.op <span class="op">==</span> <span class="st">'LABEL'</span>:</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>            label_map[instr.dest] <span class="op">=</span> i</span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> label_map</span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> find_target_instruction(start_index, instructions):</span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a><span class="co">    Encontra a próxima instrução que não seja LABEL ou GOTO.</span></span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a><span class="co">    Retorna o índice da instrução real ou o destino de um GOTO.</span></span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a>    i <span class="op">=</span> start_index</span>
<span id="cb45-20"><a href="#cb45-20" aria-hidden="true" tabindex="-1"></a>    visited <span class="op">=</span> {start_index}</span>
<span id="cb45-21"><a href="#cb45-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb45-22"><a href="#cb45-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> i <span class="op">&lt;</span> <span class="bu">len</span>(instructions):</span>
<span id="cb45-23"><a href="#cb45-23" aria-hidden="true" tabindex="-1"></a>        instr <span class="op">=</span> instructions[i]</span>
<span id="cb45-24"><a href="#cb45-24" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb45-25"><a href="#cb45-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> instr.op <span class="op">==</span> <span class="st">'LABEL'</span>:</span>
<span id="cb45-26"><a href="#cb45-26" aria-hidden="true" tabindex="-1"></a>            i <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb45-27"><a href="#cb45-27" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> i <span class="kw">in</span> visited: <span class="cf">return</span> i, <span class="va">None</span> <span class="co"># Ciclo de labels</span></span>
<span id="cb45-28"><a href="#cb45-28" aria-hidden="true" tabindex="-1"></a>            visited.add(i)</span>
<span id="cb45-29"><a href="#cb45-29" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb45-30"><a href="#cb45-30" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb45-31"><a href="#cb45-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> instr.op <span class="op">==</span> <span class="st">'GOTO'</span>:</span>
<span id="cb45-32"><a href="#cb45-32" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Deve retornar o *destino* do goto</span></span>
<span id="cb45-33"><a href="#cb45-33" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="op">-</span><span class="dv">1</span>, instr.dest <span class="co"># -1 indica GOTO</span></span>
<span id="cb45-34"><a href="#cb45-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-35"><a href="#cb45-35" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Encontrou instrução real</span></span>
<span id="cb45-36"><a href="#cb45-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> i, <span class="va">None</span></span>
<span id="cb45-37"><a href="#cb45-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb45-38"><a href="#cb45-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">-</span><span class="dv">1</span>, <span class="va">None</span> <span class="co"># Fim do código</span></span>
<span id="cb45-39"><a href="#cb45-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-40"><a href="#cb45-40" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> optimize_branches(instructions):</span>
<span id="cb45-41"><a href="#cb45-41" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb45-42"><a href="#cb45-42" aria-hidden="true" tabindex="-1"></a><span class="co">    Otimiza estruturas de controle.</span></span>
<span id="cb45-43"><a href="#cb45-43" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb45-44"><a href="#cb45-44" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> []</span>
<span id="cb45-45"><a href="#cb45-45" aria-hidden="true" tabindex="-1"></a>    label_map <span class="op">=</span> build_label_map(instructions)</span>
<span id="cb45-46"><a href="#cb45-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Mapeia labels para seus alvos finais (após chains)</span></span>
<span id="cb45-47"><a href="#cb45-47" aria-hidden="true" tabindex="-1"></a>    final_targets <span class="op">=</span> {}</span>
<span id="cb45-48"><a href="#cb45-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-49"><a href="#cb45-49" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> resolve_chain(label, visited):</span>
<span id="cb45-50"><a href="#cb45-50" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> label <span class="kw">in</span> final_targets:</span>
<span id="cb45-51"><a href="#cb45-51" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> final_targets[label]</span>
<span id="cb45-52"><a href="#cb45-52" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> label <span class="kw">in</span> visited:</span>
<span id="cb45-53"><a href="#cb45-53" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> label <span class="co"># Ciclo</span></span>
<span id="cb45-54"><a href="#cb45-54" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> label <span class="kw">not</span> <span class="kw">in</span> label_map:</span>
<span id="cb45-55"><a href="#cb45-55" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> label <span class="co"># Label externo?</span></span>
<span id="cb45-56"><a href="#cb45-56" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb45-57"><a href="#cb45-57" aria-hidden="true" tabindex="-1"></a>        visited.add(label)</span>
<span id="cb45-58"><a href="#cb45-58" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb45-59"><a href="#cb45-59" aria-hidden="true" tabindex="-1"></a>        target_idx <span class="op">=</span> label_map[label]</span>
<span id="cb45-60"><a href="#cb45-60" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb45-61"><a href="#cb45-61" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Encontrar próxima instrução real após o label</span></span>
<span id="cb45-62"><a href="#cb45-62" aria-hidden="true" tabindex="-1"></a>        next_idx <span class="op">=</span> target_idx <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb45-63"><a href="#cb45-63" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span> next_idx <span class="op">&lt;</span> <span class="bu">len</span>(instructions) <span class="kw">and</span> instructions[next_idx].op <span class="op">==</span> <span class="st">'LABEL'</span>:</span>
<span id="cb45-64"><a href="#cb45-64" aria-hidden="true" tabindex="-1"></a>            next_idx <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb45-65"><a href="#cb45-65" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb45-66"><a href="#cb45-66" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> next_idx <span class="op">&lt;</span> <span class="bu">len</span>(instructions):</span>
<span id="cb45-67"><a href="#cb45-67" aria-hidden="true" tabindex="-1"></a>            next_instr <span class="op">=</span> instructions[next_idx]</span>
<span id="cb45-68"><a href="#cb45-68" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> next_instr.op <span class="op">==</span> <span class="st">'GOTO'</span>:</span>
<span id="cb45-69"><a href="#cb45-69" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Seguir o chain</span></span>
<span id="cb45-70"><a href="#cb45-70" aria-hidden="true" tabindex="-1"></a>                final_dest <span class="op">=</span> resolve_chain(next_instr.dest, visited)</span>
<span id="cb45-71"><a href="#cb45-71" aria-hidden="true" tabindex="-1"></a>                final_targets[label] <span class="op">=</span> final_dest</span>
<span id="cb45-72"><a href="#cb45-72" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> final_dest</span>
<span id="cb45-73"><a href="#cb45-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-74"><a href="#cb45-74" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Chain termina (ou não é um chain)</span></span>
<span id="cb45-75"><a href="#cb45-75" aria-hidden="true" tabindex="-1"></a>        final_targets[label] <span class="op">=</span> label</span>
<span id="cb45-76"><a href="#cb45-76" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> label</span>
<span id="cb45-77"><a href="#cb45-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-78"><a href="#cb45-78" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Resolver todos os chains</span></span>
<span id="cb45-79"><a href="#cb45-79" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> label <span class="kw">in</span> label_map:</span>
<span id="cb45-80"><a href="#cb45-80" aria-hidden="true" tabindex="-1"></a>        resolve_chain(label, <span class="bu">set</span>())</span>
<span id="cb45-81"><a href="#cb45-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-82"><a href="#cb45-82" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Reconstruir código</span></span>
<span id="cb45-83"><a href="#cb45-83" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, instr <span class="kw">in</span> <span class="bu">enumerate</span>(instructions):</span>
<span id="cb45-84"><a href="#cb45-84" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> instr.op <span class="op">==</span> <span class="st">'GOTO'</span>:</span>
<span id="cb45-85"><a href="#cb45-85" aria-hidden="true" tabindex="-1"></a>            final_dest <span class="op">=</span> final_targets.get(instr.dest, instr.dest)</span>
<span id="cb45-86"><a href="#cb45-86" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb45-87"><a href="#cb45-87" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Eliminar goto para próxima instrução</span></span>
<span id="cb45-88"><a href="#cb45-88" aria-hidden="true" tabindex="-1"></a>            next_i <span class="op">=</span> i <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb45-89"><a href="#cb45-89" aria-hidden="true" tabindex="-1"></a>            <span class="cf">while</span> next_i <span class="op">&lt;</span> <span class="bu">len</span>(instructions) <span class="kw">and</span> instructions[next_i].op <span class="op">==</span> <span class="st">'LABEL'</span>:</span>
<span id="cb45-90"><a href="#cb45-90" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> instructions[next_i].dest <span class="op">==</span> final_dest:</span>
<span id="cb45-91"><a href="#cb45-91" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">break</span></span>
<span id="cb45-92"><a href="#cb45-92" aria-hidden="true" tabindex="-1"></a>                next_i <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb45-93"><a href="#cb45-93" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb45-94"><a href="#cb45-94" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> next_i <span class="op">&lt;</span> <span class="bu">len</span>(instructions) <span class="kw">and</span> <span class="op">\</span></span>
<span id="cb45-95"><a href="#cb45-95" aria-hidden="true" tabindex="-1"></a>               instructions[next_i].op <span class="op">==</span> <span class="st">'LABEL'</span> <span class="kw">and</span> <span class="op">\</span></span>
<span id="cb45-96"><a href="#cb45-96" aria-hidden="true" tabindex="-1"></a>               instructions[next_i].dest <span class="op">==</span> final_dest:</span>
<span id="cb45-97"><a href="#cb45-97" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span> <span class="co"># Omitir instrução</span></span>
<span id="cb45-98"><a href="#cb45-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-99"><a href="#cb45-99" aria-hidden="true" tabindex="-1"></a>            result.append(Instruction(<span class="st">'GOTO'</span>, final_dest))</span>
<span id="cb45-100"><a href="#cb45-100" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb45-101"><a href="#cb45-101" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> instr.op <span class="kw">in</span> [<span class="st">'IF_GT'</span>, <span class="st">'IF_LT'</span>, <span class="st">'IF_EQ'</span>]:</span>
<span id="cb45-102"><a href="#cb45-102" aria-hidden="true" tabindex="-1"></a>            final_dest <span class="op">=</span> final_targets.get(instr.dest, instr.dest)</span>
<span id="cb45-103"><a href="#cb45-103" aria-hidden="true" tabindex="-1"></a>            result.append(Instruction(instr.op, final_dest, instr.arg1, instr.arg2))</span>
<span id="cb45-104"><a href="#cb45-104" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb45-105"><a href="#cb45-105" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb45-106"><a href="#cb45-106" aria-hidden="true" tabindex="-1"></a>            result.append(instr)</span>
<span id="cb45-107"><a href="#cb45-107" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb45-108"><a href="#cb45-108" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="exemplo-complexo" class="level3" data-number="17.10.3">
<h3 data-number="17.10.3" class="anchored" data-anchor-id="exemplo-complexo"><span class="header-section-number">17.10.3</span> Exemplo Complexo</h3>
<p><strong>Entrada</strong>:</p>
<pre class="shell"><code>    if x &lt; 10 goto L1
    goto L3
L1: goto L2
L2: goto L4
L3: y = 0
L4: z = y + 1</code></pre>
<p><strong>Análise</strong>:</p>
<ul>
<li><code>resolve_chain('L2')</code> <span class="math inline">\(\rightarrow\)</span> L4;</li>
<li><code>resolve_chain('L1')</code> <span class="math inline">\(\rightarrow\)</span> <code>resolve_chain('L2')</code> <span class="math inline">\(\rightarrow\)</span> L4;</li>
<li><code>final_targets = {'L1': 'L4', 'L2': 'L4', 'L3': 'L3', 'L4': 'L4'}</code>.</li>
</ul>
<p><strong>Saída</strong>:</p>
<pre><code>    if x &lt; 10 goto L4
    goto L3
L3: y = 0
L4: z = y + 1</code></pre>
</section>
<section id="branch-prediction-e-otimização" class="level3" data-number="17.10.4">
<h3 data-number="17.10.4" class="anchored" data-anchor-id="branch-prediction-e-otimização"><span class="header-section-number">17.10.4</span> Branch Prediction e Otimização</h3>
<p>Compiladores modernos consideram predição de branches:</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> optimize_for_branch_prediction(cfg):</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Reorganiza código para melhorar predição de branches (Conceitual).</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Heurísticas:</span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a><span class="co">    1. Colocar caso mais provável sequencialmente após o branch</span></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a><span class="co">    2. Evitar branches para trás (exceto loops)</span></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> block <span class="kw">in</span> cfg.blocks:</span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(block.successors) <span class="op">==</span> <span class="dv">2</span>:  <span class="co"># Branch condicional</span></span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>            likely, unlikely <span class="op">=</span> predict_branch(block) <span class="co"># (Usa PGO ou heurística)</span></span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Inverter condição se necessário para colocar caso</span></span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a>            <span class="co"># provável como fall-through</span></span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> unlikely <span class="kw">is</span> block.next_sequential_block:</span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a>                invert_branch_condition(block)</span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a>                swap_successors(block)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="eliminação-de-loadstore-redundantes" class="level2" data-number="17.11">
<h2 data-number="17.11" class="anchored" data-anchor-id="eliminação-de-loadstore-redundantes"><span class="header-section-number">17.11</span> Eliminação de Load/Store Redundantes</h2>
<p>Remove operações redundantes de memória quando o valor já está disponível em registrador.</p>
<section id="padrões-detectados" class="level3" data-number="17.11.1">
<h3 data-number="17.11.1" class="anchored" data-anchor-id="padrões-detectados"><span class="header-section-number">17.11.1</span> Padrões Detectados</h3>
<ol type="1">
<li><strong>Store-Load</strong>: <code>store r1, M[addr]; load r2, M[addr]</code> <span class="math inline">\(\rightarrow\)</span> <code>r2 = r1</code></li>
<li><strong>Load-Load</strong>: <code>load r1, M[addr]; load r2, M[addr]</code> <span class="math inline">\(\rightarrow\)</span> <code>r2 = r1</code></li>
<li><strong>Store-Store</strong>: <code>store r1, M[addr]; store r2, M[addr]</code> <span class="math inline">\(\rightarrow\)</span> remover primeiro store</li>
</ol>
</section>
<section id="algoritmo-5" class="level3" data-number="17.11.2">
<h3 data-number="17.11.2" class="anchored" data-anchor-id="algoritmo-5"><span class="header-section-number">17.11.2</span> Algoritmo</h3>
<div class="sourceCode" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> eliminate_redundant_memory_ops(instructions):</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Elimina loads e stores redundantes (em um bloco básico).</span></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Mantém rastreamento de:</span></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a><span class="co">    - Valor conhecido em cada endereço (addr -&gt; reg)</span></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a><span class="co">    - Registradores que foram sobrescritos</span></span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>    memory_state <span class="op">=</span> {}  <span class="co"># endereço -&gt; registrador que contém o valor</span></span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>    last_store_to <span class="op">=</span> {} <span class="co"># endereço -&gt; instrução de store</span></span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> []</span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> instr <span class="kw">in</span> instructions:</span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> instr.op <span class="op">==</span> <span class="st">'STORE'</span>: <span class="co"># store arg1, arg2 (val, addr)</span></span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a>            addr <span class="op">=</span> instr.arg2</span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a>            value_reg <span class="op">=</span> instr.arg1</span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb49-19"><a href="#cb49-19" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Store-Store: Se o último store foi para o</span></span>
<span id="cb49-20"><a href="#cb49-20" aria-hidden="true" tabindex="-1"></a>            <span class="co"># mesmo endereço, o anterior é morto.</span></span>
<span id="cb49-21"><a href="#cb49-21" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> addr <span class="kw">in</span> last_store_to:</span>
<span id="cb49-22"><a href="#cb49-22" aria-hidden="true" tabindex="-1"></a>                prev_store_instr <span class="op">=</span> last_store_to[addr]</span>
<span id="cb49-23"><a href="#cb49-23" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> prev_store_instr <span class="kw">in</span> result:</span>
<span id="cb49-24"><a href="#cb49-24" aria-hidden="true" tabindex="-1"></a>                    result.remove(prev_store_instr) <span class="co"># Remove store anterior</span></span>
<span id="cb49-25"><a href="#cb49-25" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb49-26"><a href="#cb49-26" aria-hidden="true" tabindex="-1"></a>            result.append(instr)</span>
<span id="cb49-27"><a href="#cb49-27" aria-hidden="true" tabindex="-1"></a>            memory_state[addr] <span class="op">=</span> value_reg</span>
<span id="cb49-28"><a href="#cb49-28" aria-hidden="true" tabindex="-1"></a>            last_store_to[addr] <span class="op">=</span> instr</span>
<span id="cb49-29"><a href="#cb49-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-30"><a href="#cb49-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> instr.op <span class="op">==</span> <span class="st">'LOAD'</span>: <span class="co"># load dest, arg1 (dest, addr)</span></span>
<span id="cb49-31"><a href="#cb49-31" aria-hidden="true" tabindex="-1"></a>            addr <span class="op">=</span> instr.arg1</span>
<span id="cb49-32"><a href="#cb49-32" aria-hidden="true" tabindex="-1"></a>            dest_reg <span class="op">=</span> instr.dest</span>
<span id="cb49-33"><a href="#cb49-33" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb49-34"><a href="#cb49-34" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Store-Load ou Load-Load</span></span>
<span id="cb49-35"><a href="#cb49-35" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> addr <span class="kw">in</span> memory_state:</span>
<span id="cb49-36"><a href="#cb49-36" aria-hidden="true" tabindex="-1"></a>                src_reg <span class="op">=</span> memory_state[addr]</span>
<span id="cb49-37"><a href="#cb49-37" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Substituir load por cópia de registrador</span></span>
<span id="cb49-38"><a href="#cb49-38" aria-hidden="true" tabindex="-1"></a>                result.append(Instruction(<span class="st">'ASSIGN'</span>, dest_reg, src_reg))</span>
<span id="cb49-39"><a href="#cb49-39" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Agora o dest_reg também contém o valor</span></span>
<span id="cb49-40"><a href="#cb49-40" aria-hidden="true" tabindex="-1"></a>                memory_state[addr] <span class="op">=</span> dest_reg</span>
<span id="cb49-41"><a href="#cb49-41" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb49-42"><a href="#cb49-42" aria-hidden="true" tabindex="-1"></a>                result.append(instr)</span>
<span id="cb49-43"><a href="#cb49-43" aria-hidden="true" tabindex="-1"></a>                memory_state[addr] <span class="op">=</span> dest_reg</span>
<span id="cb49-44"><a href="#cb49-44" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb49-45"><a href="#cb49-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> instr.op <span class="op">==</span> <span class="st">'CALL'</span>:</span>
<span id="cb49-46"><a href="#cb49-46" aria-hidden="true" tabindex="-1"></a>             <span class="co"># Chamada de função invalida *toda* a memória</span></span>
<span id="cb49-47"><a href="#cb49-47" aria-hidden="true" tabindex="-1"></a>             memory_state <span class="op">=</span> {}</span>
<span id="cb49-48"><a href="#cb49-48" aria-hidden="true" tabindex="-1"></a>             last_store_to <span class="op">=</span> {}</span>
<span id="cb49-49"><a href="#cb49-49" aria-hidden="true" tabindex="-1"></a>             result.append(instr)</span>
<span id="cb49-50"><a href="#cb49-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-51"><a href="#cb49-51" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb49-52"><a href="#cb49-52" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Outra instrução (ex: t1 = a + b)</span></span>
<span id="cb49-53"><a href="#cb49-53" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> instr.dest:</span>
<span id="cb49-54"><a href="#cb49-54" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Se t1 foi modificado, invalida estados</span></span>
<span id="cb49-55"><a href="#cb49-55" aria-hidden="true" tabindex="-1"></a>                <span class="co"># que dependiam dele</span></span>
<span id="cb49-56"><a href="#cb49-56" aria-hidden="true" tabindex="-1"></a>                memory_state <span class="op">=</span> {addr: reg <span class="cf">for</span> addr, reg <span class="kw">in</span> memory_state.items()</span>
<span id="cb49-57"><a href="#cb49-57" aria-hidden="true" tabindex="-1"></a>                                <span class="cf">if</span> reg <span class="op">!=</span> instr.dest}</span>
<span id="cb49-58"><a href="#cb49-58" aria-hidden="true" tabindex="-1"></a>            result.append(instr)</span>
<span id="cb49-59"><a href="#cb49-59" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb49-60"><a href="#cb49-60" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="exemplo-com-store-load" class="level3" data-number="17.11.3">
<h3 data-number="17.11.3" class="anchored" data-anchor-id="exemplo-com-store-load"><span class="header-section-number">17.11.3</span> Exemplo com Store-Load</h3>
<p><strong>Entrada</strong>:</p>
<pre><code>t1 = 10
store t1, M[200]
t2 = load M[200]
t3 = t2 + 5</code></pre>
<p><strong>Análise</strong>: 1. <code>t1 = 10</code> 2. <code>store t1, M[200]</code>: <code>memory_state = {'M[200]': 't1'}</code> 3. <code>t2 = load M[200]</code>: Endereço <code>M[200]</code> está em <code>memory_state</code>, vindo de <code>t1</code>. Substituir. 4. Instrução gerada: <code>t2 = t1</code>. <code>memory_state = {'M[200]': 't2'}</code> (pois <code>t2</code> agora também tem o valor).</p>
<p><strong>Saída</strong>:</p>
<pre><code>t1 = 10
store t1, M[200]
t2 = t1            # Substituir load por cópia
t3 = t2 + 5</code></pre>
</section>
</section>
<section id="eliminação-de-código-inalcançável" class="level2" data-number="17.12">
<h2 data-number="17.12" class="anchored" data-anchor-id="eliminação-de-código-inalcançável"><span class="header-section-number">17.12</span> Eliminação de Código Inalcançável</h2>
<p>Remove código que nunca pode ser executado porque não há caminho de controle que leve até ele.</p>
<section id="algoritmo-baseado-em-alcançabilidade" class="level3" data-number="17.12.1">
<h3 data-number="17.12.1" class="anchored" data-anchor-id="algoritmo-baseado-em-alcançabilidade"><span class="header-section-number">17.12.1</span> Algoritmo Baseado em Alcançabilidade</h3>
<div class="sourceCode" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> eliminate_unreachable_code(cfg):</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Remove código inalcançável usando busca em grafos.</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a><span class="co">        cfg: Control Flow Graph</span></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a><span class="co">        CFG com blocos inalcançáveis removidos</span></span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Passo 1: Marcar blocos alcançáveis</span></span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a>    reachable <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a>    worklist <span class="op">=</span> [cfg.entry_block]</span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> worklist:</span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a>        block <span class="op">=</span> worklist.pop()</span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb52-18"><a href="#cb52-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> block <span class="kw">in</span> reachable:</span>
<span id="cb52-19"><a href="#cb52-19" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb52-20"><a href="#cb52-20" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb52-21"><a href="#cb52-21" aria-hidden="true" tabindex="-1"></a>        reachable.add(block)</span>
<span id="cb52-22"><a href="#cb52-22" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb52-23"><a href="#cb52-23" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Adicionar sucessores</span></span>
<span id="cb52-24"><a href="#cb52-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> successor <span class="kw">in</span> block.successors:</span>
<span id="cb52-25"><a href="#cb52-25" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> successor <span class="kw">not</span> <span class="kw">in</span> reachable:</span>
<span id="cb52-26"><a href="#cb52-26" aria-hidden="true" tabindex="-1"></a>                worklist.append(successor)</span>
<span id="cb52-27"><a href="#cb52-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb52-28"><a href="#cb52-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Passo 2: Remover blocos inalcançáveis</span></span>
<span id="cb52-29"><a href="#cb52-29" aria-hidden="true" tabindex="-1"></a>    cfg.blocks <span class="op">=</span> [b <span class="cf">for</span> b <span class="kw">in</span> cfg.blocks <span class="cf">if</span> b <span class="kw">in</span> reachable]</span>
<span id="cb52-30"><a href="#cb52-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb52-31"><a href="#cb52-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Passo 3: Limpar referências para blocos removidos</span></span>
<span id="cb52-32"><a href="#cb52-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> block <span class="kw">in</span> cfg.blocks:</span>
<span id="cb52-33"><a href="#cb52-33" aria-hidden="true" tabindex="-1"></a>        block.successors <span class="op">=</span> [s <span class="cf">for</span> s <span class="kw">in</span> block.successors <span class="cf">if</span> s <span class="kw">in</span> reachable]</span>
<span id="cb52-34"><a href="#cb52-34" aria-hidden="true" tabindex="-1"></a>        block.predecessors <span class="op">=</span> [p <span class="cf">for</span> p <span class="kw">in</span> block.predecessors <span class="cf">if</span> p <span class="kw">in</span> reachable]</span>
<span id="cb52-35"><a href="#cb52-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb52-36"><a href="#cb52-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> cfg</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="eliminação-de-código-após-return" class="level3" data-number="17.12.2">
<h3 data-number="17.12.2" class="anchored" data-anchor-id="eliminação-de-código-após-return"><span class="header-section-number">17.12.2</span> Eliminação de Código Após Return</h3>
<p>Caso especial comum: código após return incondicional.</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> eliminate_code_after_return(instructions):</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Remove instruções após return ou goto incondicional.</span></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a><span class="co">    (Em um bloco básico linear)</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> []</span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>    in_dead_code <span class="op">=</span> <span class="va">False</span></span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> instr <span class="kw">in</span> instructions:</span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> instr.op <span class="op">==</span> <span class="st">'LABEL'</span>:</span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Label inicia novo bloco potencialmente alcançável</span></span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a>            in_dead_code <span class="op">=</span> <span class="va">False</span></span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a>            result.append(instr)</span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> <span class="kw">not</span> in_dead_code:</span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a>            result.append(instr)</span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb53-18"><a href="#cb53-18" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Return ou goto incondicional tornam código seguinte morto</span></span>
<span id="cb53-19"><a href="#cb53-19" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> instr.op <span class="kw">in</span> [<span class="st">'RETURN'</span>, <span class="st">'GOTO'</span>]:</span>
<span id="cb53-20"><a href="#cb53-20" aria-hidden="true" tabindex="-1"></a>                in_dead_code <span class="op">=</span> <span class="va">True</span></span>
<span id="cb53-21"><a href="#cb53-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb53-22"><a href="#cb53-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="análise-de-condições-constantes" class="level3" data-number="17.12.3">
<h3 data-number="17.12.3" class="anchored" data-anchor-id="análise-de-condições-constantes"><span class="header-section-number">17.12.3</span> Análise de Condições Constantes</h3>
<p>Branches com condições constantes revelam código inalcançável:</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> evaluate_condition(instr):</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Tenta avaliar condição em tempo de compilação.</span></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a><span class="co">        True, False, ou None (se não pode determinar)</span></span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> is_constant(instr.arg1) <span class="kw">or</span> <span class="kw">not</span> is_constant(instr.arg2):</span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>    val1, val2 <span class="op">=</span> instr.arg1, instr.arg2</span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> instr.op <span class="op">==</span> <span class="st">'IF_GT'</span>: <span class="cf">return</span> val1 <span class="op">&gt;</span> val2</span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> instr.op <span class="op">==</span> <span class="st">'IF_LT'</span>: <span class="cf">return</span> val1 <span class="op">&lt;</span> val2</span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> instr.op <span class="op">==</span> <span class="st">'IF_EQ'</span>: <span class="cf">return</span> val1 <span class="op">==</span> val2</span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb54-18"><a href="#cb54-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-19"><a href="#cb54-19" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> eliminate_constant_branches(instructions):</span>
<span id="cb54-20"><a href="#cb54-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb54-21"><a href="#cb54-21" aria-hidden="true" tabindex="-1"></a><span class="co">    Remove código inalcançável devido a condições constantes.</span></span>
<span id="cb54-22"><a href="#cb54-22" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb54-23"><a href="#cb54-23" aria-hidden="true" tabindex="-1"></a><span class="co">    if true goto L1 → goto L1 (código após é inalcançável)</span></span>
<span id="cb54-24"><a href="#cb54-24" aria-hidden="true" tabindex="-1"></a><span class="co">    if false goto L1 → remove branch (código em L1 pode ser inalcançável)</span></span>
<span id="cb54-25"><a href="#cb54-25" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb54-26"><a href="#cb54-26" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> []</span>
<span id="cb54-27"><a href="#cb54-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-28"><a href="#cb54-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, instr <span class="kw">in</span> <span class="bu">enumerate</span>(instructions):</span>
<span id="cb54-29"><a href="#cb54-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> instr.op <span class="kw">in</span> [<span class="st">'IF_GT'</span>, <span class="st">'IF_LT'</span>, <span class="st">'IF_EQ'</span>]:</span>
<span id="cb54-30"><a href="#cb54-30" aria-hidden="true" tabindex="-1"></a>            condition_result <span class="op">=</span> evaluate_condition(instr)</span>
<span id="cb54-31"><a href="#cb54-31" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb54-32"><a href="#cb54-32" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> condition_result <span class="kw">is</span> <span class="va">True</span>:</span>
<span id="cb54-33"><a href="#cb54-33" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Condição sempre verdadeira</span></span>
<span id="cb54-34"><a href="#cb54-34" aria-hidden="true" tabindex="-1"></a>                result.append(Instruction(<span class="st">'GOTO'</span>, instr.dest))</span>
<span id="cb54-35"><a href="#cb54-35" aria-hidden="true" tabindex="-1"></a>                <span class="co"># O código seguinte (até um label) </span></span>
<span id="cb54-36"><a href="#cb54-36" aria-hidden="true" tabindex="-1"></a>                <span class="co"># será pego por eliminate_code_after_return</span></span>
<span id="cb54-37"><a href="#cb54-37" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb54-38"><a href="#cb54-38" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> condition_result <span class="kw">is</span> <span class="va">False</span>:</span>
<span id="cb54-39"><a href="#cb54-39" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Condição sempre falsa, remover branch</span></span>
<span id="cb54-40"><a href="#cb54-40" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb54-41"><a href="#cb54-41" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb54-42"><a href="#cb54-42" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb54-43"><a href="#cb54-43" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Condição não constante</span></span>
<span id="cb54-44"><a href="#cb54-44" aria-hidden="true" tabindex="-1"></a>                result.append(instr)</span>
<span id="cb54-45"><a href="#cb54-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb54-46"><a href="#cb54-46" aria-hidden="true" tabindex="-1"></a>            result.append(instr)</span>
<span id="cb54-47"><a href="#cb54-47" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-48"><a href="#cb54-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="exemplo-completo-1" class="level3" data-number="17.12.4">
<h3 data-number="17.12.4" class="anchored" data-anchor-id="exemplo-completo-1"><span class="header-section-number">17.12.4</span> Exemplo Completo</h3>
<p><strong>Entrada</strong>:</p>
<pre><code>if x &gt; 10 goto L2
goto L3
L1: a = 5         # Inalcançável - nenhum branch para L1
L2: b = 20
    goto L4
    c = 30        # Inalcançável - após goto
L3: d = 15
L4: result = b + d</code></pre>
<p><strong>Análise de Alcançabilidade</strong>: 1. <code>eliminate_code_after_return</code> remove <code>c = 30</code>. 2. <code>eliminate_unreachable_code(cfg)</code> (busca no grafo) não encontraria <code>L1</code>.</p>
<p><strong>Saída</strong>:</p>
<pre><code>if x &gt; 10 goto L2
goto L3
L2: b = 20
    goto L4
L3: d = 15
L4: result = b + d</code></pre>
</section>
</section>
<section id="integração-e-ordem-de-aplicação" class="level2" data-number="17.13">
<h2 data-number="17.13" class="anchored" data-anchor-id="integração-e-ordem-de-aplicação"><span class="header-section-number">17.13</span> Integração e Ordem de Aplicação</h2>
<p>As otimizações <em>peephole</em> devem ser aplicadas em ordem estratégica, pois uma pode habilitar outra.</p>
<section id="pipeline-de-otimização" class="level3" data-number="17.13.1">
<h3 data-number="17.13.1" class="anchored" data-anchor-id="pipeline-de-otimização"><span class="header-section-number">17.13.1</span> Pipeline de Otimização</h3>
<div class="sourceCode" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> optimize_code(instructions, max_iterations<span class="op">=</span><span class="dv">10</span>):</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Aplica otimizações _peephole_ iterativamente até convergência.</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a><span class="co">    (Assumindo que 'instructions' é um único bloco básico)</span></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a><span class="co">        instructions: Código TAC inicial</span></span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a><span class="co">        max_iterations: Limite de iterações</span></span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a><span class="co">        Código otimizado</span></span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a>    code <span class="op">=</span> instructions</span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a>    iteration <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb57-16"><a href="#cb57-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> iteration <span class="op">&lt;</span> max_iterations:</span>
<span id="cb57-17"><a href="#cb57-17" aria-hidden="true" tabindex="-1"></a>        old_code <span class="op">=</span> code</span>
<span id="cb57-18"><a href="#cb57-18" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb57-19"><a href="#cb57-19" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Fase 1: Simplificação e redução</span></span>
<span id="cb57-20"><a href="#cb57-20" aria-hidden="true" tabindex="-1"></a>        code <span class="op">=</span> algebraic_simplification(code)</span>
<span id="cb57-21"><a href="#cb57-21" aria-hidden="true" tabindex="-1"></a>        code <span class="op">=</span> strength_reduction(code)</span>
<span id="cb57-22"><a href="#cb57-22" aria-hidden="true" tabindex="-1"></a>        code <span class="op">=</span> constant_propagation(code) <span class="co"># Inclui folding</span></span>
<span id="cb57-23"><a href="#cb57-23" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb57-24"><a href="#cb57-24" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Fase 2: Eliminação de redundâncias</span></span>
<span id="cb57-25"><a href="#cb57-25" aria-hidden="true" tabindex="-1"></a>        code <span class="op">=</span> copy_propagation(code)</span>
<span id="cb57-26"><a href="#cb57-26" aria-hidden="true" tabindex="-1"></a>        code <span class="op">=</span> local_cse(code)</span>
<span id="cb57-27"><a href="#cb57-27" aria-hidden="true" tabindex="-1"></a>        code <span class="op">=</span> eliminate_redundant_memory_ops(code)</span>
<span id="cb57-28"><a href="#cb57-28" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb57-29"><a href="#cb57-29" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Fase 3: Otimização de controle (limitada a bloco básico)</span></span>
<span id="cb57-30"><a href="#cb57-30" aria-hidden="true" tabindex="-1"></a>        code <span class="op">=</span> eliminate_constant_branches(code)</span>
<span id="cb57-31"><a href="#cb57-31" aria-hidden="true" tabindex="-1"></a>        code <span class="op">=</span> eliminate_code_after_return(code)</span>
<span id="cb57-32"><a href="#cb57-32" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb57-33"><a href="#cb57-33" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Fase 4: Limpeza</span></span>
<span id="cb57-34"><a href="#cb57-34" aria-hidden="true" tabindex="-1"></a>        <span class="co"># (Dead Code Elimination total requer análise de liveness global)</span></span>
<span id="cb57-35"><a href="#cb57-35" aria-hidden="true" tabindex="-1"></a>        <span class="co"># code = eliminate_dead_code(code) # (Pode ser caro iterar)</span></span>
<span id="cb57-36"><a href="#cb57-36" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb57-37"><a href="#cb57-37" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Convergiu? (requer __eq__ na classe Instruction)</span></span>
<span id="cb57-38"><a href="#cb57-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> code <span class="op">==</span> old_code:</span>
<span id="cb57-39"><a href="#cb57-39" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="cb57-40"><a href="#cb57-40" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb57-41"><a href="#cb57-41" aria-hidden="true" tabindex="-1"></a>        iteration <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb57-42"><a href="#cb57-42" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb57-43"><a href="#cb57-43" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Executar DCE uma vez no final</span></span>
<span id="cb57-44"><a href="#cb57-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># (Requer análise de liveness global para ser 100% correto)</span></span>
<span id="cb57-45"><a href="#cb57-45" aria-hidden="true" tabindex="-1"></a>    code <span class="op">=</span> eliminate_dead_code(code) </span>
<span id="cb57-46"><a href="#cb57-46" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb57-47"><a href="#cb57-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> code</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="métricas-de-otimização" class="level3" data-number="17.13.2">
<h3 data-number="17.13.2" class="anchored" data-anchor-id="métricas-de-otimização"><span class="header-section-number">17.13.2</span> Métricas de Otimização</h3>
<div class="sourceCode" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> count_expensive_ops(instructions):</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Conta operações custosas (multiplicação, divisão, etc.)."""</span></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>    expensive <span class="op">=</span> [<span class="st">'*'</span>, <span class="st">'/'</span>, <span class="st">'**'</span>, <span class="st">'LOAD'</span>, <span class="st">'STORE'</span>]</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">sum</span>(<span class="dv">1</span> <span class="cf">for</span> instr <span class="kw">in</span> instructions <span class="cf">if</span> instr.op <span class="kw">in</span> expensive)</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> count_temporaries(instructions):</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>    temps <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> instr <span class="kw">in</span> instructions:</span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> instr.dest <span class="kw">and</span> instr.dest.startswith(<span class="st">'t'</span>):</span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>            temps.add(instr.dest)</span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">len</span>(temps)</span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_optimization_metrics(original, optimized):</span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb58-15"><a href="#cb58-15" aria-hidden="true" tabindex="-1"></a><span class="co">    Calcula métricas para avaliar eficácia das otimizações.</span></span>
<span id="cb58-16"><a href="#cb58-16" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb58-17"><a href="#cb58-17" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb58-18"><a href="#cb58-18" aria-hidden="true" tabindex="-1"></a><span class="co">        Dict com métricas</span></span>
<span id="cb58-19"><a href="#cb58-19" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb58-20"><a href="#cb58-20" aria-hidden="true" tabindex="-1"></a>    original_len <span class="op">=</span> <span class="bu">len</span>(original)</span>
<span id="cb58-21"><a href="#cb58-21" aria-hidden="true" tabindex="-1"></a>    optimized_len <span class="op">=</span> <span class="bu">len</span>(optimized)</span>
<span id="cb58-22"><a href="#cb58-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb58-23"><a href="#cb58-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb58-24"><a href="#cb58-24" aria-hidden="true" tabindex="-1"></a>        <span class="st">'original_instructions'</span>: original_len,</span>
<span id="cb58-25"><a href="#cb58-25" aria-hidden="true" tabindex="-1"></a>        <span class="st">'optimized_instructions'</span>: optimized_len,</span>
<span id="cb58-26"><a href="#cb58-26" aria-hidden="true" tabindex="-1"></a>        <span class="st">'instructions_removed'</span>: original_len <span class="op">-</span> optimized_len,</span>
<span id="cb58-27"><a href="#cb58-27" aria-hidden="true" tabindex="-1"></a>        <span class="st">'reduction_percentage'</span>: </span>
<span id="cb58-28"><a href="#cb58-28" aria-hidden="true" tabindex="-1"></a>            <span class="dv">100</span> <span class="op">*</span> (original_len <span class="op">-</span> optimized_len) <span class="op">/</span> original_len <span class="cf">if</span> original_len <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span>,</span>
<span id="cb58-29"><a href="#cb58-29" aria-hidden="true" tabindex="-1"></a>        <span class="st">'expensive_ops_reduced'</span>: </span>
<span id="cb58-30"><a href="#cb58-30" aria-hidden="true" tabindex="-1"></a>            count_expensive_ops(original) <span class="op">-</span> count_expensive_ops(optimized),</span>
<span id="cb58-31"><a href="#cb58-31" aria-hidden="true" tabindex="-1"></a>        <span class="st">'temporary_vars_eliminated'</span>:</span>
<span id="cb58-32"><a href="#cb58-32" aria-hidden="true" tabindex="-1"></a>            count_temporaries(original) <span class="op">-</span> count_temporaries(optimized)</span>
<span id="cb58-33"><a href="#cb58-33" aria-hidden="true" tabindex="-1"></a>    }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="considerações-de-implementação" class="level2" data-number="17.14">
<h2 data-number="17.14" class="anchored" data-anchor-id="considerações-de-implementação"><span class="header-section-number">17.14</span> Considerações de Implementação</h2>
<section id="representação-eficiente" class="level3" data-number="17.14.1">
<h3 data-number="17.14.1" class="anchored" data-anchor-id="representação-eficiente"><span class="header-section-number">17.14.1</span> Representação Eficiente</h3>
<p>Para compiladores de produção, usar estruturas de dados mais sofisticadas:</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> BasicBlock:</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Bloco básico otimizado com caching de análises."""</span></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, instructions):</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.instructions <span class="op">=</span> instructions</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.predecessors <span class="op">=</span> []</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.successors <span class="op">=</span> []</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._use_def_cache <span class="op">=</span> <span class="va">None</span></span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._dominators_cache <span class="op">=</span> <span class="va">None</span></span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">@property</span></span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> use_def_chains(<span class="va">self</span>):</span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>._use_def_cache <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb59-13"><a href="#cb59-13" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>._use_def_cache <span class="op">=</span> build_use_def_chains(<span class="va">self</span>.instructions)</span>
<span id="cb59-14"><a href="#cb59-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>._use_def_cache</span>
<span id="cb59-15"><a href="#cb59-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb59-16"><a href="#cb59-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> invalidate_caches(<span class="va">self</span>):</span>
<span id="cb59-17"><a href="#cb59-17" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Invalida caches após modificação."""</span></span>
<span id="cb59-18"><a href="#cb59-18" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._use_def_cache <span class="op">=</span> <span class="va">None</span></span>
<span id="cb59-19"><a href="#cb59-19" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._dominators_cache <span class="op">=</span> <span class="va">None</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="tratamento-de-tipos" class="level3" data-number="17.14.2">
<h3 data-number="17.14.2" class="anchored" data-anchor-id="tratamento-de-tipos"><span class="header-section-number">17.14.2</span> Tratamento de Tipos</h3>
<p>Otimizações devem preservar semântica de tipos:</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> type_safe_optimization(instr):</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Verifica se otimização preserva semântica de tipos.</span></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> instr.op <span class="op">==</span> <span class="st">'*'</span> <span class="kw">and</span> is_power_of_2(instr.arg2):</span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Só aplicar shift se tipos são inteiros</span></span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> get_type(instr.arg1) <span class="op">==</span> <span class="st">'int'</span> <span class="kw">and</span> get_type(instr.dest) <span class="op">==</span> <span class="st">'int'</span>:</span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> reduce_strength(instr)</span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> instr</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="exercícios" class="level2" data-number="17.15">
<h2 data-number="17.15" class="anchored" data-anchor-id="exercícios"><span class="header-section-number">17.15</span> Exercícios</h2>
<section id="exercício-1-otimização-completa" class="level3" data-number="17.15.1">
<h3 data-number="17.15.1" class="anchored" data-anchor-id="exercício-1-otimização-completa"><span class="header-section-number">17.15.1</span> Exercício 1: Otimização Completa</h3>
<p>Aplique todas as otimizações ao seguinte código:</p>
<pre><code>a = 7
b = a + 0
c = b * 2
d = c - a
e = d / 1
f = a + 0
result = e + f
RETURN result</code></pre>
<p><strong>Solução</strong>:</p>
<ol type="1">
<li><strong>(Iteração 1) Alg. Simp</strong>:
<ul>
<li><code>b = a + 0</code> <span class="math inline">\(\rightarrow\)</span> <code>b = a</code></li>
<li><code>e = d / 1</code> <span class="math inline">\(\rightarrow\)</span> <code>e = d</code></li>
<li><code>f = a + 0</code> <span class="math inline">\(\rightarrow\)</span> <code>f = a</code> Código: <code>a=7, b=a, c=b*2, d=c-a, e=d, f=a, result=e+f, RETURN result</code></li>
</ul></li>
<li><strong>(Iteração 1) Const. Prop</strong>:
<ul>
<li><code>a = 7</code> <span class="math inline">\(\rightarrow\)</span> <code>constants = {a: 7}</code></li>
<li><code>b = a</code> (Copy Prop) <span class="math inline">\(\rightarrow\)</span> <code>b = 7</code> (Const Prop) <span class="math inline">\(\rightarrow\)</span> <code>constants = {a: 7, b: 7}</code></li>
<li><code>c = b * 2</code> <span class="math inline">\(\rightarrow\)</span> <code>c = 7 * 2</code> <span class="math inline">\(\rightarrow\)</span> <code>c = 14</code> <span class="math inline">\(\rightarrow\)</span> <code>constants = {..., c: 14}</code></li>
<li><code>d = c - a</code> <span class="math inline">\(\rightarrow\)</span> <code>d = 14 - 7</code> <span class="math inline">\(\rightarrow\)</span> <code>d = 7</code> <span class="math inline">\(\rightarrow\)</span> <code>constants = {..., d: 7}</code></li>
<li><code>e = d</code> <span class="math inline">\(\rightarrow\)</span> <code>e = 7</code> <span class="math inline">\(\rightarrow\)</span> <code>constants = {..., e: 7}</code></li>
<li><code>f = a</code> <span class="math inline">\(\rightarrow\)</span> <code>f = 7</code> <span class="math inline">\(\rightarrow\)</span> <code>constants = {..., f: 7}</code></li>
<li><code>result = e + f</code> <span class="math inline">\(\rightarrow\)</span> <code>result = 7 + 7</code> <span class="math inline">\(\rightarrow\)</span> <code>result = 14</code> <span class="math inline">\(\rightarrow\)</span> <code>constants = {..., result: 14}</code> Código: <code>a=7, b=7, c=14, d=7, e=7, f=7, result=14, RETURN 14</code></li>
</ul></li>
<li><strong>(Iteração 2) Dead Code Elimination</strong>:
<ul>
<li><code>RETURN 14</code> é essencial. (A instrução <code>result = 14</code> define <code>result</code>, que é usado por <code>RETURN result</code> no código <em>antes</em> da propagação para o <code>RETURN</code>).</li>
<li>Assumindo <code>RETURN result</code> é o final, <code>result</code> é vivo.</li>
<li><code>result = 14</code> define <code>result</code>. É vivo.</li>
<li><code>a, b, c, d, e, f</code> não são usados por nenhuma instrução viva.</li>
<li>Código: <code>result = 14, RETURN result</code></li>
</ul></li>
<li><strong>(Iteração 3) Const Prop / Copy Prop</strong>:
<ul>
<li><code>RETURN result</code> <span class="math inline">\(\rightarrow\)</span> <code>RETURN 14</code></li>
<li>Código: <code>result = 14, RETURN 14</code></li>
</ul></li>
<li><strong>(Iteração 4) Dead Code</strong>:
<ul>
<li><code>RETURN 14</code> é essencial.</li>
<li><code>result = 14</code> define <code>result</code>, que não é mais usado. É morto.</li>
</ul></li>
</ol>
<p><strong>Código final</strong>:</p>
<pre><code>RETURN 14</code></pre>
</section>
<section id="exercício-2-strength-reduction-em-loop" class="level3" data-number="17.15.2">
<h3 data-number="17.15.2" class="anchored" data-anchor-id="exercício-2-strength-reduction-em-loop"><span class="header-section-number">17.15.2</span> Exercício 2: Strength Reduction em Loop</h3>
<p>Otimize o seguinte loop:</p>
<pre><code>i = 0
L1: if i &gt;= n goto L2
    t1 = i * 4
    a[t1] = 0
    i = i + 1
    goto L1
L2: return</code></pre>
<p><strong>Solução</strong>: Aplicar strength reduction substituindo multiplicação por adição (variável de indução).</p>
<pre><code>i = 0
j = 0  # Variável de indução j = i * 4
L1: if i &gt;= n goto L2
    a[j] = 0
    i = i + 1
    j = j + 4  # Incrementar j pelo passo (4)
    goto L1
L2: return</code></pre>
</section>
<section id="exercício-3-cse-e-dead-code" class="level3" data-number="17.15.3">
<h3 data-number="17.15.3" class="anchored" data-anchor-id="exercício-3-cse-e-dead-code"><span class="header-section-number">17.15.3</span> Exercício 3: CSE e Dead Code</h3>
<p>Identifique subexpressões comuns e código morto:</p>
<pre><code>t1 = a + b
t2 = c * d
t3 = a + b
t4 = t1 + t3
t5 = t2 - t2
result = t4
RETURN result</code></pre>
<p><strong>Solução</strong>:</p>
<ol type="1">
<li><strong>CSE</strong>: <code>t3 = a + b</code> é comum com <code>t1</code>.
<ul>
<li>Substituir: <code>t3 = t1</code> Código: <code>t1=a+b, t2=c*d, t3=t1, t4=t1+t3, t5=t2-t2, result=t4, RETURN result</code></li>
</ul></li>
<li><strong>Copy Propagation</strong>:
<ul>
<li><code>t4 = t1 + t3</code> <span class="math inline">\(\rightarrow\)</span> <code>t4 = t1 + t1</code> Código: <code>t1=a+b, t2=c*d, t3=t1, t4=t1+t1, t5=t2-t2, result=t4, RETURN result</code></li>
</ul></li>
<li><strong>Algebraic Simplification</strong>:
<ul>
<li><code>t5 = t2 - t2</code> <span class="math inline">\(\rightarrow\)</span> <code>t5 = 0</code></li>
<li>(Opcional) <code>t4 = t1 + t1</code> <span class="math inline">\(\rightarrow\)</span> <code>t4 = t1 * 2</code> (ou <code>t4 = t1 &lt;&lt; 1</code>) Código: <code>t1=a+b, t2=c*d, t3=t1, t4=t1*2, t5=0, result=t4, RETURN result</code></li>
</ul></li>
<li><strong>Dead Code Elimination</strong>:
<ul>
<li><code>RETURN result</code> é vivo.</li>
<li><code>result = t4</code> é vivo.</li>
<li><code>t4 = t1 * 2</code> é vivo.</li>
<li><code>t1 = a + b</code> é vivo.</li>
<li><code>t2 = c * d</code>, <code>t3 = t1</code>, <code>t5 = 0</code> são mortos (seus resultados não são usados).</li>
</ul></li>
<li><strong>Código otimizado</strong>:</li>
</ol>
<pre><code>t1 = a + b
t4 = t1 * 2
result = t4
RETURN result</code></pre>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/frankalcantara\.com");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./15-llvmIR.html" class="pagination-link" aria-label="Introdução à Representação Intermediária (IR) do **LLVM** com C++">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Introdução à Representação Intermediária (IR) do <strong>LLVM</strong> com C++</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./19-mlir-sintaxe.html" class="pagination-link" aria-label="**MLIR** 101: Nosso Primeiro Exemplo e Sintaxe Básica">
        <span class="nav-page-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title"><strong>MLIR</strong> 101: Nosso Primeiro Exemplo e Sintaxe Básica</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
<p>Copyright © 2025 Frank de Alcantara</p>
<div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/frankalcantara/linguagens-formais/edit/main/16-peepOtimiza.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/frankalcantara/linguagens-formais/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>