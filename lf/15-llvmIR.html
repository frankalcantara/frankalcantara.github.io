<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.553">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Linguagens Formais e Autômatos - 16&nbsp; Introdução à Representação Intermediária (IR) do LLVM com C++</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./16-peepOtimiza.html" rel="next">
<link href="./14-GeraInter.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles/custom.css">
</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./14-GeraInter.html">Geração de Código Intermediário</a></li><li class="breadcrumb-item"><a href="./15-llvmIR.html"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Introdução à Representação Intermediária (IR) do LLVM com C++</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Linguagens Formais e Autômatos</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/frankalcantara/linguagens-formais" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Disciplina de Linguagens Formais</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Analisadores Léxicos</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-lexico.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Analisadores Léxicos</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01a-lexico.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Alfabetos, Linguagens e Strings: Fundamentos Matemáticos</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-lexico.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Autômatos Finitos Determinísticos</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">Analisadores Sintáticos</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04-Gramaticas.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Gramáticas e Linguagens Livres de Contexto</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05-parsersLL1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Parsers LL(1): Começando a Análise Sintática</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06-first-follow.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Conjuntos FIRST e FOLLOW</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07-parserLR1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Parsers <span class="math inline">\(LR(1)\)</span>: Análise Sintática <em>bottom-up</em></span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08-parserSLR1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Parsers <span class="math inline">\(SLR(1)\)</span>: A Ponte Entre Simplicidade e Poder</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
 <span class="menu-text">Analisadores Semânticos</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10-semantico.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Analisadores Semânticos: a determinação do significado</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10a-semantico.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Fundamentos Matemáticos da Semântica</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10b-semantico.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Julgamento de Tipos em Linguagens Imperativas</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10c-semantico.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">O Sistema de Tipos Hindley-Milner</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./11-tabelaSimbolos.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Tabela de Símbolos em Compiladores Modernos</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
 <span class="menu-text">Geração de Código Intermediário</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./14-GeraInter.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Geração de Código Intermediário: A Linguagem Universal do Compilador</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./15-llvmIR.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Introdução à Representação Intermediária (IR) do LLVM com C++</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./16-peepOtimiza.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Otimizações Peephole: Algoritmos e Técnicas em Código Intermediário</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">
 <span class="menu-text">Projetos da Disciplina - 2025-2</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./fase1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Fase 1 - Projeto Prático</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./fase2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Fase 2 - Analisador Sintático <span class="math inline">\(LL(1)\)</span></span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./fase3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Fase 3 - Analisador Semântico</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./apend1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Apêndice 1: A Relação de Myhill-Nerode</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./sol-exercicios.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">Solução dos Exercícios</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./referencias.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Referências</span></a>
  </div>
</li>
    </ul>
    </div>
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Sumário</h2>
   
  <ul>
  <li><a href="#configuração-do-ambiente-ubuntu-vs-code-c-e-llvm" id="toc-configuração-do-ambiente-ubuntu-vs-code-c-e-llvm" class="nav-link active" data-scroll-target="#configuração-do-ambiente-ubuntu-vs-code-c-e-llvm"><span class="header-section-number">16.1</span> Configuração do Ambiente (Ubuntu, VS Code, C++ e LLVM)</a>
  <ul class="collapse">
  <li><a href="#pré-requisitos" id="toc-pré-requisitos" class="nav-link" data-scroll-target="#pré-requisitos"><span class="header-section-number">16.1.1</span> Pré-requisitos</a></li>
  <li><a href="#instalação-do-llvmclang" id="toc-instalação-do-llvmclang" class="nav-link" data-scroll-target="#instalação-do-llvmclang"><span class="header-section-number">16.1.2</span> Instalação do LLVM/Clang</a></li>
  <li><a href="#instalação-do-vs-code-e-extensões" id="toc-instalação-do-vs-code-e-extensões" class="nav-link" data-scroll-target="#instalação-do-vs-code-e-extensões"><span class="header-section-number">16.1.3</span> Instalação do VS Code e Extensões</a></li>
  <li><a href="#criar-diretório-de-trabalho" id="toc-criar-diretório-de-trabalho" class="nav-link" data-scroll-target="#criar-diretório-de-trabalho"><span class="header-section-number">16.1.4</span> Criar Diretório de Trabalho</a></li>
  </ul></li>
  <li><a href="#fundamentos-teóricos-do-llvm-ir" id="toc-fundamentos-teóricos-do-llvm-ir" class="nav-link" data-scroll-target="#fundamentos-teóricos-do-llvm-ir"><span class="header-section-number">16.2</span> Fundamentos Teóricos do <strong>LLVM IR</strong></a>
  <ul class="collapse">
  <li><a href="#o-que-é-llvm" id="toc-o-que-é-llvm" class="nav-link" data-scroll-target="#o-que-é-llvm"><span class="header-section-number">16.2.1</span> O que é LLVM?</a></li>
  <li><a href="#o-que-é-llvm-ir" id="toc-o-que-é-llvm-ir" class="nav-link" data-scroll-target="#o-que-é-llvm-ir"><span class="header-section-number">16.2.2</span> O que é <strong>LLVM IR</strong>?</a></li>
  <li><a href="#fluxo-de-compilação-completo" id="toc-fluxo-de-compilação-completo" class="nav-link" data-scroll-target="#fluxo-de-compilação-completo"><span class="header-section-number">16.2.3</span> Fluxo de Compilação Completo</a></li>
  <li><a href="#conceitos-fundamentais-do-ssa" id="toc-conceitos-fundamentais-do-ssa" class="nav-link" data-scroll-target="#conceitos-fundamentais-do-ssa"><span class="header-section-number">16.2.4</span> Conceitos Fundamentais do SSA</a></li>
  <li><a href="#dissecando-a-sintaxe-do-llvm-ir" id="toc-dissecando-a-sintaxe-do-llvm-ir" class="nav-link" data-scroll-target="#dissecando-a-sintaxe-do-llvm-ir"><span class="header-section-number">16.2.5</span> Dissecando a Sintaxe do LLVM IR</a></li>
  </ul></li>
  <li><a href="#primeiro-exemplo-geração-e-análise-de-ir" id="toc-primeiro-exemplo-geração-e-análise-de-ir" class="nav-link" data-scroll-target="#primeiro-exemplo-geração-e-análise-de-ir"><span class="header-section-number">16.3</span> Primeiro Exemplo: Geração e Análise de IR</a>
  <ul class="collapse">
  <li><a href="#exemplo-mais-completo-múltiplas-operações" id="toc-exemplo-mais-completo-múltiplas-operações" class="nav-link" data-scroll-target="#exemplo-mais-completo-múltiplas-operações"><span class="header-section-number">16.3.1</span> Exemplo Mais Completo: Múltiplas Operações</a></li>
  <li><a href="#gerar-o-llvm-ir" id="toc-gerar-o-llvm-ir" class="nav-link" data-scroll-target="#gerar-o-llvm-ir"><span class="header-section-number">16.3.2</span> Gerar o <strong>LLVM IR</strong></a></li>
  <li><a href="#análise-detalhada-do-ir-gerado" id="toc-análise-detalhada-do-ir-gerado" class="nav-link" data-scroll-target="#análise-detalhada-do-ir-gerado"><span class="header-section-number">16.3.3</span> Análise Detalhada do IR Gerado</a></li>
  <li><a href="#otimização-do-ir" id="toc-otimização-do-ir" class="nav-link" data-scroll-target="#otimização-do-ir"><span class="header-section-number">16.3.4</span> Otimização do IR</a></li>
  <li><a href="#gerar-ir-com-diferentes-níveis-de-otimização" id="toc-gerar-ir-com-diferentes-níveis-de-otimização" class="nav-link" data-scroll-target="#gerar-ir-com-diferentes-níveis-de-otimização"><span class="header-section-number">16.3.5</span> Gerar IR com Diferentes Níveis de Otimização</a></li>
  <li><a href="#entendendo-o-novo-pass-manager-llvm-14" id="toc-entendendo-o-novo-pass-manager-llvm-14" class="nav-link" data-scroll-target="#entendendo-o-novo-pass-manager-llvm-14"><span class="header-section-number">16.3.6</span> Entendendo o Novo Pass Manager (LLVM 14+)</a></li>
  </ul></li>
  <li><a href="#exemplo-com-controle-de-fluxo" id="toc-exemplo-com-controle-de-fluxo" class="nav-link" data-scroll-target="#exemplo-com-controle-de-fluxo"><span class="header-section-number">16.4</span> Exemplo com Controle de Fluxo</a>
  <ul class="collapse">
  <li><a href="#código-com-condicionais-garantindo-o-branch" id="toc-código-com-condicionais-garantindo-o-branch" class="nav-link" data-scroll-target="#código-com-condicionais-garantindo-o-branch"><span class="header-section-number">16.4.1</span> Código com Condicionais (Garantindo o Branch)</a></li>
  <li><a href="#gerar-e-analisar-o-ir" id="toc-gerar-e-analisar-o-ir" class="nav-link" data-scroll-target="#gerar-e-analisar-o-ir"><span class="header-section-number">16.4.2</span> Gerar e Analisar o IR</a></li>
  <li><a href="#análise-detalhada-do-ir-gerado-1" id="toc-análise-detalhada-do-ir-gerado-1" class="nav-link" data-scroll-target="#análise-detalhada-do-ir-gerado-1"><span class="header-section-number">16.4.3</span> Análise Detalhada do IR Gerado</a></li>
  <li><a href="#visualizar-o-grafo-de-fluxo-de-controle-cfg" id="toc-visualizar-o-grafo-de-fluxo-de-controle-cfg" class="nav-link" data-scroll-target="#visualizar-o-grafo-de-fluxo-de-controle-cfg"><span class="header-section-number">16.4.4</span> Visualizar o Grafo de Fluxo de Controle (CFG)</a></li>
  <li><a href="#otimização-do-código-com-controle-de-fluxo" id="toc-otimização-do-código-com-controle-de-fluxo" class="nav-link" data-scroll-target="#otimização-do-código-com-controle-de-fluxo"><span class="header-section-number">16.4.5</span> Otimização do Código com Controle de Fluxo</a></li>
  </ul></li>
  <li><a href="#exemplo-com-laços-de-repetição-loops" id="toc-exemplo-com-laços-de-repetição-loops" class="nav-link" data-scroll-target="#exemplo-com-laços-de-repetição-loops"><span class="header-section-number">16.5</span> 5. Exemplo com Laços de Repetição (Loops)</a>
  <ul class="collapse">
  <li><a href="#código-com-laço-de-repetição" id="toc-código-com-laço-de-repetição" class="nav-link" data-scroll-target="#código-com-laço-de-repetição"><span class="header-section-number">16.5.1</span> 5.1. Código com Laço de Repetição</a></li>
  <li><a href="#análise-do-ir-não-otimizado" id="toc-análise-do-ir-não-otimizado" class="nav-link" data-scroll-target="#análise-do-ir-não-otimizado"><span class="header-section-number">16.5.2</span> 5.2. Análise do IR Não Otimizado</a></li>
  <li><a href="#visualizando-o-cfg-do-laço" id="toc-visualizando-o-cfg-do-laço" class="nav-link" data-scroll-target="#visualizando-o-cfg-do-laço"><span class="header-section-number">16.5.3</span> 5.3. Visualizando o CFG do Laço</a></li>
  <li><a href="#otimização-de-laços-vetorização-e-desdobramento-em-ação" id="toc-otimização-de-laços-vetorização-e-desdobramento-em-ação" class="nav-link" data-scroll-target="#otimização-de-laços-vetorização-e-desdobramento-em-ação"><span class="header-section-number">16.5.4</span> 5.4. Otimização de Laços: Vetorização e Desdobramento em Ação</a></li>
  <li><a href="#converter-para-bitcode" id="toc-converter-para-bitcode" class="nav-link" data-scroll-target="#converter-para-bitcode"><span class="header-section-number">16.5.5</span> 6.1. Converter para Bitcode</a></li>
  <li><a href="#converter-bitcode-de-volta-para-texto" id="toc-converter-bitcode-de-volta-para-texto" class="nav-link" data-scroll-target="#converter-bitcode-de-volta-para-texto"><span class="header-section-number">16.5.6</span> 6.2. Converter Bitcode de volta para Texto</a></li>
  <li><a href="#linkar-múltiplos-arquivos-bitcode" id="toc-linkar-múltiplos-arquivos-bitcode" class="nav-link" data-scroll-target="#linkar-múltiplos-arquivos-bitcode"><span class="header-section-number">16.5.7</span> 6.3. Linkar Múltiplos Arquivos Bitcode</a></li>
  </ul></li>
  <li><a href="#análise-de-otimizações-comuns" id="toc-análise-de-otimizações-comuns" class="nav-link" data-scroll-target="#análise-de-otimizações-comuns"><span class="header-section-number">16.6</span> 7. Análise de Otimizações Comuns</a>
  <ul class="collapse">
  <li><a href="#constant-folding" id="toc-constant-folding" class="nav-link" data-scroll-target="#constant-folding"><span class="header-section-number">16.6.1</span> 7.1. Constant Folding</a></li>
  <li><a href="#dead-code-elimination" id="toc-dead-code-elimination" class="nav-link" data-scroll-target="#dead-code-elimination"><span class="header-section-number">16.6.2</span> 7.2. Dead Code Elimination</a></li>
  <li><a href="#function-inlining" id="toc-function-inlining" class="nav-link" data-scroll-target="#function-inlining"><span class="header-section-number">16.6.3</span> 7.3. Function Inlining</a></li>
  <li><a href="#common-subexpression-elimination" id="toc-common-subexpression-elimination" class="nav-link" data-scroll-target="#common-subexpression-elimination"><span class="header-section-number">16.6.4</span> 7.4. Common Subexpression Elimination</a></li>
  </ul></li>
  <li><a href="#exercícios-práticos" id="toc-exercícios-práticos" class="nav-link" data-scroll-target="#exercícios-práticos"><span class="header-section-number">16.7</span> 8. Exercícios Práticos</a>
  <ul class="collapse">
  <li><a href="#exercício-1-análise-básica" id="toc-exercício-1-análise-básica" class="nav-link" data-scroll-target="#exercício-1-análise-básica"><span class="header-section-number">16.7.1</span> Exercício 1: Análise Básica</a></li>
  <li><a href="#exercício-2-testando-passes-individuais" id="toc-exercício-2-testando-passes-individuais" class="nav-link" data-scroll-target="#exercício-2-testando-passes-individuais"><span class="header-section-number">16.7.2</span> Exercício 2: Testando Passes Individuais</a></li>
  <li><a href="#exercício-3-estruturas-de-dados" id="toc-exercício-3-estruturas-de-dados" class="nav-link" data-scroll-target="#exercício-3-estruturas-de-dados"><span class="header-section-number">16.7.3</span> Exercício 3: Estruturas de Dados</a></li>
  <li><a href="#exercício-2-estruturas-de-dados" id="toc-exercício-2-estruturas-de-dados" class="nav-link" data-scroll-target="#exercício-2-estruturas-de-dados"><span class="header-section-number">16.7.4</span> Exercício 2: Estruturas de Dados</a></li>
  <li><a href="#exercício-3-ponteiros-e-referências" id="toc-exercício-3-ponteiros-e-referências" class="nav-link" data-scroll-target="#exercício-3-ponteiros-e-referências"><span class="header-section-number">16.7.5</span> Exercício 3: Ponteiros e Referências</a></li>
  <li><a href="#exercício-4-otimização-de-loop" id="toc-exercício-4-otimização-de-loop" class="nav-link" data-scroll-target="#exercício-4-otimização-de-loop"><span class="header-section-number">16.7.6</span> Exercício 4: Otimização de Loop</a></li>
  </ul></li>
  <li><a href="#comandos-de-referência-rápida" id="toc-comandos-de-referência-rápida" class="nav-link" data-scroll-target="#comandos-de-referência-rápida"><span class="header-section-number">16.8</span> 9. Comandos de Referência Rápida</a>
  <ul class="collapse">
  <li><a href="#geração-de-ir" id="toc-geração-de-ir" class="nav-link" data-scroll-target="#geração-de-ir"><span class="header-section-number">16.8.1</span> Geração de IR</a></li>
  <li><a href="#conversão" id="toc-conversão" class="nav-link" data-scroll-target="#conversão"><span class="header-section-number">16.8.2</span> Conversão</a></li>
  <li><a href="#otimização-llvm-14" id="toc-otimização-llvm-14" class="nav-link" data-scroll-target="#otimização-llvm-14"><span class="header-section-number">16.8.3</span> Otimização (LLVM 14+)</a></li>
  <li><a href="#análise-e-visualização" id="toc-análise-e-visualização" class="nav-link" data-scroll-target="#análise-e-visualização"><span class="header-section-number">16.8.4</span> Análise e Visualização</a></li>
  <li><a href="#compilação-final" id="toc-compilação-final" class="nav-link" data-scroll-target="#compilação-final"><span class="header-section-number">16.8.5</span> Compilação Final</a></li>
  </ul></li>
  <li><a href="#troubleshooting-comum" id="toc-troubleshooting-comum" class="nav-link" data-scroll-target="#troubleshooting-comum"><span class="header-section-number">16.9</span> 10. Troubleshooting Comum</a>
  <ul class="collapse">
  <li><a href="#problema-opt-não-otimiza-nada-arquivos-têm-mesmo-tamanho" id="toc-problema-opt-não-otimiza-nada-arquivos-têm-mesmo-tamanho" class="nav-link" data-scroll-target="#problema-opt-não-otimiza-nada-arquivos-têm-mesmo-tamanho"><span class="header-section-number">16.9.1</span> Problema: opt não otimiza nada, arquivos têm mesmo tamanho</a></li>
  <li><a href="#problema-comando-não-encontrado" id="toc-problema-comando-não-encontrado" class="nav-link" data-scroll-target="#problema-comando-não-encontrado"><span class="header-section-number">16.9.2</span> Problema: Comando não encontrado</a></li>
  <li><a href="#problema-versão-incorreta-sendo-usada" id="toc-problema-versão-incorreta-sendo-usada" class="nav-link" data-scroll-target="#problema-versão-incorreta-sendo-usada"><span class="header-section-number">16.9.3</span> Problema: Versão incorreta sendo usada</a></li>
  <li><a href="#problema-arquivo-.ll-corrompido-ou-ilegível" id="toc-problema-arquivo-.ll-corrompido-ou-ilegível" class="nav-link" data-scroll-target="#problema-arquivo-.ll-corrompido-ou-ilegível"><span class="header-section-number">16.9.4</span> Problema: Arquivo .ll corrompido ou ilegível</a></li>
  <li><a href="#problema-otimização-não-funciona-como-esperado" id="toc-problema-otimização-não-funciona-como-esperado" class="nav-link" data-scroll-target="#problema-otimização-não-funciona-como-esperado"><span class="header-section-number">16.9.5</span> Problema: Otimização não funciona como esperado</a></li>
  </ul></li>
  <li><a href="#recursos-adicionais" id="toc-recursos-adicionais" class="nav-link" data-scroll-target="#recursos-adicionais"><span class="header-section-number">16.10</span> 11. Recursos Adicionais</a>
  <ul class="collapse">
  <li><a href="#documentação-oficial" id="toc-documentação-oficial" class="nav-link" data-scroll-target="#documentação-oficial"><span class="header-section-number">16.10.1</span> Documentação Oficial</a></li>
  <li><a href="#ferramentas-úteis" id="toc-ferramentas-úteis" class="nav-link" data-scroll-target="#ferramentas-úteis"><span class="header-section-number">16.10.2</span> Ferramentas Úteis</a></li>
  <li><a href="#leitura-recomendada" id="toc-leitura-recomendada" class="nav-link" data-scroll-target="#leitura-recomendada"><span class="header-section-number">16.10.3</span> Leitura Recomendada</a></li>
  </ul></li>
  <li><a href="#apêndice-tipos-de-dados-no-llvm-ir" id="toc-apêndice-tipos-de-dados-no-llvm-ir" class="nav-link" data-scroll-target="#apêndice-tipos-de-dados-no-llvm-ir"><span class="header-section-number">16.11</span> 12. Apêndice: Tipos de Dados no LLVM IR</a>
  <ul class="collapse">
  <li><a href="#tipos-primitivos" id="toc-tipos-primitivos" class="nav-link" data-scroll-target="#tipos-primitivos"><span class="header-section-number">16.11.1</span> Tipos Primitivos</a></li>
  <li><a href="#tipos-derivados" id="toc-tipos-derivados" class="nav-link" data-scroll-target="#tipos-derivados"><span class="header-section-number">16.11.2</span> Tipos Derivados</a></li>
  <li><a href="#exemplos" id="toc-exemplos" class="nav-link" data-scroll-target="#exemplos"><span class="header-section-number">16.11.3</span> Exemplos</a></li>
  </ul></li>
  <li><a href="#apêndice-migrando-da-sintaxe-antiga-para-nova-legacy-pm-new-pm" id="toc-apêndice-migrando-da-sintaxe-antiga-para-nova-legacy-pm-new-pm" class="nav-link" data-scroll-target="#apêndice-migrando-da-sintaxe-antiga-para-nova-legacy-pm-new-pm"><span class="header-section-number">16.12</span> 13. Apêndice: Migrando da Sintaxe Antiga para Nova (Legacy PM → New PM)</a>
  <ul class="collapse">
  <li><a href="#comandos-básicos-de-otimização" id="toc-comandos-básicos-de-otimização" class="nav-link" data-scroll-target="#comandos-básicos-de-otimização"><span class="header-section-number">16.12.1</span> Comandos Básicos de Otimização</a></li>
  <li><a href="#passes-individuais" id="toc-passes-individuais" class="nav-link" data-scroll-target="#passes-individuais"><span class="header-section-number">16.12.2</span> Passes Individuais</a></li>
  <li><a href="#múltiplos-passes-em-sequência" id="toc-múltiplos-passes-em-sequência" class="nav-link" data-scroll-target="#múltiplos-passes-em-sequência"><span class="header-section-number">16.12.3</span> Múltiplos Passes em Sequência</a></li>
  <li><a href="#debug-e-análise" id="toc-debug-e-análise" class="nav-link" data-scroll-target="#debug-e-análise"><span class="header-section-number">16.12.4</span> Debug e Análise</a></li>
  <li><a href="#passes-de-análise-print" id="toc-passes-de-análise-print" class="nav-link" data-scroll-target="#passes-de-análise-print"><span class="header-section-number">16.12.5</span> Passes de Análise (Print)</a></li>
  <li><a href="#forçar-o-legacy-pm-versões-de-transição-llvm-13-15" id="toc-forçar-o-legacy-pm-versões-de-transição-llvm-13-15" class="nav-link" data-scroll-target="#forçar-o-legacy-pm-versões-de-transição-llvm-13-15"><span class="header-section-number">16.12.6</span> Forçar o Legacy PM (Versões de Transição LLVM 13-15)</a></li>
  <li><a href="#dicas-para-conversão" id="toc-dicas-para-conversão" class="nav-link" data-scroll-target="#dicas-para-conversão"><span class="header-section-number">16.12.7</span> Dicas para Conversão</a></li>
  <li><a href="#como-encontrar-o-nome-correto-de-um-pass" id="toc-como-encontrar-o-nome-correto-de-um-pass" class="nav-link" data-scroll-target="#como-encontrar-o-nome-correto-de-um-pass"><span class="header-section-number">16.12.8</span> Como Encontrar o Nome Correto de um Pass</a></li>
  <li><a href="#script-de-conversão-rápida" id="toc-script-de-conversão-rápida" class="nav-link" data-scroll-target="#script-de-conversão-rápida"><span class="header-section-number">16.12.9</span> Script de Conversão Rápida</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/frankalcantara/linguagens-formais/edit/main/15-llvmIR.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/frankalcantara/linguagens-formais/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./14-GeraInter.html">Geração de Código Intermediário</a></li><li class="breadcrumb-item"><a href="./15-llvmIR.html"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Introdução à Representação Intermediária (IR) do LLVM com C++</span></a></li></ol></nav>
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Introdução à Representação Intermediária (IR) do LLVM com C++</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>Apresentação Intermediária (IR) do LLVM é uma linguagem de baixo nível usada como uma etapa intermediária na compilação de código fonte para código de máquina. Neste ponto do livro, vamos instalar em uma máquina Ubuntu os componentes necessários para trabalhar com <strong>LLVM IR</strong>, com o objetivo de introduzir os conceitos fundamentais de uma representação intermediária real, de mercado. Além disso, demonstraremos como gerar e analisar o IR a partir de código C++, e exploraremos algumas das principais otimizações que podem ser aplicadas.</p>
<section id="configuração-do-ambiente-ubuntu-vs-code-c-e-llvm" class="level2" data-number="16.1">
<h2 data-number="16.1" class="anchored" data-anchor-id="configuração-do-ambiente-ubuntu-vs-code-c-e-llvm"><span class="header-section-number">16.1</span> Configuração do Ambiente (Ubuntu, VS Code, C++ e LLVM)</h2>
<p>Nesta seção, vamos ser um pouco mais detalhados, quase um tutorial de instalação, para garantir que a esforçada leitora tenha o ambiente correto para a criação deste conhecimento.</p>
<p>Os passos a seguir foram testados em uma instalação limpa do Ubuntu 24.04 LTS, limpa, atualizada e rodando em uma máquina virtual VirtualBox.</p>
<section id="pré-requisitos" class="level3" data-number="16.1.1">
<h3 data-number="16.1.1" class="anchored" data-anchor-id="pré-requisitos"><span class="header-section-number">16.1.1</span> Pré-requisitos</h3>
<p>Antes de começar, certifique-se de ter:</p>
<ul>
<li>Ubuntu 24.04 LTS ou superior;</li>
<li>Conexão com internet;</li>
<li>Privilégios de superusuário (sudo);</li>
<li>Pelo menos 5GB de espaço livre em disco.</li>
</ul>
</section>
<section id="instalação-do-llvmclang" class="level3" data-number="16.1.2">
<h3 data-number="16.1.2" class="anchored" data-anchor-id="instalação-do-llvmclang"><span class="header-section-number">16.1.2</span> Instalação do LLVM/Clang</h3>
<p>O repositório oficial do LLVM fornece as versões mais atualizadas das ferramentas.</p>
<p><strong>Passo 1: Baixar e preparar o script de instalação</strong>:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">wget</span> https://apt.llvm.org/llvm.sh</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">chmod</span> +x llvm.sh</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Passo 2: Instalar a versão mais recente do LLVM</strong>:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Para instalar a versão 20 (substitua pelo número da versão mais recente)</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> ./llvm.sh 21</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Instalar ferramentas adicionais úteis</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apt install <span class="at">-y</span> llvm-21-tools llvm-21-dev</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Passo 3: Configurar alternativas do sistema</strong>:</p>
<p>Crie links simbólicos para usar os comandos sem especificar a versão:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Os comandos a seguir configuram os links simbólicos do sistema</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co"># para que os comandos gerais (clang, opt, etc.) apontem para </span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co"># a versão 21 do LLVM/Clang com prioridade 150.</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. **Clang** (Compilador C)</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> update-alternatives <span class="at">--install</span> /usr/bin/clang <span class="kw">`</span><span class="fu">clang</span><span class="kw">`</span> /usr/bin/clang-21 150</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Clang++ (Compilador C++)</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> update-alternatives <span class="at">--install</span> /usr/bin/clang++ clang++ /usr/bin/clang++-21 150</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Opt (Otimizador IR do LLVM)</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> update-alternatives <span class="at">--install</span> /usr/bin/opt opt /usr/bin/opt-21 150</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. llvm-dis (Desassemblador de Bitcode para IR de texto)</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> update-alternatives <span class="at">--install</span> /usr/bin/llvm-dis llvm-dis /usr/bin/llvm-dis-21 150</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. llvm-as (Assembler de IR de texto para Bitcode)</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> update-alternatives <span class="at">--install</span> /usr/bin/llvm-as llvm-as /usr/bin/llvm-as-21 150</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a><span class="co"># 6. llc (Compilador de Linguagem de Baixo Nível - Backend)</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> update-alternatives <span class="at">--install</span> /usr/bin/llc llc /usr/bin/llc-21 150</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a><span class="co"># 7. llvm-link (Ferramenta para unir módulos LLVM)</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> update-alternatives <span class="at">--install</span> /usr/bin/llvm-link llvm-link /usr/bin/llvm-link-21 150</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Passo 4: Verificar a instalação</strong>:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">clang</span> <span class="at">--version</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="ex">opt</span> <span class="at">--version</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="ex">llvm-dis</span> <span class="at">--version</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Você deve ver algo como:</p>
<pre><code>clang version 20.x.x
Target: x86_64-pc-linux-gnu
...</code></pre>
<p><strong>Passo 5: Testar o opt com um exemplo rápido</strong>:</p>
<p>Vamos criar um teste direto na linha de comando para garantir que <code>opt</code> está funcionando:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Criar um arquivo C++ de teste mais complexo</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> <span class="op">&gt;</span> teste.cpp <span class="op">&lt;&lt; 'EOF'</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="st">int calcular(int x) {</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="st">    int a = x + 5;</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="st">    int b = a * 2;</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="st">    int c = b + 10;</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="st">    int d = c * 3;</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="st">    return d;</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="st">int main() {</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="st">    int resultado = calcular(10);</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="st">    return 0;</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a><span class="op">EOF</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a><span class="co"># IMPORTANTE: Use -Xclang -disable-O0-optnone para evitar o atributo optnone, este atributo impede otimizações posteriores</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Gerar IR não otimizado mas sem o atributo optnone</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a><span class="fu">clang</span>++ <span class="at">-S</span> <span class="at">-emit-llvm</span> <span class="at">-O0</span> <span class="at">-Xclang</span> <span class="at">-disable-O0-optnone</span> teste.cpp <span class="at">-o</span> teste.ll</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Testar otimização</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a><span class="ex">opt</span> <span class="at">-passes</span><span class="op">=</span><span class="st">'default&lt;O3&gt;'</span> <span class="at">-S</span> teste.ll <span class="at">-o</span> teste_opt.ll</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Verificar se houve otimização</span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"=== Antes da otimização ==="</span></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a><span class="fu">wc</span> <span class="at">-l</span> teste.ll</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"=== Depois da otimização ==="</span></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a><span class="fu">wc</span> <span class="at">-l</span> teste_opt.ll</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Ver uma comparação lado a lado</span></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="at">-e</span> <span class="st">"\n=== Função calcular ANTES da otimização ==="</span></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a><span class="fu">sed</span> <span class="at">-n</span> <span class="st">'/@.*calcular/,/^}/p'</span> teste.ll <span class="kw">|</span> <span class="fu">head</span> <span class="at">-20</span></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="at">-e</span> <span class="st">"\n=== Função calcular DEPOIS da otimização ==="</span></span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a><span class="fu">sed</span> <span class="at">-n</span> <span class="st">'/@.*calcular/,/^}/p'</span> teste_opt.ll</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Se tudo funcionou</strong>:</p>
<p>A atenta leitora verá algo como:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="ex">===</span> Função calcular ANTES da otimização ===</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="ex">define</span> dso_local noundef i32 @_Z8calculari<span class="er">(</span><span class="ex">i32</span> noundef %0<span class="kw">)</span> <span class="co">#0 {</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="ex">%2</span> = alloca i32, align 4</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="ex">%3</span> = alloca i32, align 4</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="ex">%4</span> = alloca i32, align 4</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  <span class="ex">%5</span> = alloca i32, align 4</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  <span class="ex">%6</span> = alloca i32, align 4</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  <span class="ex">store</span> i32 %0, ptr %2, align 4</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  <span class="ex">%7</span> = load i32, ptr %2, align 4</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>  <span class="ex">%8</span> = add nsw i32 %7, 5</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>  <span class="ex">store</span> i32 %8, ptr %3, align 4</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>  <span class="ex">%9</span> = load i32, ptr %3, align 4</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>  <span class="ex">%10</span> = mul nsw i32 %9, 2</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>  <span class="ex">store</span> i32 %10, ptr %4, align 4</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>  <span class="ex">%11</span> = load i32, ptr %4, align 4</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>  <span class="ex">%12</span> = add nsw i32 %11, 10</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>  <span class="ex">store</span> i32 %12, ptr %5, align 4</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>  <span class="ex">%13</span> = load i32, ptr %5, align 4</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>  <span class="ex">%14</span> = mul nsw i32 %13, 3</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>  <span class="ex">store</span> i32 %14, ptr %6, align 4</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>  <span class="ex">%15</span> = load i32, ptr %6, align 4</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a><span class="ex">===</span> Função calcular DEPOIS da otimização ===</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a><span class="ex">define</span> dso_local noundef i32 @_Z8calculari<span class="er">(</span><span class="ex">i32</span> noundef %0<span class="kw">)</span> <span class="ex">local_unnamed_addr</span> <span class="co">#0 {</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>  <span class="ex">%2</span> = mul i32 %0, 6</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>  <span class="ex">%3</span> = add i32 %2, 60</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>  <span class="ex">ret</span> i32 %3</span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>O arquivo otimizado deve ter significativamente menos linhas;</li>
<li>As operações intermediárias devem ter sido eliminadas, <em>constant folding</em>;</li>
<li>As instruções <code>alloca</code>, <code>store</code> e <code>load</code> devem ter desaparecido.</li>
</ul>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Problema Comum: Atributo <code>optnone</code></strong></p>
<p>Não é raro encontrar exemplos de compilação com a opção <code>-O0</code> sem <code>-Xclang -disable-O0-optnone</code>. Neste caso, o <code>clang</code> adiciona o atributo <code>optnone</code> às funções. Este atributo instrui o opt a <strong>pular completamente</strong> a otimização dessas funções, mesmo que você tente otimizá-las depois!</p>
<p>Verifique se suas funções têm este atributo:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">grep</span> <span class="st">"optnone"</span> teste.ll</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>Se você ver <code>optnone</code>, então o opt vai ignorar suas funções. Para corrigir, recompile com <code>-Xclang -disable-O0-optnone</code>.</p>
</section>
<section id="instalação-do-vs-code-e-extensões" class="level3" data-number="16.1.3">
<h3 data-number="16.1.3" class="anchored" data-anchor-id="instalação-do-vs-code-e-extensões"><span class="header-section-number">16.1.3</span> Instalação do VS Code e Extensões</h3>
<p><strong>Passo 1: Instalar o VS Code</strong>:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Adicionar repositório da Microsoft</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">wget</span> <span class="at">-qO-</span> https://packages.microsoft.com/keys/microsoft.asc <span class="kw">|</span> <span class="ex">gpg</span> <span class="at">--dearmor</span> <span class="op">&gt;</span> packages.microsoft.gpg</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> install <span class="at">-D</span> <span class="at">-o</span> root <span class="at">-g</span> root <span class="at">-m</span> 644 packages.microsoft.gpg /etc/apt/keyrings/packages.microsoft.gpg</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> sh <span class="at">-c</span> <span class="st">'echo "deb [arch=amd64,arm64,armhf signed-by=/etc/apt/keyrings/packages.microsoft.gpg] https://packages.microsoft.com/repos/code stable main" &gt; /etc/apt/sources.list.d/vscode.list'</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Instalar</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apt update</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apt install code</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Passo 2: Instalar extensões essenciais</strong>:</p>
<p>Abra o VS Code e instale as seguintes extensões (Ctrl+Shift+X):</p>
<ol type="1">
<li><strong>C/C++ Extension Pack</strong> (Microsoft)</li>
<li><strong>LLVM</strong> (LLVM Team) - Syntax highlighting para arquivos .ll</li>
<li><strong>Code Runner</strong> (Jun Han) - Execução rápida de código</li>
<li><strong>Graphviz Preview</strong> (Para visualizar CFGs)</li>
</ol>
<p><strong>Passo 3: Instalar Graphviz (para visualização de CFG)</strong>:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apt install graphviz</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="criar-diretório-de-trabalho" class="level3" data-number="16.1.4">
<h3 data-number="16.1.4" class="anchored" data-anchor-id="criar-diretório-de-trabalho"><span class="header-section-number">16.1.4</span> Criar Diretório de Trabalho</h3>
<div class="sourceCode" id="cb11"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> ~/llvm-aula</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> ~/llvm-aula</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="fundamentos-teóricos-do-llvm-ir" class="level2" data-number="16.2">
<h2 data-number="16.2" class="anchored" data-anchor-id="fundamentos-teóricos-do-llvm-ir"><span class="header-section-number">16.2</span> Fundamentos Teóricos do <strong>LLVM IR</strong></h2>
<section id="o-que-é-llvm" class="level3" data-number="16.2.1">
<h3 data-number="16.2.1" class="anchored" data-anchor-id="o-que-é-llvm"><span class="header-section-number">16.2.1</span> O que é LLVM?</h3>
<p>LLVM (Low Level Virtual Machine) é uma infraestrutura de compilador modular e reutilizável. Apesar do nome, não é exatamente uma máquina virtual tradicional, mas sim um framework de compilação.</p>
<p><strong>Componentes principais:</strong> - <strong>Frontend</strong>: Converte código fonte (C++, C, etc.) em IR - <strong>Middle-end</strong>: Otimiza o IR independente de arquitetura - <strong>Backend</strong>: Converte IR em código de máquina específico</p>
</section>
<section id="o-que-é-llvm-ir" class="level3" data-number="16.2.2">
<h3 data-number="16.2.2" class="anchored" data-anchor-id="o-que-é-llvm-ir"><span class="header-section-number">16.2.2</span> O que é <strong>LLVM IR</strong>?</h3>
<p>A Representação Intermediária do LLVM é uma linguagem de programação de baixo nível que serve como ponte entre código de alto nível e código de máquina.</p>
<p><strong>Características principais:</strong></p>
<ol type="1">
<li><strong>Fortemente Tipada</strong>: Cada valor tem um tipo explícito</li>
<li><strong>Formulário SSA (Static Single Assignment)</strong>: Cada variável é atribuída exatamente uma vez</li>
<li><strong>Abstração de Plataforma</strong>: Independente de arquitetura específica</li>
<li><strong>Formato Triplo</strong>: Texto (.ll), Bitcode (.bc), e representação em memória</li>
</ol>
</section>
<section id="fluxo-de-compilação-completo" class="level3" data-number="16.2.3">
<h3 data-number="16.2.3" class="anchored" data-anchor-id="fluxo-de-compilação-completo"><span class="header-section-number">16.2.3</span> Fluxo de Compilação Completo</h3>
<div class="sourceCode" id="cb12"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="ex">C++</span> Source Code <span class="er">(</span><span class="ex">.cpp</span><span class="kw">)</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>        <span class="kw">|</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>        <span class="kw">|</span> <span class="fu">clang</span>++ <span class="at">-S</span> <span class="at">-emit-llvm</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>        <span class="ex">v</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="ex">LLVM</span> IR Text <span class="er">(</span><span class="ex">.ll</span><span class="kw">)</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">|</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">|</span> <span class="ex">opt</span> <span class="at">-O2</span>/-O3</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>        <span class="ex">v</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="ex">LLVM</span> IR Optimized <span class="er">(</span><span class="ex">.ll</span><span class="kw">)</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>        <span class="kw">|</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>        <span class="kw">|</span> <span class="ex">llc</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>        <span class="ex">v</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="ex">Assembly</span> <span class="er">(</span><span class="ex">.s</span><span class="kw">)</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>        <span class="kw">|</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>        <span class="kw">|</span> <span class="fu">clang</span>++</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>        <span class="ex">v</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a><span class="ex">Executable</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="conceitos-fundamentais-do-ssa" class="level3" data-number="16.2.4">
<h3 data-number="16.2.4" class="anchored" data-anchor-id="conceitos-fundamentais-do-ssa"><span class="header-section-number">16.2.4</span> Conceitos Fundamentais do SSA</h3>
<p>No formato SSA:</p>
<ul>
<li>cada variável tem apenas uma atribuição;</li>
<li>usa-se notação com % para valores temporários;</li>
<li>nós Phi (φ) para mesclar valores de diferentes caminhos de execução.</li>
</ul>
<p>Considere o código a seguir:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> x <span class="op">=</span> <span class="dv">5</span><span class="op">;</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> x <span class="op">+</span> <span class="dv">3</span><span class="op">;</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> x <span class="op">*</span> <span class="dv">2</span><span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Em SSA (conceitual):</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode llvm code-with-copy"><code class="sourceCode llvm"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">%x1</span> = <span class="dv">5</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">%x2</span> = <span class="fu">%x1</span> + <span class="dv">3</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="fu">%x3</span> = <span class="fu">%x2</span> * <span class="dv">2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="dissecando-a-sintaxe-do-llvm-ir" class="level3" data-number="16.2.5">
<h3 data-number="16.2.5" class="anchored" data-anchor-id="dissecando-a-sintaxe-do-llvm-ir"><span class="header-section-number">16.2.5</span> Dissecando a Sintaxe do LLVM IR</h3>
<p>Antes de prosseguirmos para a análise detalhada de nossos exemplos, é essencial que a leitora se familiarize com os componentes fundamentais da linguagem de Representação Intermediária do LLVM. À primeira vista, o IR pode parecer uma linguagem Assembly, mas ele possui uma estrutura mais rica, um sistema de tipos forte e semânticas bem definidas que o tornam uma plataforma poderosa para otimização.</p>
<p>Nesta seção, faremos um tour pelos elementos sintáticos mais comuns que encontraremos em nossos exemplos.</p>
<section id="comentários" class="level4" data-number="16.2.5.1">
<h4 data-number="16.2.5.1" class="anchored" data-anchor-id="comentários"><span class="header-section-number">16.2.5.1</span> 1. Comentários</h4>
<p>Qualquer texto após um ponto e vírgula (<code>;</code>) é um comentário e é ignorado pelo compilador.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode llvm code-with-copy"><code class="sourceCode llvm"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co">; Este é um comentário de linha inteira.</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="fu">%a</span> = <span class="kw">add</span> <span class="dt">i32</span> <span class="fu">%b</span>, <span class="dv">5</span> <span class="co">; E este é um comentário no final de uma linha.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="identificadores-globais-e-locais" class="level4" data-number="16.2.5.2">
<h4 data-number="16.2.5.2" class="anchored" data-anchor-id="identificadores-globais-e-locais"><span class="header-section-number">16.2.5.2</span> 2. Identificadores: Globais (<code>@</code>) e Locais (<code>%</code>)</h4>
<p>Existem dois tipos principais de identificadores no LLVM IR:</p>
<ul>
<li><p><strong>Identificadores Globais (<code>@</code>)</strong>: Referem-se a entidades com endereço fixo na memória, como funções e variáveis globais. Eles são, em essência, ponteiros. <code>llvm     @main = define ...          ; Uma função global chamada main     @variavel_global = global i32 0 ; Uma variável global</code></p></li>
<li><p><strong>Identificadores Locais (<code>%</code>)</strong>: Representam valores temporários dentro de uma função. No formulário SSA, cada um desses “registradores virtuais” recebe um valor apenas uma vez. Eles podem ser nomeados (ex: <code>%soma</code>) ou numerados sequencialmente (ex: <code>%1</code>, <code>%2</code>, <code>%3</code>). <code>llvm     %a = alloca i32           ; O valor retornado por 'alloca' é %a     %b = load i32, ptr %a     ; O valor lido da memória é %b</code></p></li>
</ul>
</section>
<section id="tipos-de-dados" class="level4" data-number="16.2.5.3">
<h4 data-number="16.2.5.3" class="anchored" data-anchor-id="tipos-de-dados"><span class="header-section-number">16.2.5.3</span> 3. Tipos de Dados</h4>
<p>O LLVM IR é fortemente tipado. Cada instrução que produz um valor o faz com um tipo bem definido. Os mais comuns que veremos são: - <strong>Inteiros</strong>: <code>iN</code>, onde <code>N</code> é o número de bits. <code>i32</code> é um inteiro de 32 bits, e <code>i1</code> é um booleano (<code>true</code>/<code>false</code>). - <strong>Ponteiros</strong>: <code>ptr</code>. O LLVM usa ponteiros sem tipo, mas o tipo do dado apontado é especificado nas instruções que o utilizam (<code>load</code>, <code>store</code>, <code>getelementptr</code>). - <strong>Vetores</strong>: <code>&lt;N x T&gt;</code>, onde <code>N</code> é o número de elementos e <code>T</code> é o tipo. Como vimos na otimização do laço, <code>&lt;4 x i32&gt;</code> é um vetor de 4 inteiros de 32 bits. - <strong>Void</strong>: <code>void</code>, usado para representar o tipo de retorno de funções que não retornam valor.</p>
</section>
<section id="a-tríade-da-memória-em-código-não-otimizado" class="level4" data-number="16.2.5.4">
<h4 data-number="16.2.5.4" class="anchored" data-anchor-id="a-tríade-da-memória-em-código-não-otimizado"><span class="header-section-number">16.2.5.4</span> 4. A Tríade da Memória (em código não otimizado)</h4>
<p>Em código <code>-O0</code>, que traduz C++ literalmente, três instruções são onipresentes para gerenciar variáveis na pilha: - <code>alloca</code>: Aloca espaço na pilha da função (similar a uma variável local em C). Retorna um ponteiro para o espaço alocado. - <code>store</code>: Escreve um valor em um endereço de memória. Formato: <code>store &lt;tipo&gt; &lt;valor&gt;, ptr &lt;endereço&gt;</code>. - <code>load</code>: Lê um valor de um endereço de memória. Formato: <code>%resultado = load &lt;tipo&gt;, ptr &lt;endereço&gt;</code>. A primeira e mais importante otimização (<code>mem2reg</code>) elimina a vasta maioria dessas instruções, promovendo as variáveis da memória para registradores virtuais (<code>%</code>).</p>
</section>
<section id="instruções-comuns" class="level4" data-number="16.2.5.5">
<h4 data-number="16.2.5.5" class="anchored" data-anchor-id="instruções-comuns"><span class="header-section-number">16.2.5.5</span> 5. Instruções Comuns</h4>
<p>As instruções formam o corpo executável das funções. Cada instrução segue o formato <code>%resultado = opcode &lt;operandos&gt;</code>.</p>
<ul>
<li><strong>Término de Bloco</strong>: Instruções que encerram um bloco básico e transferem o controle.
<ul>
<li><code>ret &lt;tipo&gt; &lt;valor&gt;</code>: Retorna da função com um valor. <code>ret void</code> para funções <code>void</code>.</li>
<li><code>br label %destino</code>: <strong>Br</strong>anch incondicional para outro bloco.</li>
<li><code>br i1 %cond, label %se_verdadeiro, label %se_falso</code>: <strong>Br</strong>anch condicional, o coração do <code>if-else</code>.</li>
</ul></li>
<li><strong>Operações Aritméticas</strong>:
<ul>
<li><code>add</code>, <code>sub</code>, <code>mul</code>, <code>sdiv</code> (divisão com sinal): Realizam as quatro operações básicas. Podem ter flags como <code>nsw</code> (No Signed Wrap) para dar mais informações ao otimizador.</li>
</ul></li>
<li><strong>Operações Lógicas e de Comparação</strong>:
<ul>
<li><code>icmp &lt;pred&gt; &lt;tipo&gt; &lt;op1&gt;, &lt;op2&gt;</code>: <strong>I</strong>nteger <strong>C</strong>o<strong>mp</strong>arison. Compara dois inteiros usando um predicado (<code>eq</code> para igual, <code>ne</code> para diferente, <code>sgt</code> para maior que com sinal, <code>slt</code> para menor que com sinal, etc.). Retorna um <code>i1</code> (booleano).</li>
</ul></li>
<li><strong>Operações de Ponteiro</strong>:
<ul>
<li><code>getelementptr &lt;tipo&gt;, ptr &lt;base&gt;, &lt;índice1&gt;, ...</code>: <strong>G</strong>et <strong>E</strong>lement <strong>P</strong>oin<strong>t</strong>e<strong>r</strong>. A principal ferramenta para aritmética de ponteiros. Apenas <strong>calcula</strong> um novo endereço, não acessa a memória.</li>
</ul></li>
<li><strong>Seleção de Valor (SSA)</strong>:
<ul>
<li><code>select i1 %cond, &lt;tipo&gt; %val_true, &lt;tipo&gt; %val_false</code>: Um operador ternário. Avalia a condição e retorna um dos dois valores. É uma instrução de fluxo de dados puro.</li>
<li><code>phi &lt;tipo&gt; [ %val1, %label1 ], [ %val2, %label2 ], ...</code>: O nó <strong>Phi</strong> é fundamental para SSA. Ele seleciona um valor com base em <strong>qual bloco básico executou anteriormente</strong>. Vimos seu uso no <em>header</em> de laços e nos blocos de junção após um <code>if-else</code>.</li>
</ul></li>
<li><strong>Chamadas de Função</strong>:
<ul>
<li><code>call &lt;tipo&gt; @&lt;nome_funcao&gt;(&lt;argumentos&gt;)</code>: Chama uma função global, como as que definimos, ou funções de bibliotecas.</li>
<li><code>call &lt;tipo&gt; @llvm.&lt;nome_intrinseco&gt;(&lt;argumentos&gt;)</code>: Chama uma <strong>função intrínseca</strong> do LLVM, que são ganchos especiais para o otimizador e o backend.</li>
</ul></li>
</ul>
<p>Com esta base, a leitora está preparada para interpretar os códigos IR, tanto otimizados quanto não otimizados, que analisaremos a seguir.</p>
</section>
</section>
</section>
<section id="primeiro-exemplo-geração-e-análise-de-ir" class="level2" data-number="16.3">
<h2 data-number="16.3" class="anchored" data-anchor-id="primeiro-exemplo-geração-e-análise-de-ir"><span class="header-section-number">16.3</span> Primeiro Exemplo: Geração e Análise de IR</h2>
<section id="exemplo-mais-completo-múltiplas-operações" class="level3" data-number="16.3.1">
<h3 data-number="16.3.1" class="anchored" data-anchor-id="exemplo-mais-completo-múltiplas-operações"><span class="header-section-number">16.3.1</span> Exemplo Mais Completo: Múltiplas Operações</h3>
<p>Para ver otimizações mais claramente, vamos usar um exemplo mais elaborado.</p>
<p>Crie o arquivo <code>exemplo01_completo.cpp</code>:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co">// exemplo01_completo.cpp</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> calcular<span class="op">(</span><span class="dt">int</span> x<span class="op">)</span> <span class="op">{</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> temp1 <span class="op">=</span> x <span class="op">+</span> <span class="dv">5</span><span class="op">;</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> temp2 <span class="op">=</span> temp1 <span class="op">*</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> temp3 <span class="op">=</span> temp2 <span class="op">+</span> <span class="dv">10</span><span class="op">;</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> temp4 <span class="op">=</span> temp3 <span class="op">*</span> <span class="dv">3</span><span class="op">;</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> temp4<span class="op">;</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> x <span class="op">=</span> <span class="dv">10</span><span class="op">;</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> resultado <span class="op">=</span> calcular<span class="op">(</span>x<span class="op">);</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Este exemplo é melhor porque:</p>
<ul>
<li>tem múltiplas operações que podem ser simplificadas;</li>
<li>usa variáveis intermediárias que podem ser eliminadas;</li>
<li>O resultado final pode ser calculado em tempo de compilação, <em>constant folding</em>.</li>
</ul>
</section>
<section id="gerar-o-llvm-ir" class="level3" data-number="16.3.2">
<h3 data-number="16.3.2" class="anchored" data-anchor-id="gerar-o-llvm-ir"><span class="header-section-number">16.3.2</span> Gerar o <strong>LLVM IR</strong></h3>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>IMPORTANTE sobre o atributo <code>optnone</code></strong></p>
<p>Quando você compila com <code>-O0</code>, o <code>clang</code> adiciona o atributo <code>optnone</code> às funções criadas em representação intermediária. <strong>Este atributo instrui o LLVM a não otimizar essas funções</strong>, mesmo se você usar <code>opt</code> depois.</p>
</div>
</div>
<p>Para gerar IR não otimizado mas que possa ser otimizado posteriormente, use uma destas abordagens:</p>
<p><strong>Opção 1: Desabilitar o atributo optnone (recomendada para estudo)</strong>:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">clang</span>++ <span class="at">-S</span> <span class="at">-emit-llvm</span> <span class="at">-O0</span> <span class="at">-Xclang</span> <span class="at">-disable-O0-optnone</span> exemplo01_completo.cpp <span class="at">-o</span> exemplo01_completo.ll</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Opção 2: Usar -O1 e desabilitar passes do LLVM (alternativa)</strong>:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">clang</span>++ <span class="at">-S</span> <span class="at">-emit-llvm</span> <span class="at">-O1</span> <span class="at">-Xclang</span> <span class="at">-disable-llvm-passes</span> exemplo01_soma.cpp <span class="at">-o</span> exemplo01_soma.ll</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Opção 3: Gerar IR otimizado diretamente (para comparação)</strong>:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">clang</span>++ <span class="at">-S</span> <span class="at">-emit-llvm</span> <span class="at">-O3</span> exemplo01_soma.cpp <span class="at">-o</span> exemplo01_soma.ll</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Nas três opções acima, a atenta leitora evitará os problemas causados pelo <code>optnone</code>. Além disso, nas três opções o arquivo gerado será um arquivo <code>.ll</code> legível. Nas três opções usamos os seguintes parâmetros:</p>
<ul>
<li><code>-S</code>: gera <strong>assembly</strong>, ou IR neste caso;</li>
<li><code>-emit-llvm</code>: especifica que a saída deve ser IR do LLVM;</li>
<li><code>-O0</code>: sem otimização, mas adiciona <code>optnone</code> por padrão;</li>
<li><code>-Xclang -disable-O0-optnone</code>: remove o atributo <code>optnone</code>;</li>
<li><code>-Xclang -disable-llvm-passes</code>: desabilita passes de otimização do LLVM;</li>
<li><code>-o</code>: nome do arquivo de saída.</li>
</ul>
<p><strong>Para verificar se uma função tem o atributo optnone</strong>:</p>
<p>Caso a leitora ainda tenha dúvidas se o atributo <code>optnone</code> está presente, pode usar o comando:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">grep</span> <span class="st">"optnone"</span> exemplo01_soma.ll</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Se você vir <code>optnone</code> na lista de atributos da função, o <code>opt</code> vai ignorar essa função completamente! E a desapontada leitora terá dois arquivos idênticos antes e depois da otimização.</p>
</section>
<section id="análise-detalhada-do-ir-gerado" class="level3" data-number="16.3.3">
<h3 data-number="16.3.3" class="anchored" data-anchor-id="análise-detalhada-do-ir-gerado"><span class="header-section-number">16.3.3</span> Análise Detalhada do IR Gerado</h3>
<p>Se a curiosa leitora abrir o arquivo <code>exemplo01_completo.ll</code> no VS Code. Você verá algo como:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode llvm code-with-copy"><code class="sourceCode llvm"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co">; ModuleID = 'exemplo01_soma.cpp'</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>source_filename = <span class="st">"exemplo01_soma.cpp"</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="kw">target</span> <span class="kw">datalayout</span> = <span class="st">"e-m:e-p270:32:32-p271:32:32-p272:64:64-i64:64-f80:128-n8:16:32:64-S128"</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="kw">target</span> <span class="kw">triple</span> = <span class="st">"x86_64-pc-linux-gnu"</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="co">; Função soma</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="kw">define</span> dso_local <span class="dt">i32</span> <span class="fu">@_Z4somaii</span>(<span class="dt">i32</span> noundef <span class="fu">%a</span>, <span class="dt">i32</span> noundef <span class="fu">%b</span>) #<span class="dv">0</span> {</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="fu">entry:</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">%add</span> = <span class="kw">add</span> <span class="kw">nsw</span> <span class="dt">i32</span> <span class="fu">%a</span>, <span class="fu">%b</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">ret</span> <span class="dt">i32</span> <span class="fu">%add</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a><span class="co">; Função main</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a><span class="kw">define</span> dso_local <span class="dt">i32</span> <span class="fu">@main</span>() #<span class="dv">0</span> {</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a><span class="fu">entry:</span></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">%x</span> = <span class="kw">alloca</span> <span class="dt">i32</span>, <span class="kw">align</span> <span class="dv">4</span></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">%y</span> = <span class="kw">alloca</span> <span class="dt">i32</span>, <span class="kw">align</span> <span class="dv">4</span></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">%resultado</span> = <span class="kw">alloca</span> <span class="dt">i32</span>, <span class="kw">align</span> <span class="dv">4</span></span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>  <span class="kw">store</span> <span class="dt">i32</span> <span class="dv">5</span>, ptr <span class="fu">%x</span>, <span class="kw">align</span> <span class="dv">4</span></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>  <span class="kw">store</span> <span class="dt">i32</span> <span class="dv">7</span>, ptr <span class="fu">%y</span>, <span class="kw">align</span> <span class="dv">4</span></span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">%0</span> = <span class="kw">load</span> <span class="dt">i32</span>, ptr <span class="fu">%x</span>, <span class="kw">align</span> <span class="dv">4</span></span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">%1</span> = <span class="kw">load</span> <span class="dt">i32</span>, ptr <span class="fu">%y</span>, <span class="kw">align</span> <span class="dv">4</span></span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">%call</span> = <span class="kw">call</span> <span class="dt">i32</span> <span class="fu">@_Z4somaii</span>(<span class="dt">i32</span> noundef <span class="fu">%0</span>, <span class="dt">i32</span> noundef <span class="fu">%1</span>)</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>  <span class="kw">store</span> <span class="dt">i32</span> <span class="fu">%call</span>, ptr <span class="fu">%resultado</span>, <span class="kw">align</span> <span class="dv">4</span></span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>  <span class="kw">ret</span> <span class="dt">i32</span> <span class="dv">0</span></span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Neste ponto, a leitora deve se familiarizar com os principais elementos que compõem o <strong>LLVM IR</strong>:</p>
<ol type="1">
<li><p><strong>Metadados do Módulo</strong></p>
<ul>
<li><code>target datalayout</code>: layout de dados da arquitetura alvo;</li>
<li><code>target triple</code>: especificação da plataforma (OS, arquitetura);</li>
</ul></li>
<li><p><strong>Tipos de Dados</strong></p>
<ul>
<li><code>i32</code>: inteiro de 32 bits;</li>
<li><code>ptr</code>: ponteiro genérico;</li>
<li><code>void</code>: sem valor de retorno;</li>
</ul></li>
<li><p><strong>Nome <em>Mangling</em></strong></p>
<ul>
<li><code>@_Z4somaii</code>: nome decorado da função <code>soma</code>;</li>
<li>C++ usa <em>name mangling</em> para suportar sobrecarga de funções;</li>
</ul>
<p>:::{.callout-note} <strong><em>Name Mangling</em></strong>, do inglês decoração de nomes, é uma técnica que o compilador C++ usa para transformar nomes de funções em identificadores únicos. Esta técnica é necessária porque o C++ permite sobrecarga de funções (múltiplas funções com o mesmo nome mas parâmetros diferentes):</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> calcular<span class="op">(</span><span class="dt">int</span> x<span class="op">);</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> calcular<span class="op">(</span><span class="dt">int</span> x<span class="op">,</span> <span class="dt">int</span> y<span class="op">);</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> calcular<span class="op">(</span><span class="dt">float</span> x<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>No código de máquina (ou IR), cada função precisa de um nome único. O compilador “decora” o nome incluindo informações sobre os parâmetros. Por exemplo:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> calcular<span class="op">(</span><span class="dt">int</span> x<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>No <strong>LLVM IR</strong> teremos:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode llvm code-with-copy"><code class="sourceCode llvm"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">@_Z8calculari</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>No qual temos:</p>
<ul>
<li><code>_Z</code> = prefixo padrão;</li>
<li><code>8</code> = tamanho do nome “calcular” (8 caracteres);</li>
<li><code>calcular</code> = nome original;</li>
<li><code>i = parâmetro do tipo</code>int`; :::</li>
</ul></li>
<li><p><strong>Instruções de Memória</strong>:</p>
<ul>
<li><code>alloca</code>: aloca memória na stack;</li>
<li><code>store</code>: armazena valor em endereço de memória;</li>
<li><code>load</code>: carrega valor de endereço de memória;</li>
</ul></li>
<li><p><strong>Instruções Aritméticas</strong>:</p>
<ul>
<li><code>add nsw</code>: adição com verificação de <em>overflow</em>, no signed wrap_;</li>
<li><code>mul</code>, <code>sub</code>, <code>sdiv</code>, etc.</li>
</ul>
<p>:::{.callout-note} <strong>Adição com Verificação de Overflow (nsw - No Signed Wrap)</strong></p>
<p>Quando você soma dois inteiros com sinal, existe o risco de <em>overflow</em>: o resultado pode ser grande demais para caber no tipo de dado.</p>
<p><strong>Exemplo de overflow</strong>:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> a <span class="op">=</span> <span class="dv">2000000000</span><span class="op">;</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> b <span class="op">=</span> <span class="dv">2000000000</span><span class="op">;</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> c <span class="op">=</span> a <span class="op">+</span> b<span class="op">;</span>  <span class="co">// Overflow! Resultado indefinido</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>No <strong>LLVM IR</strong>, a instrução <code>add nsw</code> significa:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode llvm code-with-copy"><code class="sourceCode llvm"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">%resultado</span> = <span class="kw">add</span> <span class="kw">nsw</span> <span class="dt">i32</span> <span class="fu">%a</span>, <span class="fu">%b</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><strong><code>nsw</code></strong> = “no signed wrap” (sem estouro de sinal);</li>
<li>É uma <strong>garantia</strong> para o otimizador: <em>este cálculo nunca vai causar overflow</em>;</li>
<li>Se houver <em>overflow</em>, o comportamento é <strong>indefinido</strong> (não é detectado, apenas assumido que não acontece);</li>
</ul>
<p><strong>Por que isso importa?</strong></p>
<p>O flag <code>nsw</code> permite otimizações mais agressivas:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode llvm code-with-copy"><code class="sourceCode llvm"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co">; Com nsw, o otimizador pode fazer:</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>x = (a + <span class="dv">1</span>) - <span class="dv">1</span>    →    x = a</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="co">; Sem nsw, essa simplificação pode estar errada se houver _overflow_</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Outros flags similares</strong>:</p>
<ul>
<li><code>nuw</code> = “no unsigned wrap” (para inteiros sem sinal);</li>
<li><code>nnan</code> = “no NaN” (para ponto flutuante);</li>
<li><code>exact</code> = divisão exata (sem resto).</li>
</ul>
<p>Por padrão, o clang adiciona <code>nsw</code> quando compila código C++ normal, assumindo que o programador evita <em>overflow</em> intencionalmente por ser este um comportamento indefinido em C++. :::</p></li>
<li><p><strong>Controle de Fluxo</strong>:</p>
<ul>
<li><code>ret</code>: retorna da função;</li>
<li><code>call</code>: chama outra função;</li>
<li><code>br</code>: Branch (desvio condicional ou incondicional)</li>
</ul></li>
</ol>
</section>
<section id="otimização-do-ir" class="level3" data-number="16.3.4">
<h3 data-number="16.3.4" class="anchored" data-anchor-id="otimização-do-ir"><span class="header-section-number">16.3.4</span> Otimização do IR</h3>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>IMPORTANTE</strong>: A partir do LLVM 14, o novo Pass Manager é o padrão. A sintaxe antiga <code>-O3</code> não funciona mais com <code>opt</code>. Use a nova sintaxe com <code>-passes</code>:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Sintaxe CORRETA para LLVM 14+</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="ex">opt</span> <span class="at">-passes</span><span class="op">=</span><span class="st">'default&lt;O3&gt;'</span> <span class="at">-S</span> exemplo01_completo.ll <span class="at">-o</span> exemplo01_completo_opt.ll</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Sintaxe Alternativa</strong>, se a versão for anterior ao LLVM 14:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Sintaxe antiga (LLVM 13 e anteriores)</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="ex">opt</span> <span class="at">-O3</span> <span class="at">-S</span> exemplo01_completo.ll <span class="at">-o</span> exemplo01_completo_opt.ll</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Para verificar qual versão do LLVM você está usando:</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="ex">opt</span> <span class="at">--version</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>Caso a esforçada leitora abra <code>exemplo01_completo_opt.ll</code> e compare com o original, verá algo dramático:</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode llvm code-with-copy"><code class="sourceCode llvm"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co">; Função calcular OTIMIZADA</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="kw">define</span> dso_local <span class="dt">i32</span> <span class="fu">@_Z8calculari</span>(<span class="dt">i32</span> noundef <span class="fu">%x</span>) {</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="fu">entry:</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">%mul</span> = <span class="kw">mul</span> <span class="kw">nsw</span> <span class="dt">i32</span> <span class="fu">%x</span>, <span class="dv">6</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">%add</span> = <span class="kw">add</span> <span class="kw">nsw</span> <span class="dt">i32</span> <span class="fu">%mul</span>, <span class="dv">60</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">ret</span> <span class="dt">i32</span> <span class="fu">%add</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a><span class="co">; Ou ainda mais otimizado (dependendo do compilador)</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a><span class="kw">define</span> dso_local <span class="dt">i32</span> <span class="fu">@_Z8calculari</span>(<span class="dt">i32</span> noundef <span class="fu">%x</span>) {</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a><span class="fu">entry:</span></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">%0</span> = <span class="kw">mul</span> <span class="kw">nsw</span> <span class="dt">i32</span> <span class="fu">%x</span>, <span class="dv">6</span></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">%1</span> = <span class="kw">add</span> <span class="kw">nsw</span> <span class="dt">i32</span> <span class="fu">%0</span>, <span class="dv">60</span></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">ret</span> <span class="dt">i32</span> <span class="fu">%1</span></span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Mudanças a serem observadas com atenção</strong>:</p>
<ul>
<li>As 5 variáveis locais (<code>temp1</code>, <code>temp2</code>, etc.) foram <strong>completamente eliminadas</strong>;</li>
<li>As 4 operações foram <strong>simplificadas</strong> para 2: uma multiplicação e uma adição;</li>
<li>Todas as operações <code>alloca</code>, <code>store</code> e <code>load</code> foram <strong>removidas</strong>;</li>
<li>A matemática foi simplificada: <code>((x + 5) * 2 + 10) * 3 = (x * 6) + 60</code>;</li>
</ul>
<p><strong>Função <em>main</em> otimizada</strong>:</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode llvm code-with-copy"><code class="sourceCode llvm"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="kw">define</span> dso_local <span class="dt">i32</span> <span class="fu">@main</span>() {</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="fu">entry:</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">ret</span> <span class="dt">i32</span> <span class="dv">0</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>A função <code>main</code> foi <strong>completamente simplificada</strong>! O otimizador:</p>
<ol type="1">
<li>Detectou que <code>calcular(10)</code> pode ser calculado em tempo de compilação;</li>
<li>Calculou: <code>(10 * 6) + 60 = 120</code>;</li>
<li>Notou que o resultado não é usado;</li>
<li>Eliminou todo o código morto;</li>
<li>Manteve apenas o <code>return 0</code>.</li>
</ol>
<p><strong>Comparar tamanhos:</strong></p>
<div class="sourceCode" id="cb33"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"Linhas antes da otimização:"</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="fu">wc</span> <span class="at">-l</span> exemplo01_completo.ll</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"Linhas depois da otimização:"</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="fu">wc</span> <span class="at">-l</span> exemplo01_completo_opt.ll</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>A leitora deve ver uma redução de aproximadamente 60-70% no número de linhas!</p>
</section>
<section id="gerar-ir-com-diferentes-níveis-de-otimização" class="level3" data-number="16.3.5">
<h3 data-number="16.3.5" class="anchored" data-anchor-id="gerar-ir-com-diferentes-níveis-de-otimização"><span class="header-section-number">16.3.5</span> Gerar IR com Diferentes Níveis de Otimização</h3>
<p>Existem duas formas de gerar IR otimizado:</p>
<p><strong>Método 1: Usar o <code>clang</code> diretamente</strong>:</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Sem otimização (mas sem optnone!)</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="fu">clang</span>++ <span class="at">-S</span> <span class="at">-emit-llvm</span> <span class="at">-O0</span> <span class="at">-Xclang</span> <span class="at">-disable-O0-optnone</span> exemplo01_completo.cpp <span class="at">-o</span> exemplo01_O0.ll</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Otimização nível 1</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a><span class="fu">clang</span>++ <span class="at">-S</span> <span class="at">-emit-llvm</span> <span class="at">-O1</span> exemplo01_completo.cpp <span class="at">-o</span> exemplo01_O1.ll</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Otimização nível 2</span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a><span class="fu">clang</span>++ <span class="at">-S</span> <span class="at">-emit-llvm</span> <span class="at">-O2</span> exemplo01_completo.cpp <span class="at">-o</span> exemplo01_O2.ll</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Otimização nível 3</span></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a><span class="fu">clang</span>++ <span class="at">-S</span> <span class="at">-emit-llvm</span> <span class="at">-O3</span> exemplo01_completo.cpp <span class="at">-o</span> exemplo01_O3.ll</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Método 2: Gerar IR não-otimizado e depois otimizar com opt</strong> (LLVM 14+):</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Primeiro gerar o IR sem otimização (SEM optnone!)</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="fu">clang</span>++ <span class="at">-S</span> <span class="at">-emit-llvm</span> <span class="at">-O0</span> <span class="at">-Xclang</span> <span class="at">-disable-O0-optnone</span> exemplo01_completo.cpp <span class="at">-o</span> exemplo01_base.ll</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Depois otimizar com opt usando o novo Pass Manager</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a><span class="ex">opt</span> <span class="at">-passes</span><span class="op">=</span><span class="st">'default&lt;O1&gt;'</span> <span class="at">-S</span> exemplo01_base.ll <span class="at">-o</span> exemplo01_O1_opt.ll</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a><span class="ex">opt</span> <span class="at">-passes</span><span class="op">=</span><span class="st">'default&lt;O2&gt;'</span> <span class="at">-S</span> exemplo01_base.ll <span class="at">-o</span> exemplo01_O2_opt.ll</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a><span class="ex">opt</span> <span class="at">-passes</span><span class="op">=</span><span class="st">'default&lt;O3&gt;'</span> <span class="at">-S</span> exemplo01_base.ll <span class="at">-o</span> exemplo01_O3_opt.ll</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Comparando os resultados</strong>:</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Ver número de linhas de cada versão</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="fu">wc</span> <span class="at">-l</span> exemplo01_O<span class="pp">*</span>.ll</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Ver apenas a função calcular de cada versão</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> arquivo <span class="kw">in</span> exemplo01_O<span class="pp">*</span>.ll<span class="kw">;</span> <span class="cf">do</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">"=== </span><span class="va">$arquivo</span><span class="st"> ==="</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sed</span> <span class="at">-n</span> <span class="st">'/@.*calcular/,/^}/p'</span> <span class="st">"</span><span class="va">$arquivo</span><span class="st">"</span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">""</span></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a><span class="cf">done</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Demonstração: O Problema do optnone</strong>:</p>
<p>Vamos ver a diferença entre gerar IR com e sem optnone:</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># COM optnone (ERRADO para otimização posterior)</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="fu">clang</span>++ <span class="at">-S</span> <span class="at">-emit-llvm</span> <span class="at">-O0</span> exemplo01_completo.cpp <span class="at">-o</span> com_optnone.ll</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="co"># SEM optnone (CORRETO)</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="fu">clang</span>++ <span class="at">-S</span> <span class="at">-emit-llvm</span> <span class="at">-O0</span> <span class="at">-Xclang</span> <span class="at">-disable-O0-optnone</span> exemplo01_completo.cpp <span class="at">-o</span> sem_optnone.ll</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Verificar a presença do atributo</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"=== Arquivo COM optnone ==="</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a><span class="fu">grep</span> <span class="st">"attributes #0"</span> com_optnone.ll</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="at">-e</span> <span class="st">"\n=== Arquivo SEM optnone ==="</span></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a><span class="fu">grep</span> <span class="st">"attributes #0"</span> sem_optnone.ll</span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Tentar otimizar ambos</span></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a><span class="ex">opt</span> <span class="at">-passes</span><span class="op">=</span><span class="st">'default&lt;O3&gt;'</span> <span class="at">-S</span> com_optnone.ll <span class="at">-o</span> com_optnone_opt.ll</span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a><span class="ex">opt</span> <span class="at">-passes</span><span class="op">=</span><span class="st">'default&lt;O3&gt;'</span> <span class="at">-S</span> sem_optnone.ll <span class="at">-o</span> sem_optnone_opt.ll</span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Comparar resultados</span></span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="at">-e</span> <span class="st">"\n=== Resultados da otimização ==="</span></span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"COM optnone - linhas antes: </span><span class="va">$(</span><span class="fu">wc</span> <span class="at">-l</span> <span class="op">&lt;</span> com_optnone.ll<span class="va">)</span><span class="st">, depois: </span><span class="va">$(</span><span class="fu">wc</span> <span class="at">-l</span> <span class="op">&lt;</span> com_optnone_opt.ll<span class="va">)</span><span class="st">"</span></span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"SEM optnone - linhas antes: </span><span class="va">$(</span><span class="fu">wc</span> <span class="at">-l</span> <span class="op">&lt;</span> sem_optnone.ll<span class="va">)</span><span class="st">, depois: </span><span class="va">$(</span><span class="fu">wc</span> <span class="at">-l</span> <span class="op">&lt;</span> sem_optnone_opt.ll<span class="va">)</span><span class="st">"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Você verá que o arquivo COM optnone <strong>não será otimizado</strong>!</p>
</section>
<section id="entendendo-o-novo-pass-manager-llvm-14" class="level3" data-number="16.3.6">
<h3 data-number="16.3.6" class="anchored" data-anchor-id="entendendo-o-novo-pass-manager-llvm-14"><span class="header-section-number">16.3.6</span> Entendendo o Novo Pass Manager (LLVM 14+)</h3>
<p>O LLVM mudou para um novo sistema de gerenciamento de passes a partir da versão 14. Aqui estão as principais diferenças:</p>
<p><strong>Sintaxe Antiga (Legacy Pass Manager - até LLVM 13)</strong>:</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="ex">opt</span> <span class="at">-O3</span> <span class="at">-S</span> arquivo.ll <span class="at">-o</span> arquivo_opt.ll</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="ex">opt</span> <span class="at">-mem2reg</span> <span class="at">-instcombine</span> <span class="at">-S</span> arquivo.ll <span class="at">-o</span> arquivo_opt.ll</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Sintaxe Nova (New Pass Manager - LLVM 14+):</strong></p>
<div class="sourceCode" id="cb39"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Pipelines predefinidos</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="ex">opt</span> <span class="at">-passes</span><span class="op">=</span><span class="st">'default&lt;O3&gt;'</span> <span class="at">-S</span> arquivo.ll <span class="at">-o</span> arquivo_opt.ll</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Passes individuais separados por vírgula</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a><span class="ex">opt</span> <span class="at">-passes</span><span class="op">=</span><span class="st">'mem2reg,instcombine'</span> <span class="at">-S</span> arquivo.ll <span class="at">-o</span> arquivo_opt.ll</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Pipeline completo com múltiplos passes</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a><span class="ex">opt</span> <span class="at">-passes</span><span class="op">=</span><span class="st">'function(mem2reg,instcombine),module(inline)'</span> <span class="at">-S</span> arquivo.ll <span class="at">-o</span> arquivo_opt.ll</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Verificar qual Pass Manager está ativo:</strong></p>
<div class="sourceCode" id="cb40"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Ver informações sobre passes</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="ex">opt</span> <span class="at">-passes</span><span class="op">=</span><span class="st">'default&lt;O3&gt;'</span> <span class="at">-debug-pass-manager</span> <span class="at">-S</span> arquivo.ll <span class="at">-o</span> /dev/null <span class="dv">2</span><span class="op">&gt;&amp;</span><span class="dv">1</span> <span class="kw">|</span> <span class="fu">head</span> <span class="at">-20</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Forçar o uso do Legacy PM (se necessário, apenas LLVM 13-15):</strong></p>
<div class="sourceCode" id="cb41"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="ex">opt</span> <span class="at">-enable-new-pm</span><span class="op">=</span>0 <span class="at">-O3</span> <span class="at">-S</span> arquivo.ll <span class="at">-o</span> arquivo_opt.ll</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="exemplo-com-controle-de-fluxo" class="level2" data-number="16.4">
<h2 data-number="16.4" class="anchored" data-anchor-id="exemplo-com-controle-de-fluxo"><span class="header-section-number">16.4</span> Exemplo com Controle de Fluxo</h2>
<p>Artefatos de controle de fluxo, como <code>if-else</code>, <code>for</code> e <code>while</code>, formam a espinha dorsal da lógica em qualquer linguagem de programação. Na Representação Intermediária do LLVM, essas estruturas de alto nível não existem como instruções únicas. Em vez disso, elas são decompostas em uma combinação de três elementos fundamentais:</p>
<ol type="1">
<li><strong>Comparações</strong>: para avaliar as condições;</li>
<li><strong>Branches (Desvios)</strong>: para pular para diferentes partes do código com base no resultado das comparações;</li>
<li><strong>Blocos Básicos com Rótulos (Labels)</strong>: os destinos para esses pulos.</li>
</ol>
<p>Nesta seção, vamos explorar como um <code>if-else</code> do C++ é traduzido para o <strong>LLVM IR</strong> e como podemos garantir que sua estrutura de desvio seja preservada para análise.</p>
<section id="código-com-condicionais-garantindo-o-branch" class="level3" data-number="16.4.1">
<h3 data-number="16.4.1" class="anchored" data-anchor-id="código-com-condicionais-garantindo-o-branch"><span class="header-section-number">16.4.1</span> Código com Condicionais (Garantindo o Branch)</h3>
<p>O <em>frontend</em> do <strong>Clang</strong> é extremamente eficiente em otimizar padrões de código simples. Uma função como <code>if (a &gt; b) return a; else return b;</code> é frequentemente convertida diretamente para uma instrução <code>select</code>, um operador ternário, mesmo com as otimizações desligadas, eliminando completamente os desvios e blocos.</p>
<p>Para forçar o compilador a gerar a estrutura completa de desvio (<code>branch</code>) que queremos estudar, precisamos introduzir um <strong>efeito colateral</strong>, <em>side effect</em>, dentro dos blocos <code>if</code> e <code>else</code>. Um efeito colateral é uma ação que modifica um estado fora da função, como chamar uma função de I/O (<code>printf</code>) ou, de forma mais simples, modificar uma variável global (ARRRGh!!!). Essa ação não pode ser otimizada para uma instrução <code>select</code>, que lida apenas com a escolha de valores e forçará a criação de uma estrutura de desvio completa na Representação Intermediária do LLVM.</p>
<p>A criativa leitora deve criar o arquivo <code>exemplo02_condicional_global.cpp</code>:</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co">// exemplo02_condicional_global.cpp</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Variável global para criar o efeito colateral.</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a><span class="co">// O compilador não pode otimizar a escrita nesta variável,</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a><span class="co">// pois outro módulo ou thread poderia lê-la.</span></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> variavel_global_para_teste <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> max_com_efeito_global<span class="op">(</span><span class="dt">int</span> a<span class="op">,</span> <span class="dt">int</span> b<span class="op">)</span> <span class="op">{</span></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> resultado<span class="op">;</span></span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>a <span class="op">&gt;</span> b<span class="op">)</span> <span class="op">{</span></span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Efeito colateral: modificar o estado global</span></span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>        variavel_global_para_teste <span class="op">=</span> <span class="dv">1</span><span class="op">;</span> </span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>        resultado <span class="op">=</span> a<span class="op">;</span></span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Efeito colateral: modificar o estado global</span></span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a>        variavel_global_para_teste <span class="op">=</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a>        resultado <span class="op">=</span> b<span class="op">;</span></span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> resultado<span class="op">;</span></span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb42-21"><a href="#cb42-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-22"><a href="#cb42-22" aria-hidden="true" tabindex="-1"></a><span class="co">// Uma função main simples para ter um executável completo</span></span>
<span id="cb42-23"><a href="#cb42-23" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb42-24"><a href="#cb42-24" aria-hidden="true" tabindex="-1"></a>    max_com_efeito_global<span class="op">(</span><span class="dv">10</span><span class="op">,</span> <span class="dv">20</span><span class="op">);</span></span>
<span id="cb42-25"><a href="#cb42-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb42-26"><a href="#cb42-26" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="gerar-e-analisar-o-ir" class="level3" data-number="16.4.2">
<h3 data-number="16.4.2" class="anchored" data-anchor-id="gerar-e-analisar-o-ir"><span class="header-section-number">16.4.2</span> Gerar e Analisar o IR</h3>
<p>Para inspecionar a estrutura de controle de fluxo de forma clara, é fundamental gerar o IR <strong>sem otimizações</strong> e, mais importante ainda, <strong>sem o atributo <code>optnone</code></strong>.</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">clang</span>++ <span class="at">-S</span> <span class="at">-emit-llvm</span> <span class="at">-O0</span> <span class="at">-Xclang</span> <span class="at">-disable-O0-optnone</span> exemplo02_condicional_global.cpp <span class="at">-o</span> exemplo02_condicional_global.ll</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Ao abrir o arquivo <code>exemplo02_condicional_global.ll</code>, a atenta leitora encontrará a seguinte representação para a função <code>max_com_efeito_global</code>:</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode llvm code-with-copy"><code class="sourceCode llvm"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co">; ModuleID = 'exemplo02_condicional_global.cpp'</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>source_filename = <span class="st">"exemplo02_condicional_global.cpp"</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="kw">target</span> <span class="kw">datalayout</span> = <span class="st">"e-m:e-p270:32:32-p271:32:32-p272:64:64-i64:64-i128:128-f80:128-n8:16:32:64-S128"</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="kw">target</span> <span class="kw">triple</span> = <span class="st">"x86_64-pc-linux-gnu"</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a><span class="fu">@variavel_global_para_teste</span> = dso_local <span class="kw">global</span> <span class="dt">i32</span> <span class="dv">0</span>, <span class="kw">align</span> <span class="dv">4</span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a><span class="co">; Function Attrs: mustprogress noinline nounwind uwtable</span></span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a><span class="kw">define</span> dso_local noundef <span class="dt">i32</span> <span class="fu">@_Z21max_com_efeito_globalii</span>(<span class="dt">i32</span> noundef <span class="fu">%0</span>, <span class="dt">i32</span> noundef <span class="fu">%1</span>) #<span class="dv">0</span> {</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>&nbsp; <span class="fu">%3</span> = <span class="kw">alloca</span> <span class="dt">i32</span>, <span class="kw">align</span> <span class="dv">4</span></span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>&nbsp; <span class="fu">%4</span> = <span class="kw">alloca</span> <span class="dt">i32</span>, <span class="kw">align</span> <span class="dv">4</span></span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>&nbsp; <span class="fu">%5</span> = <span class="kw">alloca</span> <span class="dt">i32</span>, <span class="kw">align</span> <span class="dv">4</span></span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>&nbsp; <span class="kw">store</span> <span class="dt">i32</span> <span class="fu">%0</span>, ptr <span class="fu">%3</span>, <span class="kw">align</span> <span class="dv">4</span></span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>&nbsp; <span class="kw">store</span> <span class="dt">i32</span> <span class="fu">%1</span>, ptr <span class="fu">%4</span>, <span class="kw">align</span> <span class="dv">4</span></span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>&nbsp; <span class="fu">%6</span> = <span class="kw">load</span> <span class="dt">i32</span>, ptr <span class="fu">%3</span>, <span class="kw">align</span> <span class="dv">4</span></span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>&nbsp; <span class="fu">%7</span> = <span class="kw">load</span> <span class="dt">i32</span>, ptr <span class="fu">%4</span>, <span class="kw">align</span> <span class="dv">4</span></span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a>&nbsp; <span class="fu">%8</span> = <span class="kw">icmp</span> <span class="kw">sgt</span> <span class="dt">i32</span> <span class="fu">%6</span>, <span class="fu">%7</span></span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a>&nbsp; <span class="kw">br</span> <span class="dt">i1</span> <span class="fu">%8</span>, <span class="dt">label</span> <span class="fu">%9</span>, <span class="dt">label</span> <span class="fu">%11</span></span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a><span class="dv">9</span>:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co">; preds = %2</span></span>
<span id="cb44-21"><a href="#cb44-21" aria-hidden="true" tabindex="-1"></a>&nbsp; <span class="kw">store</span> <span class="dt">i32</span> <span class="dv">1</span>, ptr <span class="fu">@variavel_global_para_teste</span>, <span class="kw">align</span> <span class="dv">4</span></span>
<span id="cb44-22"><a href="#cb44-22" aria-hidden="true" tabindex="-1"></a>&nbsp; <span class="fu">%10</span> = <span class="kw">load</span> <span class="dt">i32</span>, ptr <span class="fu">%3</span>, <span class="kw">align</span> <span class="dv">4</span></span>
<span id="cb44-23"><a href="#cb44-23" aria-hidden="true" tabindex="-1"></a>&nbsp; <span class="kw">store</span> <span class="dt">i32</span> <span class="fu">%10</span>, ptr <span class="fu">%5</span>, <span class="kw">align</span> <span class="dv">4</span></span>
<span id="cb44-24"><a href="#cb44-24" aria-hidden="true" tabindex="-1"></a>&nbsp; <span class="kw">br</span> <span class="dt">label</span> <span class="fu">%13</span></span>
<span id="cb44-25"><a href="#cb44-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-26"><a href="#cb44-26" aria-hidden="true" tabindex="-1"></a><span class="dv">11</span>:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="co">; preds = %2</span></span>
<span id="cb44-27"><a href="#cb44-27" aria-hidden="true" tabindex="-1"></a>&nbsp; <span class="kw">store</span> <span class="dt">i32</span> <span class="dv">2</span>, ptr <span class="fu">@variavel_global_para_teste</span>, <span class="kw">align</span> <span class="dv">4</span></span>
<span id="cb44-28"><a href="#cb44-28" aria-hidden="true" tabindex="-1"></a>&nbsp; <span class="fu">%12</span> = <span class="kw">load</span> <span class="dt">i32</span>, ptr <span class="fu">%4</span>, <span class="kw">align</span> <span class="dv">4</span></span>
<span id="cb44-29"><a href="#cb44-29" aria-hidden="true" tabindex="-1"></a>&nbsp; <span class="kw">store</span> <span class="dt">i32</span> <span class="fu">%12</span>, ptr <span class="fu">%5</span>, <span class="kw">align</span> <span class="dv">4</span></span>
<span id="cb44-30"><a href="#cb44-30" aria-hidden="true" tabindex="-1"></a>&nbsp; <span class="kw">br</span> <span class="dt">label</span> <span class="fu">%13</span></span>
<span id="cb44-31"><a href="#cb44-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-32"><a href="#cb44-32" aria-hidden="true" tabindex="-1"></a><span class="dv">13</span>:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="co">; preds = %11, %9</span></span>
<span id="cb44-33"><a href="#cb44-33" aria-hidden="true" tabindex="-1"></a>&nbsp; <span class="fu">%14</span> = <span class="kw">load</span> <span class="dt">i32</span>, ptr <span class="fu">%5</span>, <span class="kw">align</span> <span class="dv">4</span></span>
<span id="cb44-34"><a href="#cb44-34" aria-hidden="true" tabindex="-1"></a>&nbsp; <span class="kw">ret</span> <span class="dt">i32</span> <span class="fu">%14</span></span>
<span id="cb44-35"><a href="#cb44-35" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="análise-detalhada-do-ir-gerado-1" class="level3" data-number="16.4.3">
<h3 data-number="16.4.3" class="anchored" data-anchor-id="análise-detalhada-do-ir-gerado-1"><span class="header-section-number">16.4.3</span> Análise Detalhada do IR Gerado</h3>
<p>Diferente de um <code>if</code> em C++, a estrutura de controle no <strong>LLVM IR</strong> é explícita e baseada em saltos. Vamos analisar os novos conceitos que este código revela:</p>
<ol type="1">
<li><strong>Variáveis Globais</strong>:
<ul>
<li>A linha <code>@variavel_global_para_teste = dso_local global i32 0, align 4</code> declara nossa variável global. O <code>@</code> indica um identificador global. Aqui, definimos uma variável de 32 bits (<code>i32</code>) inicializada com <code>0</code>.</li>
</ul></li>
<li><strong>Blocos Básicos</strong>:
<ul>
<li>O código é dividido em blocos, cada um com um rótulo, <em>label</em>. Não esqueça: <strong>um bloco básico é uma sequência de instruções que sempre executa do início ao fim, sem saltos para dentro ou para fora, exceto pela instrução final</strong>.</li>
<li>Nossa função tem quatro blocos: um bloco de entrada, sem rótulo explícito, mas é o início, o bloco <code>%9</code> (o <code>if</code>), o bloco <code>%11</code> (o <code>else</code>) e o bloco <code>%13</code> (a junção).</li>
</ul></li>
<li><strong>A Mecânica do <code>if</code></strong>:
<ul>
<li><strong>Condição</strong>: <code>%8 = icmp sgt i32 %6, %7</code>
<ul>
<li>Esta é a instrução de <strong>comparação de inteiros</strong>, <code>icmp</code>,. Ela verifica se <code>%6</code> (valor de <code>a</code>) é <strong>signed greater than</strong> (<code>sgt</code>) <code>%7</code> (valor de <code>b</code>). O resultado, <code>%8</code>, é um valor booleano de 1 bit (<code>i1</code>).</li>
</ul></li>
<li><strong>Desvio Condicional</strong>: <code>br i1 %8, label %9, label %11</code>
<ul>
<li>Esta é a instrução de <strong>branch</strong> (desvio). Ela é o coração do <code>if</code>. Se a condição <code>%8</code> for verdadeira, o fluxo de execução <strong>pula</strong> para o bloco <code>%9</code>. Caso contrário, <strong>pula</strong> para o bloco <code>%11</code>.</li>
</ul></li>
<li><strong>Bloco <code>if.then</code> (Rótulo <code>%9</code>)</strong>:
<ul>
<li><code>store i32 1, ptr @variavel_global_para_teste, align 4</code>: Este é nosso efeito colateral, armazenando <code>1</code> na variável global.</li>
<li>O resto do bloco armazena o valor de <code>a</code> na variável <code>resultado</code>.</li>
<li><code>br label %13</code>: Ao final do bloco, um desvio <strong>incondicional</strong> pula para o bloco <code>%13</code>, que é o ponto de junção após o <code>if-else</code>.</li>
</ul></li>
<li><strong>Bloco <code>if.else</code> (Rótulo <code>%11</code>)</strong>:
<ul>
<li><code>store i32 2, ptr @variavel_global_para_teste, align 4</code>: O efeito colateral do caminho <code>else</code>.</li>
<li>O resto do bloco armazena o valor de <code>b</code> na variável <code>resultado</code>.</li>
<li><code>br label %13</code>: Também pula incondicionalmente para o final.</li>
</ul></li>
<li><strong>Bloco de Junção (Rótulo <code>%13</code>)</strong>:
<ul>
<li><code>preds = %11, %9</code>: A anotação <code>preds</code> (predecessores) informa que este bloco pode ser alcançado a partir dos blocos <code>%11</code> e <code>%9</code>.</li>
<li><code>%14 = load i32, ptr %5, align 4</code>: Carrega o valor final da variável <code>resultado</code>.</li>
<li><code>ret i32 %14</code>: Retorna o resultado.</li>
</ul></li>
</ul></li>
</ol>
<p>Em resumo, a combinação de <code>icmp</code>, <code>br</code> e blocos rotulados é a forma como o <strong>LLVM IR</strong> implementa de maneira explícita e de baixo nível o conceito de alto nível de uma declaração <code>if-else</code>.</p>
</section>
<section id="visualizar-o-grafo-de-fluxo-de-controle-cfg" class="level3" data-number="16.4.4">
<h3 data-number="16.4.4" class="anchored" data-anchor-id="visualizar-o-grafo-de-fluxo-de-controle-cfg"><span class="header-section-number">16.4.4</span> Visualizar o Grafo de Fluxo de Controle (CFG)</h3>
<p>A melhor maneira de entender o fluxo de controle é visualizando-o. O LLVM pode gerar uma representação do Grafo de Fluxo de Controle (CFG) no formato DOT, que pode ser convertido em uma imagem.</p>
<p><strong>Passo 1: Instalar o Graphviz (se ainda não o fez)</strong>:</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apt install graphviz</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Passo 2: Gerar o arquivo .dot a partir do IR</strong>:</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># O passe 'dot-cfg' gera um arquivo .dot para cada função no arquivo .ll</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="ex">opt</span> <span class="at">-passes</span><span class="op">=</span><span class="st">'dot-cfg'</span> <span class="at">-disable-output</span> exemplo02_condicional_global.ll</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Este comando criará um arquivo chamado <code>._Z21max_com_efeito_globalii.dot</code> (o nome pode variar um pouco) no seu diretório.</p>
<p><strong>Passo 3: Converter o arquivo .dot para uma imagem PNG</strong>:</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="ex">dot</span> <span class="at">-Tpng</span> ._Z21max_com_efeito_globalii.dot <span class="at">-o</span> cfg_global.png</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Ao abrir o arquivo <code>cfg_global.png</code>, a curiosa leitora verá uma imagem clara mostrando o bloco de entrada, a bifurcação para os blocos <code>if</code> e <code>else</code>, e a junção deles no bloco final. Esta visualização é uma ferramenta poderosa para entender a estrutura de qualquer função. Esta imagem pode ser vista na <span class="quarto-unresolved-ref">?fig-cfg-global</span>.</p>
<div class="figure[fig-cfg-global]">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src=".\images/exemplo02_condicional_global.webp" class="img-fluid figure-img"></p>
<figcaption>Grafo de Fluxo de Controle (CFG) da função <code>max_com_efeito_global</code></figcaption>
</figure>
</div>
</div>
</section>
<section id="otimização-do-código-com-controle-de-fluxo" class="level3" data-number="16.4.5">
<h3 data-number="16.4.5" class="anchored" data-anchor-id="otimização-do-código-com-controle-de-fluxo"><span class="header-section-number">16.4.5</span> Otimização do Código com Controle de Fluxo</h3>
<p>Já vimos o impacto dramático das otimizações em código puramente aritmético. Mas o que acontece quando aplicamos o mesmo processo a um código que contém desvios e, mais importante, efeitos colaterais? Será que o otimizador consegue eliminar a estrutura <code>if-else</code> mesmo com a escrita na variável global?</p>
<p>A resposta, como a esforçada leitora verá, é surpreendente e revela a genialidade dos compiladores modernos.</p>
<section id="gerando-a-versão-otimizada" class="level4" data-number="16.4.5.1">
<h4 data-number="16.4.5.1" class="anchored" data-anchor-id="gerando-a-versão-otimizada"><span class="header-section-number">16.4.5.1</span> Gerando a Versão Otimizada</h4>
<p>Vamos usar a ferramenta <code>opt</code> para aplicar o pipeline de otimização de nível 3 (<code>O3</code>) ao nosso arquivo <code>exemplo02_condicional_global.ll</code> não otimizado.</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="ex">opt</span> <span class="at">-passes</span><span class="op">=</span><span class="st">'default&lt;O3&gt;'</span> <span class="at">-S</span> exemplo02_condicional_global.ll <span class="at">-o</span> exemplo02_condicional_global_opt.ll</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Ao abrir o arquivo de saída <code>exemplo02_condicional_global_opt.ll</code>, em vez de apenas uma versão mais limpa do <code>if-else</code>, nos deparamos com algo radicalmente diferente. A estrutura de desvio desapareceu completamente!</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode llvm code-with-copy"><code class="sourceCode llvm"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co">; ModuleID = 'exemplo02_condicional_global.ll'</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>source_filename = <span class="st">"exemplo02_condicional_global.cpp"</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="kw">target</span> <span class="kw">datalayout</span> = <span class="st">"e-m:e-p270:32:32-p271:32:32-p272:64:64-i64:64-i128:128-f80:128-n8:16:32:64-S128"</span></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a><span class="kw">target</span> <span class="kw">triple</span> = <span class="st">"x86_64-pc-linux-gnu"</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a><span class="fu">@variavel_global_para_teste</span> = dso_local local_unnamed_addr <span class="kw">global</span> <span class="dt">i32</span> <span class="dv">0</span>, <span class="kw">align</span> <span class="dv">4</span></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a><span class="co">; Function Attrs: mustprogress nofree noinline norecurse nosync nounwind willreturn memory(write, argmem: none, inaccessiblemem: none) uwtable</span></span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a><span class="kw">define</span> dso_local noundef <span class="dt">i32</span> <span class="fu">@_Z21max_com_efeito_globalii</span>(<span class="dt">i32</span> noundef <span class="fu">%0</span>, <span class="dt">i32</span> noundef <span class="fu">%1</span>) local_unnamed_addr #<span class="dv">0</span> {</span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">%3</span> = <span class="kw">icmp</span> <span class="kw">sgt</span> <span class="dt">i32</span> <span class="fu">%0</span>, <span class="fu">%1</span></span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">%.</span> = <span class="kw">select</span> <span class="dt">i1</span> <span class="fu">%3</span>, <span class="dt">i32</span> <span class="dv">1</span>, <span class="dt">i32</span> <span class="dv">2</span></span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">%.7</span> = <span class="kw">tail</span> <span class="kw">call</span> <span class="dt">i32</span> <span class="fu">@llvm.smax.i32</span>(<span class="dt">i32</span> <span class="fu">%0</span>, <span class="dt">i32</span> <span class="fu">%1</span>)</span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">store</span> <span class="dt">i32</span> <span class="fu">%.</span>, ptr <span class="fu">@variavel_global_para_teste</span>, <span class="kw">align</span> <span class="dv">4</span></span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">ret</span> <span class="dt">i32</span> <span class="fu">%.7</span></span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a><span class="co">; Function Attrs: nocallback nofree nosync nounwind speculatable willreturn memory(none)</span></span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> <span class="dt">i32</span> <span class="fu">@llvm.smax.i32</span>(<span class="dt">i32</span>, <span class="dt">i32</span>) #<span class="dv">1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="análise-da-otimização-adeus-ao-branch" class="level4" data-number="16.4.5.2">
<h4 data-number="16.4.5.2" class="anchored" data-anchor-id="análise-da-otimização-adeus-ao-branch"><span class="header-section-number">16.4.5.2</span> Análise da Otimização: Adeus ao Branch</h4>
<p>A estrutura de <code>branch</code> e os múltiplos blocos básicos foram eliminados. O otimizador conseguiu converter um código baseado em <strong>fluxo de controle</strong> (com pulos) em um código linear baseado em <strong>fluxo de dados</strong>. Vamos analisar passo a passo como essa mágica aconteceu:</p>
<ol type="1">
<li><strong>A Condição</strong>: <code>%3 = icmp sgt i32 %0, %1</code>
<ul>
<li>Esta parte permanece a mesma. O compilador primeiro avalia a condição <code>a &gt; b</code> e armazena o resultado booleano (<code>true</code> ou <code>false</code>) em <code>%3</code>.</li>
</ul></li>
<li><strong>Preparação do Valor do Efeito Colateral</strong>: <code>%. = select i1 %3, i32 1, i32 2</code>
<ul>
<li>Aqui está a primeira grande mudança. Em vez de pular, o compilador usa a instrução <code>select</code> para <strong>escolher o valor</strong> que será usado no efeito colateral. Se a condição <code>%3</code> for verdadeira, <code>select</code> retorna <code>1</code>; caso contrário, retorna <code>2</code>. Esse valor é armazenado no registrador <code>%.</code>. Note que o efeito colateral (o <code>store</code>) ainda não aconteceu!</li>
</ul></li>
<li><strong>Cálculo Eficiente do Resultado</strong>: <code>%.7 = tail call i32 @llvm.smax.i32(i32 %0, i32 %1)</code>
<ul>
<li>Esta é a segunda e mais brilhante otimização. O compilador reconheceu que a lógica <code>if (a &gt; b) resultado = a; else resultado = b;</code> é simplesmente uma operação de “máximo”. Em vez de usar blocos para recriar essa lógica, ele a substituiu por uma chamada a uma <strong>função intrínseca</strong> do LLVM.</li>
<li><code>@llvm.smax.i32</code> é um recado para o backend que significa: “encontre o valor <strong>máx</strong>imo entre estes dois inteiros de <strong>32</strong> bits <strong>c</strong>om <strong>s</strong>inal”. O backend pode então traduzir isso para a instrução de máquina mais eficiente possível (como <code>cmovg</code> em x86), que executa uma comparação e movimentação de dados sem nenhum pulo no código.</li>
</ul></li>
<li><strong>Execução do Efeito Colateral</strong>: <code>store i32 %., ptr @variavel_global_para_teste, align 4</code>
<ul>
<li>Agora, com todos os valores calculados, o efeito colateral é finalmente executado. A instrução <code>store</code> pega o valor preparado pela <code>select</code> (<code>1</code> ou <code>2</code>) e o armazena na variável global.</li>
</ul></li>
<li><strong>Retorno</strong>: <code>ret i32 %.7</code>
<ul>
<li>Finalmente, a função retorna o resultado do cálculo de máximo feito pelo intrínseco.</li>
</ul></li>
</ol>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>A Grande Ideia: Separação de Interesses (<em>Separation of Concerns</em>)</strong></p>
<p>O otimizador foi capaz de realizar essa façanha porque percebeu que o <strong>cálculo do valor de retorno</strong> (<code>max(a, b)</code>) e o <strong>cálculo do valor a ser armazenado</strong> (<code>(a &gt; b) ? 1 : 2</code>) eram independentes, embora usassem a mesma condição.</p>
<p>Ele decompôs a função em suas partes lógicas, otimizou cada parte separadamente da forma mais eficiente possível (<code>select</code> para um, <code>llvm.smax.i32</code> para outro) e depois remontou o resultado em uma sequência linear, garantindo que o efeito colateral (<code>store</code>) ainda ocorresse antes do <code>ret</code>, preservando o comportamento do programa original. Esta técnica é conhecida como <strong>If-Conversion</strong> ou <strong>Predicação</strong>.</p>
</div>
</div>
</section>
<section id="o-novo-grafo-de-fluxo-de-controle-cfg" class="level4" data-number="16.4.5.3">
<h4 data-number="16.4.5.3" class="anchored" data-anchor-id="o-novo-grafo-de-fluxo-de-controle-cfg"><span class="header-section-number">16.4.5.3</span> O Novo Grafo de Fluxo de Controle (CFG)</h4>
<p>Se gerarmos o CFG desta versão otimizada, o resultado será drasticamente diferente e revelador.</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Gerar o .dot a partir do arquivo _opt.ll</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="ex">opt</span> <span class="at">-passes</span><span class="op">=</span><span class="st">'dot-cfg'</span> <span class="at">-disable-output</span> exemplo02_condicional_global_opt.ll</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Converter para imagem PNG</span></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a><span class="ex">dot</span> <span class="at">-Tpng</span> ._Z21max_com_efeito_globalii.dot <span class="at">-o</span> cfg_global_opt.png</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>O novo CFG não será mais um diamante. Será um <strong>único bloco retangular</strong>. Como pode ser visto na <span class="quarto-unresolved-ref">?fig-teste2-opt</span> Isso prova visualmente que o compilador conseguiu eliminar completamente todo o fluxo de controle condicional, transformando a função em uma linha reta de execução, o que é o cenário ideal para o desempenho em arquiteturas de CPU modernas.</p>
<div class="figure[fig-teste2-opt]">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src=".\images/teste2l_opt.webp" class="img-fluid figure-img"></p>
<figcaption>Grafo de Fluxo de Controle (CFG) otimizado da função <code>max_com_efeito_global</code></figcaption>
</figure>
</div>
</div>
</section>
</section>
</section>
<section id="exemplo-com-laços-de-repetição-loops" class="level2" data-number="16.5">
<h2 data-number="16.5" class="anchored" data-anchor-id="exemplo-com-laços-de-repetição-loops"><span class="header-section-number">16.5</span> 5. Exemplo com Laços de Repetição (Loops)</h2>
<p>Junto com os desvios condicionais, os laços de repetição são pilares da programação imperativa. No LLVM IR, um laço não é uma instrução única, mas sim uma estrutura específica no Grafo de Fluxo de Controle (CFG). Ele é formado por um conjunto de blocos básicos que se conectam de tal forma a criar um ciclo, permitindo que o código seja executado múltiplas vezes.</p>
<p>Nesta seção, vamos dissecar um laço <code>for</code> simples, entender sua representação canônica em IR e testemunhar as poderosas otimizações de laço, como a vetorização, que o LLVM pode aplicar.</p>
<section id="código-com-laço-de-repetição" class="level3" data-number="16.5.1">
<h3 data-number="16.5.1" class="anchored" data-anchor-id="código-com-laço-de-repetição"><span class="header-section-number">16.5.1</span> 5.1. Código com Laço de Repetição</h3>
<p>Vamos usar um exemplo clássico e muito comum: somar os elementos de um array. Este padrão é conhecido como “redução” e é um alvo perfeito para otimizações avançadas.</p>
<p>Crie o arquivo <code>exemplo03_loop.cpp</code>:</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co">// exemplo03_loop.cpp</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> soma_array<span class="op">(</span><span class="dt">int</span><span class="op">*</span> arr<span class="op">,</span> <span class="dt">int</span> size<span class="op">)</span> <span class="op">{</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> soma <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> size<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>        soma <span class="op">+=</span> arr<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> soma<span class="op">;</span></span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> numeros<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">4</span><span class="op">,</span> <span class="dv">5</span><span class="op">};</span></span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> resultado <span class="op">=</span> soma_array<span class="op">(</span>numeros<span class="op">,</span> <span class="dv">5</span><span class="op">);</span></span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="análise-do-ir-não-otimizado" class="level3" data-number="16.5.2">
<h3 data-number="16.5.2" class="anchored" data-anchor-id="análise-do-ir-não-otimizado"><span class="header-section-number">16.5.2</span> 5.2. Análise do IR Não Otimizado</h3>
<p>Primeiro, geramos o IR sem otimizações para podermos estudar a estrutura fundamental de um laço. O código C++ é traduzido da forma mais literal e detalhada possível, sem nenhuma tentativa de simplificação.</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="fu">clang</span>++ <span class="at">-S</span> <span class="at">-emit-llvm</span> <span class="at">-O0</span> <span class="at">-Xclang</span> <span class="at">-disable-O0-optnone</span> exemplo03_loop.cpp <span class="at">-o</span> exemplo03_loop.ll</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>O código gerado para a função <code>soma_array</code> é um excelente exemplo de código não otimizado, revelando a anatomia completa de um laço no LLVM:</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode llvm code-with-copy"><code class="sourceCode llvm"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="kw">define</span> dso_local noundef <span class="dt">i32</span> <span class="fu">@_Z10soma_arrayPii</span>(ptr noundef <span class="fu">%0</span>, <span class="dt">i32</span> noundef <span class="fu">%1</span>) #<span class="dv">0</span> {</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">; --- Bloco de Entrada (Preheader implícito) ---</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">%3</span> = <span class="kw">alloca</span> ptr, <span class="kw">align</span> <span class="dv">8</span>   <span class="co">; Aloca espaço na pilha para o ponteiro 'arr'</span></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">%4</span> = <span class="kw">alloca</span> <span class="dt">i32</span>, <span class="kw">align</span> <span class="dv">4</span>   <span class="co">; Aloca espaço para 'size'</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">%5</span> = <span class="kw">alloca</span> <span class="dt">i32</span>, <span class="kw">align</span> <span class="dv">4</span>   <span class="co">; Aloca espaço para 'soma'</span></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">%6</span> = <span class="kw">alloca</span> <span class="dt">i32</span>, <span class="kw">align</span> <span class="dv">4</span>   <span class="co">; Aloca espaço para 'i'</span></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">store</span> ptr <span class="fu">%0</span>, ptr <span class="fu">%3</span>, <span class="kw">align</span> <span class="dv">8</span></span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">store</span> <span class="dt">i32</span> <span class="fu">%1</span>, ptr <span class="fu">%4</span>, <span class="kw">align</span> <span class="dv">4</span></span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">store</span> <span class="dt">i32</span> <span class="dv">0</span>, ptr <span class="fu">%5</span>, <span class="kw">align</span> <span class="dv">4</span>   <span class="co">; soma = 0</span></span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">store</span> <span class="dt">i32</span> <span class="dv">0</span>, ptr <span class="fu">%6</span>, <span class="kw">align</span> <span class="dv">4</span>   <span class="co">; i = 0</span></span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">br</span> <span class="dt">label</span> <span class="fu">%7</span>                    <span class="co">; Pula para o início do laço (o Header)</span></span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a><span class="co">; --- Bloco 7: Header (Cabeçalho do Laço) ---</span></span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a><span class="dv">7</span>:                               <span class="co">; preds = %19, %2</span></span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">%8</span> = <span class="kw">load</span> <span class="dt">i32</span>, ptr <span class="fu">%6</span>, <span class="kw">align</span> <span class="dv">4</span> <span class="co">; Carrega 'i' da pilha</span></span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">%9</span> = <span class="kw">load</span> <span class="dt">i32</span>, ptr <span class="fu">%4</span>, <span class="kw">align</span> <span class="dv">4</span> <span class="co">; Carrega 'size' da pilha</span></span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">%10</span> = <span class="kw">icmp</span> <span class="kw">slt</span> <span class="dt">i32</span> <span class="fu">%8</span>, <span class="fu">%9</span>      <span class="co">; Condição: i &lt; size</span></span>
<span id="cb53-18"><a href="#cb53-18" aria-hidden="true" tabindex="-1"></a>  <span class="kw">br</span> <span class="dt">i1</span> <span class="fu">%10</span>, <span class="dt">label</span> <span class="fu">%11</span>, <span class="dt">label</span> <span class="fu">%22</span><span class="co">; Se verdadeiro, vai para o Body; senão, para o Exit</span></span>
<span id="cb53-19"><a href="#cb53-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-20"><a href="#cb53-20" aria-hidden="true" tabindex="-1"></a><span class="co">; --- Bloco 11: Body (Corpo do Laço) ---</span></span>
<span id="cb53-21"><a href="#cb53-21" aria-hidden="true" tabindex="-1"></a><span class="dv">11</span>:                              <span class="co">; preds = %7</span></span>
<span id="cb53-22"><a href="#cb53-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">%12</span> = <span class="kw">load</span> ptr, ptr <span class="fu">%3</span>, <span class="kw">align</span> <span class="dv">8</span>  <span class="co">; Carrega o ponteiro 'arr'</span></span>
<span id="cb53-23"><a href="#cb53-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">%13</span> = <span class="kw">load</span> <span class="dt">i32</span>, ptr <span class="fu">%6</span>, <span class="kw">align</span> <span class="dv">4</span>  <span class="co">; Carrega 'i'</span></span>
<span id="cb53-24"><a href="#cb53-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">%14</span> = <span class="kw">sext</span> <span class="dt">i32</span> <span class="fu">%13</span> <span class="kw">to</span> <span class="dt">i64</span>        <span class="co">; Estende 'i' para 64 bits para o cálculo de endereço</span></span>
<span id="cb53-25"><a href="#cb53-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">%15</span> = <span class="kw">getelementptr</span> <span class="kw">inbounds</span> <span class="dt">i32</span>, ptr <span class="fu">%12</span>, <span class="dt">i64</span> <span class="fu">%14</span> <span class="co">; Calcula o endereço de arr[i]</span></span>
<span id="cb53-26"><a href="#cb53-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">%16</span> = <span class="kw">load</span> <span class="dt">i32</span>, ptr <span class="fu">%15</span>, <span class="kw">align</span> <span class="dv">4</span> <span class="co">; Carrega o valor de arr[i]</span></span>
<span id="cb53-27"><a href="#cb53-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">%17</span> = <span class="kw">load</span> <span class="dt">i32</span>, ptr <span class="fu">%5</span>, <span class="kw">align</span> <span class="dv">4</span>  <span class="co">; Carrega 'soma'</span></span>
<span id="cb53-28"><a href="#cb53-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">%18</span> = <span class="kw">add</span> <span class="kw">nsw</span> <span class="dt">i32</span> <span class="fu">%17</span>, <span class="fu">%16</span>       <span class="co">; Executa a soma</span></span>
<span id="cb53-29"><a href="#cb53-29" aria-hidden="true" tabindex="-1"></a>  <span class="kw">store</span> <span class="dt">i32</span> <span class="fu">%18</span>, ptr <span class="fu">%5</span>, <span class="kw">align</span> <span class="dv">4</span>   <span class="co">; Armazena o novo valor em 'soma'</span></span>
<span id="cb53-30"><a href="#cb53-30" aria-hidden="true" tabindex="-1"></a>  <span class="kw">br</span> <span class="dt">label</span> <span class="fu">%19</span>                     <span class="co">; Pula para o Latch</span></span>
<span id="cb53-31"><a href="#cb53-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-32"><a href="#cb53-32" aria-hidden="true" tabindex="-1"></a><span class="co">; --- Bloco 19: Latch (Final da Iteração) ---</span></span>
<span id="cb53-33"><a href="#cb53-33" aria-hidden="true" tabindex="-1"></a><span class="dv">19</span>:                              <span class="co">; preds = %11</span></span>
<span id="cb53-34"><a href="#cb53-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">%20</span> = <span class="kw">load</span> <span class="dt">i32</span>, ptr <span class="fu">%6</span>, <span class="kw">align</span> <span class="dv">4</span> <span class="co">; Carrega 'i'</span></span>
<span id="cb53-35"><a href="#cb53-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">%21</span> = <span class="kw">add</span> <span class="kw">nsw</span> <span class="dt">i32</span> <span class="fu">%20</span>, <span class="dv">1</span>        <span class="co">; i++</span></span>
<span id="cb53-36"><a href="#cb53-36" aria-hidden="true" tabindex="-1"></a>  <span class="kw">store</span> <span class="dt">i32</span> <span class="fu">%21</span>, ptr <span class="fu">%6</span>, <span class="kw">align</span> <span class="dv">4</span>  <span class="co">; Armazena o novo 'i'</span></span>
<span id="cb53-37"><a href="#cb53-37" aria-hidden="true" tabindex="-1"></a>  <span class="kw">br</span> <span class="dt">label</span> <span class="fu">%7</span>, !llvm.loop !<span class="dv">6</span>      <span class="co">; Pula de volta para o Header</span></span>
<span id="cb53-38"><a href="#cb53-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-39"><a href="#cb53-39" aria-hidden="true" tabindex="-1"></a><span class="co">; --- Bloco 22: Exit (Saída do Laço) ---</span></span>
<span id="cb53-40"><a href="#cb53-40" aria-hidden="true" tabindex="-1"></a><span class="dv">22</span>:                              <span class="co">; preds = %7</span></span>
<span id="cb53-41"><a href="#cb53-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">%23</span> = <span class="kw">load</span> <span class="dt">i32</span>, ptr <span class="fu">%5</span>, <span class="kw">align</span> <span class="dv">4</span> <span class="co">; Carrega o valor final de 'soma'</span></span>
<span id="cb53-42"><a href="#cb53-42" aria-hidden="true" tabindex="-1"></a>  <span class="kw">ret</span> <span class="dt">i32</span> <span class="fu">%23</span>                    <span class="co">; Retorna</span></span>
<span id="cb53-43"><a href="#cb53-43" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Esta versão não otimizada é <em>verbose</em> de propósito. A observação principal é o uso intensivo de <code>alloca</code>, <code>store</code> e <code>load</code>. Cada variável C++ (<code>soma</code>, <code>i</code>) tem um espaço reservado na pilha (<code>alloca</code>), e toda leitura ou escrita é feita explicitamente com <code>load</code> e <code>store</code>. Isso mapeia diretamente o modelo de memória de variáveis do C++, mas é ineficiente.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>A Anatomia de um Laço Canônico no LLVM</strong></p>
<p>O IR gerado se encaixa perfeitamente na estrutura de laço canônica que os otimizadores do LLVM esperam encontrar: - <strong>Preheader (Pré-cabeçalho)</strong>: o bloco de entrada (<code>entry</code>) executa uma única vez, realizando todas as alocações e inicializações antes do laço começar. - <strong>Header (Cabeçalho)</strong>: o bloco <code>%7</code> é o coração do laço. É aqui que a condição <code>i &lt; size</code> é verificada a cada iteração. - <strong>Body (Corpo)</strong>: o bloco <code>%11</code> contém o trabalho principal: calcular o endereço <code>arr[i]</code>, carregar o valor e somá-lo à variável <code>soma</code>. - <strong>Latch</strong>: O bloco <code>%19</code> é executado no final de cada iteração. Sua única função é incrementar a variável de controle (<code>i++</code>) e saltar incondicionalmente de volta para o <em>Header</em> (<code>%7</code>) para a próxima verificação. - <strong>Exit (Saída)</strong>: o bloco <code>%22</code> é o destino do salto no <em>Header</em> quando a condição do laço se torna falsa. Ele simplesmente carrega o resultado final e retorna.</p>
</div>
</div>
<p>Dois conceitos se destacam nesta análise:</p>
<ol type="1">
<li><p><strong>GEP (GetElementPtr)</strong>: A instrução <code>getelementptr</code> é a forma idiomática do LLVM para realizar aritmética de ponteiros. Ela calcula o endereço de <code>arr[i]</code> a partir do ponteiro base de <code>arr</code> e do índice <code>i</code>. É crucial notar que GEP apenas <strong>calcula</strong> o endereço; a instrução <code>load</code> subsequente é que de fato <strong>lê</strong> o valor da memória.</p></li>
<li><p><strong>Metadados do Laço</strong>: A instrução <code>br label %7, !llvm.loop !6</code> no final do <em>Latch</em> possui um anexo <code>!llvm.loop !6</code>. Isso é metadado que o frontend do Clang adiciona para passar informações extras para os passes de otimização. Neste caso, <code>!llvm.loop.mustprogress</code> informa ao otimizador que este é um laço que garante progresso e não um laço infinito, permitindo otimizações mais agressivas posteriormente.</p></li>
</ol>
</section>
<section id="visualizando-o-cfg-do-laço" class="level3" data-number="16.5.3">
<h3 data-number="16.5.3" class="anchored" data-anchor-id="visualizando-o-cfg-do-laço"><span class="header-section-number">16.5.3</span> 5.3. Visualizando o CFG do Laço</h3>
<p>Gerar o CFG torna a estrutura do laço imediatamente óbvia e fácil de entender.</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="ex">opt</span> <span class="at">-passes</span><span class="op">=</span><span class="st">'dot-cfg'</span> <span class="at">-disable-output</span> exemplo03_loop.ll</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="ex">dot</span> <span class="at">-Tpng</span> ._Z10soma_arrayPii.dot <span class="at">-o</span> cfg_loop.png</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>A imagem <span class="quarto-unresolved-ref">?fig-cfg_loop</span> mostra claramente o ciclo: o bloco Header (<code>%7</code>) aponta para o Body (<code>%11</code>), o Body aponta para o Latch (<code>%19</code>), e o Latch aponta de volta para o Header, criando o laço visual. O fluxo só escapa quando o Header salta para o bloco Exit (<code>%22</code>).</p>
<div class="figure[fig-cfg_loop]">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="\images\teste3.webp" class="img-fluid figure-img"></p>
<figcaption>CFG do Laço</figcaption>
</figure>
</div>
</div>
</section>
<section id="otimização-de-laços-vetorização-e-desdobramento-em-ação" class="level3" data-number="16.5.4">
<h3 data-number="16.5.4" class="anchored" data-anchor-id="otimização-de-laços-vetorização-e-desdobramento-em-ação"><span class="header-section-number">16.5.4</span> 5.4. Otimização de Laços: Vetorização e Desdobramento em Ação</h3>
<p>Agora, vamos aplicar o otimizador e testemunhar a transformação. Laços que realizam operações aritméticas sequenciais, como o nosso, são os alvos preferidos das otimizações mais poderosas do LLVM. O resultado não é apenas uma versão “mais limpa” do laço original, mas uma reestruturação completa da lógica para extrair o máximo de desempenho do hardware.</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="ex">opt</span> <span class="at">-passes</span><span class="op">=</span><span class="st">'default&lt;O3&gt;'</span> <span class="at">-S</span> exemplo03_loop.ll <span class="at">-o</span> exemplo03_loop_opt.ll</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>O IR otimizado para a função <code>soma_array</code> é um exemplo denso e impressionante de engenharia de compiladores. Ele revela uma estratégia de múltiplas etapas para processar o array da forma mais rápida possível.</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode llvm code-with-copy"><code class="sourceCode llvm"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="kw">define</span> dso_local noundef <span class="dt">i32</span> <span class="fu">@_Z10soma_arrayPii</span>(ptr noundef <span class="kw">readonly</span> <span class="fu">%0</span>, <span class="dt">i32</span> noundef <span class="fu">%1</span>) {</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">; --- Etapa 1: Análise de Custo-Benefício ---</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">%3</span> = <span class="kw">icmp</span> <span class="kw">sgt</span> <span class="dt">i32</span> <span class="fu">%1</span>, <span class="dv">0</span></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">br</span> <span class="dt">i1</span> <span class="fu">%3</span>, <span class="dt">label</span> <span class="fu">%.lr.ph.preheader</span>, <span class="dt">label</span> <span class="fu">%._crit_edge</span></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a><span class="fu">.lr.ph.preheader:</span></span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">%wide.trip.count</span> = <span class="kw">zext</span> nneg <span class="dt">i32</span> <span class="fu">%1</span> <span class="kw">to</span> <span class="dt">i64</span></span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">%min.iters.check</span> = <span class="kw">icmp</span> <span class="kw">ult</span> <span class="dt">i32</span> <span class="fu">%1</span>, <span class="dv">8</span></span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">br</span> <span class="dt">i1</span> <span class="fu">%min.iters.check</span>, <span class="dt">label</span> <span class="fu">%.lr.ph.preheader12</span>, <span class="dt">label</span> <span class="fu">%vector.ph</span> <span class="co">; Se size &lt; 8, pula o laço vetorial</span></span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a><span class="co">; --- Etapa 2: O Laço Vetorizado e Desdobrado (O "Trabalho Pesado") ---</span></span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a><span class="fu">vector.ph:</span></span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">%n.vec</span> = <span class="kw">and</span> <span class="dt">i64</span> <span class="fu">%wide.trip.count</span>, <span class="dv">2147483640</span> <span class="co">; Arredonda o total para o múltiplo de 8 anterior</span></span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">br</span> <span class="dt">label</span> <span class="fu">%vector.body</span></span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true" tabindex="-1"></a><span class="fu">vector.body:</span></span>
<span id="cb56-17"><a href="#cb56-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">%index</span> = <span class="kw">phi</span> <span class="dt">i64</span> [ <span class="dv">0</span>, <span class="fu">%vector.ph</span> ], [ <span class="fu">%index.next</span>, <span class="fu">%vector.body</span> ]</span>
<span id="cb56-18"><a href="#cb56-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">%vec.phi</span> = <span class="kw">phi</span> &lt;<span class="dv">4</span> x <span class="dt">i32</span>&gt; [ zeroinitializer, <span class="fu">%vector.ph</span> ], [ <span class="fu">%6</span>, <span class="fu">%vector.body</span> ]      <span class="co">; Acumulador Vetorial 1</span></span>
<span id="cb56-19"><a href="#cb56-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">%vec.phi10</span> = <span class="kw">phi</span> &lt;<span class="dv">4</span> x <span class="dt">i32</span>&gt; [ zeroinitializer, <span class="fu">%vector.ph</span> ], [ <span class="fu">%7</span>, <span class="fu">%vector.body</span> ]     <span class="co">; Acumulador Vetorial 2</span></span>
<span id="cb56-20"><a href="#cb56-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">%4</span> = <span class="kw">getelementptr</span> <span class="kw">inbounds</span> <span class="kw">nuw</span> <span class="dt">i32</span>, ptr <span class="fu">%0</span>, <span class="dt">i64</span> <span class="fu">%index</span></span>
<span id="cb56-21"><a href="#cb56-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">%5</span> = <span class="kw">getelementptr</span> <span class="kw">inbounds</span> <span class="kw">nuw</span> <span class="dt">i8</span>, ptr <span class="fu">%4</span>, <span class="dt">i64</span> <span class="dv">16</span></span>
<span id="cb56-22"><a href="#cb56-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">%wide.load</span> = <span class="kw">load</span> &lt;<span class="dv">4</span> x <span class="dt">i32</span>&gt;, ptr <span class="fu">%4</span>, <span class="kw">align</span> <span class="dv">4</span>      <span class="co">; Carrega 4 elementos</span></span>
<span id="cb56-23"><a href="#cb56-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">%wide.load11</span> = <span class="kw">load</span> &lt;<span class="dv">4</span> x <span class="dt">i32</span>&gt;, ptr <span class="fu">%5</span>, <span class="kw">align</span> <span class="dv">4</span>    <span class="co">; Carrega os próximos 4 elementos</span></span>
<span id="cb56-24"><a href="#cb56-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">%6</span> = <span class="kw">add</span> &lt;<span class="dv">4</span> x <span class="dt">i32</span>&gt; <span class="fu">%wide.load</span>, <span class="fu">%vec.phi</span>           <span class="co">; Soma vetorial 1</span></span>
<span id="cb56-25"><a href="#cb56-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">%7</span> = <span class="kw">add</span> &lt;<span class="dv">4</span> x <span class="dt">i32</span>&gt; <span class="fu">%wide.load11</span>, <span class="fu">%vec.phi10</span>      <span class="co">; Soma vetorial 2</span></span>
<span id="cb56-26"><a href="#cb56-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">%index.next</span> = <span class="kw">add</span> <span class="kw">nuw</span> <span class="dt">i64</span> <span class="fu">%index</span>, <span class="dv">8</span>               <span class="co">; Avança o índice por 8</span></span>
<span id="cb56-27"><a href="#cb56-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">%8</span> = <span class="kw">icmp</span> <span class="kw">eq</span> <span class="dt">i64</span> <span class="fu">%index.next</span>, <span class="fu">%n.vec</span></span>
<span id="cb56-28"><a href="#cb56-28" aria-hidden="true" tabindex="-1"></a>  <span class="kw">br</span> <span class="dt">i1</span> <span class="fu">%8</span>, <span class="dt">label</span> <span class="fu">%middle.block</span>, <span class="dt">label</span> <span class="fu">%vector.body</span></span>
<span id="cb56-29"><a href="#cb56-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-30"><a href="#cb56-30" aria-hidden="true" tabindex="-1"></a><span class="co">; --- Etapa 3: A Redução Vetorial (A "Soma Final") ---</span></span>
<span id="cb56-31"><a href="#cb56-31" aria-hidden="true" tabindex="-1"></a><span class="fu">middle.block:</span></span>
<span id="cb56-32"><a href="#cb56-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">%bin.rdx</span> = <span class="kw">add</span> &lt;<span class="dv">4</span> x <span class="dt">i32</span>&gt; <span class="fu">%7</span>, <span class="fu">%6</span> <span class="co">; Soma os dois acumuladores vetoriais</span></span>
<span id="cb56-33"><a href="#cb56-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">%9</span> = <span class="kw">tail</span> <span class="kw">call</span> <span class="dt">i32</span> <span class="fu">@llvm.vector.reduce.add.v4i32</span>(&lt;<span class="dv">4</span> x <span class="dt">i32</span>&gt; <span class="fu">%bin.rdx</span>) <span class="co">; Reduz o vetor a um escalar</span></span>
<span id="cb56-34"><a href="#cb56-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">%cmp.n</span> = <span class="kw">icmp</span> <span class="kw">eq</span> <span class="dt">i64</span> <span class="fu">%n.vec</span>, <span class="fu">%wide.trip.count</span></span>
<span id="cb56-35"><a href="#cb56-35" aria-hidden="true" tabindex="-1"></a>  <span class="kw">br</span> <span class="dt">i1</span> <span class="fu">%cmp.n</span>, <span class="dt">label</span> <span class="fu">%._crit_edge</span>, <span class="dt">label</span> <span class="fu">%.lr.ph.preheader12</span> <span class="co">; Se acabou, vai pro fim; senão, pro laço de limpeza</span></span>
<span id="cb56-36"><a href="#cb56-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-37"><a href="#cb56-37" aria-hidden="true" tabindex="-1"></a><span class="co">; --- Etapa 4: O Laço de Limpeza (O "Arremate") ---</span></span>
<span id="cb56-38"><a href="#cb56-38" aria-hidden="true" tabindex="-1"></a><span class="fu">.lr.ph.preheader12:</span></span>
<span id="cb56-39"><a href="#cb56-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">%indvars.iv.ph</span> = <span class="kw">phi</span> <span class="dt">i64</span> [ <span class="dv">0</span>, <span class="fu">%.lr.ph.preheader</span> ], [ <span class="fu">%n.vec</span>, <span class="fu">%middle.block</span> ]</span>
<span id="cb56-40"><a href="#cb56-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">%.067.ph</span> = <span class="kw">phi</span> <span class="dt">i32</span> [ <span class="dv">0</span>, <span class="fu">%.lr.ph.preheader</span> ], [ <span class="fu">%9</span>, <span class="fu">%middle.block</span> ] <span class="co">; Pega o resultado do laço vetorial</span></span>
<span id="cb56-41"><a href="#cb56-41" aria-hidden="true" tabindex="-1"></a>  <span class="kw">br</span> <span class="dt">label</span> <span class="fu">%.lr.ph</span></span>
<span id="cb56-42"><a href="#cb56-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-43"><a href="#cb56-43" aria-hidden="true" tabindex="-1"></a><span class="fu">.lr.ph:</span></span>
<span id="cb56-44"><a href="#cb56-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">%indvars.iv</span> = <span class="kw">phi</span> <span class="dt">i64</span> [ <span class="fu">%indvars.iv.next</span>, <span class="fu">%.lr.ph</span> ], [ <span class="fu">%indvars.iv.ph</span>, <span class="fu">%.lr.ph.preheader12</span> ]</span>
<span id="cb56-45"><a href="#cb56-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">%.067</span> = <span class="kw">phi</span> <span class="dt">i32</span> [ <span class="fu">%12</span>, <span class="fu">%.lr.ph</span> ], [ <span class="fu">%.067.ph</span>, <span class="fu">%.lr.ph.preheader12</span> ]</span>
<span id="cb56-46"><a href="#cb56-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">%10</span> = <span class="kw">getelementptr</span> <span class="kw">inbounds</span> <span class="kw">nuw</span> <span class="dt">i32</span>, ptr <span class="fu">%0</span>, <span class="dt">i64</span> <span class="fu">%indvars.iv</span></span>
<span id="cb56-47"><a href="#cb56-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">%11</span> = <span class="kw">load</span> <span class="dt">i32</span>, ptr <span class="fu">%10</span>, <span class="kw">align</span> <span class="dv">4</span></span>
<span id="cb56-48"><a href="#cb56-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">%12</span> = <span class="kw">add</span> <span class="kw">nsw</span> <span class="dt">i32</span> <span class="fu">%11</span>, <span class="fu">%.067</span></span>
<span id="cb56-49"><a href="#cb56-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">%indvars.iv.next</span> = <span class="kw">add</span> <span class="kw">nuw</span> <span class="kw">nsw</span> <span class="dt">i64</span> <span class="fu">%indvars.iv</span>, <span class="dv">1</span></span>
<span id="cb56-50"><a href="#cb56-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">%exitcond.not</span> = <span class="kw">icmp</span> <span class="kw">eq</span> <span class="dt">i64</span> <span class="fu">%indvars.iv.next</span>, <span class="fu">%wide.trip.count</span></span>
<span id="cb56-51"><a href="#cb56-51" aria-hidden="true" tabindex="-1"></a>  <span class="kw">br</span> <span class="dt">i1</span> <span class="fu">%exitcond.not</span>, <span class="dt">label</span> <span class="fu">%._crit_edge</span>, <span class="dt">label</span> <span class="fu">%.lr.ph</span></span>
<span id="cb56-52"><a href="#cb56-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-53"><a href="#cb56-53" aria-hidden="true" tabindex="-1"></a><span class="co">; --- Etapa 5: A Saída (O "Ponto de Encontro") ---</span></span>
<span id="cb56-54"><a href="#cb56-54" aria-hidden="true" tabindex="-1"></a><span class="fu">._crit_edge:</span></span>
<span id="cb56-55"><a href="#cb56-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">%.06.lcssa</span> = <span class="kw">phi</span> <span class="dt">i32</span> [ <span class="dv">0</span>, <span class="fu">%2</span> ], [ <span class="fu">%9</span>, <span class="fu">%middle.block</span> ], [ <span class="fu">%12</span>, <span class="fu">%.lr.ph</span> ]</span>
<span id="cb56-56"><a href="#cb56-56" aria-hidden="true" tabindex="-1"></a>  <span class="kw">ret</span> <span class="dt">i32</span> <span class="fu">%.06.lcssa</span></span>
<span id="cb56-57"><a href="#cb56-57" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section id="análise-da-otimização-uma-estratégia-de-múltiplas-etapas" class="level4" data-number="16.5.4.1">
<h4 data-number="16.5.4.1" class="anchored" data-anchor-id="análise-da-otimização-uma-estratégia-de-múltiplas-etapas"><span class="header-section-number">16.5.4.1</span> Análise da Otimização: Uma Estratégia de Múltiplas Etapas</h4>
<p>Este IR otimizado é o resultado de uma combinação de técnicas. A estratégia geral do compilador foi: processar o máximo de dados possível com um laço vetorial super-rápido e, em seguida, lidar com os elementos restantes com um pequeno laço escalar.</p>
<p><strong>Etapa 1: A Análise de Custo-Benefício (O “Preâmbulo”)</strong> Antes de fazer qualquer coisa, o otimizador verifica se a vetorização vale a pena. No bloco <code>.lr.ph.preheader</code>, a instrução <code>%min.iters.check = icmp ult i32 %1, 8</code> checa se o número de elementos é menor que 8. Se for, ele considera que a sobrecarga da vetorização não compensa e pula diretamente para o laço escalar de limpeza (Etapa 4).</p>
<p><strong>Etapa 2: O Laço Vetorizado e Desdobrado (O “Trabalho Pesado”)</strong> Se o array é grande o suficiente, entramos no bloco <code>vector.body</code>. Aqui, duas otimizações massivas ocorrem simultaneamente: 1. <strong>Auto-Vetorização (SIMD)</strong>: O código usa tipos vetoriais como <code>&lt;4 x i32&gt;</code> para carregar (<code>load</code>) e somar (<code>add</code>) <strong>4 inteiros de uma vez</strong>. 2. <strong>Desdobramento de Laço (Loop Unrolling)</strong>: A leitora atenta notará que existem <strong>dois</strong> acumuladores vetoriais (<code>%vec.phi</code>, <code>%vec.phi10</code>) e <strong>duas</strong> operações de <code>load</code> e <code>add</code> por iteração. Isso significa que o laço foi “desdobrado”: em cada ciclo, ele processa <code>2 x 4 = 8</code> elementos do array. Isso reduz a sobrecarga do laço (menos saltos e comparações por elemento) e aumenta o paralelismo de instruções para o processador.</p>
<p><strong>Etapa 3: A Redução Vetorial (A “Soma Final”)</strong> Após o laço principal terminar, o bloco <code>middle.block</code> faz a “faxina”. - Primeiro, ele soma os dois acumuladores vetoriais (<code>%bin.rdx = add ...</code>). - Em seguida, usa o intrínseco <code>@llvm.vector.reduce.add.v4i32</code> para somar os 4 elementos do vetor resultante em um único valor inteiro, <code>%9</code>. Este é o resultado de todo o processamento vetorial.</p>
<p><strong>Etapa 4: O Laço de Limpeza (O “Arremate”)</strong> O que acontece se o tamanho do array não for um múltiplo de 8? O bloco <code>%.lr.ph</code> é um laço escalar, muito parecido com nossa versão não otimizada, que cuida dos elementos restantes (de 1 a 7). Sua genialidade está no nó <code>phi</code> <code>%.067.ph</code>, que o inicializa com <code>0</code> (se a vetorização foi pulada) ou com <code>%9</code> (o resultado da parte vetorial).</p>
<p><strong>Etapa 5: A Saída (O “Ponto de Encontro”)</strong> O bloco final, <code>._crit_edge</code>, é o ponto de convergência para todos os caminhos possíveis. O nó <code>phi</code> <code>%.06.lcssa</code> seleciona o resultado correto: <code>0</code> se o array estava vazio, o resultado do <code>middle.block</code> se o tamanho era um múltiplo exato de 8, ou o resultado final do laço de limpeza.</p>
<p>O CFG desta versão otimizada será muito mais complexo, mostrando a decisão inicial, o ciclo do laço vetorial, o ciclo do laço de limpeza e os caminhos que conectam todos eles, refletindo visualmente esta sofisticada estratégia de otimização.</p>
</section>
</section>
<section id="converter-para-bitcode" class="level3" data-number="16.5.5">
<h3 data-number="16.5.5" class="anchored" data-anchor-id="converter-para-bitcode"><span class="header-section-number">16.5.5</span> 6.1. Converter para Bitcode</h3>
<p>O Bitcode é a representação binária do LLVM IR, mais compacta e eficiente.</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Gerar bitcode diretamente</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a><span class="fu">clang</span>++ <span class="at">-c</span> <span class="at">-emit-llvm</span> exemplo01_soma.cpp <span class="at">-o</span> exemplo01_soma.bc</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Ou converter de .ll para .bc</span></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a><span class="ex">llvm-as</span> exemplo01_soma.ll <span class="at">-o</span> exemplo01_soma.bc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="converter-bitcode-de-volta-para-texto" class="level3" data-number="16.5.6">
<h3 data-number="16.5.6" class="anchored" data-anchor-id="converter-bitcode-de-volta-para-texto"><span class="header-section-number">16.5.6</span> 6.2. Converter Bitcode de volta para Texto</h3>
<div class="sourceCode" id="cb58"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="ex">llvm-dis</span> exemplo01_soma.bc <span class="at">-o</span> exemplo01_soma_reverso.ll</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="linkar-múltiplos-arquivos-bitcode" class="level3" data-number="16.5.7">
<h3 data-number="16.5.7" class="anchored" data-anchor-id="linkar-múltiplos-arquivos-bitcode"><span class="header-section-number">16.5.7</span> 6.3. Linkar Múltiplos Arquivos Bitcode</h3>
<p>Crie dois arquivos:</p>
<p><code>modulo_a.cpp</code>:</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> funcao_a<span class="op">(</span><span class="dt">int</span> x<span class="op">)</span> <span class="op">{</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x <span class="op">*</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><code>modulo_b.cpp</code>:</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> funcao_a<span class="op">(</span><span class="dt">int</span> x<span class="op">);</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> funcao_b<span class="op">(</span><span class="dt">int</span> y<span class="op">)</span> <span class="op">{</span></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> funcao_a<span class="op">(</span>y<span class="op">)</span> <span class="op">+</span> <span class="dv">10</span><span class="op">;</span></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Compile e linke:</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="fu">clang</span>++ <span class="at">-c</span> <span class="at">-emit-llvm</span> modulo_a.cpp <span class="at">-o</span> modulo_a.bc</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="fu">clang</span>++ <span class="at">-c</span> <span class="at">-emit-llvm</span> modulo_b.cpp <span class="at">-o</span> modulo_b.bc</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a><span class="ex">llvm-link</span> modulo_a.bc modulo_b.bc <span class="at">-o</span> modulos_linkados.bc</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a><span class="ex">llvm-dis</span> modulos_linkados.bc <span class="at">-o</span> modulos_linkados.ll</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<hr>
</section>
</section>
<section id="análise-de-otimizações-comuns" class="level2" data-number="16.6">
<h2 data-number="16.6" class="anchored" data-anchor-id="análise-de-otimizações-comuns"><span class="header-section-number">16.6</span> 7. Análise de Otimizações Comuns</h2>
<section id="constant-folding" class="level3" data-number="16.6.1">
<h3 data-number="16.6.1" class="anchored" data-anchor-id="constant-folding"><span class="header-section-number">16.6.1</span> 7.1. Constant Folding</h3>
<p><strong>Código:</strong></p>
<div class="sourceCode" id="cb62"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> calcular<span class="op">()</span> <span class="op">{</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">5</span> <span class="op">+</span> <span class="dv">3</span> <span class="op">*</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>IR Otimizado:</strong></p>
<div class="sourceCode" id="cb63"><pre class="sourceCode llvm code-with-copy"><code class="sourceCode llvm"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="kw">define</span> <span class="dt">i32</span> <span class="fu">@calcular</span>() {</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">ret</span> <span class="dt">i32</span> <span class="dv">11</span></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="dead-code-elimination" class="level3" data-number="16.6.2">
<h3 data-number="16.6.2" class="anchored" data-anchor-id="dead-code-elimination"><span class="header-section-number">16.6.2</span> 7.2. Dead Code Elimination</h3>
<p><strong>Código:</strong></p>
<div class="sourceCode" id="cb64"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> funcao<span class="op">()</span> <span class="op">{</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> x <span class="op">=</span> <span class="dv">10</span><span class="op">;</span></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> y <span class="op">=</span> <span class="dv">20</span><span class="op">;</span>  <span class="co">// não usado</span></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x<span class="op">;</span></span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>A variável <code>y</code> será eliminada no IR otimizado.</p>
</section>
<section id="function-inlining" class="level3" data-number="16.6.3">
<h3 data-number="16.6.3" class="anchored" data-anchor-id="function-inlining"><span class="header-section-number">16.6.3</span> 7.3. Function Inlining</h3>
<p>Pequenas funções são automaticamente incorporadas no ponto de chamada.</p>
</section>
<section id="common-subexpression-elimination" class="level3" data-number="16.6.4">
<h3 data-number="16.6.4" class="anchored" data-anchor-id="common-subexpression-elimination"><span class="header-section-number">16.6.4</span> 7.4. Common Subexpression Elimination</h3>
<p><strong>Código:</strong></p>
<div class="sourceCode" id="cb65"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> x <span class="op">=</span> a <span class="op">*</span> b <span class="op">+</span> c<span class="op">;</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> y <span class="op">=</span> a <span class="op">*</span> b <span class="op">+</span> d<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>O cálculo <code>a * b</code> será feito apenas uma vez.</p>
<hr>
</section>
</section>
<section id="exercícios-práticos" class="level2" data-number="16.7">
<h2 data-number="16.7" class="anchored" data-anchor-id="exercícios-práticos"><span class="header-section-number">16.7</span> 8. Exercícios Práticos</h2>
<section id="exercício-1-análise-básica" class="level3" data-number="16.7.1">
<h3 data-number="16.7.1" class="anchored" data-anchor-id="exercício-1-análise-básica"><span class="header-section-number">16.7.1</span> Exercício 1: Análise Básica</h3>
<p>Crie uma função que calcula o fatorial iterativo:</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> fatorial<span class="op">(</span><span class="dt">int</span> n<span class="op">)</span> <span class="op">{</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> resultado <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span><span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">1</span><span class="op">;</span> i <span class="op">&lt;=</span> n<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>        resultado <span class="op">*=</span> i<span class="op">;</span></span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> resultado<span class="op">;</span></span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Tarefas:</strong> 1. Gere o IR sem otimização (<code>-O0</code>) 2. Identifique os blocos básicos no IR 3. Localize os nós phi (φ-nodes) 4. Otimize com <code>-passes='default&lt;O3&gt;'</code> e compare 5. Conte quantas instruções foram eliminadas</p>
</section>
<section id="exercício-2-testando-passes-individuais" class="level3" data-number="16.7.2">
<h3 data-number="16.7.2" class="anchored" data-anchor-id="exercício-2-testando-passes-individuais"><span class="header-section-number">16.7.2</span> Exercício 2: Testando Passes Individuais</h3>
<p>Use o mesmo código do fatorial e aplique passes individuais em sequência:</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Gerar IR base</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a><span class="fu">clang</span>++ <span class="at">-S</span> <span class="at">-emit-llvm</span> <span class="at">-O0</span> fatorial.cpp <span class="at">-o</span> fatorial.ll</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Aplicar mem2reg</span></span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a><span class="ex">opt</span> <span class="at">-passes</span><span class="op">=</span><span class="st">'mem2reg'</span> <span class="at">-S</span> fatorial.ll <span class="at">-o</span> fatorial_mem2reg.ll</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Aplicar instcombine após mem2reg</span></span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a><span class="ex">opt</span> <span class="at">-passes</span><span class="op">=</span><span class="st">'instcombine'</span> <span class="at">-S</span> fatorial_mem2reg.ll <span class="at">-o</span> fatorial_inst.ll</span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Aplicar loop-simplify</span></span>
<span id="cb67-11"><a href="#cb67-11" aria-hidden="true" tabindex="-1"></a><span class="ex">opt</span> <span class="at">-passes</span><span class="op">=</span><span class="st">'loop-simplify'</span> <span class="at">-S</span> fatorial_inst.ll <span class="at">-o</span> fatorial_loop.ll</span>
<span id="cb67-12"><a href="#cb67-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-13"><a href="#cb67-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Comparar com otimização completa</span></span>
<span id="cb67-14"><a href="#cb67-14" aria-hidden="true" tabindex="-1"></a><span class="ex">opt</span> <span class="at">-passes</span><span class="op">=</span><span class="st">'default&lt;O3&gt;'</span> <span class="at">-S</span> fatorial.ll <span class="at">-o</span> fatorial_O3.ll</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Perguntas:</strong> - Qual pass teve maior impacto na redução de código? - O resultado final é idêntico ao <code>-passes='default&lt;O3&gt;'</code>?</p>
</section>
<section id="exercício-3-estruturas-de-dados" class="level3" data-number="16.7.3">
<h3 data-number="16.7.3" class="anchored" data-anchor-id="exercício-3-estruturas-de-dados"><span class="header-section-number">16.7.3</span> Exercício 3: Estruturas de Dados</h3>
<p>Implemente uma struct simples: 1. Gere o IR sem otimização 2. Identifique os blocos básicos 3. Localize os nós phi 4. Otimize com -O3 e compare</p>
</section>
<section id="exercício-2-estruturas-de-dados" class="level3" data-number="16.7.4">
<h3 data-number="16.7.4" class="anchored" data-anchor-id="exercício-2-estruturas-de-dados"><span class="header-section-number">16.7.4</span> Exercício 2: Estruturas de Dados</h3>
<p>Implemente uma struct simples:</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> Ponto <span class="op">{</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> x<span class="op">;</span></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> y<span class="op">;</span></span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> distancia_manhattan<span class="op">(</span>Ponto a<span class="op">,</span> Ponto b<span class="op">)</span> <span class="op">{</span></span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> abs<span class="op">(</span>a<span class="op">.</span>x <span class="op">-</span> b<span class="op">.</span>x<span class="op">)</span> <span class="op">+</span> abs<span class="op">(</span>a<span class="op">.</span>y <span class="op">-</span> b<span class="op">.</span>y<span class="op">);</span></span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Analise como structs são representadas no IR.</p>
</section>
<section id="exercício-3-ponteiros-e-referências" class="level3" data-number="16.7.5">
<h3 data-number="16.7.5" class="anchored" data-anchor-id="exercício-3-ponteiros-e-referências"><span class="header-section-number">16.7.5</span> Exercício 3: Ponteiros e Referências</h3>
<p>Compare o IR gerado para:</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> func_valor<span class="op">(</span><span class="dt">int</span> x<span class="op">)</span> <span class="op">{</span> x<span class="op">++;</span> <span class="op">}</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> func_ref<span class="op">(</span><span class="dt">int</span><span class="op">&amp;</span> x<span class="op">)</span> <span class="op">{</span> x<span class="op">++;</span> <span class="op">}</span></span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> func_ptr<span class="op">(</span><span class="dt">int</span><span class="op">*</span> x<span class="op">)</span> <span class="op">{</span> <span class="op">(*</span>x<span class="op">)++;</span> <span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="exercício-4-otimização-de-loop" class="level3" data-number="16.7.6">
<h3 data-number="16.7.6" class="anchored" data-anchor-id="exercício-4-otimização-de-loop"><span class="header-section-number">16.7.6</span> Exercício 4: Otimização de Loop</h3>
<p>Implemente e compare:</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Versão 1</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> soma_v1<span class="op">(</span><span class="dt">int</span> n<span class="op">)</span> <span class="op">{</span></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> s <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span><span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> n<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>        s <span class="op">+=</span> i<span class="op">;</span></span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> s<span class="op">;</span></span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a><span class="co">// Versão 2 (fórmula direta)</span></span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> soma_v2<span class="op">(</span><span class="dt">int</span> n<span class="op">)</span> <span class="op">{</span></span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> n <span class="op">*</span> <span class="op">(</span>n <span class="op">-</span> <span class="dv">1</span><span class="op">)</span> <span class="op">/</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb70-13"><a href="#cb70-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<hr>
</section>
</section>
<section id="comandos-de-referência-rápida" class="level2" data-number="16.8">
<h2 data-number="16.8" class="anchored" data-anchor-id="comandos-de-referência-rápida"><span class="header-section-number">16.8</span> 9. Comandos de Referência Rápida</h2>
<section id="geração-de-ir" class="level3" data-number="16.8.1">
<h3 data-number="16.8.1" class="anchored" data-anchor-id="geração-de-ir"><span class="header-section-number">16.8.1</span> Geração de IR</h3>
<table class="table">
<colgroup>
<col style="width: 45%">
<col style="width: 55%">
</colgroup>
<thead>
<tr class="header">
<th>Comando</th>
<th>Descrição</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>clang++ -S -emit-llvm arquivo.cpp -o arquivo.ll</code></td>
<td>Gera IR em texto</td>
</tr>
<tr class="even">
<td><code>clang++ -c -emit-llvm arquivo.cpp -o arquivo.bc</code></td>
<td>Gera Bitcode</td>
</tr>
<tr class="odd">
<td><code>clang++ -S -emit-llvm -O2 arquivo.cpp -o arquivo.ll</code></td>
<td>Gera IR otimizado</td>
</tr>
</tbody>
</table>
</section>
<section id="conversão" class="level3" data-number="16.8.2">
<h3 data-number="16.8.2" class="anchored" data-anchor-id="conversão"><span class="header-section-number">16.8.2</span> Conversão</h3>
<table class="table">
<thead>
<tr class="header">
<th>Comando</th>
<th>Descrição</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>llvm-as arquivo.ll -o arquivo.bc</code></td>
<td>Texto para Bitcode</td>
</tr>
<tr class="even">
<td><code>llvm-dis arquivo.bc -o arquivo.ll</code></td>
<td>Bitcode para texto</td>
</tr>
</tbody>
</table>
</section>
<section id="otimização-llvm-14" class="level3" data-number="16.8.3">
<h3 data-number="16.8.3" class="anchored" data-anchor-id="otimização-llvm-14"><span class="header-section-number">16.8.3</span> Otimização (LLVM 14+)</h3>
<table class="table">
<colgroup>
<col style="width: 45%">
<col style="width: 55%">
</colgroup>
<thead>
<tr class="header">
<th>Comando</th>
<th>Descrição</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>opt -passes='default&lt;O1&gt;' -S arquivo.ll -o saida.ll</code></td>
<td>Otimização nível 1</td>
</tr>
<tr class="even">
<td><code>opt -passes='default&lt;O2&gt;' -S arquivo.ll -o saida.ll</code></td>
<td>Otimização nível 2</td>
</tr>
<tr class="odd">
<td><code>opt -passes='default&lt;O3&gt;' -S arquivo.ll -o saida.ll</code></td>
<td>Otimização nível 3</td>
</tr>
<tr class="even">
<td><code>opt -passes='mem2reg' -S arquivo.ll -o saida.ll</code></td>
<td>Pass específico (mem2reg)</td>
</tr>
<tr class="odd">
<td><code>opt -passes='mem2reg,instcombine' -S arquivo.ll -o saida.ll</code></td>
<td>Múltiplos passes</td>
</tr>
<tr class="even">
<td><code>opt -passes='default&lt;O3&gt;' -debug-pass-manager -S arquivo.ll -o saida.ll</code></td>
<td>Ver passes executados</td>
</tr>
</tbody>
</table>
</section>
<section id="análise-e-visualização" class="level3" data-number="16.8.4">
<h3 data-number="16.8.4" class="anchored" data-anchor-id="análise-e-visualização"><span class="header-section-number">16.8.4</span> Análise e Visualização</h3>
<table class="table">
<thead>
<tr class="header">
<th>Comando</th>
<th>Descrição</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>opt -passes=dot-cfg arquivo.ll -disable-output</code></td>
<td>Gera CFG em DOT</td>
</tr>
<tr class="even">
<td><code>dot -Tpng arquivo.dot -o grafo.png</code></td>
<td>Converte DOT para PNG</td>
</tr>
</tbody>
</table>
</section>
<section id="compilação-final" class="level3" data-number="16.8.5">
<h3 data-number="16.8.5" class="anchored" data-anchor-id="compilação-final"><span class="header-section-number">16.8.5</span> Compilação Final</h3>
<table class="table">
<thead>
<tr class="header">
<th>Comando</th>
<th>Descrição</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>llc arquivo.ll -o arquivo.s</code></td>
<td>IR para Assembly</td>
</tr>
<tr class="even">
<td><code>clang++ arquivo.ll -o executavel</code></td>
<td>IR para executável</td>
</tr>
<tr class="odd">
<td><code>clang++ arquivo.bc -o executavel</code></td>
<td>Bitcode para executável</td>
</tr>
</tbody>
</table>
<hr>
</section>
</section>
<section id="troubleshooting-comum" class="level2" data-number="16.9">
<h2 data-number="16.9" class="anchored" data-anchor-id="troubleshooting-comum"><span class="header-section-number">16.9</span> 10. Troubleshooting Comum</h2>
<section id="problema-opt-não-otimiza-nada-arquivos-têm-mesmo-tamanho" class="level3" data-number="16.9.1">
<h3 data-number="16.9.1" class="anchored" data-anchor-id="problema-opt-não-otimiza-nada-arquivos-têm-mesmo-tamanho"><span class="header-section-number">16.9.1</span> Problema: opt não otimiza nada, arquivos têm mesmo tamanho</h3>
<p><strong>Sintoma:</strong> Você executa <code>opt -passes='default&lt;O3&gt;'</code> mas o arquivo de saída é idêntico ao de entrada.</p>
<p><strong>Causas Comuns:</strong></p>
<p><strong>1. Atributo <code>optnone</code> (causa mais comum)</strong></p>
<p>Verifique se suas funções têm o atributo <code>optnone</code>:</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="fu">grep</span> <span class="st">"optnone"</span> arquivo.ll</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Se você ver algo como <code>attributes #0 = { ... optnone ... }</code>, esse é o problema. O atributo <code>optnone</code> instrui o LLVM a <strong>pular completamente</strong> essa função.</p>
<p><strong>Soluções:</strong></p>
<div class="sourceCode" id="cb72"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Solução 1: Recompilar sem optnone</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a><span class="fu">clang</span>++ <span class="at">-S</span> <span class="at">-emit-llvm</span> <span class="at">-O0</span> <span class="at">-Xclang</span> <span class="at">-disable-O0-optnone</span> arquivo.cpp <span class="at">-o</span> arquivo.ll</span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Solução 2: Usar -O1 e desabilitar passes</span></span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a><span class="fu">clang</span>++ <span class="at">-S</span> <span class="at">-emit-llvm</span> <span class="at">-O1</span> <span class="at">-Xclang</span> <span class="at">-disable-llvm-passes</span> arquivo.cpp <span class="at">-o</span> arquivo.ll</span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Solução 3: Compilar direto com otimização</span></span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a><span class="fu">clang</span>++ <span class="at">-S</span> <span class="at">-emit-llvm</span> <span class="at">-O3</span> arquivo.cpp <span class="at">-o</span> arquivo.ll</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>2. Código muito simples</strong></p>
<p>Se o código é extremamente simples (como <code>int soma(int a, int b) { return a + b; }</code>), pode não haver muito o que otimizar. Use um exemplo mais complexo:</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="co">// exemplo_complexo.cpp</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> calcular<span class="op">(</span><span class="dt">int</span> x<span class="op">)</span> <span class="op">{</span></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> a <span class="op">=</span> x <span class="op">+</span> <span class="dv">5</span><span class="op">;</span></span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> b <span class="op">=</span> a <span class="op">*</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> c <span class="op">=</span> b <span class="op">+</span> <span class="dv">10</span><span class="op">;</span></span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> c <span class="op">*</span> <span class="dv">3</span><span class="op">;</span></span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Diagnóstico completo:</strong></p>
<div class="sourceCode" id="cb74"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Verificar atributo optnone</span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"=== Verificando optnone ==="</span></span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a><span class="fu">grep</span> <span class="at">-n</span> <span class="st">"optnone"</span> arquivo.ll</span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Verificar se há funções para otimizar</span></span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="at">-e</span> <span class="st">"\n=== Funções no arquivo ==="</span></span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a><span class="fu">grep</span> <span class="st">"^define"</span> arquivo.ll</span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Tentar otimizar com debug</span></span>
<span id="cb74-10"><a href="#cb74-10" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="at">-e</span> <span class="st">"\n=== Tentando otimizar com debug ==="</span></span>
<span id="cb74-11"><a href="#cb74-11" aria-hidden="true" tabindex="-1"></a><span class="ex">opt</span> <span class="at">-passes</span><span class="op">=</span><span class="st">'default&lt;O3&gt;'</span> <span class="at">-debug-pass-manager</span> <span class="at">-S</span> arquivo.ll <span class="at">-o</span> arquivo_opt.ll <span class="dv">2</span><span class="op">&gt;&amp;</span><span class="dv">1</span> <span class="kw">|</span> <span class="fu">head</span> <span class="at">-30</span></span>
<span id="cb74-12"><a href="#cb74-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-13"><a href="#cb74-13" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Comparar arquivos</span></span>
<span id="cb74-14"><a href="#cb74-14" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="at">-e</span> <span class="st">"\n=== Comparação de tamanhos ==="</span></span>
<span id="cb74-15"><a href="#cb74-15" aria-hidden="true" tabindex="-1"></a><span class="fu">wc</span> <span class="at">-l</span> arquivo.ll arquivo_opt.ll</span>
<span id="cb74-16"><a href="#cb74-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-17"><a href="#cb74-17" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. Ver diferenças</span></span>
<span id="cb74-18"><a href="#cb74-18" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="at">-e</span> <span class="st">"\n=== Diferenças (primeiras 20 linhas) ==="</span></span>
<span id="cb74-19"><a href="#cb74-19" aria-hidden="true" tabindex="-1"></a><span class="fu">diff</span> arquivo.ll arquivo_opt.ll <span class="kw">|</span> <span class="fu">head</span> <span class="at">-20</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>3. Sintaxe incorreta do opt</strong></p>
<p>Certifique-se de usar a sintaxe correta para sua versão:</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Verificar versão</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a><span class="ex">opt</span> <span class="at">--version</span></span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a><span class="co"># LLVM 14+: usar -passes</span></span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a><span class="ex">opt</span> <span class="at">-passes</span><span class="op">=</span><span class="st">'default&lt;O3&gt;'</span> <span class="at">-S</span> arquivo.ll <span class="at">-o</span> arquivo_opt.ll</span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a><span class="co"># LLVM 13-: sintaxe antiga pode funcionar</span></span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a><span class="ex">opt</span> <span class="at">-O3</span> <span class="at">-S</span> arquivo.ll <span class="at">-o</span> arquivo_opt.ll</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>4. Script de teste completo</strong></p>
<p>Salve este script como <code>testar_opt.sh</code>:</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"=== Teste de Otimização do LLVM opt ==="</span></span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">""</span></span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Criar código de teste</span></span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> <span class="op">&gt;</span> teste_opt.cpp <span class="op">&lt;&lt; 'EOF'</span></span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a><span class="st">int calcular(int x) {</span></span>
<span id="cb76-9"><a href="#cb76-9" aria-hidden="true" tabindex="-1"></a><span class="st">    int a = x + 5;</span></span>
<span id="cb76-10"><a href="#cb76-10" aria-hidden="true" tabindex="-1"></a><span class="st">    int b = a * 2;</span></span>
<span id="cb76-11"><a href="#cb76-11" aria-hidden="true" tabindex="-1"></a><span class="st">    int c = b + 10;</span></span>
<span id="cb76-12"><a href="#cb76-12" aria-hidden="true" tabindex="-1"></a><span class="st">    int d = c * 3;</span></span>
<span id="cb76-13"><a href="#cb76-13" aria-hidden="true" tabindex="-1"></a><span class="st">    return d;</span></span>
<span id="cb76-14"><a href="#cb76-14" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb76-15"><a href="#cb76-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-16"><a href="#cb76-16" aria-hidden="true" tabindex="-1"></a><span class="st">int main() {</span></span>
<span id="cb76-17"><a href="#cb76-17" aria-hidden="true" tabindex="-1"></a><span class="st">    int resultado = calcular(10);</span></span>
<span id="cb76-18"><a href="#cb76-18" aria-hidden="true" tabindex="-1"></a><span class="st">    return 0;</span></span>
<span id="cb76-19"><a href="#cb76-19" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb76-20"><a href="#cb76-20" aria-hidden="true" tabindex="-1"></a><span class="op">EOF</span></span>
<span id="cb76-21"><a href="#cb76-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-22"><a href="#cb76-22" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"1. Código criado: teste_opt.cpp"</span></span>
<span id="cb76-23"><a href="#cb76-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-24"><a href="#cb76-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Gerar IR sem optnone</span></span>
<span id="cb76-25"><a href="#cb76-25" aria-hidden="true" tabindex="-1"></a><span class="fu">clang</span>++ <span class="at">-S</span> <span class="at">-emit-llvm</span> <span class="at">-O0</span> <span class="at">-Xclang</span> <span class="at">-disable-O0-optnone</span> teste_opt.cpp <span class="at">-o</span> teste_opt.ll</span>
<span id="cb76-26"><a href="#cb76-26" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"2. IR gerado: teste_opt.ll"</span></span>
<span id="cb76-27"><a href="#cb76-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-28"><a href="#cb76-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Verificar optnone</span></span>
<span id="cb76-29"><a href="#cb76-29" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="fu">grep</span> <span class="at">-q</span> <span class="st">"optnone"</span> teste_opt.ll<span class="kw">;</span> <span class="cf">then</span></span>
<span id="cb76-30"><a href="#cb76-30" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">"   ⚠️  AVISO: Atributo optnone encontrado! Otimização pode não funcionar."</span></span>
<span id="cb76-31"><a href="#cb76-31" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span></span>
<span id="cb76-32"><a href="#cb76-32" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">"   ✓ OK: Sem atributo optnone"</span></span>
<span id="cb76-33"><a href="#cb76-33" aria-hidden="true" tabindex="-1"></a><span class="cf">fi</span></span>
<span id="cb76-34"><a href="#cb76-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-35"><a href="#cb76-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Contar linhas antes</span></span>
<span id="cb76-36"><a href="#cb76-36" aria-hidden="true" tabindex="-1"></a><span class="va">linhas_antes</span><span class="op">=</span><span class="va">$(</span><span class="fu">wc</span> <span class="at">-l</span> <span class="op">&lt;</span> teste_opt.ll<span class="va">)</span></span>
<span id="cb76-37"><a href="#cb76-37" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"3. Linhas antes da otimização: </span><span class="va">$linhas_antes</span><span class="st">"</span></span>
<span id="cb76-38"><a href="#cb76-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-39"><a href="#cb76-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Otimizar</span></span>
<span id="cb76-40"><a href="#cb76-40" aria-hidden="true" tabindex="-1"></a><span class="ex">opt</span> <span class="at">-passes</span><span class="op">=</span><span class="st">'default&lt;O3&gt;'</span> <span class="at">-S</span> teste_opt.ll <span class="at">-o</span> teste_opt_O3.ll <span class="dv">2</span><span class="op">&gt;&amp;</span><span class="dv">1</span> <span class="kw">|</span> <span class="fu">head</span> <span class="at">-5</span></span>
<span id="cb76-41"><a href="#cb76-41" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"4. Otimização aplicada"</span></span>
<span id="cb76-42"><a href="#cb76-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-43"><a href="#cb76-43" aria-hidden="true" tabindex="-1"></a><span class="co"># Contar linhas depois</span></span>
<span id="cb76-44"><a href="#cb76-44" aria-hidden="true" tabindex="-1"></a><span class="va">linhas_depois</span><span class="op">=</span><span class="va">$(</span><span class="fu">wc</span> <span class="at">-l</span> <span class="op">&lt;</span> teste_opt_O3.ll<span class="va">)</span></span>
<span id="cb76-45"><a href="#cb76-45" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"5. Linhas depois da otimização: </span><span class="va">$linhas_depois</span><span class="st">"</span></span>
<span id="cb76-46"><a href="#cb76-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-47"><a href="#cb76-47" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcular redução</span></span>
<span id="cb76-48"><a href="#cb76-48" aria-hidden="true" tabindex="-1"></a><span class="va">reducao</span><span class="op">=</span><span class="va">$((</span><span class="dv">100</span> <span class="op">*</span> (<span class="va">linhas_antes</span> <span class="op">-</span> <span class="va">linhas_depois</span>) <span class="op">/</span> <span class="va">linhas_antes))</span></span>
<span id="cb76-49"><a href="#cb76-49" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">""</span></span>
<span id="cb76-50"><a href="#cb76-50" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"=== RESULTADO ==="</span></span>
<span id="cb76-51"><a href="#cb76-51" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">[</span> <span class="va">$linhas_depois</span> <span class="ot">-lt</span> <span class="va">$linhas_antes</span> <span class="bu">]</span><span class="kw">;</span> <span class="cf">then</span></span>
<span id="cb76-52"><a href="#cb76-52" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">"✓ SUCESSO! Código foi otimizado!"</span></span>
<span id="cb76-53"><a href="#cb76-53" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">"  Redução: </span><span class="va">$reducao</span><span class="st">%"</span></span>
<span id="cb76-54"><a href="#cb76-54" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">""</span></span>
<span id="cb76-55"><a href="#cb76-55" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">"Função calcular ANTES (primeiras 15 linhas):"</span></span>
<span id="cb76-56"><a href="#cb76-56" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sed</span> <span class="at">-n</span> <span class="st">'/@.*calcular/,/^}/p'</span> teste_opt.ll <span class="kw">|</span> <span class="fu">head</span> <span class="at">-15</span></span>
<span id="cb76-57"><a href="#cb76-57" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">""</span></span>
<span id="cb76-58"><a href="#cb76-58" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">"Função calcular DEPOIS:"</span></span>
<span id="cb76-59"><a href="#cb76-59" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sed</span> <span class="at">-n</span> <span class="st">'/@.*calcular/,/^}/p'</span> teste_opt_O3.ll</span>
<span id="cb76-60"><a href="#cb76-60" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span></span>
<span id="cb76-61"><a href="#cb76-61" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">"✗ FALHA! Otimização não funcionou."</span></span>
<span id="cb76-62"><a href="#cb76-62" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">"  Possíveis causas:"</span></span>
<span id="cb76-63"><a href="#cb76-63" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">"  1. Atributo optnone presente"</span></span>
<span id="cb76-64"><a href="#cb76-64" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">"  2. Sintaxe incorreta do opt"</span></span>
<span id="cb76-65"><a href="#cb76-65" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">"  3. Problema com o LLVM"</span></span>
<span id="cb76-66"><a href="#cb76-66" aria-hidden="true" tabindex="-1"></a><span class="cf">fi</span></span>
<span id="cb76-67"><a href="#cb76-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-68"><a href="#cb76-68" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">""</span></span>
<span id="cb76-69"><a href="#cb76-69" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"=== Comparação Visual ==="</span></span>
<span id="cb76-70"><a href="#cb76-70" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"Função calcular ANTES:"</span></span>
<span id="cb76-71"><a href="#cb76-71" aria-hidden="true" tabindex="-1"></a><span class="fu">grep</span> <span class="at">-A</span> 10 <span class="st">"define.*calcular"</span> teste_opt.ll</span>
<span id="cb76-72"><a href="#cb76-72" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">""</span></span>
<span id="cb76-73"><a href="#cb76-73" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"Função calcular DEPOIS:"</span></span>
<span id="cb76-74"><a href="#cb76-74" aria-hidden="true" tabindex="-1"></a><span class="fu">grep</span> <span class="at">-A</span> 10 <span class="st">"define.*calcular"</span> teste_opt_O3.ll</span>
<span id="cb76-75"><a href="#cb76-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-76"><a href="#cb76-76" aria-hidden="true" tabindex="-1"></a><span class="co"># Limpar</span></span>
<span id="cb76-77"><a href="#cb76-77" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span> <span class="at">-f</span> teste_opt.cpp teste_opt.ll teste_opt_O3.ll</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Execute:</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="fu">chmod</span> +x testar_opt.sh</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a><span class="ex">./testar_opt.sh</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="problema-comando-não-encontrado" class="level3" data-number="16.9.2">
<h3 data-number="16.9.2" class="anchored" data-anchor-id="problema-comando-não-encontrado"><span class="header-section-number">16.9.2</span> Problema: Comando não encontrado</h3>
<p><strong>Solução:</strong></p>
<div class="sourceCode" id="cb78"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Verificar se o LLVM está instalado</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a><span class="fu">which</span> clang++</span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a><span class="fu">which</span> opt</span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Se não estiver, reinstalar</span></span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> ./llvm.sh 20</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="problema-versão-incorreta-sendo-usada" class="level3" data-number="16.9.3">
<h3 data-number="16.9.3" class="anchored" data-anchor-id="problema-versão-incorreta-sendo-usada"><span class="header-section-number">16.9.3</span> Problema: Versão incorreta sendo usada</h3>
<p><strong>Solução:</strong></p>
<div class="sourceCode" id="cb79"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Atualizar alternativas</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> update-alternatives <span class="at">--config</span> clang++</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="problema-arquivo-.ll-corrompido-ou-ilegível" class="level3" data-number="16.9.4">
<h3 data-number="16.9.4" class="anchored" data-anchor-id="problema-arquivo-.ll-corrompido-ou-ilegível"><span class="header-section-number">16.9.4</span> Problema: Arquivo .ll corrompido ou ilegível</h3>
<p><strong>Solução:</strong></p>
<div class="sourceCode" id="cb80"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Regenerar o arquivo</span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span> arquivo.ll</span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a><span class="fu">clang</span>++ <span class="at">-S</span> <span class="at">-emit-llvm</span> arquivo.cpp <span class="at">-o</span> arquivo.ll</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="problema-otimização-não-funciona-como-esperado" class="level3" data-number="16.9.5">
<h3 data-number="16.9.5" class="anchored" data-anchor-id="problema-otimização-não-funciona-como-esperado"><span class="header-section-number">16.9.5</span> Problema: Otimização não funciona como esperado</h3>
<p><strong>Solução:</strong> Use <code>-Rpass=.*</code> para ver quais otimizações foram aplicadas:</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="fu">clang</span>++ <span class="at">-O3</span> <span class="at">-Rpass</span><span class="op">=</span>.<span class="pp">*</span> arquivo.cpp</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<hr>
</section>
</section>
<section id="recursos-adicionais" class="level2" data-number="16.10">
<h2 data-number="16.10" class="anchored" data-anchor-id="recursos-adicionais"><span class="header-section-number">16.10</span> 11. Recursos Adicionais</h2>
<section id="documentação-oficial" class="level3" data-number="16.10.1">
<h3 data-number="16.10.1" class="anchored" data-anchor-id="documentação-oficial"><span class="header-section-number">16.10.1</span> Documentação Oficial</h3>
<ul>
<li>LLVM Language Reference: https://llvm.org/docs/LangRef.html</li>
<li>LLVM Passes: https://llvm.org/docs/Passes.html</li>
<li>Getting Started: https://llvm.org/docs/GettingStarted.html</li>
</ul>
</section>
<section id="ferramentas-úteis" class="level3" data-number="16.10.2">
<h3 data-number="16.10.2" class="anchored" data-anchor-id="ferramentas-úteis"><span class="header-section-number">16.10.2</span> Ferramentas Úteis</h3>
<ul>
<li>Compiler Explorer (https://godbolt.org): Visualize IR online</li>
<li>LLVM Tutorial: https://llvm.org/docs/tutorial/</li>
</ul>
</section>
<section id="leitura-recomendada" class="level3" data-number="16.10.3">
<h3 data-number="16.10.3" class="anchored" data-anchor-id="leitura-recomendada"><span class="header-section-number">16.10.3</span> Leitura Recomendada</h3>
<ul>
<li>“Getting Started with LLVM Core Libraries” - Bruno Cardoso Lopes</li>
<li>LLVM Blog: https://blog.llvm.org/</li>
</ul>
<hr>
</section>
</section>
<section id="apêndice-tipos-de-dados-no-llvm-ir" class="level2" data-number="16.11">
<h2 data-number="16.11" class="anchored" data-anchor-id="apêndice-tipos-de-dados-no-llvm-ir"><span class="header-section-number">16.11</span> 12. Apêndice: Tipos de Dados no LLVM IR</h2>
<section id="tipos-primitivos" class="level3" data-number="16.11.1">
<h3 data-number="16.11.1" class="anchored" data-anchor-id="tipos-primitivos"><span class="header-section-number">16.11.1</span> Tipos Primitivos</h3>
<ul>
<li><code>i1</code>, <code>i8</code>, <code>i16</code>, <code>i32</code>, <code>i64</code>: Inteiros de 1, 8, 16, 32, 64 bits</li>
<li><code>float</code>: Ponto flutuante 32 bits</li>
<li><code>double</code>: Ponto flutuante 64 bits</li>
<li><code>ptr</code>: Ponteiro genérico</li>
<li><code>void</code>: Sem valor</li>
</ul>
</section>
<section id="tipos-derivados" class="level3" data-number="16.11.2">
<h3 data-number="16.11.2" class="anchored" data-anchor-id="tipos-derivados"><span class="header-section-number">16.11.2</span> Tipos Derivados</h3>
<ul>
<li><code>[N x tipo]</code>: Array de N elementos</li>
<li><code>{tipo1, tipo2, ...}</code>: Struct (estrutura)</li>
<li><code>&lt;N x tipo&gt;</code>: Vetor (para SIMD)</li>
</ul>
</section>
<section id="exemplos" class="level3" data-number="16.11.3">
<h3 data-number="16.11.3" class="anchored" data-anchor-id="exemplos"><span class="header-section-number">16.11.3</span> Exemplos</h3>
<div class="sourceCode" id="cb82"><pre class="sourceCode llvm code-with-copy"><code class="sourceCode llvm"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="fu">%array</span> = <span class="kw">alloca</span> [<span class="dv">10</span> x <span class="dt">i32</span>]              <span class="co">; array de 10 inteiros</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a><span class="fu">%struct</span> = <span class="kw">alloca</span> {<span class="dt">i32</span>, <span class="dt">float</span>}           <span class="co">; struct com int e float</span></span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a><span class="fu">%vector</span> = <span class="kw">alloca</span> &lt;<span class="dv">4</span> x <span class="dt">float</span>&gt;            <span class="co">; vetor SIMD de 4 floats</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<hr>
</section>
</section>
<section id="apêndice-migrando-da-sintaxe-antiga-para-nova-legacy-pm-new-pm" class="level2" data-number="16.12">
<h2 data-number="16.12" class="anchored" data-anchor-id="apêndice-migrando-da-sintaxe-antiga-para-nova-legacy-pm-new-pm"><span class="header-section-number">16.12</span> 13. Apêndice: Migrando da Sintaxe Antiga para Nova (Legacy PM → New PM)</h2>
<p>Se você encontrar tutoriais antigos ou código que usa a sintaxe antiga do opt, aqui está um guia de conversão:</p>
<section id="comandos-básicos-de-otimização" class="level3" data-number="16.12.1">
<h3 data-number="16.12.1" class="anchored" data-anchor-id="comandos-básicos-de-otimização"><span class="header-section-number">16.12.1</span> Comandos Básicos de Otimização</h3>
<table class="table">
<thead>
<tr class="header">
<th>Sintaxe Antiga (até LLVM 13)</th>
<th>Sintaxe Nova (LLVM 14+)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>opt -O0 arquivo.ll</code></td>
<td><code>opt -passes='default&lt;O0&gt;' arquivo.ll</code></td>
</tr>
<tr class="even">
<td><code>opt -O1 arquivo.ll</code></td>
<td><code>opt -passes='default&lt;O1&gt;' arquivo.ll</code></td>
</tr>
<tr class="odd">
<td><code>opt -O2 arquivo.ll</code></td>
<td><code>opt -passes='default&lt;O2&gt;' arquivo.ll</code></td>
</tr>
<tr class="even">
<td><code>opt -O3 arquivo.ll</code></td>
<td><code>opt -passes='default&lt;O3&gt;' arquivo.ll</code></td>
</tr>
</tbody>
</table>
</section>
<section id="passes-individuais" class="level3" data-number="16.12.2">
<h3 data-number="16.12.2" class="anchored" data-anchor-id="passes-individuais"><span class="header-section-number">16.12.2</span> Passes Individuais</h3>
<table class="table">
<colgroup>
<col style="width: 53%">
<col style="width: 46%">
</colgroup>
<thead>
<tr class="header">
<th>Sintaxe Antiga</th>
<th>Sintaxe Nova</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>opt -mem2reg arquivo.ll</code></td>
<td><code>opt -passes='mem2reg' arquivo.ll</code></td>
</tr>
<tr class="even">
<td><code>opt -instcombine arquivo.ll</code></td>
<td><code>opt -passes='instcombine' arquivo.ll</code></td>
</tr>
<tr class="odd">
<td><code>opt -inline arquivo.ll</code></td>
<td><code>opt -passes='inline' arquivo.ll</code></td>
</tr>
<tr class="even">
<td><code>opt -dce arquivo.ll</code></td>
<td><code>opt -passes='dce' arquivo.ll</code></td>
</tr>
<tr class="odd">
<td><code>opt -simplifycfg arquivo.ll</code></td>
<td><code>opt -passes='simplifycfg' arquivo.ll</code></td>
</tr>
</tbody>
</table>
</section>
<section id="múltiplos-passes-em-sequência" class="level3" data-number="16.12.3">
<h3 data-number="16.12.3" class="anchored" data-anchor-id="múltiplos-passes-em-sequência"><span class="header-section-number">16.12.3</span> Múltiplos Passes em Sequência</h3>
<table class="table">
<colgroup>
<col style="width: 53%">
<col style="width: 46%">
</colgroup>
<thead>
<tr class="header">
<th>Sintaxe Antiga</th>
<th>Sintaxe Nova</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>opt -mem2reg -instcombine arquivo.ll</code></td>
<td><code>opt -passes='mem2reg,instcombine' arquivo.ll</code></td>
</tr>
<tr class="even">
<td><code>opt -inline -mem2reg -dce arquivo.ll</code></td>
<td><code>opt -passes='inline,mem2reg,dce' arquivo.ll</code></td>
</tr>
</tbody>
</table>
</section>
<section id="debug-e-análise" class="level3" data-number="16.12.4">
<h3 data-number="16.12.4" class="anchored" data-anchor-id="debug-e-análise"><span class="header-section-number">16.12.4</span> Debug e Análise</h3>
<table class="table">
<colgroup>
<col style="width: 53%">
<col style="width: 46%">
</colgroup>
<thead>
<tr class="header">
<th>Sintaxe Antiga</th>
<th>Sintaxe Nova</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>opt -debug-pass=Arguments</code></td>
<td><code>opt -debug-pass-manager</code></td>
</tr>
<tr class="even">
<td><code>opt -debug-pass=Structure</code></td>
<td><code>opt -debug-pass-manager</code></td>
</tr>
<tr class="odd">
<td><code>opt -view-cfg arquivo.ll</code></td>
<td><code>opt -passes='dot-cfg' arquivo.ll</code> seguido de visualização</td>
</tr>
<tr class="even">
<td><code>opt -print-callgraph arquivo.ll</code></td>
<td><code>opt -passes='print&lt;callgraph&gt;' arquivo.ll</code></td>
</tr>
</tbody>
</table>
</section>
<section id="passes-de-análise-print" class="level3" data-number="16.12.5">
<h3 data-number="16.12.5" class="anchored" data-anchor-id="passes-de-análise-print"><span class="header-section-number">16.12.5</span> Passes de Análise (Print)</h3>
<table class="table">
<colgroup>
<col style="width: 53%">
<col style="width: 46%">
</colgroup>
<thead>
<tr class="header">
<th>Sintaxe Antiga</th>
<th>Sintaxe Nova</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>opt -print-cfg arquivo.ll</code></td>
<td><code>opt -passes='print&lt;cfg&gt;' arquivo.ll</code></td>
</tr>
<tr class="even">
<td><code>opt -print-dom-info arquivo.ll</code></td>
<td><code>opt -passes='print&lt;domtree&gt;' arquivo.ll</code></td>
</tr>
<tr class="odd">
<td><code>opt -print-loops arquivo.ll</code></td>
<td><code>opt -passes='print&lt;loops&gt;' arquivo.ll</code></td>
</tr>
</tbody>
</table>
</section>
<section id="forçar-o-legacy-pm-versões-de-transição-llvm-13-15" class="level3" data-number="16.12.6">
<h3 data-number="16.12.6" class="anchored" data-anchor-id="forçar-o-legacy-pm-versões-de-transição-llvm-13-15"><span class="header-section-number">16.12.6</span> Forçar o Legacy PM (Versões de Transição LLVM 13-15)</h3>
<p>Se você realmente precisa usar a sintaxe antiga em versões de transição:</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Forçar legacy PM (não recomendado, pode não estar disponível)</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a><span class="ex">opt</span> <span class="at">-enable-new-pm</span><span class="op">=</span>0 <span class="at">-O3</span> arquivo.ll</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="dicas-para-conversão" class="level3" data-number="16.12.7">
<h3 data-number="16.12.7" class="anchored" data-anchor-id="dicas-para-conversão"><span class="header-section-number">16.12.7</span> Dicas para Conversão</h3>
<ol type="1">
<li><strong>Passes separados por vírgula</strong>: Na nova sintaxe, use vírgula <code>,</code> para separar passes</li>
<li><strong>Aspas são importantes</strong>: Use <code>'</code> para evitar problemas com o shell</li>
<li><strong>Pipeline default</strong>: Para otimizações padrão, use <code>default&lt;ON&gt;</code></li>
<li><strong>Hierarquia de passes</strong>: Alguns passes agora precisam especificar o escopo:
<ul>
<li><code>function(...)</code> para passes de função</li>
<li><code>module(...)</code> para passes de módulo</li>
</ul></li>
</ol>
<p><strong>Exemplo complexo:</strong></p>
<div class="sourceCode" id="cb84"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Antiga</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a><span class="ex">opt</span> <span class="at">-inline</span> <span class="at">-mem2reg</span> <span class="at">-instcombine</span> <span class="at">-simplifycfg</span> <span class="at">-dce</span> arquivo.ll</span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Nova</span></span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a><span class="ex">opt</span> <span class="at">-passes</span><span class="op">=</span><span class="st">'inline,function(mem2reg,instcombine,simplifycfg,dce)'</span> arquivo.ll</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="como-encontrar-o-nome-correto-de-um-pass" class="level3" data-number="16.12.8">
<h3 data-number="16.12.8" class="anchored" data-anchor-id="como-encontrar-o-nome-correto-de-um-pass"><span class="header-section-number">16.12.8</span> Como Encontrar o Nome Correto de um Pass</h3>
<div class="sourceCode" id="cb85"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Listar todos os passes disponíveis no novo PM</span></span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a><span class="ex">opt</span> <span class="at">--print-passes</span></span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Buscar um pass específico</span></span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a><span class="ex">opt</span> <span class="at">--print-passes</span> <span class="kw">|</span> <span class="fu">grep</span> <span class="at">-i</span> <span class="st">"nome_do_pass"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="script-de-conversão-rápida" class="level3" data-number="16.12.9">
<h3 data-number="16.12.9" class="anchored" data-anchor-id="script-de-conversão-rápida"><span class="header-section-number">16.12.9</span> Script de Conversão Rápida</h3>
<p>Se você tem muitos scripts usando a sintaxe antiga, aqui está um exemplo de como converter:</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a><span class="co"># converter_opt.sh - Converte comandos opt antigos para novos</span></span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Exemplo de uso: ./converter_opt.sh "opt -O3 -inline arquivo.ll"</span></span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a><span class="va">comando</span><span class="op">=</span><span class="va">$1</span></span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Substituir -O0, -O1, -O2, -O3</span></span>
<span id="cb86-9"><a href="#cb86-9" aria-hidden="true" tabindex="-1"></a><span class="va">comando</span><span class="op">=</span><span class="va">$(</span><span class="bu">echo</span> <span class="st">"</span><span class="va">$comando</span><span class="st">"</span> <span class="kw">|</span> <span class="fu">sed</span> <span class="st">"s/-O\([0-3]\)/-passes='default&lt;O\1&gt;'/g"</span><span class="va">)</span></span>
<span id="cb86-10"><a href="#cb86-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-11"><a href="#cb86-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Avisar sobre outras flags que precisam conversão manual</span></span>
<span id="cb86-12"><a href="#cb86-12" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">echo</span> <span class="st">"</span><span class="va">$comando</span><span class="st">"</span> <span class="kw">|</span> <span class="fu">grep</span> <span class="at">-qE</span> <span class="st">' -[a-z-]+ '</span> <span class="kw">|</span> <span class="fu">grep</span> <span class="at">-v</span> <span class="st">"passes="</span><span class="kw">;</span> <span class="cf">then</span></span>
<span id="cb86-13"><a href="#cb86-13" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">"AVISO: Comando contém flags que precisam ser convertidas manualmente"</span></span>
<span id="cb86-14"><a href="#cb86-14" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">"Comando original: </span><span class="va">$1</span><span class="st">"</span></span>
<span id="cb86-15"><a href="#cb86-15" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">"Comando parcialmente convertido: </span><span class="va">$comando</span><span class="st">"</span></span>
<span id="cb86-16"><a href="#cb86-16" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">"Consulte a tabela de conversão para flags individuais"</span></span>
<span id="cb86-17"><a href="#cb86-17" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span></span>
<span id="cb86-18"><a href="#cb86-18" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">"Comando convertido: </span><span class="va">$comando</span><span class="st">"</span></span>
<span id="cb86-19"><a href="#cb86-19" aria-hidden="true" tabindex="-1"></a><span class="cf">fi</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/frankalcantara\.com");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./14-GeraInter.html" class="pagination-link" aria-label="Geração de Código Intermediário: A Linguagem Universal do Compilador">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Geração de Código Intermediário: A Linguagem Universal do Compilador</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./16-peepOtimiza.html" class="pagination-link" aria-label="Otimizações Peephole: Algoritmos e Técnicas em Código Intermediário">
        <span class="nav-page-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Otimizações Peephole: Algoritmos e Técnicas em Código Intermediário</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
<p>Copyright © 2025 Frank de Alcantara</p>
<div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/frankalcantara/linguagens-formais/edit/main/15-llvmIR.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/frankalcantara/linguagens-formais/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>